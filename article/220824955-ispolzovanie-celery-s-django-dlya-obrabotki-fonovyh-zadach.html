
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы....">
<meta property="og:description" content="Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы....">
<meta name="twitter:description" content="Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы....">
<meta property="aiturec:description" content="Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1540/profiles/20048/profileImage/face.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1540/profiles/20048/profileImage/face.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1540/profiles/20048/profileImage/face.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1540/profiles/20048/profileImage/face.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1540/profiles/20048/profileImage/face.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html">
<link rel="canonical" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html">
<meta property="og:url" content="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html" title="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io" title="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/63456435436.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html" class="tm-user-info__username" title="
М. Старостенко" aria-label="
М. Старостенко">
М. Старостенко</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Использование Celery с Django для обработки фоновых задач...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Django" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach" class="tm-article-snippet__hubs-item-link"><span>Django</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1540/profiles/20048/profileImage/face.jpg">
    <meta itemprop="headline name" content="Использование Celery с Django для обработки фоновых задач... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Веб-приложения обычно начинаются разрабатываться просто, но могут стать довольно сложными, и большинство из них быстро перерастает область ответственности только за HTTP-запросы.<br></p><p>Когда это происходит, нужно провести различие между тем, что должно выполняться мгновенно (обычно в жизненном цикле HTTP-запроса), и что может произойти в конечном итоге, после запроса. Почему это необходимо? Ну, потому что, когда ваше приложение становится перегруженным трафиком, решения, подобные этому, начинают иметь значение. </p><p>Операции в веб-приложении могут быть классифицированы как критические или request-time операции и фоновые задачи, которые происходят за пределами цикла запрос-ответ. Они сопоставляются с описанными выше: </p><ul><li>Должно произойти мгновенно: request-time операция</li> <li>Должно произойти после ответа: фоновые задачи</li> </ul><p>Request-time операции могут выполняться в течение одного цикла запрос/ответ, не беспокоясь о том, что операция может получить тайм-аут или что у пользователя может быть плохое соединение. Общие примеры включают CRUD (создание, чтение, обновление, удаление) операций с базой данных и управление пользователями (процедуры входа/выхода).</p><p>Фоновые задачи отличаются, поскольку они обычно довольно трудоемки и склонны к сбою, главным образом из-за внешних зависимостей. Некоторые распространенные сценарии среди сложных веб-приложений включают:</p><ul><li>Отправка уведомлений о подтверждении или рассылка сообщений</li> <li>Ежедневное сканирование и скрапинг некоторой информации из разных источников и сохранение их</li> <li>Анализ данных</li> <li>Удаление ненужных ресурсов</li> <li>экспорт документов/фотографии в различных форматах</li> </ul><p>Фоновые задачи являются основным направлением данного руководства. Наиболее распространенным шаблоном программирования, используемым для этого сценария, является Producer-Consumer архитектура. </p><p>Проще говоря, эта архитектура может быть описана следующим образом: </p><ul><li>Producers создают данные или задачи.</li> <li>Задачи помещаются в очередь, которая называется очередью задач. </li> <li>Consumers несут ответственность за потребление данных или выполнение задач. </li> </ul><p>Обычно сonsumers загружают задачи из очереди в режиме first-out (FIFO)  или в соответствии с их приоритетами. Потребителей также называют воркерами, и это термин, который мы будем использовать повсюду, поскольку он согласуется с терминологией, используемой обсуждаемыми технологиями.<br></p><p>Какие задачи можно обрабатывать в фоновом режиме? Задачи, которые:</p><ul><li>Не являются существенными для основного функционала веб-приложения</li> <li>Не могут выполняться в цикле запросо/ответ, поскольку они медленны (интенсивность ввода-вывода и.т.д.)</li> <li>Зависят от внешних ресурсов, которые могут быть недоступны или не будут вести себя так, как ожидалось</li> <li>Возможно, потребуют повторить попытку хотя бы один раз</li> <li>Должны выполняться по графику</li> </ul><p>Celery является де-факто выбором для обработки фоновых задач в экосистеме Python/Django. Он имеет простой и понятный API, и он прекрасно сочетается с Django. Он поддерживает различные технологии для очереди задач и различные парадигмы для воркеров.</p><p>В этом уроке мы собираемся создать игровое веб-приложение Django (работающее с реальными сценариями), которое использует обработку фоновых задач.</p><h2>Настройка<span></span> </h2><p>Предполагая, что вы уже знакомы с менеджером пакетов Python и виртуальными окружениями, давайте установим Django:</p><pre class="brush: bash noskimlinks noskimwords">$ pip install Django</pre><p>Я решил создать еще одно приложение для ведения блога. Приложение будет простым. Пользователь может просто создать учетную запись и без особых проблем может создать пост и опубликовать его на платформе. </p><p>Настройка Django проекта <code>quick_publisher</code>:</p><pre class="brush: bash noskimlinks noskimwords">$ django-admin startproject quick_publisher</pre><p>Давайте начнем разработку приложения:</p><pre class="brush: bash noskimlinks noskimwords">$ cd quick_publisher $ ./manage.py startapp main</pre><p>При запуске нового Django проекта  мне нравится создавать <code>main</code> приложение, которое содержит, помимо прочего, кастомную модель пользователя. Чаще всего Я сталкиваюсь с ограничениями модели <code>User</code> по умолчанию. Наличие пользовательской модели <code>User</code> дает нам гибкость.</p><pre class="brush: python noskimlinks noskimwords"># main/models.pyfrom django.db import modelsfrom django.contrib.auth.models import AbstractBaseUser, PermissionsMixin, BaseUserManagerclass UserAccountManager(BaseUserManager):    use_in_migrations = True    def _create_user(self, email, password, **extra_fields):        if not email:            raise ValueError("Email address must be provided")        if not password:            raise ValueError("Password must be provided")        email = self.normalize_email(email)        user = self.model(email=email, **extra_fields)        user.set_password(password)        user.save(using=self._db)        return user    def create_user(self, email=None, password=None, **extra_fields):        return self._create_user(email, password, **extra_fields)    def create_superuser(self, email, password, **extra_fields):        extra_fields["is_staff"] = True        extra_fields["is_superuser"] = True        return self._create_user(email, password, **extra_fields)class User(AbstractBaseUser, PermissionsMixin):    REQUIRED_FIELDS = []    USERNAME_FIELD = "email"    objects = UserAccountManager()    email = models.EmailField("email", unique=True, blank=False, null=False)    full_name = models.CharField("full name", blank=True, null=True, max_length=400)    is_staff = models.BooleanField("staff status", default=False)    is_active = models.BooleanField("active", default=True)    def get_short_name(self):        return self.email    def get_full_name(self):        return self.email    def __unicode__(self):        return self.email</pre><p>Обязательно ознакомьтесь с <span>документацией</span> Django, если вы не знакомы с тем, как работают пользовательские модели.</p><p>Теперь нам нужно указать Django, использовать эту модель пользователя вместо стандартной. Добавьте эту строку в файл <code>quick_publisher/settings.py</code>:</p><pre class="noskimlinks noskimwords"><code>AUTH_USER_MODEL = "main.User"</code></pre><p>Нам также необходимо добавить <code>main</code> приложение в список <code>INSTALLED_APPS</code> в файле <code>quick_publisher/settings.py</code>. Теперь мы можем создавать миграции, применять их и создавать суперпользователя, чтобы иметь возможность входа в панель администратора Django:</p><pre class="brush: bash noskimlinks noskimwords">$ ./manage.py makemigrations main $ ./manage.py migrate $ ./manage.py createsuperuser</pre><p>Давайте теперь создадим отдельное Django приложение, которое отвечает за посты:</p><pre class="brush: bash noskimlinks noskimwords">$ ./manage.py startapp publish</pre><p>Давайте определим простую модель Post в <code>publisher/models.py</code>:</p><pre class="brush: python noskimlinks noskimwords">from django.db import modelsfrom django.utils import timezonefrom django.contrib.auth import get_user_modelclass Post(models.Model):    author = models.ForeignKey(get_user_model())    created = models.DateTimeField("Created Date", default=timezone.now)    title = models.CharField("Title", max_length=200)    content = models.TextField("Content")    slug = models.SlugField("Slug")    def __str__(self):        return ""%s" by %s" % (self.title, self.author)</pre><p>Привязка модели <code>Post</code> с  администратором Django выполняется в файле <code>publisher/admin.py</code> следующим образом:</p><pre class="brush: python noskimlinks noskimwords">from django.contrib import adminfrom .models import Post@admin.register(Post)class PostAdmin(admin.ModelAdmin):    pass</pre><p>Наконец, давайте подключим приложение <code>publisher</code> к нашему проекту, добавив его в список <code>INSTALLED_APPS</code>.</p><p>Теперь мы можем запустить сервер и перейти к <code>http:// localhost:8000/admin/</code> и создать наши первые посты, чтобы у нас было то, с чем можно взаимодействовать:</p><pre class="brush: bash noskimlinks noskimwords">$ ./manage.py runserver</pre><p>Надеюсь, что Вы сделали задание и создали посты. </p><p>Давайте двигаться дальше. Следующий очевидный шаг - создать способ просмотра опубликованных постов. </p><pre class="brush: python noskimlinks noskimwords"># publisher/views.pyfrom django.http import Http404from django.shortcuts import renderfrom .models import Postdef view_post(request, slug):    try:        post = Post.objects.get(slug=slug)    except Post.DoesNotExist:        raise Http404("Poll does not exist")    return render(request, "post.html", context={"post": post})</pre><p>Давайте свяжем наше новое представление с URL-адресом в: <code>quick_publisher/urls.py</code></p><pre class="brush: python noskimlinks noskimwords"># quick_publisher/urls.pyfrom django.conf.urls import urlfrom django.contrib import adminfrom publisher.views import view_posturlpatterns = [    url(r"^admin/", admin.site.urls),    url(r"^(?P&lt;slug&gt;[a-zA-Z0-9\-]+)", view_post, name="view_post")]</pre><p>Наконец, давайте создадим шаблон, который отображает пост: <code>publisher/templates/post.html</code></p><pre class="brush: html noskimlinks noskimwords">&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head lang="en"&gt;    &lt;meta charset="UTF-8"&gt;    &lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;    &lt;h1&gt;{{ post.title }}&lt;/h1&gt;    &lt;p&gt;{{ post.content }}&lt;/p&gt;    &lt;p&gt;Published by {{ post.author.full_name }} on {{ post.created }}&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</pre><p>Теперь мы можем перейти к <span>http://localhost:8000/the-slug-of-the-post-you-created/</span> в браузере. Это не совсем чудо веб-дизайна, но создание красивых страниц постов выходит за рамки этого урока.</p><h2>Отправка писем с подтверждением<span></span> </h2><p>Вот классический сценарий:</p><ul><li>Вы создаете учетную запись.</li> <li>Вы указываете адрес электронной почты, который будет идентифицирован, как уникальный на платформе.</li> <li>Платформа проверяет, что вы действительно являетесь владельцем адреса электронной почты, отправив электронное письмо с ссылкой на подтверждение.</li> <li>Пока Вы не выполните проверку, вы не сможете (полностью) использовать платформу.</li> </ul><p>Давайте добавим флаг <code>is_verified</code> и <code>verify_uid</code> в модель <code>User</code>:</p><pre class="brush: python noskimlinks noskimwords"># main/models.pyimport uuidclass User(AbstractBaseUser, PermissionsMixin):    REQUIRED_FIELDS = []    USERNAME_FIELD = "email"    objects = UserAccountManager()    email = models.EmailField("email", unique=True, blank=False, null=False)    full_name = models.CharField("full name", blank=True, null=True, max_length=400)    is_staff = models.BooleanField("staff status", default=False)    is_active = models.BooleanField("active", default=True)    is_verified = models.BooleanField("verified", default=False) # Add the `is_verified` flag    verification_uuid = models.UUIDField("Unique Verification UUID", default=uuid.uuid4)    def get_short_name(self):        return self.email    def get_full_name(self):        return self.email    def __unicode__(self):        return self.email</pre><p>Давайте воспользуемся этим случаем, чтобы добавить возможность администрирования модели User:</p><pre class="brush: python noskimlinks noskimwords">from django.contrib import adminfrom .models import User@admin.register(User)class UserAdmin(admin.ModelAdmin):    pass</pre><p>Давайте сделаем изменения в базе данных:</p><pre class="brush: bash noskimlinks noskimwords">$ ./manage.py makemigrations $ ./manage.py migrate</pre><p>Теперь нам нужно написать код, который отправляет электронное письмо при создании пользователя. В таких случаях используются сигналы Django, и это хороший момент, чтобы коснуться этой темы. </p><p>Сигналы срабатывают до/после определенных событий в приложении. Мы можем определить коллбеки, которые вызываются автоматически при срабатывании сигналов. Чтобы сделать триггер для коллбека, мы должны сначала подключить его к сигналу.</p><p>Мы собираемся создать коллбек, который будет вызван после создания пользователя. Мы добавим этот код после определения модели <code>User</code> в: <code>main/models.py</code></p><pre class="brush: python noskimlinks noskimwords">from django.db.models import signalsfrom django.core.mail import send_maildef user_post_save(sender, instance, signal, *args, **kwargs):    if not instance.is_verified:        # Send verification email        send_mail(            "Verify your QuickPublisher account",            "Follow this link to verify your account: "                "http://localhost:8000%s" % reverse("verify", kwargs={"uuid": str(instance.verification_uuid)}),            "from@quickpublisher.dev",            [instance.email],            fail_silently=False,        )signals.post_save.connect(user_post_save, sender=User)</pre><p>Здесь мы определили функцию <code class="inline">user_post_save</code> и связали ее с сигналом <code class="inline">post_save</code> (который запускается после сохранения модели), отправленным моделью <code class="inline">User</code>.</p><p>Django не просто отправляет электронные письма самостоятельно; Его необходимо связать с почтовой службой. Для простоты вы можете добавить свои учетные данные Gmail в <code>quick_publisher/settings.py</code> или добавить своего любимого поставщика электронной почты. </p><p>Вот как выглядит конфигурация Gmail:</p><pre class="brush: python noskimlinks noskimwords">EMAIL_USE_TLS = TrueEMAIL_HOST = "smtp.gmail.com"EMAIL_HOST_USER = "&lt;YOUR_GMAIL_USERNAME&gt;@gmail.com"EMAIL_HOST_PASSWORD = "&lt;YOUR_GMAIL_PASSWORD&gt;"EMAIL_PORT = 587</pre><p>Чтобы проверить все, зайдите в панель администратора и создайте нового пользователя с действительным адресом электронной почты, который вы можете быстро проверить. Если все пойдет хорошо, вы получите электронное письмо со ссылкой для подтверждения. Процедура проверки еще не готова. </p><p>Вот как выполнить проверку учетной записи:</p><pre class="brush: python noskimlinks noskimwords"># main/views.pyfrom django.http import Http404from django.shortcuts import render, redirectfrom .models import Userdef home(request):    return render(request, "home.html")def verify(request, uuid):    try:        user = User.objects.get(verification_uuid=uuid, is_verified=False)    except User.DoesNotExist:        raise Http404("User does not exist or is already verified")    user.is_verified = True    user.save()    return redirect("home")</pre><p>Привязка представления в: <code>quick_publisher/urls.py</code></p><pre class="brush: python noskimlinks noskimwords"># quick_publisher/urls.pyfrom django.conf.urls import urlfrom django.contrib import adminfrom publisher.views import view_postfrom main.views import home, verifyurlpatterns = [    url(r"^$", home, name="home"),    url(r"^admin/", admin.site.urls),    url(r"^verify/(?P&lt;uuid&gt;[a-z0-9\-]+)/", verify, name="verify"),    url(r"^(?P&lt;slug&gt;[a-zA-Z0-9\-]+)", view_post, name="view_post")]</pre><p>Кроме того, не забудьте создать файл <code>home.html</code> в каталоге <code>main/templates/home.html</code>. Это будет рендерится c представлением <code>home</code>.</p><p>Попробуйте запустить весь сценарий снова. Если все будет хорошо, вы получите электронное письмо с действительным URL-адресом подтверждения. Если пройдёте по URL-адресу, а затем проверите раздел администратора, Вы увидите, как была проверена учетная запись.</p><h2>Асинхронная отправка писем<span></span> </h2><p>У нас есть проблема в текущей реализации. Возможно, вы заметили, что создание пользователя немного медленное. Это происходит потому, что Django отправляет письмо с проверкой во время запроса. </p><p>Вот как это работает: мы отправляем пользовательские данные в приложение Django. Приложение создает модель <code>User</code>, а затем создает соединение с Gmail (или другим выбранным вами сервисом). Django ждет ответа, и только после этого он возвращает ответ на наш браузер. </p><p>Вот где проявляется необходимость в Celery. Во первых, убедитесь, что он установлен:</p><pre class="brush: bash noskimlinks noskimwords">$ pip install Celery</pre><p>Теперь нам нужно создать Celery приложение  в нашем Django приложении:</p><pre class="brush: python noskimlinks noskimwords"># quick_publisher/celery.pyimport osfrom celery import Celeryos.environ.setdefault("DJANGO_SETTINGS_MODULE", "quick_publisher.settings")app = Celery("quick_publisher")app.config_from_object("django.conf:settings")# Load task modules from all registered Django app configs.app.autodiscover_tasks()</pre><p>Celery - это очередь задач. Он получает задания из нашего приложения Django и запускает их в фоновом режиме. Celery должен быть сопряжен с другими сервисами, которые действуют в качестве брокеров. </p><p>Брокеры промежуточно отправляют сообщения между веб-приложением и Celery. В этом уроке мы будем использовать Redis. Redis прост в установке, и мы можем легко начать с него без особых проблем.</p><p>Вы можете установить Redis, следуя инструкциям на странице Redis Quick Start. Вам нужно будет установить библиотеку Redis Python, выполнив <code>pip install redis</code> и комплект, необходимый для использования Redis и Celery: <code>pip install celery [redis]</code>.</p><p>Запустите Redis сервер в отдельной консоли следующим образом: <code>$ redis-server</code></p><p>Давайте добавим связанные с Celery/Redis конфиги в <code>quick_publisher/settings.py</code>:</p><pre class="brush: python noskimlinks noskimwords"># REDIS related settings REDIS_HOST = "localhost" REDIS_PORT = "6379" BROKER_URL = "redis://" + REDIS_HOST + ":" + REDIS_PORT + "/0" BROKER_TRANSPORT_OPTIONS = {"visibility_timeout": 3600} CELERY_RESULT_BACKEND = "redis://" + REDIS_HOST + ":" + REDIS_PORT + "/0"</pre><p>Прежде чем что-либо может быть запущено в Celery, оно должно быть декларировано как задача. </p><p>Вот как это сделать:</p><pre class="brush: python noskimlinks noskimwords"># main/tasks.pyimport loggingfrom django.urls import reversefrom django.core.mail import send_mailfrom django.contrib.auth import get_user_modelfrom quick_publisher.celery import app@app.taskdef send_verification_email(user_id):    UserModel = get_user_model()    try:        user = UserModel.objects.get(pk=user_id)        send_mail(            "Verify your QuickPublisher account",            "Follow this link to verify your account: "                "http://localhost:8000%s" % reverse("verify", kwargs={"uuid": str(user.verification_uuid)}),            "from@quickpublisher.dev",            [user.email],            fail_silently=False,        )    except UserModel.DoesNotExist:        logging.warning("Tried to send verification email to non-existing user "%s"" % user_id)</pre><p>Мы здесь сделали следующее: мы переместили функцию отправки по почты в другой файл под названием <code>tasks.py</code>. </p><p>Несколько примечаний:</p><ul><li>Имя файла имеет значение. Celery проходит через все приложения в <code>INSTALLED_APPS</code> и регистрирует задачи в файлах <code>tasks.py</code>.</li> <li>Обратите внимание, как мы украсили декорировали <code>send_verification_email</code> с помощью <code>@app.task</code>. Это указывает Celery, что это задача, которая будет выполняться в очереди задач.</li> <li>Обратите внимание, что мы ожидаем аргумент <code>user_id</code>, а не объект <code>User</code>. Это связано с тем, что при отправке задач на Celery может возникнуть проблема с сериализацией сложных объектов. Лучше использовать примитивные типы.</li> </ul><p>Возвращаясь к <code>main/models.py</code>, код сигнала преобразуется в:</p><pre class="brush: python noskimlinks noskimwords">from django.db.models import signalsfrom main.tasks import send_verification_emaildef user_post_save(sender, instance, signal, *args, **kwargs):    if not instance.is_verified:        # Send verification email        send_verification_email.delay(instance.pk)signals.post_save.connect(user_post_save, sender=User)</pre><p>Обратите внимание, как мы вызываем метод <code>.delay</code> объекта задачи. Это означает, что мы отправляем задание на Celery, и мы не ожидаем результата. Если бы мы использовали <code>send_verification_email (instance.pk)</code>, мы все равно отправили бы его в Celery и ждали завершения задачи, чего мы не хотим.</p><p>Прежде чем Вы начнете создавать нового пользователя, есть есть загвоздка. Celery - это сервис, и нам нужно его запустить. Откройте новую консоль, убедитесь, что вы активируете соответствующий virtualenv, и перейдите в каталог проекта.</p><pre class="brush: bash noskimlinks noskimwords">$ celery worker -A quick_publisher --loglevel=debug --concurrency=4</pre><p>Эта команда запустит четыре процесса воркеров Celery. Да, теперь Вы можете, наконец, пойти и создать другого пользователя. Обратите внимание на то, что нет задержки, следите за логами в консоли Celery и посмотрите, правильно ли выполняются задачи. Это должно выглядеть примерно так:</p><pre class="brush: bash noskimlinks noskimwords">[2017-04-28 15:00:09,190: DEBUG/MainProcess] Task accepted: main.tasks.send_verification_email[f1f41e1f-ca39-43d2-a37d-9de085dc99de] pid:62065[2017-04-28 15:00:11,740: INFO/PoolWorker-2] Task main.tasks.send_verification_email[f1f41e1f-ca39-43d2-a37d-9de085dc99de] succeeded in 2.5500912349671125s: None</pre><h2>Периодические задачи с Celery<span></span> </h2><p>Вот еще один общий сценарий. Большинство зрелых веб-приложений отправляют своим пользователям электронные письма c периодичностью. Некоторые распространенные примеры электронных писем с периодической отправкой:</p><ul><li>Ежемесячные отчеты</li> <li>Уведомления о деятельности (лайки, запросы в друзья и т. д.)</li> <li>Напоминания для выполнения определенных действий («Не забудьте активировать свою учетную запись»)</li> </ul><p>Вот что мы будем делать в нашем приложении. Мы посчитаем, сколько раз просматривался каждый пост и будем отправлять ежедневный отчет автору. Каждый день мы собираемся пройтись через всех пользователей, загружать их посты и отправлять электронное письмо с таблицей, содержащей посты и количество просмотров.</p><p>Давайте изменим модель <code>Post</code>, чтобы мы могли выполнять подсчет просмотров.</p><pre class="brush: python noskimlinks noskimwords">class Post(models.Model):    author = models.ForeignKey(User)    created = models.DateTimeField("Created Date", default=timezone.now)    title = models.CharField("Title", max_length=200)    content = models.TextField("Content")    slug = models.SlugField("Slug")    view_count = models.IntegerField("View Count", default=0)    def __str__(self):        return ""%s" by %s" % (self.title, self.author)</pre><p>Как всегда, когда мы меняем модель, нам нужно выполнить миграцию базы данных:</p><pre class="brush: bash noskimlinks noskimwords">$ ./manage.py makemigrations $ ./manage.py migrate</pre><p>Давайте также изменим Django представление <code>view_post</code>  для подсчета просмотров:</p><pre class="brush: python noskimlinks noskimwords">def view_post(request, slug):    try:        post = Post.objects.get(slug=slug)    except Post.DoesNotExist:        raise Http404("Poll does not exist")        post.view_count += 1    post.save()    return render(request, "post.html", context={"post": post})</pre><p>Было бы полезно отобразить <code>view_count</code> в шаблоне. Добавьте <code>&lt;p&gt;Viewed {{ post.view_count }} times&lt;/p&gt;</code> где-нибудь в файле <code>publisher/templates/post.html</code>. Сделайте несколько просмотров поста и посмотрите, как увеличивается счетчик.</p><p>Давайте создадим задачу Celery. Поскольку речь идет о постах, я собираюсь разместить её в <code>publisher/​​tasks.py</code>:</p><pre class="brush: python noskimlinks noskimwords">from django.template import Template, Contextfrom django.core.mail import send_mailfrom django.contrib.auth import get_user_modelfrom quick_publisher.celery import appfrom publisher.models import PostREPORT_TEMPLATE = """Here"s how you did till now:{% for post in posts %}        "{{ post.title }}": viewed {{ post.view_count }} times |{% endfor %}"""@app.taskdef send_view_count_report():    for user in get_user_model().objects.all():        posts = Post.objects.filter(author=user)        if not posts:            continue        template = Template(REPORT_TEMPLATE)        send_mail(            "Your QuickPublisher Activity",            template.render(context=Context({"posts": posts})),            "from@quickpublisher.dev",            [user.email],            fail_silently=False,        )</pre><p>Каждый раз, когда Вы вносите изменения в задачи Celery, не забудьте перезапустить процесс Celery. Celery должен обнаружить и перезагрузить задачи. Перед созданием задачи выполняющейся периодический мы должны проверить это в Django shell, чтобы убедиться, что все работает как ожидается:</p><pre class="brush: python noskimlinks noskimwords">$ ./manage.py shell In [1]: from publisher.tasks import send_view_count_report In [2]: send_view_count_report.delay()</pre><p>Надеюсь, что Вы получили правильный отчёт в своем письме. </p><p>Давайте теперь создадим периодическую задачу. Откройте <code>quick_publisher/celery.py</code> и зарегистрируйте задания:</p><pre class="brush: python noskimlinks noskimwords"># quick_publisher/celery.pyimport osfrom celery import Celeryfrom celery.schedules import crontabos.environ.setdefault("DJANGO_SETTINGS_MODULE", "quick_publisher.settings")app = Celery("quick_publisher")app.config_from_object("django.conf:settings")# Load task modules from all registered Django app configs.app.autodiscover_tasks()app.conf.beat_schedule = {    "send-report-every-single-minute": {        "task": "publisher.tasks.send_view_count_report",        "schedule": crontab(),  # change to `crontab(minute=0, hour=0)` if you want it to run daily at midnight    },}</pre><p>До сих пор мы создавали расписание, которое запускало задачу <code class="inline">publisher.tasks.send_view_count_report</code> каждую минуту, как показано в нотации <code class="inline">crontab()</code>. Вы также можете указать различные <span>расписания Celery Crontab</span>. </p><p>Откройте другую консоль, активируйте соответствующее окружение и запустите службу Celery Beat. </p><pre class="brush: bash noskimlinks noskimwords">$ celery -A quick_publisher beat</pre><p>Работа службы Beat заключается в том, чтобы задавать задачи в Celery в соответствии с расписанием. Учтите, что расписание выполняет задачу <code>send_view_count_report</code> каждую минуту в соответствии с настройкой. Это удобно для тестирования, но не рекомендуется для реального веб-приложения.<br></p><h2>Сделать задачи более надежными<span></span> </h2><p>Задачи часто используются для выполнения ненадежных операций, операций, зависящих от внешних ресурсов, или задачи, которые могут легко падать по различным причинам. Вот инструкция, чтобы сделать их более надежными:</p><ul><li>Сделать задачи идемпотентными. Идемпотентная задача - это задача, которая, не изменяет состояние системы, если она остановлена ​​на полпути. Задача либо полностью вносит изменения в систему, либо нет.</li> <li>Повторение задачи. Если задача падает, рекомендуется попробовать выполнять ее снова и снова, пока она не будет выполнена успешно. Вы можете сделать это c помощью <span>Celery Retry</span>. Еще одна интересная вещь, на которую стоит обратить внимание, - это алгоритм экспоненциального отказа. Это может пригодиться, когда вы думаете об уменьшении ненужной нагрузки на сервер, возникающей из за повторных задач.</li> </ul><h2>Заключение<span></span> </h2><p>Надеюсь, что это была интересная статья для вас и хорошее введение в использование Celery с Django. <br></p><p>Вот несколько выводов, которые мы можем сделать:</p><ul><li>Хорошей практикой является сохранение ненадежных и трудоемких задач за пределами запроса.</li> <li>Задачи, которые долго выполняются, должны выполняться в фоновом режиме воркерами (или другими способами).</li> <li>Фоновые задачи могут использоваться для различных задач, которые не критичны для базового функционирования приложения.</li> <li>Celery также может выполнять периодические задания с использованием службы <code>celery beat</code>.</li> <li>Задачи могут быть более надежными, если они сделаны идемпотентными и повторены (возможно, с использованием алгоритма экспоненциального отказа).</li> </ul>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Django" href="https://norma-studio.github.io/article/220824955-ispolzovanie-celery-s-django-dlya-obrabotki-fonovyh-zadach" class="tm-article-body__tags-item-link">Django</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
38790</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
460</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
