
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По п...">
<meta property="og:description" content="NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По п...">
<meta name="twitter:description" content="NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По п...">
<meta property="aiturec:description" content="NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По п...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html">
<link rel="canonical" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html">
<meta property="og:url" content="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html" title="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io" title="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/64535356345.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html" class="tm-user-info__username" title="
В. Чендылов" aria-label="
В. Чендылов">
В. Чендылов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Пишем приложения реального времени на NativeScript: Push-уведомления
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="NativeScript" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya" class="tm-article-snippet__hubs-item-link"><span>NativeScript</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png">
    <meta itemprop="headline name" content="Пишем приложения реального времени на NativeScript: Push-уведомления
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По п...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По п...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>NativeScript является основой для создания кросс-платформенных нативных мобильных приложений с использованием XML, CSS и JavaScript. В этой серии мы изучаем некоторые интересные вещи, которые вы можете сделать с помощью приложения NativeScript: геолокация и интеграция с Google Maps, база данных SQLite, интеграция с Firebase и push-уведомления. По пути мы создаем фитнес-приложение с возможностями реального времени, которые будут использовать каждую из этих функций.</p><p>В этом уроке вы узнаете, как легко добавлять push-уведомления к вашему NativeScript-приложению с помощью Firebase Cloud Messaging Service</p><h2>Что вы будете создавать<br></h2><p>Исходя из предыдущего учебника, вы будете добавлять push-уведомления в приложение. Уведомление будет инициировано, когда пользователь побьет свою текущую запись или когда один из его друзей заберет у него первое место.</p><h2>Настройка проекта</h2><p>Если вы следовали предыдущему руководству по Firebase, вы можете просто использовать тот же проект. В противном случае вы можете создать новый проект и скопировать файлы в папку приложения вашего проекта.</p><pre class="brush: bash noskimlinks noskimwords">tns create fitApp --appid "com.yourname.fitApp"</pre><p>После этого вам также необходимо установить плагины геолокации, Google Maps, SQLite и Firebase:</p><pre class="brush: bash noskimlinks noskimwords">tns plugin add nativescript-geolocationtns plugin add nativescript-google-maps-sdktns plugin add nativescript-sqlitetns plugin add nativescript-plugin-firebase</pre><p>После установки вам необходимо настроить плагин Google Maps. Вы можете найти полные инструкции о том, как это сделать, прочитав раздел «<strong>Установка плагина Google Maps</strong>» в <span>предыдущем учебнике</span>.</p><p>Затем установите библиотеку fecha для форматирования дат:</p><pre class="brush: bash noskimlinks noskimwords">npm install --save fecha</pre><p>После этого вам также необходимо настроить плагин Firebase. Обязательно прочтите следующие разделы в <span>предыдущем учебнике</span>, чтобы вы могли запустить приложение:</p><ul><li>Запуск проекта</li> <li>Настройка приложения Firebase</li> <li>Настройка приложения Facebook</li> <li>Установка плагина Firebase</li> <li>Настройка интеграции с Facebook</li> </ul><p>Поскольку мы уже создали плагин Firebase в предыдущем учебнике, для настройки push-уведомлений нужно выполнить лишь небольшую работу.</p><p>Во-первых, вы должны перенастроить плагин, перейдя в каталог <strong>node_modules/nativescript-plugin-firebase</strong> и запустив <code class="inline">npm run config</code>. На этот раз выберите аутентификацию Facebook и Messaging.</p><p>Как только это будет сделано, откройте файл <strong>firebase.nativescript.json</strong> в корневой директории вашего проекта и убедитесь, что для <code class="inline">messaging</code> установлено значение <code class="inline">true</code>:</p><pre class="brush: javascript noskimlinks noskimwords">{    "using_ios": false,    "using_android": true,    "remote_config": false,    "messaging": true,    "crash_reporting": false,    "storage": false,    "facebook_auth": true,    "google_auth": false,    "admob": false,    "invites": false}</pre><p>Затем откройте <strong>app/App_Resources/Android/AndroidManifest.xml</strong> и добавьте следующие службы внутри <code class="inline">&lt;application&gt;</code>. Это включает службу сообщений Firebase для приложения:</p><pre class="brush: xml noskimlinks noskimwords">&lt;application ...&gt;&lt;service android:name="org.nativescript.plugins.firebase.MyFirebaseInstanceIDService"&gt;    &lt;intent-filter&gt;        &lt;action android:name="com.google.firebase.INSTANCE_ID_EVENT"/&gt;    &lt;/intent-filter&gt;&lt;/service&gt;&lt;service android:name="org.nativescript.plugins.firebase.MyFirebaseMessagingService"&gt;    &lt;intent-filter&gt;        &lt;action android:name="com.google.firebase.MESSAGING_EVENT"/&gt;    &lt;/intent-filter&gt;&lt;/service&gt;&lt;/application&gt;</pre><h2>Запуск проекта</h2><p>Вы можете запустить проект, выполнив команду <code class="inline">tns run android</code>. Но поскольку это приложение будет основываться на функциональности геолокации, я рекомендую вам использовать эмулятор GPS для быстрой настройки и изменения вашего местоположения. Вы можете прочитать о том, как это сделать в разделе «<strong>Запуск приложения</strong>» в <span>предыдущем учебнике</span>.</p><p>Если вы получаете какие-либо ошибки сборки, вы можете удалить платформу и повторно запустить приложение:</p><pre class="brush: bash noskimlinks noskimwords">tns platform remove androidtns run android</pre><h2>Настройка Firebase Cloud Functions</h2><p>Вы будете использовать<span> Firebase Cloud Functions</span> для создания сервера, который будет отправлять push-уведомления. Эта функция Firebase используется для запуска внутреннего кода всякий раз, когда определенное событие происходит в функциях Firebase, которые вы используете, например, если в базе данных реального времени есть новые данные или когда появляется новый пользователь через службу аутентификации Firebase. Для этого приложения вы будете использовать <span>HTTP-триггеры</span> для отправки push-уведомлений, когда мобильное приложение делает запрос к определенной точке входа.</p><p>Чтобы использовать Firebase Cloud Functions, сначала необходимо глобально установить пакет <code class="inline">firebase-tools</code>:</p><pre class="brush: bash noskimlinks noskimwords">npm install -g firebase-tools</pre><p>Затем создайте новую папку, в которой будет размещен код сервера. Это должно быть вне папки вашего приложения. Внутри этой папки установите пакет <code class="inline">firebase-functions</code>:</p><pre class="brush: bash noskimlinks noskimwords">npm install firebase-functions@latest --save</pre><p>Как только он будет установлен, войдите в Firebase, выполнив команду <code class="inline">firebase login</code>. Откроется новая вкладка браузера, в которой вы сможете войти в свою учетную запись Google. Пройдите весь процесс и согласитесь со всеми запрошенными разрешениями.</p><p>После входа в систему вы можете теперь инициализировать функции Firebase для конкретного проекта Firebase:</p><pre class="brush: bash noskimlinks noskimwords">firebase init functions</pre><p>Он спросит вас, хотите ли вы настроить проект по умолчанию или нет. Выберите проект Firebase, который вы создали в предыдущем учебнике:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/setup-firebase-functions.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"></figure><p>Затем вас спросят, хотите ли вы установить зависимости. Скажи да.</p><p>После установки всех зависимостей вы должны увидеть файл <strong>firebase.json</strong> и папку с <strong>functions</strong> внутри каталога. Файл, над которым вы будете работать, - это файл <strong>functions/index.js</strong>. Откройте этот файл, и вы увидите следующее:</p><pre class="brush: javascript noskimlinks noskimwords">const functions = require("firebase-functions");// // Create and Deploy Your First Cloud Functions// // https://firebase.google.com/docs/functions/write-firebase-functions//// exports.helloWorld = functions.https.onRequest((request, response) =&gt; {//  response.send("Hello from Firebase!");// });</pre><p>Раскомментируйте функцию <code class="inline">helloWorld</code>, и вы увидите триггеры HTTP в действии.</p><pre class="brush: javascript noskimlinks noskimwords">exports.helloWorld = functions.https.onRequest((request, response) =&gt; {    response.send("Hello from Firebase!");});</pre><p>Для развертывания функции в облаке выполните следующее:</p><pre class="brush: bash noskimlinks noskimwords">firebase deploy --only functions</pre><p>По завершении развертывания он должен показать URL-адрес, где была развернута функция:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/deploy-firebase-functions.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"></figure><p>Получите доступ к этому URL из своего браузера, чтобы увидеть результат «Привет от Firebase!».</p><h2>Добавление кода сервера</h2><p>Теперь вы готовы добавить код для внедрения push-уведомлений. Во-первых, вы добавите код для серверного компонента, а затем код для приложения.</p><p>Откройте файл <strong>functions/index.js</strong> и очистите его содержимое. </p><h3>Создание функции Firebase</h3><p>Импортируйте пакеты Firebase, которые вам понадобятся:</p><pre class="brush: javascript noskimlinks noskimwords">const functions = require("firebase-functions"); // for listening to http triggersconst admin = require("firebase-admin"); // for accessing the realtime databaseadmin.initializeApp(functions.config().firebase); // initialize the Firebase Admin SDK</pre><p>Создайте функцию <code class="inline">init_push</code>. Обратите внимание, что триггер HTTP вызывается для любого метода запроса, поэтому вам нужно отфильтровать метода запроса, который вы хотите обработать. В этом случае мы хотим только обрабатывать запросы <code class="inline">POST</code>. Мы ожидаем, что приложение отдаст <code class="inline">id</code>, <code class="inline">steps</code> и <code class="inline">friend_ids</code> в качестве данных запроса. </p><pre class="brush: javascript noskimlinks noskimwords">exports.init_push = functions.https.onRequest((request, response) =&gt; {        if(request.method == "POST"){        var id = request.body.id; // ID of the user who made the request (Firebase Auth ID)        var steps = parseInt(request.body.steps); // latest steps, not recorded yet        var friend_ids = request.body.friend_ids.split(",");         friend_ids.push(id); // also include the ID of the current user        // next: add code for getting the user and friends data    }});</pre><h3>Получение данных пользователя и друзей</h3><p>Затем запросите базу данных Firebase, чтобы проверить, существует ли идентификатор пользователя. Это служит средством для защиты ендпоинта, поэтому не каждый может инициировать push-уведомления. (Разумеется, реальное приложение должно обладать гораздо более надежной защитой, чтобы пользователи не могли подделывать свои собственные данные или данные кого-либо еще.) </p><p>Если пользователь существует, запросите базу данных еще раз, чтобы она вернула всех пользователей. Обратите внимание, что Firebase в настоящее время не предоставляет способ возврата записей на основе массива идентификаторов, поэтому нам придется сами фильтровать соответствующие данные:</p><pre class="brush: javascript noskimlinks noskimwords">admin.database().ref("/users")    .orderByChild("id")    .limitToFirst(1)    .equalTo(id)    .once("value").then(snapshot =&gt; {        var user_data = snapshot.val();    if(user_data){        // get all users from the database        admin.database().ref("/users")            .once("value").then(snapshot =&gt; {            // next: add code for getting the current user"s data and their friends data        });    }});</pre><p>Затем перебираем результаты, возвращаемые из Firebase, и создаем новый массив, в котором размещаются данные <code class="inline">friends_data</code>. Как только это будет сделано, отсортируйте массив в соответствии с количеством шагов каждого пользователя. Первый с самым высоким числом шагов имеет первый индекс.</p><pre class="brush: javascript noskimlinks noskimwords">var friends_data = [];var current_user_data = null;var notification_data = {};var has_notification = false;var users = snapshot.val();for(var key in users){    var user_id = users[key].id;        if(friend_ids.indexOf(user_id) != -1 &amp;&amp; id != user_id){ // the current user"s friends        friends_data.push(users[key]);    }else if(id == user_id){ // the current user        current_user_data = users[key];    }}// sort in descending order by the number of stepsvar sorted_friends_data = friends_data.sort(function(a, b) {    return b.steps - a.steps;}); // next: add code for constructing the notification payload</pre><h3>Создаем пейлоад нотификации</h3><p>Теперь мы готовы определить, кто получит уведомление и сконструируем пейлоад для уведомлений. Кто на первом месте? Это текущий пользователь или один из друзей пользователя? Поскольку текущий пользователь также может побить свой собственный рекорд, то нам просто нужно проверить, была ли эта запись побита.</p><pre class="brush: javascript noskimlinks noskimwords">if(steps &gt; sorted_friends_data[0].steps){    // notify friend who was overtaken    var diff_steps = steps - sorted_friends_data[0].steps;    notification_data = {        payload: {            title: "One of your friends beat your record",            body: "Too bad, your friend " + current_user_data.user_name + " just overtook you by " + diff_steps + " steps"        },        device_token: sorted_friends_data[0].device_token    };    has_notification = true;    }else if(steps &gt; current_user_data.steps){    // notify current user    var diff_steps = steps - current_user_data.steps;    notification_data = {        payload: {            title: "You beat your record!",            body: "Congrats! You beat your current record by " + diff_steps + " steps!"         },        device_token: current_user_data.device_token    };    has_notification = true;}// next: add code for sending push notification</pre><h3>Отправка уведомления</h3><p>Наконец, отправьте уведомление:</p><pre class="brush: javascript noskimlinks noskimwords">if(has_notification){        var payload = {      notification: notification_data.payload    };        // send push notification    admin.messaging().sendToDevice(notification_data.device_token, payload).then(function(res) {                response.send(JSON.stringify({"has_notification": true})); // inform the app that a notification was sent    })    .catch(function(error) {        response.send(JSON.stringify(error)); // send the push notification error to the app    });}else{    response.send(JSON.stringify({"has_notification": false})); // inform the app that a notification was not sent}</pre><h2>Обновление кода приложения</h2><p>Раньше вы настраивали приложение, чтобы оно могло получать push-уведомления. На этот раз вы добавите код, чтобы ваше приложение могло обрабатывать эти push-уведомления и отображать их пользователю. </p><h3>Получение Push-уведомлений</h3><p>Первое, что вам нужно сделать для получения push-уведомлений, - это обновить функцию <code class="inline">firebase.init()</code>, чтобы включить прослушиватель для приема токена устройства:</p><pre class="brush: javascript noskimlinks noskimwords">onPushTokenReceivedCallback: function(token) {    // temporarily save it to application settings until such time that     // the user logs in for the first time    applicationSettings.setString("device_token", token);},</pre><p>Эта функция выполняется только один раз, поэтому вам необходимо локально сохранить токен, используя настройки приложения. Позже это позволит нам получить токен устройства, когда пользователь входит в систему в первый раз. Если вы все еще помните из предыдущего урока, мы сохраняем данные пользователя в Firebase при первом входе в систему.</p><p>Затем вы можете добавить слушателя для получения уведомлений. Это отобразит окно предупреждения, в котором будет использоваться заголовок и тело сообщения:</p><pre class="brush: javascript noskimlinks noskimwords">onMessageReceivedCallback: function(message) {    dialogs.alert({        title: message.title,        message: message.body,        okButtonText: "ok"    });},</pre><h3>Сохранение токена устройства в Firebase</h3><p>FireBase Cloud Messaging требует токена устройства при отправке push-уведомления на конкретное устройство. Поскольку мы уже используем Firebase, мы просто сохраним токен устройства вместе с пользовательскими данными. Для этого вам нужно отредактировать код для сохранения данных пользователя, чтобы включить токен устройства, который мы получили раньше:</p><pre class="brush: javascript noskimlinks noskimwords">if(firebase_result.value == null){     var device_token = applicationSettings.getString("device_token");    var user_data = {        "uid": fb_result.uid,        "user_name": fb_result.name,        "profile_photo": fb_result.profileImageURL,        "device_token": device_token     };}</pre><h3>Тригерим пуш уведомления</h3><p>Пуш уведомление срабатывает, когда происходит одна из двух вещей:</p><ul><li>когда пользователь бьет свой собственный рекорд</li> <li>когда один из друзей пользователя бьет свой рекорд и выходит на первое место</li> </ul><p>Первое достаточно простое, поэтому нет необходимости в дополнительной настройке. Но для второго потребуется немного поработать. Во-первых, вы должны отредактировать код, когда изменяется состояние auth. Сразу после извлечения идентификаторов друзей из результата Facebook вам нужно сохранить идентификаторы друзей, используя настройки приложения.</p><pre class="brush: javascript noskimlinks noskimwords">// extracting the friend IDs from the Facebook resultvar friends_ids = r.data.map(function(obj){    return obj.id;});// save the friend IDsapplicationSettings.setString("friends_ids", JSON.stringify(friends_ids));friends_ids.push(user[user_key].id);</pre><p>Затем обновите код, когда пользователь перестает отслеживать свою прогулку. Сразу после кода для создания пользовательских данных для обновления пользователя, получите идентификаторы друзей из параметров приложения и включите их в объект, который содержит данные запроса для запуска push-уведомления.</p><pre class="brush: javascript noskimlinks noskimwords">// construct the user data for updating the user"s distance and stepsvar user_key = applicationSettings.getString("user_key");var user = applicationSettings.getString("user");var user_data = JSON.parse(user);user_data[user_key].distance = total_distance;user_data[user_key].steps = total_steps;// get friend IDsvar friends_ids = JSON.parse(applicationSettings.getString("friends_ids"));var request_data = {    "id": user_data[user_key].id,    "friend_ids": friends_ids.join(","),    "steps": total_steps};</pre><p>Сделайте запрос к ендпоинту облачных функций Firebase, которую вы создали ранее. После того как будет получен ответ об успешном завершении, только тогда данные пользователя будут обновлены в базе данных Firebase. </p><pre class="brush: javascript noskimlinks noskimwords">http.request({     url: "https://us-central1-pushapp-ab621.cloudfunctions.net/init_push",     method: "POST",    headers: { "Content-Type": "application/json" },    content: JSON.stringify(request_data) }).then(function (response) {       var statusCode = response.statusCode;    if(statusCode == 200){        // update the user"s data on Firebase        firebase.update(            "/users",            user_data        );     }}, function (e) {    console.log("Error occurred while initiating push: ", e);});</pre><h2>Тестирование Push-уведомлений</h2><p>Вы можете протестировать отправку push-уведомлений, сначала удалив приложение из эмулятора или устройства. Это позволяет нам правильно запускать функцию для получения токена устройства. Не забудьте добавить <code class="inline">console.log</code> для вывода токена устройства:</p><pre class="brush: javascript noskimlinks noskimwords">onPushTokenReceivedCallback: function(token) {    applicationSettings.setString("device_token", token);    console.log("device token: ", device_token); // &lt;-- add this}</pre><p>Когда токен устройства выводится в консоли NativeScript, скопируйте его, щелкните меню «<strong>База данных</strong>» на панели управления приложениями Firebase и добавьте его в качестве токена устройства всем пользователям приложения. Используйте <code class="inline">device_token</code> как имя свойства.</p><p>Чтобы вызвать push-уведомление, вы можете использовать <span>curl</span> для отправки запроса <code class="inline">POST</code> к функции Firebase:</p><pre class="brush: plain noskimlinks noskimwords">curl -X POST -H "Content-Type:application/json" YOUR_FIREBASE_FUNCTION_ENDPOINT -d "{"id":"ID OF A FIREBASE USER", "steps":NUMBER_OF_STEPS, "friend_ids":"COMMA,SEPARATED,FIREBASE,USER_IDs"}"</pre><p>Если curl у вас не установлен, вы можете использовать приложение <span>Postman</span> для отправки запросов. Используйте следующие настройки для запроса:</p><ul><li> <strong>Метод запроса</strong>: <code class="inline">POST</code> </li> <li> <strong>URL</strong>: ендпоинт вашей функции Firebase</li> <li> <strong>Ключ заголовка:</strong> <code class="inline">Content-type</code> </li> <li> <strong>Значение заголовка:</strong> <code class="inline">application/json</code> </li> <li> <strong>Тело:</strong> </li> </ul><pre class="brush: plain noskimlinks noskimwords">{"id":"ID OF A FIREBASE USER", "steps":NUMBER_OF_STEPS, "friend_ids":"COMMA,SEPARATED,FIREBASE,USER_IDs"}</pre><p>После запуска вы увидите вывод, похожий на следующий:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/app-final-output.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"></figure><p>Если приложение не открыто, вы увидите уведомление в области уведомлений:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1125/posts/29475/image/final-output-outside-app.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"></figure><h2>Заключение</h2><p>Поздравляю! Наконец, вы закончили фитнес-приложение. В течение четырех учебников вы создавали приложение NativeScript, в котором используются карты Google, база данных SQLite, Firebase Realtime и Firebase Cloud Messaging. Теперь у вас неплохая основа для создания приложений NativeScript, которые используют эти технологии.</p><p>Чтобы узнать больше о NativeScript или других кросс-платформенных мобильных технологиях, обязательно ознакомьтесь с некоторыми нашими другими курсами и учебниками здесь, на Envato Tuts +!</p><ul class="roundup-block__contents posts--half-width roundup-block--list"><li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/71/courses/1050/preview_image/ns-1.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"><div class="roundup-block__primary-category topic-code">NativeScript</div> <div class="roundup-block__content-title">Создаем мобильное приложение с NativeScript</div> <div class="roundup-block__author">Keyvan Kasaei</div></span></li> <li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/71/courses/987/preview_image/native-3.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"><div class="roundup-block__primary-category topic-code">NativeScript</div> <div class="roundup-block__content-title">Начинаем работу с NativeScript и Mobile Angular 2</div> <div class="roundup-block__author">Реджинальд Доусон</div></span></li> <li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/16/courses/708/preview_image/react-1.png" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"><div class="roundup-block__primary-category topic-code">React Native</div> <div class="roundup-block__content-title">Начинаем работать с React Native</div> <div class="roundup-block__author">Маркус Мюльбергер</div></span></li> <li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/16/courses/845/preview_image/reactnative-banner.jpg" alt="Пишем приложения реального времени на NativeScript: Push-уведомления..." title="Пишем приложения реального времени на NativeScript: Push-уведомления..." width="50" height="50"><div class="roundup-block__primary-category topic-code">React Native</div> <div class="roundup-block__content-title">Создайте социальное приложение с React Native</div> <div class="roundup-block__author">Маркус Мюльбергер</div></span></li> </ul><p></p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="NativeScript" href="https://norma-studio.github.io/article/220824897-pishem-prilozheniya-realnogo-vremeni-na-nativescript-push-uvedomleniya" class="tm-article-body__tags-item-link">NativeScript</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
43557</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
638</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
