
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации....">
<meta property="og:description" content="В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации....">
<meta name="twitter:description" content="В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации....">
<meta property="aiturec:description" content="В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html">
<link rel="canonical" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html">
<meta property="og:url" content="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html" title="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io" title="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/63456435436.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html" class="tm-user-info__username" title="
М. Старостенко" aria-label="
М. Старостенко">
М. Старостенко</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Как создать кастомную аутентификацию в Laravel
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="PHP" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel" class="tm-article-snippet__hubs-item-link"><span>PHP</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
    <meta itemprop="headline name" content="Как создать кастомную аутентификацию в Laravel
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>В этой статье мы рассмотрим систему аутентификации в рамках Laravel. Основная цель этой статьи - создать настраиваемый защитный механизм аутентификации путем расширения базовой системы аутентификации.</p><p>Laravel в своем ядре обеспечивает очень прочную систему аутентификации, что делает внедрение базовой аутентификации совсем простым. На самом деле вам просто нужно запустить пару artisan команд, чтобы настроить каркас системы аутентификации.</p><p>Более того, сама система разработана таким образом, что вы можете ее расширить и подключить к своим адаптерам аутентификации. Это то, что мы подробно обсудим в этой статье. Прежде чем мы перейдем к внедрению специального средства проверки подлинности, мы начнем с обсуждения основных элементов аутентификации и ее провайдеров в Laravel.</p><h2>Основные элементы: гуарды и провайдеры</h2><p>Система аутентификации Laravel состоит из двух элементов в своем ядре: гуарды и провайдеры.</p><h3>Гуарды</h3><p>Гуард можно рассматривать как способе подачи логики, которая используется для идентификации пользователей, прошедших проверку аутентификации. В основе Laravel предоставляет различные гуарды, такие как сессия и токен. Гуард сессии поддерживает состояние пользователя в каждом запросе с помощью файлов cookie, а с другой стороны гуард токена аутентифицирует пользователя, проверяя действительный токен в каждом запросе.</p><p>Итак, как вы можете видеть, гуард определяет логику аутентификации, и нет необходимости, чтобы он всегда справлялся с этим, выбирая действительные учетные данные из вашего бэкенда. Вы можете реализовать гуард, который просто проверяет наличие определенной вещи в заголовках запросов и аутентифицирует пользователей на основе этого.</p><p>Позже в этой статье мы будем внедрять гуард, который проверяет определенные параметры JSON в заголовках запроса и извлекает валидного пользователя из MongoDB.</p><h3>Провайдеры</h3><p>Если гуард определяет логику аутентификации, поставщик аутентификации отвечает за извлечение пользователя из внутреннего хранилища. Если гуард требует, чтобы пользователь был проверен против внутреннего хранилища, тогда реализация запроса пользователя переходит в поставщика проверки подлинности.</p><p>Laravel поставляется с двумя поставщиками аутентификации по умолчанию - Database and Eloquent. Поставщик аутентификации базы данных имеет дело с прямым поиском учетных данных пользователя из внутреннего хранилища, в то время как Eloquent предоставляет уровень абстракции, который делает это необходимым.</p><p>В нашем примере мы реализуем поставщика аутентификации MongoDB, который извлекает учетные данные пользователя  MongoDB.</p><p>Итак, это было базовое введение в гуардов и провайдеров в системе аутентификации Laravel. В следующем разделе мы сосредоточимся на разработке кастомных гуарда и поставщика!</p><h2>Быстрый взгляд на настройку файлов</h2><p>Давайте быстро рассмотрим список файлов, которые мы будем использовать на протяжении этой статьи.</p><ul><li> <code class="inline">config/auth.php</code>: Это файл конфигурации аутентификации, в который мы добавим запись нашего пользовательского гуарда.</li> <li> <code class="inline">config/mongo.php</code>: Это файл, содержащий конфигурацию MongoDB.</li> <li> <code class="inline">app/Services/Contracts/NosqlServiceInterface.php</code>: Это интерфейс, который реализует наш пользовательский класс базы данных Mongo.</li> <li> <code class="inline">app/Database/MongoDatabase.php</code>: Это основной класс базы данных, который взаимодействует с MongoDB.</li> <li> <code class="inline">app/Models/Auth/User.php</code>: Это класс модели пользователя, который реализует контракт Authenticable.</li> <li> <code class="inline">app/Extensions/MongoUserProvider.php</code>: Это реализация поставщика проверки подлинности.</li> <li> <code class="inline">app/Services/Auth/JsonGuard.php</code>: Это реализация драйвера гуарда аутентификации.</li> <li> <code class="inline">app/Providers/AuthServiceProvider.php</code>: Это уже существующий файл, который мы будем использовать для добавления привязок контейнера нашего сервиса.</li> <li> <code class="inline">app/Http/Controllers/MongoController.php</code>: Это файл демонстрационного контроллера, который мы будем создавать, чтобы протестировать наш пользовательский гуард.</li> </ul><p>Не беспокойтесь, если данный список файлов пока для вас не поняет, поскольку скоро мы подробно обсудим его.</p><h2>Погружение в реализацию</h2><p>В этом разделе мы рассмотрим реализацию необходимых файлов.</p><p>Первое, что нам нужно сделать, это сообщить Laravel о нашем кастомном гуарде. Идем дальше и добавляем данные кастомного гуарда в файл <code class="inline">config/auth.php,</code> как показано нижн.</p><pre class="brush: php noskimlinks noskimwords">......"guards" =&gt; [    "web" =&gt; [        "driver" =&gt; "session",        "provider" =&gt; "users",    ],    "api" =&gt; [        "driver" =&gt; "token",        "provider" =&gt; "users",    ],        "custom" =&gt; [      "driver" =&gt; "json",      "provider" =&gt; "mongo",    ],],......</pre><p>Как вы можете видеть, мы добавили наш кастомный гуард под специальным ключом <em>custom</em>.</p><p>Затем нам нужно добавить соответствующую запись провайдера в разделе <em>providers</em>.</p><pre class="brush: php noskimlinks noskimwords">......"providers" =&gt; [    "users" =&gt; [        "driver" =&gt; "eloquent",        "model" =&gt; App\User::class,    ],    "mongo" =&gt; [        "driver" =&gt; "mongo"    ],    // "users" =&gt; [    //     "driver" =&gt; "database",    //     "table" =&gt; "users",    // ],],......</pre><p>Мы добавили запись нашего провайдера под ключом <em>mongo</em>.</p><p>Наконец, давайте изменим гуард аутентификации по умолчанию с web на custom.</p><pre class="brush: php noskimlinks noskimwords">......"defaults" =&gt; [    "guard" =&gt; "custom",    "passwords" =&gt; "users",],......</pre><p>Конечно, пока это не сработает, поскольку мы еще не реализовали необходимые файлы. И об этом мы поговорим в следующих разделах.</p><h3>Настройка драйвера MongoDB</h3><p>В этом разделе мы будем реализовывать необходимые файлы, которые общаются с базовым экземпляром MongoDB.</p><p>Сначала создадим конфигурационный файл <code class="inline">config/mongo.php</code>, который содержит настройки соединения MongoDB по умолчанию.</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpreturn [  "defaults" =&gt; [    "host" =&gt; "{HOST_IP}",    "port" =&gt; "{HOST_PORT}",    "database" =&gt; "{DB_NAME}"  ]];</pre><p>Конечно, вам нужно изменить значения заполнителя в соответствии с вашими настройками.</p><p>Вместо прямого создания класса, который взаимодействует с MongoDB, мы в первую очередь создадим интерфейс.</p><p>Преимущество создания интерфейса заключается в том, что он предоставляет контракт, которого разработчик должен придерживаться при его реализации. Кроме того, наша реализация MongoDB может быть легко заменена другой версией NoSQL, если это необходимо.</p><p>Идем дальше и создаем файла интерфейса <code class="inline">app/Services/Contracts/NosqlServiceInterface.php</code> со следующим содержимым.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Services/Contracts/NosqlServiceInterface.phpnamespace App\Services\Contracts;Interface NosqlServiceInterface{  /**   * Create a Document   *   * @param string $collection Collection/Table Name   * @param array  $document   Document   * @return boolean   */  public function create($collection, Array $document);   /**   * Update a Document   *   * @param string $collection Collection/Table Name   * @param mix    $id         Primary Id   * @param array  $document   Document   * @return boolean   */  public function update($collection, $id, Array $document);  /**   * Delete a Document   *   * @param string $collection Collection/Table Name   * @param mix    $id         Primary Id   * @return boolean   */  public function delete($collection, $id);   /**   * Search Document(s)   *   * @param string $collection Collection/Table Name   * @param array  $criteria   Key-value criteria   * @return array   */  public function find($collection, Array $criteria);}</pre><p>Это довольно простой интерфейс, который объявляет базовые методы CRUD, которые должен определить класс, реализующий этот интерфейс.</p><p>Теперь давайте определим фактический класс в <code class="inline">app/Database/MongoDatabase.php</code>.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Database/MongoDatabase.phpnamespace App\Database;use App\Services\Contracts\NosqlServiceInterface;class MongoDatabase implements NosqlServiceInterface{  private $connection;  private $database;      public function __construct($host, $port, $database)  {    $this-&gt;connection = new MongoClient( "mongodb://{$host}:{$port}" );    $this-&gt;database = $this-&gt;connection-&gt;{$database};  }   /**   * @see \App\Services\Contracts\NosqlServiceInterface::find()   */  public function find($collection, Array $criteria)  {    return $this-&gt;database-&gt;{$collection}-&gt;findOne($criteria);  }  public function create($collection, Array $document) {}  public function update($collection, $id, Array $document) {}  public function delete($collection, $id) {}}</pre><p>Конечно, я предполагаю, что вы установили MongoDB и соответствующее расширение PHP MongoDB.</p><p>Метод <code class="inline">__construct</code> создает экземпляр класса <code class="inline">MongoClient</code> с необходимыми параметрами. Другим важным методом, который нас интересует, является метод <code class="inline">find</code>, который извлекает запись на основе критериев, предоставленных в качестве аргументов метода.</p><p>Такого была реализация драйвера MongoDB, и я старался максимально упростить его.</p><h3>Настройка модели пользователя</h3><p>Соблюдая стандарты системы аутентификации, нам необходимо реализовать модель User, которая должна реализовать контракт <code class="inline">Illuminate\Contracts\Auth\Authenticatable</code>.</p><p>Двигаемся дальше и создаем файл <code class="inline">app/Models/Auth/User.php</code>  со следующим содержимым.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Models/Auth/User.phpnamespace App\Models\Auth;use Illuminate\Contracts\Auth\Authenticatable as AuthenticatableContract;use App\Services\Contracts\NosqlServiceInterface;class User implements AuthenticatableContract{  private $conn;   private $username;  private $password;  protected $rememberTokenName = "remember_token";  public function __construct(NosqlServiceInterface $conn)  {    $this-&gt;conn = $conn;  }  /**   * Fetch user by Credentials   *   * @param array $credentials   * @return Illuminate\Contracts\Auth\Authenticatable   */  public function fetchUserByCredentials(Array $credentials)  {    $arr_user = $this-&gt;conn-&gt;find("users", ["username" =&gt; $credentials["username"]]);        if (! is_null($arr_user)) {      $this-&gt;username = $arr_user["username"];      $this-&gt;password = $arr_user["password"];    }    return $this;  }  /**   * {@inheritDoc}   * @see \Illuminate\Contracts\Auth\Authenticatable::getAuthIdentifierName()   */  public function getAuthIdentifierName()  {    return "username";  }   /**   * {@inheritDoc}   * @see \Illuminate\Contracts\Auth\Authenticatable::getAuthIdentifier()   */  public function getAuthIdentifier()  {    return $this-&gt;{$this-&gt;getAuthIdentifierName()};  }  /**   * {@inheritDoc}   * @see \Illuminate\Contracts\Auth\Authenticatable::getAuthPassword()   */  public function getAuthPassword()  {    return $this-&gt;password;  }  /**   * {@inheritDoc}   * @see \Illuminate\Contracts\Auth\Authenticatable::getRememberToken()   */  public function getRememberToken()  {    if (! empty($this-&gt;getRememberTokenName())) {      return $this-&gt;{$this-&gt;getRememberTokenName()};    }  }  /**   * {@inheritDoc}   * @see \Illuminate\Contracts\Auth\Authenticatable::setRememberToken()   */  public function setRememberToken($value)  {    if (! empty($this-&gt;getRememberTokenName())) {      $this-&gt;{$this-&gt;getRememberTokenName()} = $value;    }  }  /**   * {@inheritDoc}   * @see \Illuminate\Contracts\Auth\Authenticatable::getRememberTokenName()   */  public function getRememberTokenName()  {    return $this-&gt;rememberTokenName;  }}</pre><p>Вы должны были заметить, что <code class="inline">App\Models\Auth\User</code> реализует контракт <code class="inline">Illuminate\Contracts\Auth\Authenticatable</code>.</p><p>Большинство методов, реализованных в нашем классе, не требуют пояснений. Имея это в виду, мы определили метод <code class="inline">fetchUserByCredentials</code>, который извлекает пользователя. В нашем случае это будет класс <code class="inline">MongoDatabase</code>, который будет вызываться для извлечения необходимой информации.</p><p>Итак, это реализация модели User.</p><h3>Настройка провайдера аутентификации</h3><p>Как мы обсуждали ранее, система аутентификации Laravel состоит из двух элементов - гуардов и провайдеров.</p><p>В этом разделе мы создадим провайдера аутентификации, который занимается поиском пользователя на бэкенде.</p><p>Двигаемся дальше и создаем файл <code class="inline">app/Extensions/MongoUserProvider.php</code>, как показано ниже.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Extensions/MongoUserProvider.phpnamespace App\Extensions;use Illuminate\Support\Str;use Illuminate\Contracts\Auth\UserProvider;use Illuminate\Contracts\Auth\Authenticatable;class MongoUserProvider implements UserProvider{  /**   * The Mongo User Model   */  private $model;  /**   * Create a new mongo user provider.   *   * @return \Illuminate\Contracts\Auth\Authenticatable|null   * @return void   */  public function __construct(\App\Models\Auth\User $userModel)  {    $this-&gt;model = $userModel;  }  /**   * Retrieve a user by the given credentials.   *   * @param  array  $credentials   * @return \Illuminate\Contracts\Auth\Authenticatable|null   */  public function retrieveByCredentials(array $credentials)  {      if (empty($credentials)) {          return;      }    $user = $this-&gt;model-&gt;fetchUserByCredentials(["username" =&gt; $credentials["username"]]);      return $user;  }   /**   * Validate a user against the given credentials.   *   * @param  \Illuminate\Contracts\Auth\Authenticatable  $user   * @param  array  $credentials  Request credentials   * @return bool   */  public function validateCredentials(Authenticatable $user, Array $credentials)  {      return ($credentials["username"] == $user-&gt;getAuthIdentifier() &amp;&amp;    md5($credentials["password"]) == $user-&gt;getAuthPassword());  }  public function retrieveById($identifier) {}  public function retrieveByToken($identifier, $token) {}  public function updateRememberToken(Authenticatable $user, $token) {}}</pre><p>Опять же, вам нужно убедиться, что пользовательский провайдер должен реализовать контракт <code class="inline">Illuminate\Contracts\Auth\UserProvider</code>.</p><p>Двигаясь вперед, он определяет два важных метода: retrieveByCredentials и validateCredentials.</p><p>Метод <code class="inline">retrieveByCredentials</code> используется для извлечения учетных данных пользователя с использованием класса модели User, который обсуждался в предыдущем разделе. С другой стороны, метод <code class="inline">validateCredentials</code> используется для проверки пользователя с использованием данного набора учетных данных.</p><p>И это была реализация нашего пользовательского провайдера аутентификации. В следующем разделе мы продолжим работу и создаем гуарда, который взаимодействует с провайдеров аутентификации <code class="inline">MongoUserProvider</code>.</p><h3>Настройка гуарда аутентификации</h3><p>Как мы обсуждали ранее, гуард в системе аутентификации Laravel устанавливает, как пользователь аутентифицируется. В нашем случае мы проверим наличие параметра запроса <em>jsondata</em>, который должен содержать строку учетных данных, кодированную JSON.</p><p>В этом разделе мы создадим гуарда, который взаимодействует с провайдеров аутентификации, который был только что создан в последнем разделе.</p><p>Далее создайте файл <code class="inline">app/Services/Auth/JsonGuard.php</code>  со следующим содержимым.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Services/Auth/JsonGuard.phpnamespace App\Services\Auth;use Illuminate\Http\Request;use Illuminate\Contracts\Auth\Guard;use Illuminate\Contracts\Auth\UserProvider;use GuzzleHttp\json_decode;use phpDocumentor\Reflection\Types\Array_;use Illuminate\Contracts\Auth\Authenticatable;class JsonGuard implements Guard{  protected $request;  protected $provider;  protected $user;  /**   * Create a new authentication guard.   *   * @param  \Illuminate\Contracts\Auth\UserProvider  $provider   * @param  \Illuminate\Http\Request  $request   * @return void   */  public function __construct(UserProvider $provider, Request $request)  {    $this-&gt;request = $request;    $this-&gt;provider = $provider;    $this-&gt;user = NULL;  }  /**   * Determine if the current user is authenticated.   *   * @return bool   */  public function check()  {    return ! is_null($this-&gt;user());  }  /**   * Determine if the current user is a guest.   *   * @return bool   */  public function guest()  {    return ! $this-&gt;check();  }  /**   * Get the currently authenticated user.   *   * @return \Illuminate\Contracts\Auth\Authenticatable|null   */  public function user()  {    if (! is_null($this-&gt;user)) {      return $this-&gt;user;    }  }      /**   * Get the JSON params from the current request   *   * @return string   */  public function getJsonParams()  {    $jsondata = $this-&gt;request-&gt;query("jsondata");    return (!empty($jsondata) ? json_decode($jsondata, TRUE) : NULL);  }  /**   * Get the ID for the currently authenticated user.   *   * @return string|null  */  public function id()  {    if ($user = $this-&gt;user()) {      return $this-&gt;user()-&gt;getAuthIdentifier();    }  }  /**   * Validate a user"s credentials.   *   * @return bool   */  public function validate(Array $credentials=[])  {    if (empty($credentials["username"]) || empty($credentials["password"])) {      if (!$credentials=$this-&gt;getJsonParams()) {        return false;      }    }    $user = $this-&gt;provider-&gt;retrieveByCredentials($credentials);          if (! is_null($user) &amp;&amp; $this-&gt;provider-&gt;validateCredentials($user, $credentials)) {      $this-&gt;setUser($user);      return true;    } else {      return false;    }  }  /**   * Set the current user.   *   * @param  Array $user User info   * @return void   */  public function setUser(Authenticatable $user)  {    $this-&gt;user = $user;    return $this;  }}</pre><p>Прежде всего, нашему классу необходимо реализовать интерфейс <code class="inline">Illuminate\Contracts\Auth\Guard</code>. Таким образом, нам нужно определить все методы, объявленные в этом интерфейсе.</p><p>Важно отметить, что функция <code class="inline">__construct</code> требует реализации <code class="inline">Illuminate\Contracts\Auth\UserProvider</code>. В нашем случае мы передадим экземпляр <code class="inline">App\Extensions\MongoUserProvider</code>.</p><p>Далее, есть функция <code class="inline">getJsonParams</code>, которая извлекает учетные данные пользователя из параметра запроса с именем <code class="inline">jsondata</code>. Поскольку ожидается, что мы получим кодированную строку JSON учетных данных пользователя, мы использовали функцию <code class="inline">json_decode</code> для декодирования данных JSON.</p><p>В функции validate первое, что мы проверяем, это наличие аргумента <code class="inline">$credentials</code>. Если этого нет, мы вызываем метод <code class="inline">getJsonParams</code> для получения учетных данных пользователя из параметров запроса.</p><p>Затем мы вызываем метод <code class="inline">retrieveByCredentials</code> провайдера <code class="inline">MongoUserProvider</code>, который извлекает пользователя из базы данных MongoDB. Наконец, метод <code class="inline">validateCredentials</code> провайдера <code class="inline">MongoUserProvider</code> проверяет валидность User.</p><p>Итак, это была реализация нашего кастомного гуарда. В следующем разделе описывается, как соединить эти фрагменты вместе, чтобы сформировать успешную систему аутентификации.</p><h2>Все вместе</h2><p>До сих пор мы разработали все элементы кастомного гуарда аутентификации, которые должны предоставить нам новую систему аутентификации. Однако он не будет работать из коробки, поскольку мы должны сначала зарегистрировать его, используя привязки сервисов в контейнере Laravel.</p><p>Как вы уже должны знать, провайдер услуг Laravel является правильным местом для реализации необходимых привязок.</p><p>Откройте файл <code class="inline">app/Providers/AuthServiceProvider.php</code>, который позволяет нам добавлять привязки гуардов. Если он не содержит каких-либо пользовательских изменений, вы можете просто заменить его следующим содержимым.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Providers/AuthServiceProvider.phpnamespace App\Providers;use Illuminate\Support\Facades\Auth;use Illuminate\Support\Facades\Gate;use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;use App\Services\Auth\JsonGuard;use App\Extensions\MongoUserProvider;use App\Database\MongoDatabase;use App\Models\Auth\User;use Illuminate\Http\Request;use Illuminate\Support\Facades\Config;class AuthServiceProvider extends ServiceProvider{  /**   * The policy mappings for the application.   *   * @var array   */  protected $policies = [    "App\Model" =&gt; "App\Policies\ModelPolicy",  ];  /**   * Register any authentication / authorization services.   *   * @return void   */  public function boot()  {    $this-&gt;registerPolicies();        $this-&gt;app-&gt;bind("App\Database\MongoDatabase", function ($app) {      return new MongoDatabase(config("mongo.defaults.host"), config("mongo.defaults.port"), config("mongo.defaults.database"));    });        $this-&gt;app-&gt;bind("App\Models\Auth\User", function ($app) {      return new User($app-&gt;make("App\Database\MongoDatabase"));    });    // add custom guard provider    Auth::provider("mongo", function ($app, array $config) {      return new MongoUserProvider($app-&gt;make("App\Models\Auth\User"));    });    // add custom guard    Auth::extend("json", function ($app, $name, array $config) {      return new JsonGuard(Auth::createUserProvider($config["provider"]), $app-&gt;make("request"));    });  }  public function register()  {    $this-&gt;app-&gt;bind(      "App\Services\Contracts\NosqlServiceInterface",      "App\Database\MongoDatabase"    );  }}</pre><p>Давайте рассмотрим метод <code class="inline">boot</code>, который содержит большинство привязок провайдера.</p><p>Для начала создадим привязки для элементов <code class="inline">App\Database\MongoDatabase</code> и <code class="inline">App\Models\Auth\User</code>.</p><pre class="brush: php noskimlinks noskimwords">$this-&gt;app-&gt;bind("App\Database\MongoDatabase", function ($app) {  return new MongoDatabase(config("mongo.defaults.host"), config("mongo.defaults.port"), config("mongo.defaults.database"));});$this-&gt;app-&gt;bind("App\Models\Auth\User", function ($app) {  return new User($app-&gt;make("App\Database\MongoDatabase"));});</pre><p>Прошло некоторое время, когда мы говорили о провайдере и охранниках, и пришло время подключить наш собственный гуард к системе аутентификации Laravel.</p><p>Мы использовали метод провайдера <code class="inline">Auth</code> Facade для добавления нашего кастомного гуадра аутентификации по ключу <em>mongo</em>. Напомним, что ключ отражает параметры, которые были добавлены ранее в файл <code class="inline">auth.php</code>.</p><pre class="brush: php noskimlinks noskimwords">Auth::provider("mongo", function ($app, array $config) {  return new MongoUserProvider($app-&gt;make("App\Models\Auth\User"));});</pre><p>Аналогичным образом мы будем внедрять наш кастомный гуард, используя метод extend фасада <code class="inline">Auth</code>.</p><pre class="brush: php noskimlinks noskimwords">Auth::extend("json", function ($app, $name, array $config) {  return new JsonGuard(Auth::createUserProvider($config["provider"]), $app-&gt;make("request"));});</pre><p>Далее, существует метод <code class="inline">register</code>, который мы использовали для привязки интерфейса <code class="inline">App\Services\Contracts\NosqlServiceInterface</code> к реализации <code class="inline">App\Database\MongoDatabase</code>.</p><pre class="brush: php noskimlinks noskimwords">$this-&gt;app-&gt;bind(  "App\Services\Contracts\NosqlServiceInterface",  "App\Database\MongoDatabase");</pre><p>Поэтому всякий раз, когда возникает необходимость в разрешении зависимости <code class="inline">App\Services\Contracts\NosqlServiceInterface</code>, Laravel отвечает реализацией адаптера <code class="inline">App\Database\MongoDatabase</code>.</p><p>Преимущество использования этого подхода заключается в том, что можно легко подменить данную реализацию своей кастомной. Например, скажем, кто-то хотел бы заменить реализацию <code class="inline">App\Database\MongoDatabase</code> адаптером CouchDB в будущем. В этом случае им просто нужно добавить соответствующую привязку в методе register.</p><p>Так что это был поставщик услуг в вашем распоряжении. На данный момент у нас есть все, что требуется для проверки нашей реализации пользовательского гуарда, поэтому следующий и заключительный раздел будет об этом.</p><h2>А это вообще работает?</h2><p>Вы проделали всю тяжелую работу, настроив свой первый кастомный гуард аутентификации, и теперь пришло время воспользоваться его преимуществами.</p><p>Давайте быстро реализуем простой базовый контроллер <code class="inline">app/Http/Controllers/MongoController.php</code>, как показано ниже.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Http/Controllers/MongoController.phpnamespace App\Http\Controllers;use App\Http\Controllers\Controller;use Illuminate\Contracts\Auth\Guard;class MongoController extends Controller{  public function login(Guard $auth_guard)  {    if ($auth_guard-&gt;validate()) {      // get the current authenticated user      $user = $auth_guard-&gt;user();          echo "Success!";    } else {      echo "Not authorized to access this page!";    }  }}</pre><p>Внимательно посмотрите на зависимость метода login в систему, для чего требуется реализация гуарда <code class="inline">Illuminate\Contracts\Auth\Guard</code>. Поскольку в файле <em>auth.php</em> установлен <code class="inline">custom</code> гуард в качестве гуарда по умолчанию, то будет использоваться файл <code class="inline">App\Services\Auth\JsonGuard</code>.</p><p>Затем мы вызываем метод <code class="inline">validate</code> класса <code class="inline">App\Services\Auth\JsonGuard</code>, который, в свою очередь, инициирует серию вызовов методов:</p><ul><li>Он вызывает метод <code class="inline">retrieveByCredentials</code> класса <code class="inline">App\Extensions\MongoUserProvider</code>.</li> <li>Метод <code class="inline">retrieveByCredentials</code> вызывает метод <code class="inline">fetchUserByCredentials</code> класса User <code class="inline">App\Models\Auth\User</code>.</li> <li>Метод <code class="inline">fetchUserByCredentials</code> вызывает метод <code class="inline">find</code> из <code class="inline">App\Database\MongoDatabase</code> для получения учетных данных пользователя.</li> <li>Наконец, метод <code class="inline">find</code> из <code class="inline">App\Database\MongoDatabase</code> возвращает ответ!</li> </ul><p>Если все работает так, как ожидалось, мы должны получить аутентифицированного пользователя, вызвав метод <code class="inline">user</code> нашего гуарда.</p><p>Чтобы получить доступ к контроллеру, вы должны добавить соответствующий маршрут в файле <code class="inline">routes/web.php</code>.</p><pre class="brush: php noskimlinks noskimwords">Route::get("/custom/mongo/login", "MongoController@login");</pre><p>Попробуйте получить доступ к URL-адресу <span>http://your-laravel-site/custom/mongo/login</span>, не передавая никаких параметров, и вы должны увидеть сообщение «не авторизован».</p><p>С другой стороны, попробуйте что-то вроде <span>http://your-laravel-site/custom/mongo/login?jsondata={"username":"admin", "password": "admin"}</span>, и это должно вернуть сообщение об успешном завершении если пользователь присутствует в вашей базе данных.</p><p>Обратите внимание, что так сделано просто для примера, чтобы продемонстрировать, как работает пользовательский гуард. Вы должны реализовать надежное решение для такой функции, как логин. Фактически, я только что дал представление об потоке аутентификации; вы несете ответственность за создание надежного и безопасного решения для вашего приложения.</p><p>На этом наше путешествие сегодня заканчивается, и, надеюсь, что я вернусь с более полезными вещами. Если вы хотите, чтобы я писал на какие-либо конкретные темы, не забудьте оставить мне сообщение!</p><h2>Заключение</h2><p>Фреймворк Laravel обеспечивает надежную систему аутентификации, которая может быть расширена, если вы хотите реализовать свою кастомную. Это была тема сегодняшней статьи по внедрению пользовательского гуарда и подключению его к рабочему процессу аутентификации Laravel.</p><p>В ходе этого мы продолжили работу и разработали систему, которая аутентифицирует пользователя на основе JSON данных в запросе и сопоставляет его с базой данных MongoDB. И для этого мы создали кастомный гуард защиту и реализацию пользовательского провайдера.</p><p>Я надеюсь, что это упражнение предоставило вам понимание потока аутентификации Laravel, и теперь вы должны чувствовать себя в своих собственных действиях более уверенно.</p><p>Для тех из вас, кто только начинает работать с Laravel или хочет расширить свои знания, создать сайт или приложение с расширениями, у нас есть множество вещей, которые вы можете изучить на <span>Envato Market</span>.<br></p><p>Я хотел бы услышать ваши отзывы и предложения, поэтому кричите громко, используя приведенный ниже канал связи!<br></p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="PHP" href="https://norma-studio.github.io/article/220824598-kak-sozdat-kastomnuyu-autentifikatsiyu-v-laravel" class="tm-article-body__tags-item-link">PHP</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
30714</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
357</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
