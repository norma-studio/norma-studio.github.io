
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. ...">
<meta property="og:description" content="Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. ...">
<meta name="twitter:description" content="Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. ...">
<meta property="aiturec:description" content="Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. ...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html">
<link rel="canonical" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html">
<meta property="og:url" content="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html" title="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io" title="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/543234456.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html" class="tm-user-info__username" title="
А. Гаврилов" aria-label="
А. Гаврилов">
А. Гаврилов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Аутентификация Node-приложений при помощи Passport
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Node.js" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport" class="tm-article-snippet__hubs-item-link"><span>Node.js</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png">
    <meta itemprop="headline name" content="Аутентификация Node-приложений при помощи Passport
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. ...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. ...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



 <p>Реализация надежной стратегии аутентификации для любого приложения может быть чрезвычайно трудной задачей, и Node-приложения не являются исключением. </p><p>В данном руководстве мы разработаем приложение Node.js с нуля и будем использовать новое, но очень популярное промежуточное ПО (* программное обеспечение. Здесь и далее прим. пер.) для реализации аутентификации - <span>Passport </span>для решения наших вопросов по аутентификации. <br></p><blockquote>В документации по Passport оно описывается как «простое нетребовательное промежуточное ПО для реализации аутентификации Node-приложений», и по делу. </blockquote><p>Поставляясь в виде промежуточного ПО, Passport отлично справляется с разделением вопросов аутентификации от остальных. Благодаря этому Passport можно легко встраивать в любое веб-приложение<span> на основе Express</span> так же легко как мы встраиваем другое промежуточное ПО для Express, например, для обеспечения <span>входа в систему</span>, <span>разбора тела запроса</span>, <span>разбора куки</span>, реализации сессии и т.д. </p><p>В руководстве предполагается, что у вас имеются базовые представления о <span>Node.js</span> и фреймворке <span>Express</span>, и делается попытка сосредоточить внимание на реализации аутентификации, хотя мы и создадим образец приложения Express с нуля и усовершенствуем путем добавления в него маршрутов и реализации аутентификации для некоторых из них. </p><h2>Стратегии аутентификации</h2><p>Passport предоставляет нам возможность выбора из более чем 140 способов аутентификации. Вы можете реализовать аутентификацию при помощи локального/удаленного экземпляра базы данных, или использовать SSO (* single sign-on – технологию единого входа) при помощи провайдеров OAuth (* открытый протокол авторизации, который позволяет предоставить третьей стороне ограниченный доступ к защищённым ресурсам пользователя без необходимости передавать ей (третьей стороне) логин и пароль) для <span>Facebook</span>, <span>Twitter</span>, <span>Google </span>и т.д. для аутентификации пользователей с помощью их аккаунтов в социальных сетях, или же вы можете выбрать из обширного списка <span>провайдеров,</span> которые поддерживают аутентификацию при помощи Passport и предоставляют для этого соответствующий модуль Node.</p><p>Но не переживайте: вам нет необходимости подключать какие-либо стратегии, которые не нужны для вашего приложения. Все эти стратегии независимы друг от друга и реализованы в виде отдельных модулей Node, которые  не подключаются по умолчанию при установке Passport при помощи <code class="inline">npm install passport. </code></p><p>В данном руководстве мы будем использовать локальную стратегию аутентификации Passport и проводить аутентификацию пользователей при помощи локально настроенного экземпляра MongoDB, сохраняя данные пользователей в базу данных. Для использования локальной стратегии аутентификации нам необходимо установить модуль <span>passport-local</span> при помощи <code class="inline">npm install passport-local.</code></p><p>Но погодите: Перед тем как вы запустите вашу консоль и начнете выполнять эти команды, давайте начнем с создания приложения Express с нуля и добавим несколько маршрутов в него (для входа в приложение, регистрации и главной страницы) и затем попробуем добавить в него наше промежуточное ПО для реализации аутентификации. Обратите внимание, что для целей данного руководства мы будем использовать Express 4, однако с небольшими <span>поправками</span> Passport также будет работать и с Express 3. </p><h2>Установка приложения</h2><p>Если вы еще этого не сделали, то установите <span>Express </span>и <span>express-generator</span> для создания шаблона приложения просто при помощи выполнения в консоли <code class="inline">express passport-mongo.</code> Структура созданного приложения должна выглядеть следующим образом:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/passportjs-initial-app-structure.png" alt="Аутентификация Node-приложений при помощи Passport..." title="Аутентификация Node-приложений при помощи Passport..." width="50" height="50"></figure><p>Давайте уберем некоторые функциональные возможности, которые мы не будем использовать: удалите файл u<code class="inline">sers.js </code>и уберите ссылки на него из файла <code class="inline">app.js. </code></p><h2>Добавление зависимостей проекта</h2><p>Откройте<code class="inline"> package.json </code>и добавьте зависимости для модулей <code class="inline">passport </code>и <code class="inline">passport-local.</code></p><pre class="brush: bash noskimlinks noskimwords">"passport": "~0.2.0","passport-local": "~1.0.0"</pre><p>Поскольку мы будем сохранять данные пользователей в MongoDB, то будем использовать Mongoose (* ODM (Object Document Mapper – объектно-документный отобразитель)) в качестве инструмента для моделирования объектных данных. Другим способом установки и сохранения зависимостей в <code class="inline">package.json</code> является выполнение:</p><pre class="brush: bash noskimlinks noskimwords">npm install mongoose --save </pre><p><code class="inline">package.json </code>должен выглядеть следующим образом:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=595/uploads/users/388/posts/21619/image/passportjs-packagejson-final.png" alt="Аутентификация Node-приложений при помощи Passport..." title="Аутентификация Node-приложений при помощи Passport..." width="50" height="50"></figure><p>Теперь установите все зависимости и запустите шаблон приложения, выполнив в консоли<code class="inline"> npm install &amp;&amp; npm start</code>. В результате этого будут загружены и установлены все зависимости и запустится сервер Node. Вы можете ознакомиться с базовым приложением Express по адресу<span> http://localhost:3000/</span>, однако там не на что смотреть. </p><p>Очень скоро мы изменим это, создав полноценное приложение Express, которое предоставляет страницу регистрации для нового пользователя, страницу входа для зарегистрированного пользователя и осуществляет аутентификацию зарегистрированного пользователя при помощи Passport. </p><h2>Создание модели Mongoose</h2><p>Поскольку мы будем сохранять данные пользователя в Mongo, то давайте создадим модель User в <span>Mongoose </span>и сохраним ее в <code class="inline">models/user.js</code> нашего приложения. </p><pre class="brush: javascript noskimlinks noskimwords">var mongoose = require("mongoose");module.exports = mongoose.model("User",{        username: String,  password: String,email: String,gender: String,address: String});</pre><p>По сути, мы создаем <span>модель </span>Mongoose, при помощи которой мы можем выполнять операции CRUD (* create, read, update, delete – создать, прочесть, обновить, удалить) над данными базы, лежащей в основе.</p><h2>Настройка Mongo </h2><p>Если у вас нет установленной локально Mongo, то мы рекомендуем вам использовать облачные сервисы предоставления баз данных, например, <span>Modulus </span>или <span>MongoLab</span>. Создать рабочий экземпляр MongoDB при помощи них можно не только бесплатно, но и всего за несколько кликов. </p><p>После создания базы данных на одном из этих сервисов вам будет предоставлен URI наподобие следующего: <code class="inline">mongodb</code>://&lt;dbuser&gt;:&lt;dbpassword&gt;@novus.modulusmongo.net:27017/&lt;dbName&gt;, который можно использовать для осуществления операций CRUD над данными базы. Рекомендуется хранить конфигурацию базы данных в отдельном файле, который можно подключить в случае необходимости. И поэтому мы создаем модуль Node<code class="inline"> db.js</code>, который выглядит следующим образом:</p><pre class="brush: javascript noskimlinks noskimwords">module.exports = {  "url" : "mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;@novus.modulusmongo.net:27017/&lt;dbName&gt;"}</pre><p>Если вы похожи на меня и используете локальный экземпляр Mongo, то пришло время запустить демон (* программа, работающая в фоновом режиме) <code class="inline">mongod</code>.  <code class="inline">db.js</code> должен выглядеть следующим образом:</p><pre class="brush: javascript noskimlinks noskimwords">module.exports = {  "url" : "mongodb://localhost/passport"}</pre><p> Теперь мы используем эту конфигурацию в <code class="inline">app.js</code> и подключаемся к базе данных при помощи Mongoose API:  </p><pre class="brush: javascript noskimlinks noskimwords">var dbConfig = require("./db.js");var mongoose = require("mongoose");mongoose.connect(dbConfig.url);</pre><h2>Настройка Passport</h2><p>Passport предоставляет только механизм для реализации аутентификации, оставляя за нами реализацию поддержки сессий; для этого мы будем использовать модуль <span>express-session</span>. Откройте <code class="inline">app.js</code> и вставьте представленный ниже код перед настройкой маршрутов:</p><pre class="brush: javascript noskimlinks noskimwords">// Configuring Passportvar passport = require("passport");var expressSession = require("express-session");app.use(expressSession({secret: "mySecretKey"}));app.use(passport.initialize());app.use(passport.session());</pre><div><br></div><p>Это необходимо для обеспечения стабильности нашей сессии на сайте. Перед запуском приложения нам необходимо установить <span>express-session </span>и добавить его в наш список зависимостей в <code class="inline">package.json.</code> Для этого выполните <code class="inline">npm install --save express-session</code></p><h2>Сериализация и десериализация экземпляров пользователей</h2><p>Для Passport также необходимо обеспечить сериализацию и десериализацию экземпляров пользователей из хранилища для сессий, чтобы поддерживать сессии входа таким образом, что каждый последующим запрос не будет содержать мандат (* учетная запись с параметрами доступа пользователя, созданными после его успешной аутентификации) пользователя. Для этого Passport имеет методы <code class="inline">serializeUser </code>и <code class="inline">deserializeUser</code>:</p><pre class="brush: javascript noskimlinks noskimwords">passport.serializeUser(function(user, done) {  done(null, user._id);});passport.deserializeUser(function(id, done) {  User.findById(id, function(err, user) {    done(err, user);  });});</pre><h2>Использование стратегий Passport</h2><p> Теперь мы определим стратегии Passport для реализации <b>возможностей входа в приложение</b> и <b>регистрации</b>. Каждая из них будет экземпляром <b>Local Authentication Strategy </b>(* локальной стратегии аутентификации) Passport и будет создана при помощи функции <code class="inline">passport.use().</code> . Мы используем модуль <span>connect-flash</span>, который помогает нам в обработке ошибок, предоставляя  флэш-сообщения, которые могут быть показаны пользователю в случае ошибки.</p><h3>Стратегия входа в приложение</h3><p>Стратегия входа в приложение выглядит следующим образом:</p><pre class="brush: javascript noskimlinks noskimwords">// passport/login.jspassport.use("login", new LocalStrategy({    passReqToCallback : true  },  function(req, username, password, done) {     // check in mongo if a user with username exists or not    User.findOne({ "username" :  username },       function(err, user) {        // In case of any error, return using the done method        if (err)          return done(err);        // Username does not exist, log error &amp; redirect back        if (!user){          console.log("User Not Found with username "+username);          return done(null, false,                 req.flash("message", "User Not found."));                         }        // User exists but wrong password, log the error         if (!isValidPassword(user, password)){          console.log("Invalid Password");          return done(null, false,               req.flash("message", "Invalid Password"));        }        // User and password both match, return user from         // done method which will be treated like success        return done(null, user);      }    );}));</pre><p>Первым параметром<code class="inline"> passport.use()</code> является <b>имя</b> стратегии, которое будет использоваться для распознавания этой стратегии при дальнейшем применении. Второй параметр – это <b>тип </b>стратегии, которую вы хотите создать; здесь мы используем тип  <span>username-password</span>, или LocalStrategy. Следует отметить, что по умолчанию LocalStrategy будет искать мандат пользователя в параметрах <code class="inline">username </code>и <code class="inline">password</code>, но также этот тип позволяет использовать любые другие именованные параметры. Переменная конфигурации <code class="inline">passReqToCallback </code>позволяет нам получить доступ к <code class="inline">объекту запроса</code> в функции  обратного вызова, таким образом давая нам возможность использования любого параметра, доступного в объекте запроса.<br></p><p>Далее мы используем <span>API Mongoose </span>для поиска данного пользователя в нашей основной коллекции Users, чтобы проверить, существует ли он в базе данных. Последний параметр в нашей функции обратного вызова, <code class="inline">done</code>, представляет из себя полезный метод, при помощи которого мы могли бы сигнализировать модулю Passport об успехе или неудаче. Чтобы сообщить о неудаче, необходимо, чтобы либо первый параметр содержал ошибку, либо результатом  вычисления значения второго параметра было значение <code class="inline">false</code>. Для оповещения об успехе необходимо, чтобы первым параметром было <code class="inline">null </code>и результатом  вычисления значения второго параметра было значение <code class="inline">truthy</code>, в случае чего оно будет доступно в <code class="inline">объекте запроса.</code></p><p>Поскольку пароли ненадежны по своей природе, нам необходимо всегда их <span>шифровать</span> перед сохранением в базу данных. Для этого мы используем модуль <span>bcrypt-nodejs</span>, помогающий в шифровании/дешифровании паролей. </p><pre class="brush: javascript noskimlinks noskimwords">var isValidPassword = function(user, password){  return bCrypt.compareSync(password, user.password);}</pre><p>Если вы предпочитаете просмотру фрагментов кода обзор полного кода в действии, ознакомьтесь с <span>кодом по ссылке.</span></p><h3>Стратегия для регистрации</h3><p>Теперь мы определяем следующую стратегию, с помощью которой реализуется возможность регистрации нового пользователя и создается его или ее запись в MongoDB, лежащей в основе:</p><pre class="brush: javascript noskimlinks noskimwords">passport.use("signup", new LocalStrategy({    passReqToCallback : true   },  function(req, username, password, done) {    findOrCreateUser = function(){      // find a user in Mongo with provided username      User.findOne({"username":username},function(err, user) {        // In case of any error return        if (err){          console.log("Error in SignUp: "+err);          return done(err);        }        // already exists        if (user) {          console.log("User already exists");          return done(null, false,              req.flash("message","User Already Exists"));        } else {          // if there is no user with that email          // create the user          var newUser = new User();          // set the user"s local credentials          newUser.username = username;          newUser.password = createHash(password);          newUser.email = req.param("email");          newUser.firstName = req.param("firstName");          newUser.lastName = req.param("lastName");          // save the user          newUser.save(function(err) {            if (err){              console.log("Error in Saving user: "+err);                throw err;              }            console.log("User Registration succesful");                return done(null, newUser);          });        }      });    };        // Delay the execution of findOrCreateUser and execute     // the method in the next tick of the event loop    process.nextTick(findOrCreateUser);  }););</pre><p>Здесь мы опять используем API Mongoose, чтобы узнать, существует ли уже пользователь с данным именем или нет. Если нет, то создаем нового пользователя и сохраняем информацию о нем в Mongo. В ином случае возвращаем ошибку, используя функцию обратного вызова <code class="inline">done </code>и флэш-сообщения. Обратите внимание, что мы используем <code class="inline">bcrypt-nodejs</code> для создания хеша пароля перед сохранением:</p><pre class="brush: javascript noskimlinks noskimwords">// Generates hash using bCryptvar createHash = function(password){ return bCrypt.hashSync(password, bCrypt.genSaltSync(10), null);}</pre><h2>Создание маршрутов</h2><p>Если бы мы взглянули на наше приложение с высоты птичьего полёта, оно бы выглядело подобным образом:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/388/posts/21619/image/Bird_Eye_View_of_PassportJS_App.png" alt="Аутентификация Node-приложений при помощи Passport..." title="Аутентификация Node-приложений при помощи Passport..." width="50" height="50"></figure><p>Теперь мы определяем маршруты для нашего приложения в следующем модуле, который использует экземпляр Passport, созданный выше в <code class="inline">app.js.</code> Сохраните этот модуль в<code class="inline"> routes/index.js.</code></p><pre class="brush: javascript noskimlinks noskimwords">module.exports = function(passport){  /* GET login page. */  router.get("/", function(req, res) {    // Display the Login page with any flash message, if any    res.render("index", { message: req.flash("message") });  });  /* Handle Login POST */  router.post("/login", passport.authenticate("login", {successRedirect: "/home",failureRedirect: "/",failureFlash : true    }));  /* GET Registration Page */  router.get("/signup", function(req, res){res.render("register",{message: req.flash("message")});  });  /* Handle Registration POST */  router.post("/signup", passport.authenticate("signup", {successRedirect: "/home",failureRedirect: "/signup",failureFlash : true    }));  return router;}</pre><p>Наиболее важная часть выше расположенного фрагмента кода – это использование <code class="inline">passport.authenticate()</code> для поручения осуществления аутентификации стратегиям <code class="inline">login </code>и <code class="inline">signup</code>, когда происходят HTTP-запросы по методу <code class="inline">POST </code>к маршрутам <code class="inline">/login</code> и <code class="inline">/signup</code>. Обратите внимание, что включение в название путей маршрутов названий стратегий не является обязательным и может быть любым.</p><h2>Создание представлений на Jade (* переименован в Pug)</h2><p>Далее мы создаем следующие два представления для нашего приложения:</p><ol><li> в <code class="inline">layout.jade</code> содержится базовый шаблон и информация о стилевом оформлении </li> <li> в <code class="inline">ndex.jade</code> содержится страница входа, которая предоставляет форму для входа и возможность создать новый аккаунт</li> </ol><pre class="brush: html noskimlinks noskimwords">extends layoutblock content  div.containerdiv.row  div.col-sm-6.col-md-4.col-md-offset-4h1.text-center.login-title Sign in to our Passport app  div.account-wallimg(class="profile-img", src="https://lh5.googleusercontent.com/-b0-k99FZlyE/AAAAAAAAAAI/AAAAAAAAAAA/eu7opA4byxI/photo.jpg?sz=120")form(class="form-signin", action="/login", method="POST")  input(type="text", name="username" class="form-control", placeholder="Email",required, autofocus)  input(type="password", name="password" class="form-control", placeholder="Password", required)  button(class="btn btn-lg btn-primary btn-block", type="submit") Sign in  span.clearfix  a(href="/signup", class="text-center new-account") Create an account  #message  if messageh1.text-center.error-message #{message}</pre><p>Благодаря Bootstrap (* веб-фреймворк для создания дизайна веб-сайтов и веб-приложений) наша страница входа выглядит следующим образом: </p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=390/uploads/users/388/posts/21619/image/passportjs-login-page.png" alt="Аутентификация Node-приложений при помощи Passport..." title="Аутентификация Node-приложений при помощи Passport..." width="50" height="50"></figure><p>Нам необходимы еще представления для заполнения регистрационных данных и для домашней страницы нашего приложения:</p><ol><li> в <code class="inline">register.jade</code> содержится форма для регистрации</li> <li> в <code class="inline">home.jade</code> выводится приветствие и показываются данные вошедшего пользователя</li> </ol><p>Если вам незнаком Jade, то ознакомьтесь<span> с документацией.</span></p><h2>Реализация функциональной возможности выхода из приложения</h2><p>Passport, являясь промежуточным ПО, имеет возможность добавлять определенные свойства и методы в объекты ответа и запроса и удачно ее использует, добавляя очень полезный метод <code class="inline">request.logout(),</code> который позволяет сделать недействительной только сессию на сайте, не затрагивая остальное возможности.</p><pre class="brush: javascript noskimlinks noskimwords">/* Handle Logout */router.get("/signout", function(req, res) {  req.logout();  res.redirect("/");});</pre><h2>Защита маршрутов</h2><p>Passport также предоставляет возможность защитить доступ к маршруту, доступ к которому необходимо ограничить для анонимных пользователей. Это означает, что если какой-то пользователь пытается получить доступ к <span>http://localhost:3000/home</span> без прохождения аутентификации в приложении, то он будет перенаправлен на начальную страницу при помощи:</p><pre class="brush: javascript noskimlinks noskimwords">/* GET Home Page */router.get("/home", isAuthenticated, function(req, res){  res.render("home", { user: req.user });});// As with any middleware it is quintessential to call next()// if the user is authenticatedvar isAuthenticated = function (req, res, next) {  if (req.isAuthenticated())return next();  res.redirect("/");}</pre><h2>Заключение</h2><p>Passport не единственный игрок на арене, когда речь заходит об аутентификации приложений Node.js. Имеются альтернативы, например, <span>EveryAuth</span>, однако благодаря принципу модульности, гибкости, поддержке сообщества и факту, что Passport – промежуточное ПО, обсуждаемый в руководстве модуль является более удачным выбором. </p><p>Вот <span>сравнение </span>этих двух вариантов от самого разработчика Passport.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Node.js" href="https://norma-studio.github.io/article/220824545-autentifikatsiya-node-prilozhenij-pri-pomoschi-passport" class="tm-article-body__tags-item-link">Node.js</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
37381</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
670</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
