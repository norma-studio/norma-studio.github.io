
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="В этой статье мы рассмотрим API очереди в фреймворке для- веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения....">
<meta property="og:description" content="В этой статье мы рассмотрим API очереди в фреймворке для- веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения....">
<meta name="twitter:description" content="В этой статье мы рассмотрим API очереди в фреймворке для- веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения....">
<meta property="aiturec:description" content="В этой статье мы рассмотрим API очереди в фреймворке для- веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html">
<link rel="canonical" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html">
<meta property="og:url" content="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html" title="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io" title="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/636536435.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html" class="tm-user-info__username" title="
С. Торгашев" aria-label="
С. Торгашев">
С. Торгашев</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Отложенные задачи в Laravel с помощью очередей...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Laravel" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej" class="tm-article-snippet__hubs-item-link"><span>Laravel</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/413/profiles/18842/profileImage/thumb_140656049277268.jpg">
    <meta itemprop="headline name" content="Отложенные задачи в Laravel с помощью очередей... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="В этой статье мы рассмотрим API очереди в фреймворке для- веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">В этой статье мы рассмотрим API очереди в фреймворке для- веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>В этой статье мы рассмотрим API очереди в фреймворке для  веб приложений Laravel. Оно позволяет откладывать ресурсоемкие задачи во время выполнения сценария, чтобы улучшить общий опыт использования нашего приложения для конечных пользователей. После базовой терминологии, я продемонстрирую ее, реализовав пример реального приложения.</p><p>Время загрузки страницы является важным аспектом любого успешного веб-сайта, и не следует упускать из виду важность этого, так как оно влияет на SEO сайта и итоговый опыт конечного пользователя. Чаще всего вам приходится отлаживать веб-страницы с длительным временем загрузки. Конечно, есть разные подходы, которые вы могли бы использовать для устранения этой проблемы.</p><p>При исследовании причин вы часто понимаете, что есть определенные блоки кода, вызывающие задержку в выполнении страницы. Следующее, что вы могли бы попробовать, это определить блоки, которые можно отложить для обработки и которые не оказывают реального влияния на конечный результат текущей страницы. Это должно действительно улучшить общую скорость отдачи веб-страницы, поскольку мы устранили блоки кода, которые вызывают задержку.</p><p>Сегодня мы рассмотрим аналогичную концепцию в контексте веб-фреймворка Laravel. Фактически, Laravel уже предоставляет полезный встроенный API, который позволяет нам отсрочить обработку задач - API очередей. Не тратя много времени, я расскажу об основных элементах API очередей.</p><h2>Драйверы, соединения, очереди и задания</h2><p>Основная цель API Queue - запускать задания, которые добавляются в очередь. Далее очередь может принадлежать определенному соединению, и это соединение может принадлежать определенному драйверу очереди, настроенному для работы с этим соединением. Давайте кратко попытаемся понять, что я только что сказал.</p><h3>Драйверы очереди</h3><p>Точно так же вы использовали бы другой драйвер для подключения к базе данных, вы также можете выбрать из множества разных драйверов очереди. API очереди поддерживает различные адаптеры, такие как база данных, beanstalkd, sqs и redis.</p><p>Драйвер очереди - это просто место, которое используется для хранения информации, связанной с  этой очередью. Например, если вы используете драйвер очереди баз данных, новое задание будет добавлено в таблицу заданий в базе данных. С другой стороны, если вы настроили redis в качестве драйвера очереди по умолчанию, задание будет добавлено на сервер redis.</p><p>API Queue также предоставляет два специальных драйвера очереди для тестирования - sync и null. Драйвер очереди синхронизации используется для немедленного выполнения задания на очередь, в то время как драйвер очереди null используется для пропуска задания, чтобы он не выполнялся вообще.</p><h3>Соединение</h3><p>Когда вы настраиваете API Queue в первый раз, вам нужно указать соединение по умолчанию, которое должно использоваться для обработки очереди по умолчанию. Как минимум, соединение должно предоставить следующую информацию:</p><ul><li>драйвер очереди, который будет использоваться</li> <li>конкретные значения конфигурации драйвера очереди</li> <li>имя очереди по умолчанию, в которое будет добавлено задание</li> </ul><h3>Очереди</h3><p>Когда вы добавляете какое-либо задание в очередь, оно будет добавлено в очередь по умолчанию. Фактически, в большинстве случаев это то что нужно, если у вас нет рабочих мест, которым необходимо уделять более высокий приоритет по сравнению с другими заданиями. В этом случае вы можете создать очередь с именем <em>high</em> и разместить задания с более высоким приоритетом в этой конкретной очереди.</p><p>Когда вы запускаете воркера очереди, который обрабатывает задания в очереди, вы можете опционально передать параметр <code class="inline">--queue</code>, который позволяет вам указывать имена очередей в том порядке, в котором они должны быть обработаны. Например, если вы укажете, что <code class="inline">--queue = high, default</code>, он сначала обрабатывает задания в  очереди <em>high</em>, и как только оно будет завершено, он будет получать задания в очереди по умолчанию.</p><h3>Задания</h3><p>Задача в Queue API - это задача, отложенная из основного потока выполнения. Например, если вы хотите создать превью картинки, когда пользователь загружает изображение из внешнего интерфейса, вы можете создать новое задание, которое обрабатывает обработку эскизов. Таким образом, вы можете отложить задачу обработки эскизов из основного потока выполнения.</p><p>Это было базовое введение в терминологию Queue API. В следующем разделе мы рассмотрим, как создать собственное задание очереди и запустить его, используя Laravel.</p><h2>Создайте свою первую работу в очереди</h2><p>К настоящему времени вы должны уже чувствовать себя уверено в работе с очередью. В этом разделе мы собираемся реализовать пример реального приложения, демонстрирующий концепцию задач очереди в Laravel.</p><p>Чаще всего вы оказываетесь в ситуации, когда вам нужно создать разные миниатюрные версии изображения, загруженного пользователем. В большинстве случаев разработчик пытается обработать его в реальном времени, чтобы сразу создавать разные версии изображений, когда пользователь загружает изображение.</p><p>Сначала кажется, это разумный подход, если вы собираетесь создать пару версий, и это не займет слишком много времени. С другой стороны, если вы имеете дело с приложением, которое требует интенсивной обработки и, следовательно, потребляет больше ресурсов, обработка в режиме реального времени может закончиться неудовлетворенным пользователем.</p><p>Очевидным вариантом, который появляется в вашем сознании, в первую очередь, является отсрочить обработку генерации миниатюр как можно позже. Самый простой подход, который вы могли бы реализовать в этом конкретном сценарии, - установить задание cron, которое запускает обработку через равные промежутки времени, и это должно помочь.</p><p>С другой стороны, гораздо лучший подход состоит в том, чтобы отложить и перевести задачу в очередь, и позволить работнику очереди обрабатывать ее, когда у нее есть шанс сделать это. В рабочей среде работник очереди - это демон-скрипт, который всегда запускает и обрабатывает задачи в очереди. Очевидным преимуществом такого подхода является гораздо лучший опыт работы с конечным пользователем, и вам не нужно ждать выполнения cron, поскольку работа будет обработана как можно скорее.</p><p>Я думаю, что уже достаточно теории, чтобы перейти к реальной реализации.</p><p>В нашем случае мы будем использовать драйвер очереди <code class="inline">database</code>, и нам требуется создать таблицу <code class="inline">jobs</code> в базе данных. Таблица <code class="inline">jobs</code> содержит все задания, которые необходимо обработать в следующем запуске воркера очереди.</p><p>Прежде чем мы начнем и создадим таблицу <code class="inline">jobs</code>, давайте изменим конфигурацию очереди по умолчанию из <code class="inline">sync</code> в <code class="inline">database</code> в файле <code class="inline">config/queue.php</code>.</p><pre class="brush: php noskimlinks noskimwords">....../*|--------------------------------------------------------------------------| Default Queue Driver|--------------------------------------------------------------------------|| Laravel"s queue API supports an assortment of back-ends via a single| API, giving you convenient access to each back-end using the same| syntax for each one. Here you may set the default queue driver.|| Supported: "sync", "database", "beanstalkd", "sqs", "redis", "null"|*/"default" =&gt; env("QUEUE_DRIVER", "database"),......</pre><p>Фактически, Laravel уже предоставляет artisan команду, которая помогает нам создать таблицу <code class="inline">jobs</code>. Выполните следующую команду в корне вашего приложения Laravel и создайте необходимую миграцию базы данных, которая создаст таблицу <code class="inline">jobs</code>.</p><pre class="brush: plain noskimlinks noskimwords">$php artisan queue:table</pre><p>Файл миграции, созданный в <code class="inline">database/migrations/YYYY_MM_DD_HHMMSS_create_jobs_table.php</code>, должен выглядеть так:</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpuse Illuminate\Support\Facades\Schema;use Illuminate\Database\Schema\Blueprint;use Illuminate\Database\Migrations\Migration;class CreateJobsTable extends Migration{    /**     * Run the migrations.     *     * @return void     */    public function up()    {        Schema::create("jobs", function (Blueprint $table) {            $table-&gt;bigIncrements("id");            $table-&gt;string("queue");            $table-&gt;longText("payload");            $table-&gt;unsignedTinyInteger("attempts");            $table-&gt;unsignedInteger("reserved_at")-&gt;nullable();            $table-&gt;unsignedInteger("available_at");            $table-&gt;unsignedInteger("created_at");            $table-&gt;index(["queue", "reserved_at"]);        });    }    /**     * Reverse the migrations.     *     * @return void     */    public function down()    {        Schema::dropIfExists("jobs");    }}</pre><p>Затем, давайте запустим команду <code class="inline">migrate</code>, чтобы она фактически создала таблицу <code class="inline">jobs</code> в базе данных.</p><pre class="brush: php noskimlinks noskimwords">php artisan migrate</pre><p>Это касается миграции <code class="inline">jobs</code>.</p><p>Затем давайте создадим модель <code class="inline">Image</code>, которая будет использоваться для управления изображениями, загружаемыми конечным пользователем. Для модели <code class="inline">Image</code> также требуется связанная таблица базы данных, поэтому при создании модели изображения мы будем использовать параметр <code class="inline">-migrate</code>.</p><pre class="brush: php noskimlinks noskimwords">php artisan make:model Image --migration</pre><p>Вышеупомянутая команда должна создать класс модели <code class="inline">Image</code> и связанную с ним миграцию базы данных.</p><p>Класс модели <code class="inline">Image</code> должен выглядеть следующим образом:</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Image.phpnamespace App;use Illuminate\Database\Eloquent\Model;class Image extends Model{    //}</pre><p>И файл миграции базы данных должен быть создан в <code class="inline">database/migrations/YYYY_MM_DD_HHMMSS_create_images_table.php</code>. Мы также хотим сохранить исходный путь изображения, загруженного конечным пользователем. Давайте переработаем код файла миграции базы данных <code class="inline">Image</code>, чтобы он выглядел следующим образом.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// database/migrations/YYYY_MM_DD_HHMMSS_create_images_table.phpuse Illuminate\Support\Facades\Schema;use Illuminate\Database\Schema\Blueprint;use Illuminate\Database\Migrations\Migration;class CreateImagesTable extends Migration{    /**     * Run the migrations.     *     * @return void     */    public function up()    {        Schema::create("images", function (Blueprint $table) {            $table-&gt;increments("id");            $table-&gt;timestamps();            $table-&gt;string("org_path");        });    }    /**     * Reverse the migrations.     *     * @return void     */    public function down()    {        Schema::dropIfExists("images");    }}</pre><p>Как вы можете видеть, мы добавили столбец <code class="inline">$table-&gt;string("org_path")</code>, чтобы сохранить путь к исходному изображению. Затем вам просто нужно запустить команду <code class="inline">migrate</code>, чтобы фактически создать эту таблицу в базе данных.</p><pre class="brush: plain noskimlinks noskimwords">$php artisan migrate</pre><p>И это касается модели Image.</p><p>Затем давайте создадим фактическое задание очереди, которое отвечает за обработку эскизов изображений. Для обработки миниатюр мы собираемся использовать очень популярную библиотеку обработки изображений - Intervention Image.</p><p>Чтобы установить библиотеку Intervention Image, запустите следующую команду в корне вашего приложения.</p><pre class="brush: plain noskimlinks noskimwords">$php composer.phar require intervention/image</pre><p>Теперь пришло время создать класс <code class="inline">Job</code>, и для этого мы будем использовать команду artisan.</p><pre class="brush: plain noskimlinks noskimwords">$php artisan make:job ProcessImageThumbnails</pre><p>Это должно создать шаблон класса <code class="inline">Job</code> в <code class="inline">app/Jobs/ProcessImageThumbnails.php</code>. Давайте заменим содержимое этого файла следующим.</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// app/Jobs/ProcessImageThumbnails.phpnamespace App\Jobs;use App\Image as ImageModel;use Illuminate\Bus\Queueable;use Illuminate\Queue\SerializesModels;use Illuminate\Queue\InteractsWithQueue;use Illuminate\Contracts\Queue\ShouldQueue;use Illuminate\Foundation\Bus\Dispatchable;use Illuminate\Support\Facades\DB;class ProcessImageThumbnails implements ShouldQueue{    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;    protected $image;    /**     * Create a new job instance.     *     * @return void     */    public function __construct(ImageModel $image)    {        $this-&gt;image = $image;    }    /**     * Execute the job.     *     * @return void     */    public function handle()    {        // access the model in the queue for processing        $image = $this-&gt;image;        $full_image_path = public_path($image-&gt;org_path);        $resized_image_path = public_path("thumbs" . DIRECTORY_SEPARATOR .  $image-&gt;org_path);        // create image thumbs from the original image        $img = \Image::make($full_image_path)-&gt;resize(300, 200);        $img-&gt;save($resized_image_path);    }}</pre><p>Когда работник очереди начинает обработку любого задания, он ищет метод <code class="inline">handle</code>. Таким образом, метод <code class="inline">handle</code> содержит основную логику вашей работы.</p><p>В нашем случае нам нужно создать миниатюру изображения, загруженного пользователем. Код метода <code class="inline">handle</code> довольно прост - мы извлекаем изображение из модели <code class="inline">ImageModel</code> и создаем эскиз, используя библиотеку Intervention Image. Конечно, нам нужно передать соответствующую модель <code class="inline">Image</code>, когда мы отправим наше задание, и мы увидим это через мгновение.</p><p>Чтобы протестировать наше вновь созданное задание, мы создадим простую форму загрузки, которая позволяет пользователю загружать изображение. Конечно, мы не будем создавать эскизы изображений сразу; мы отложим эту задачу так, чтобы ее можно было обработать работником очереди.</p><p>Давайте создадим файл контроллера в <code class="inline">app/Http/Controllers/ImageController.php</code>, как показано ниже.</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpnamespace App\Http\Controllers;use App\Image;use App\Jobs\ProcessImageThumbnails;use Illuminate\Http\Request;use Illuminate\Support\Facades\Redirect;use App\Http\Controllers\Controller;use Validator;class ImageController extends Controller{    /**     * Show Upload Form     *     * @param  Request  $request     * @return Response     */    public function index(Request $request)    {        return view("upload_form");    }    /**     * Upload Image     *     * @param  Request  $request     * @return Response     */    public function upload(Request $request)    {        // upload image        $this-&gt;validate($request, [          "demo_image" =&gt; "required|image|mimes:jpeg,png,jpg,gif,svg|max:2048",        ]);        $image = $request-&gt;file("demo_image");        $input["demo_image"] = time().".".$image-&gt;getClientOriginalExtension();        $destinationPath = public_path("/images");        $image-&gt;move($destinationPath, $input["demo_image"]);        // make db entry of that image        $image = new Image;        $image-&gt;org_path = "images" . DIRECTORY_SEPARATOR . $input["demo_image"];        $image-&gt;save();        // defer the processing of the image thumbnails        ProcessImageThumbnails::dispatch($image);        return Redirect::to("image/index")-&gt;with("message", "Image uploaded successfully!");    }}</pre><p>Давайте создадим соответствующий файл отображения в <code class="inline">resources/views/upload_form.blade.php</code>.</p><pre class="brush: php noskimlinks noskimwords">&lt;!DOCTYPE html&gt;&lt;html lang="{{ config("app.locale") }}"&gt;    &lt;head&gt;        &lt;meta charset="utf-8"&gt;        &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;        &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;        &lt;meta name="csrf-token" content="{{ csrf_token() }}" /&gt;        &lt;title&gt;Laravel&lt;/title&gt;        &lt;!-- Fonts --&gt;        &lt;link href="https://fonts.googleapis.com/css?family=Raleway:100,600" rel="stylesheet" type="text/css"&gt;        &lt;!-- Styles --&gt;        &lt;style&gt;            html, body {                background-color: #fff;                color: #636b6f;                font-family: "Raleway", sans-serif;                font-weight: 100;                height: 100vh;                margin: 0;            }            .full-height {                height: 100vh;            }            .flex-center {                align-items: center;                display: flex;                justify-content: center;            }            .position-ref {                position: relative;            }            .top-right {                position: absolute;                right: 10px;                top: 18px;            }            .content {                text-align: center;            }            .title {                font-size: 84px;            }            .links &gt; a {                color: #636b6f;                padding: 0 25px;                font-size: 12px;                font-weight: 600;                letter-spacing: .1rem;                text-decoration: none;                text-transform: uppercase;            }            .m-b-md {                margin-bottom: 30px;            }                        .alert {                color: red;                font-weight: bold;                margin: 10px;            }            .success {                color: blue;                font-weight: bold;                margin: 10px;            }        &lt;/style&gt;    &lt;/head&gt;    &lt;body&gt;        &lt;div class="flex-center position-ref full-height"&gt;            @if (Route::has("login"))                &lt;div class="top-right links"&gt;                    @if (Auth::check())                        &lt;a href="{{ url("/home") }}"&gt;Home&lt;/a&gt;                    @else                        &lt;a href="{{ url("/login") }}"&gt;Login&lt;/a&gt;                        &lt;a href="{{ url("/register") }}"&gt;Register&lt;/a&gt;                    @endif                &lt;/div&gt;            @endif            &lt;div class="content"&gt;                &lt;div class="m-b-md"&gt;                    &lt;h1 class="title"&gt;Demo Upload Form&lt;/h1&gt;                                        @if ($errors-&gt;any())                        &lt;div class="alert alert-danger"&gt;                            &lt;ul&gt;                                @foreach ($errors-&gt;all() as $error)                                    &lt;li&gt;{{ $error }}&lt;/li&gt;                                @endforeach                            &lt;/ul&gt;                        &lt;/div&gt;                    @endif                                        @if (session("message"))                        &lt;div class="success"&gt;                            {{ session("message") }}                        &lt;/div&gt;                    @endif                                        &lt;form method="post" action="{{ url("/image/upload") }}" enctype="multipart/form-data"&gt;                      &lt;div&gt;                        &lt;input type="file" name="demo_image" /&gt;                      &lt;/div&gt;                      &lt;br/&gt;                      &lt;div&gt;                        &lt;input type="hidden" name="_token" value="{{ csrf_token() }}"&gt;                        &lt;input type="submit" value="Upload Image"/&gt;                      &lt;/div&gt;                    &lt;/form&gt;                &lt;/div&gt;            &lt;/div&gt;        &lt;/div&gt;    &lt;/body&gt;&lt;/html&gt;</pre><p>Наконец, давайте добавим маршруты для действий <code class="inline">index</code> и <code class="inline">upload</code> в файле <code class="inline">routes/web.php</code>.</p><pre class="brush: php noskimlinks noskimwords">Route::get("image/index", "ImageController@index");Route::post("image/upload", "ImageController@upload");</pre><p>В контроллере <code class="inline">ImageController</code> метод <code class="inline">index</code> используется для отображения формы загрузки.</p><pre class="brush: php noskimlinks noskimwords">public function index(Request $request){    return view("upload_form");}</pre><p>Когда пользователь отправляет форму, вызывается метод <code class="inline">upload</code>.</p><pre class="brush: php noskimlinks noskimwords">public function upload(Request $request){    // upload image    $this-&gt;validate($request, [        "demo_image" =&gt; "required|image|mimes:jpeg,png,jpg,gif,svg|max:2048",    ]);    $image = $request-&gt;file("demo_image");    $input["demo_image"] = time().".".$image-&gt;getClientOriginalExtension();    $destinationPath = public_path("/images");    $image-&gt;move($destinationPath, $input["demo_image"]);    // make db entry of that image    $image = new Image;    $image-&gt;org_path = "images" . DIRECTORY_SEPARATOR . $input["demo_image"];    $image-&gt;save();    // defer the processing of the image thumbnails    ProcessImageThumbnails::dispatch($image);    return Redirect::to("image/index")-&gt;with("message", "Image uploaded successfully!");}</pre><p>В начале метода <code class="inline">upload</code> вы увидите обычный код загрузки файлов, который перемещает загруженный файл в каталог <code class="inline">public/images</code>. Затем мы вставляем запись базы данных с использованием модели <code class="inline">App/Image</code>.</p><p>Наконец, мы используем задание <code class="inline">ProcessImageThumbnails</code>, чтобы отложить задачу обработки миниатюр. Важно отметить, что это метод <code class="inline">dispatch</code> используется для отложенной задачи. В конце пользователь перенаправляется на страницу загрузки с сообщением об успешном завершении.</p><p>На данный момент задание добавляется в таблицу <code class="inline">jobs</code> для обработки. Подтвердите это, выполнив следующий запрос.</p><pre class="brush: sql noskimlinks noskimwords">mysql&gt; select * FROM lvl_jobs;|  1 | default | {"displayName":"App\Jobs\ProcessImageThumbnails","job":"Illuminate\Queue\CallQueuedHandler@call","maxTries":null,"timeout":null,"data":{"commandName":"App\Jobs\ProcessImageThumbnails","command":"O:31:\"App\Jobs\ProcessImageThumbnails\":5:{s:8:\"\u0000*\u0000image\";O:45:\"Illuminate\Contracts\Database\ModelIdentifier\":2:{s:5:\"class\";s:9:\"App\Image\";s:2:\"id\";i:2;}s:6:\"\u0000*\u0000job\";N;s:10:\"connection\";N;s:5:\"queue\";N;s:5:\"delay\";N;}"}} |        0 |        NULL |   1510219099 | 1510219099 |</pre><p>Вы, должно быть, задаетесь вопросом, что нужно для обработки задания? Не беспокойтесь - это мы обсудим в следующем разделе.</p><h2>Обработчик очереди</h2><p>Задача работника очереди Laravel заключается в обработке заданий, стоящих в очереди для обработки. Фактически, есть команда artisan, которая помогает нам запустить работника очереди.</p><pre class="brush: plain noskimlinks noskimwords">$php artisan queue:work</pre><p>Как только вы запустите эту команду, он начнет обрабатывать ожидающие задания. В нашем случае он должен обработать задание <code class="inline">ProcessImageThumbnails</code>, которое было поставлено в очередь, когда пользователь загрузил изображение.</p><pre class="brush: plain noskimlinks noskimwords">$php artisan queue:work[YYYY-MM-DD HHMMSS] Processing: App\Jobs\ProcessImageThumbnails[YYYY-MM-DD HHMMSS] Processed:  App\Jobs\ProcessImageThumbnails</pre><p>Вы заметили бы, что при запуске работника очереди он будет работать до тех пор, пока вы не убьете его вручную или не закроете терминал. Фактически, он ожидает, что следующее задание будет обработано. Как только в очереди будет новое задание, оно будет обработано сразу, если обработчик очереди запущен.</p><p>Конечно, мы не можем заставить его работать таким образом, поэтому нам нужно найти способ, чтобы обработчик очереди работал постоянно в фоновом режиме.</p><p>Для этого уже есть несколько инструментов управления процессом, из которых вы можете выбрать. Вот этот список:</p><ul><li>Circus</li> <li>daemontools</li> <li>Monit</li> <li>Supervisor</li> <li>Upstart</li> </ul><p>Вы должны выбрать тот инструмент, которым вам удобнее управлять обработчиком очереди Laravel. В принципе, мы хотим убедиться, что работник очереди работает бесконечно, чтобы сразу обрабатывать новые задания.</p><p>Итак, это было API Queue на ваше рассмотрение. Вы можете использовать его в своей повседневной разработке, чтобы отложить трудоемкие задачи для улучшения работы конечного пользователя.</p><h2>Заключение</h2><p>В этой статье мы обсудили API очереди в Laravel, что очень полезно, если вы захотите отложить обработку ресурсоемких задач.</p><p>Мы начали с базового введения в Queue API, который включал обсуждение соединений, очередей и заданий. Во второй половине статьи мы создали специальное задание очереди, которое продемонстрировало, как вы можете использовать API Queue в реальном приложении.</p><p>Для тех из вас, кто только начинает работать с Laravel или хочет расширить свои знания, сайт или приложение с расширениями, у нас есть множество вещей, которые вы можете еще изучить на <span>Envato Market</span>.<br></p><p>Не стесняйтесь использовать форму обратной связи ниже, чтобы оставить свои запросы и предложения.<br></p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Laravel" href="https://norma-studio.github.io/article/220824607-otlozhennye-zadachi-v-laravel-s-pomoschyu-ocheredej" class="tm-article-body__tags-item-link">Laravel</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
41697</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
740</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
