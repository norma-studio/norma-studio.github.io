
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, н...">
<meta property="og:description" content="В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, н...">
<meta name="twitter:description" content="В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, н...">
<meta property="aiturec:description" content="В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, н...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html" title="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io" title="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/65404fb3f3f8602d7f5b3bdc85cbef02.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html" class="tm-user-info__username" title="
А. Крайнов" aria-label="
А. Крайнов">
А. Крайнов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Запросы в Rails, часть 3...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3" class="tm-article-snippet__hubs-item-link"><span>Ruby on Rails</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
    <meta itemprop="headline name" content="Запросы в Rails, часть 3... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, н...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, н...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>В этом последнем фрагменте мы немного глубже рассмотрим запросы и поиграем с несколькими более сложными сценариями. Мы рассмотрим отношения моделей Active Record немного больше в этой статье, но я буду избегать примеров, которые могут быть слишком запутанными для новичков. Прежде чем двигаться дальше, материал, подобный приведенному ниже примеру, не должен вам пугать:<br></p><pre class="brush: rails noskimlinks noskimwords">Mission.last.agents.where(name: "James Bond")</pre><p>Если вы новичок в запросах Active Record и SQL, я рекомендую вам взглянуть на мои предыдущие две статьи, прежде чем продолжить. Так как можно без знания все этого чтение дальше может оказаться весьма трудным. С другой стороны, эта статья не будет такой же продолжительной, как и другие, если вы просто захотите взглянуть на эти несколько продвинутые варианты использования. Пойдем! <br></p><h2>Темы</h2><ul><li>Скоупы и ассоциации</li> <li>Слиммер джоины</li> <li>Мерж</li> <li>has_many</li> <li>Кастомные джоины</li> </ul><h2>Скоупы и ассоциации</h2><p>Давайте повторим. Мы можем сразу же запросить модели Active Record, но ассоциации также относятся к запросам, и мы можем связать все эти штучки. Все идет нормально. Мы также можем упаковывать фаиндеров в аккуратные, многоразовые скоупы в ваших моделях, и я кратко упомянул об их сходстве с методами класса.</p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :mission  scope :find_bond,        -&gt; { where(name: "James Bond") }  scope :licenced_to_kill, -&gt; { where(licence_to_kill: true) }  scope :womanizer,        -&gt; { where(womanizer: true) }  scope :gambler,          -&gt; { where(gambler: true) } end# =&gt; Agent.find_bond# =&gt; Agent.licenced_to_kill# =&gt; Agent.womanizer# =&gt; Agent.gambler# =&gt; Mission.last.agents.find_bond# =&gt; Mission.last.agents.licenced_to_kill# =&gt; Mission.last.agents.womanizer# =&gt; Mission.last.agents.gambler# =&gt; Agent.licenced_to_kill.womanizer.gambler# =&gt; Mission.last.agents.womanizer.gambler.licenced_to_kill</pre><p>Таким образом, вы также можете упаковать их в свои собственные методы класса. Хотя скоупы и не являются чем то магическим, но некоторые люди их таковыми считают. Но так как методами класса можно получить те же результаты, то я считаю это вполне нормальным.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :mission  def self.find_bond    where(name: "James Bond")  end  def self.licenced_to_kill    where(licence_to_kill: true)  end  def self.womanizer    where(womanizer: true)  end  def self.gambler    where(gambler: true)  endend# =&gt; Agent.find_bond# =&gt; Agent.licenced_to_kill# =&gt; Agent.womanizer# =&gt; Agent.gambler# =&gt; Mission.last.agents.find_bond# =&gt; Mission.last.agents.licenced_to_kill# =&gt; Mission.last.agents.womanizer# =&gt; Mission.last.agents.gambler# =&gt; Agent.licenced_to_kill.womanizer.gambler# =&gt; Mission.last.agents.womanizer.gambler.licenced_to_kill</pre><p>Эти методы класса читаются одинаково, и вам не нужно беспокоиться на счет лямбды. Что бы ни было лучше для вас или вашей команды; Это зависит от того, какой API вы хотите использовать. Просто не смешивайте и не сравнивайте их с одним выбором! Обе версии позволяют легко связать эти методы внутри другого метода класса, например:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :mission  scope :licenced_to_kill, -&gt; { where(licence_to_kill: true) }  scope :womanizer,        -&gt; { where(womanizer: true) }  def self.find_licenced_to_kill_womanizer    womanizer.licenced_to_kill  endend# =&gt; Agent.find_licenced_to_kill_womanizer# =&gt; Mission.last.agents.find_licenced_to_kill_womanizer</pre><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :mission  def self.licenced_to_kill    where(licence_to_kill: true)  end  def self.womanizer    where(womanizer: true)  end  def self.find_licenced_to_kill_womanizer    womanizer.licenced_to_kill  endend# =&gt; Agent.find_licenced_to_kill_womanizer# =&gt; Mission.last.agents.find_licenced_to_kill_womanizer</pre><p>Давайте сделаем этот еще один шаг дальше. Мы можем использовать лямбду в самих ассоциациях для определения определенного скоупа. Сначала это выглядит немного странно, но они могут быть очень удобными. Это позволяет вызывать эти лямбды прямо на ваших ассоциациях. </p><p>Это довольно круто и легко читается с более короткими цепочками вызовов. Остерегайтесь слишком сильного связывания этих моделей.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  has_many :double_o_agents,    -&gt; { where(licence_to_kill: true) },    class_name: "Agent"end# =&gt; Mission.double_o_agents</pre><p>Скажи мне, что это не круто! Это не для повседневного использования, а для догадок, я думаю. Поэтому здесь <code class="inline">Mission</code> может «запрашивать» только агентов, у которых есть лицензия на убийство. </p><p>Немного слов о синтаксисе, поскольку мы отклонились от соглашений об именах и использовали нечто более выразительное, например <code class="inline">double_o_agents</code>. Мы должны упомянуть имя класса, чтобы не путать Rails, что в противном случае могло бы ожидать поиск класса <code class="inline">DoubleOAgent</code>. Разумеется, у вас могут быть как ассоциации <code class="inline">Agent</code>, так и обычные, а Rails не будет жаловаться по этому поводу.</p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  has_many :agents    has_many :double_o__agents,    -&gt; { where(licence_to_kill: true) },    class_name: "Agent"end# =&gt; Mission.agents# =&gt; Mission.double_o_agents</pre><h2>Слиммер джоины<br></h2><p>Когда вы запрашиваете базу данных для записей, и вам не нужны все данные, вы можете указать, что именно вы хотите получить. Зачем? Поскольку данные, возвращаемые в Active Record, в конечном итоге будут встроены в новые объекты Ruby. Давайте рассмотрим одну простую стратегию, чтобы избежать раздувания памяти в приложении Rails:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  has_many :agentsendclass Agent &lt; ActiveRecord::Base  belongs_to :missionend</pre><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.all.joins(:mission)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id"</pre><p>Таким образом, этот запрос возвращает список агентов с миссией из базы данных в Active Record, которая затем, в свою очередь, собирается создавать объекты Ruby из нее. Данные <code class="inline">mission</code> доступны, поскольку данные из этих строк объединяются в строки данных агента. Это означает, что объединенные данные доступны во время запроса, но не будут возвращены в Active Record. Таким образом, вы будете иметь эти данные например для выполнения вычислений. </p><p>Это особенно круто, потому что вы можете использовать данные, которые также не могут быть отправлены обратно в ваше приложение. Меньшее количество атрибутов, которые нужно встроить в объекты Ruby, которые занимают память, может оказаться большим плюсом в производительности. В общем, подумайте о том, чтобы отправить только наверняка необходимые строки и столбцы, которые вам нужны. Таким образом, вы можете немного избежать чрезмерного использования памяти.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.all.joins(:mission).where(missions: { objective: "Saving the world" })</pre><p>Просто кратко о синтаксисе здесь: потому что мы не запрашиваем таблицу <code class="inline">Agent</code> через <code class="inline">where</code>, а через джоин в таблице <code class="inline">:mission</code>, нам нужно указать в нашем <code class="inline">WHERE</code>, что мы ищем конкретные <code class="inline">missions</code>.</p><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."objective" = ?  [["objective", "Saving the world"]]</pre><p>Использование <code class="inline">includes</code> здесь также приведет к возврату миссий в Active Record для активной загрузки и захвату памяти объеками Ruby.<br></p><h2>Слияние<br></h2><p><code class="inline">merge</code> пригодится, например, когда мы хотим совместить запрос с агентами и связанными с ними миссиями, которые имеют определенную область действия, определенную вами. Мы можем взять два объекта <code class="inline">ActiveRecord::Relation</code> и объединить их условия. Слияние полезно, если вы хотите использовать определенный скоуп при использовании ассоциации. </p><p>Другими словами, то, что мы можем сделать с <code class="inline">merge</code>, - это фильтр с именованным скоупом на объединенной модели. В одном из предыдущих примеров мы использовали методы класса для определения таких именных скоупов. <br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base      has_many :agents  def self.dangerous    where(enemy: "Ernst Stavro Blofeld")  endendclass Agent &lt; ActiveRecord::Base  belongs_to :missionend</pre><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:mission).merge(Mission.dangerous)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."enemy" = ?  [["enemy", "Ernst Stavro Blofeld"]]</pre><p>Когда мы инкапсулируем, что <code class="inline">dangerous</code> миссия находится в модели <code class="inline">Mission</code>, мы таким образом можем спрятать ее на <code class="inline">join</code> посредством <code class="inline">merge</code>. Поэтому перемещение логики таких условий к соответствующей модели, которой она принадлежит, с одной стороны - хорошая техника для достижения более слабой связанности - мы не хотим, чтобы наши модели Active Record знали много деталей друг о друге, а с другой это дает вам хороший API в ваших объединениях. Пример ниже без слияния не будет работать без ошибок:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.all.merge(Mission.dangerous)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" WHERE "missions"."enemy" = ?  [["enemy", "Ernst Stavro Blofeld"]]</pre><p>Когда мы теперь объединяем объект <code class="inline">ActiveRecord::Relation</code> для наших миссий на наших агентов, база данных не знает, о каких миссиях мы говорим. Нам нужно четко указать, какая связь нам нужна, и сначала присоединиться к данным миссии. Одна последняя вишенка на торте. Мы можем инкапсулировать это еще лучше, привлекая агентов: <br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  has_many :agents  def self.dangerous    where(enemy: "Ernst Stavro Blofeld")  endendclass Agent &lt; ActiveRecord::Base      belongs_to :mission  def self.double_o_engagements    joins(:mission).merge(Mission.dangerous)  endend</pre><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.double_o_engagements</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."enemy" = ?  [["enemy", "Ernst Stavro Blofeld"]]</pre><p>И что мы имеем в итоге. Инкапсуляция, правильное ООП и отличная читаемость. Джек-пот!<br></p><h2>has_many</h2><p>Выше мы видели уже много раз видели ассоциацию <code class="inline">belongs_to</code> в действии. Давайте взглянем на это с другой точки зрения и включим секреты секретной службы в микс:</p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Section &lt; ActiveRecord::Base  has_many :agentsendclass Mission &lt; ActiveRecord::Base  has_many :agentsendclass Agent &lt; ActiveRecord::Base  belongs_to :mission  belongs_to :sectionend</pre><p>Таким образом, в этом случае у агентов будет не только <code class="inline">mission_id</code>, но также и <code class="inline">section_id</code>. Все идет нормально. Давайте найдем все разделы с агентами с определенными разделами миссии, которые выполняют какую-то миссию.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Section.joins(:agents)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "sections".* FROM "sections" INNER JOIN "agents" ON "agents"."section_id" = "sections."id"</pre><p>Вы что-то заметили? Небольшая деталь отличается. Внешние ключи перевернуты. Здесь мы запрашиваем список разделов, но используем внешние ключи следующим образом: <code class="inline">"agents"."section_id" = "sections."id"</code>. Другими словами, мы ищем внешний ключ из таблицы, в которую мы делаем джоин.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:mission)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id"</pre><p>Раньше наши соединения через ассоциацию <code class="inline">belongs_to</code> выглядели так: внешние ключи были отзеркалены (<code class="inline">"missions"."id" = "agents"."mission_id</code>") и искали внешний ключ из таблицы, с которой мы начинаем.<br></p><p>Возвращаясь к вашему сценарию <code class="inline">has_many</code>, мы теперь получим список разделов, которые повторяются, потому что у них есть несколько агентов в каждом разделе. Поэтому для каждого столбца агента, к которому присоединяемся, мы получаем строку для этого раздела или section_id - короче говоря, в основном мы дублируем строки. Чтобы сделать это еще более головокружительным, давайте представим миссии в микс.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Section.joins(agents: :mission)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "sections".* FROM "sections" INNER JOIN "agents" ON "agents"."section_id" = "sections"."id" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id"</pre><p>Проверьте две части <code class="inline">INNER JOIN</code>. Вы все еще со мной? Мы «добираемся» через агентов к их миссиям из раздела агента. Мы получаем миссии, которые косвенно связаны с определенным разделом. </p><p>В результате мы включаем новые столбцы, но количество строк остается таким же. То, что отправляется обратно в Active Record - приводит к созданию новых объектов Ruby, также остается списком разделов. Поэтому, когда у нас есть несколько миссий с несколькими агентами, мы снова получим дублированные строки для нашего раздела. Давайте отфильтруем это еще немного:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Section.joins(agents: :mission).where(missions: { enemy: "Ernst Stavro Blofeld" })</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "sections".* FROM "sections" INNER JOIN "agents" ON "agents"."section_id" = "sections"."id" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."enemy" = "Ernst Stavro Blofeld"</pre><p>Теперь мы получаем только возвращаемые части, которые участвуют в миссиях, в которых вовлечен враг Эрнст Ставро Блофельд. Поскольку некоторые супер-злодеи могут работать более чем в одном разделе - например, в разделах A и C, United Sates и Canada, соответственно. </p><p>Если у нас есть несколько агентов в данном разделе, которые работают над одной и той же миссией, чтобы остановить Blofeld или что-то еще, у нас снова будут повторяющиеся строки, возвращенные нам в Active Record. Давайте будем немного более разборчивыми:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Section.joins(agents: :mission).where(missions: { enemy: "Ernst Stavro Blofeld" }).distinct</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT DISTINCT "sections".* FROM "sections" INNER JOIN "agents" ON "agents"."section_id" = "sections"."id" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."enemy" = "Ernst Stavro Blofeld"</pre><p>То, что это дает нам, - это количество разделов, из которых работает Blofeld, - которые известны, - которые имеют агентов, действующих в миссиях с ним как противник. В качестве заключительного шага давайте снова проведем рефакторинг. Мы извлекаем это в метод класса класса <code class="inline">Section</code>:<br></p><h4>Рельсы</h4><pre class="brush: rails noskimlinks noskimwords">class Section &lt; ActiveRecord::Base  has_many :agents  def self.critical    joins(agents: :mission).where(missions: { enemy: "Ernst Stavro Blofeld" }).distinct  endendclass Mission &lt; ActiveRecord::Base  has_many :agentsendclass Agent &lt; ActiveRecord::Base  belongs_to :mission  belongs_to :sectionend</pre><p>Вы можете реорганизовать это еще больше и разделить обязанности по достижению свободной связи, но давайте двигаться дальше.<br></p><h2>Пользовательские соединения <br></h2><p>Большую часть времени вы можете положиться на Active Record, чтобы он писал нужный SQL для вас. Это означает, что вы остаетесь на земле Ruby, и вам не нужно слишком беспокоиться о деталях базы данных. Но иногда вам нужно прорыть дыру в землю SQL и делать свое дело. Например, если вам нужно использовать <code class="inline">LEFT</code>-соединение и выйти из обычного поведения Active Record при выполнении <code class="inline">INNER</code>-соединения по умолчанию. <code class="inline">joins</code> - небольшое окно для написания собственного пользовательского SQL, если это необходимо. Вы открываете его, подключаете свой собственный код запроса, закрываете «окно» и можете продолжать добавлять методы запросов Active Record.<br></p><p>Давайте продемонстрируем это с примером, который включает в себя гаджеты. Предположим, что типичный агент обычно имеет гаджеты через <code class="inline">has_many</code>, и мы хотим найти агентов, которые не снабжены какими-либо причудливыми гаджетами, чтобы помочь им в этой области. Обычное соединение не дало бы хороших результатов, так как мы действительно заинтересованы в <code class="inline">nil</code> или <code class="inline">null</code> в SQL-значениях этих шпионских игрушек.<br></p><h4>Рельсы</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  has_many :agentsendclass Agent &lt; ActiveRecord::Base  belongs_to :mission  has_many   :gadgetsendclass Gadget &lt; ActiveRecord::Base  belongs_to :agentend</pre><p>Когда мы выполняем операцию <code class="inline">join</code>, мы получим только  агентов, которые уже оснащены гаджетами, потому что <code class="inline">agent_id</code> в этих гаджетах не равен нулю. Это ожидаемое поведение внутреннего соединения по умолчанию. Внутреннее соединение основывается на совпадении с обеих сторон и возвращает только строки данных, которые соответствуют этому условию. Необязательный гаджет с <code class="inline">nil</code> значением для агента, который не имеет гаджета, не соответствует этому критерию. <br></p><h4>Рельсы</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:gadgets)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "gadgets" ON "gadgets"."agent_id" = "agents"."id"</pre><p>С другой стороны, мы ищем агентов, которые крайне нуждаются в любви от интендантов. Ваше первое предположение могло бы выглядеть следующим образом:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:gadgets).where(gadgets: {agent_id: nil})  </pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "gadgets" ON "gadgets"."agent_id" = "agents"."id" WHERE "gadgets"."agent_id" IS NULL</pre><p>Неплохо, но, как вы можете видеть из вывода SQL, это не работает и продолжает настаивать на использовании <code class="inline">INNER JOIN</code> по умолчанию. Это сценарий, в котором нам нужно соединение <code class="inline">OUTER</code>, потому что одна сторона нашего так сказать «уравнения» отсутствует. Мы ищем результаты для гаджетов, которых не существует, точнее, для агентов без гаджетов. </p><p>До сих пор, когда мы передавали символ в Active Record в join, он ожидал ассоциации. С другой стороны, если передается строка, ожидается, что она будет фактическим фрагментом кода SQL - частью вашего запроса.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins("LEFT OUTER JOIN gadgets ON gadgets.agent_id = agents.id").where(gadgets: {agent_id: nil})</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" LEFT OUTER JOIN gadgets ON gadgets.agent_id = agents.id WHERE "gadgets"."agent_id" IS NULL</pre><p>Или, если вам любопытно относиться к ленивым агентам без миссий, висящих, возможно, на Барбадосе или где угодно - наше обычное соединение будет выглядеть так:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins("LEFT OUTER JOIN missions ON missions.id = agents.mission_id").where(missions: { id: nil })</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" LEFT OUTER JOIN missions ON missions.id = agents.mission_id WHERE "missions"."id" IS NULL</pre><p>Внешнее соединение является более инклюзивной версией соединения, поскольку оно будет соответствовать всем записям из объединенных таблиц, даже если некоторые из этих отношений еще не существуют. Поскольку этот подход не так широк, как внутренние соединения, вы получите кучу nil. Конечно, это может быть информативным в некоторых случаях, но внутренние объединения, тем не менее, обычно являются тем, что мы ищем. Rails 5 позволяет использовать для таких случаев специализированный метод, называемый <code class="inline">left_outer_joins</code>. Наконецто! </p><p>Одна мелочь: держите эти заглядывающие дыры в землю SQL как можно меньше, если сможете. И все, включая вы сами в будущем, будут вам за это благодарны.<br></p><h2>Заключение<br></h2><p>Использование Active Record для написания эффективного SQL для вас является одним из основных навыков, которые вы должны были получить из этой мини-серии для новичков. Таким образом, вы также получите код, совместимый с любой поддерживаемой базой данных, что означает, что запросы будут стабильными между базами данных. Необходимо, чтобы вы понимали не только то, как играть с Active Record, но и SQL за ней. </p><p>Да, SQL может быть скучным, утомительным для чтения, и совсем не элегантным, но не забывайте, что Rails обертывает Active Record вокруг SQL, и вы не должны пренебрегать пониманием этой важной части технологии. Эффективность имеет решающее значение для запросов к базе данных, особенно если вы создаете что-то для более широкой аудитории с интенсивным трафиком. </p><p>Теперь выходите в сеть и найдите еще несколько материалов по SQL, чтобы хорошенько его освоить, раз и навсегда!</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825219-zaprosy-v-rails-chast-3" class="tm-article-body__tags-item-link">Ruby on Rails</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
34553</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
510</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
