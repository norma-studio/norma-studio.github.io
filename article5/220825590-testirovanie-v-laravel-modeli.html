
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Если вы надеетесь узнать, почему тесты полезны, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в Laravel 4. ...">
<meta property="og:description" content="Если вы надеетесь узнать, почему тесты полезны, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в Laravel 4. ...">
<meta name="twitter:description" content="Если вы надеетесь узнать, почему тесты полезны, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в Laravel 4. ...">
<meta property="aiturec:description" content="Если вы надеетесь узнать, почему тесты полезны, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в Laravel 4. ...">
<meta property="og:image" content="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png">
<meta property="aiturec:image" content="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png">
<meta name="twitter:image" content="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png">
<meta property="vk:image" content="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html" title="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io" title="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/64535356345.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html" class="tm-user-info__username" title="
В. Чендылов" aria-label="
В. Чендылов">
В. Чендылов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Тестирование в Laravel: Модели...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="PHP" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli" class="tm-article-snippet__hubs-item-link"><span>PHP</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli.html" />
    <link itemprop="image" href="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png">
    <meta itemprop="headline name" content="Тестирование в Laravel: Модели... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Если вы надеетесь узнать, почему тесты полезны, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в Laravel 4. ...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Если вы надеетесь узнать, почему тесты полезны, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в Laravel 4. ...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Если вы надеетесь узнать, <span>почему тесты полезны</span>, это не статья для вас. В ходе этого урока я предполагаю, что вы уже понимаете преимущества и надеетесь узнать, как лучше писать и организовывать свои тесты в <span>Laravel 4</span>. </p><p></p> <p>Версия 4 Laravel предлагает серьезные улучшения в отношении тестирования по сравнению с предыдущим релизом. Это первая статья серии, в которой рассказывается, как писать тесты для приложений Laravel 4. Мы начнем серию, обсуждая тестирование модели.</p> <hr><h2>Настройка</h2> <h3>База данных в памяти</h3> <p>Если вы не используете сырые запросы в своей базе данных, Laravel позволяет вашему приложению оставаться агностиком базы данных. При простом изменении драйвера ваше приложение теперь может работать с другими СУБД (MySQL, PostgreSQL, SQLite и т.д.). Среди стандартных опций SQLite предлагает своеобразную, но очень полезную функцию: базы данных в памяти.</p> <p>С Sqlite мы можем установить подключение к базе данных <code>:memory:</code>, что значительно ускорит наши тесты так как база данных не будет располагаться на жестком диске. Кроме того, база данных никогда не будет заполнена данными, оставшимися от предыдущих тестов, потому что соединение <code>:memory:</code> всегда начинается с пустой базы данных.</p> <blockquote> <p>Короче говоря: база данных в памяти позволяет быстро и чисто тестировать приложение. </p> </blockquote> <p>В каталоге <code>app/config/testing</code> создайте новый файл с именем <code>database.php</code> и заполните его следующим содержимым:</p> <pre class="brush: php noskimlinks noskimwords">// app/config/testing/database.php&lt;?phpreturn array(    "default" =&gt; "sqlite",    "connections" =&gt; array(        "sqlite" =&gt; array(            "driver"   =&gt; "sqlite",            "database" =&gt; ":memory:",            "prefix"   =&gt; ""        ),    ));</pre> <p>Тот факт, что <code>database.php</code> помещен в каталог конфигурации <code>testing</code>, означает, что эти параметры будут использоваться только в тестовой среде (которую автоматически устанавливает Laravel). Таким образом, когда к вашему приложению обращаются нормально, база данных в памяти не будет использоваться.</p> <h3>Перед запуском тестов</h3> <p>Поскольку база данных в памяти всегда пуста при подключении, важно <strong>migrate</strong> базу данных перед каждым тестом. Для этого откройте <code>app/tests/TestCase.php</code> и добавьте следующий метод в конец класса:</p> <pre class="brush: php noskimlinks noskimwords">/** * Migrates the database and set the mailer to "pretend". * This will cause the tests to run quickly. * */private function prepareForTests(){    Artisan::call("migrate");    Mail::pretend(true);}</pre> <blockquote> <p>ПРИМЕЧАНИЕ. Метод <code>setUp()</code> выполняется PHPUnit перед каждым тестом.</p> </blockquote> <p>Этот метод подготовит базу данных и изменит статус класса <code>Mailer</code> Laravel на <code>pretend</code>. Таким образом, Mailer не будет отправлять какие-либо реальные сообщения при запуске тестов. Вместо этого он будет записывать «отправленные» сообщения. </p> <p>Чтобы завершить <code>app/tests/TestCase.php</code>, вызовите метод <code>prepareForTests()</code> в методе <code>setUp()</code> PHPUnit, который будет выполняться перед каждым тестом.</p> <blockquote> <p>Не забудьте вызвать <code>parent::setUp()</code>, поскольку мы переписываем метод родительского класса.</p> </blockquote> <pre class="brush: php noskimlinks noskimwords">/** * Default preparation for each test * */public function setUp(){    parent::setUp(); // Don"t forget this!    $this-&gt;prepareForTests();}</pre> <p>На этом этапе <code>app/tests/TestCase.php</code> должен выглядеть следующим образом. <em>Помните, что <code>createApplication</code> создается автоматически Laravel. Вам не нужно беспокоиться об этом.</em></p> <pre class="brush: php noskimlinks noskimwords">// app/tests/TestCase.php&lt;?phpclass TestCase extends Illuminate\Foundation\Testing\TestCase {    /**     * Default preparation for each test     */    public function setUp()    {        parent::setUp();        $this-&gt;prepareForTests();    }    /**     * Creates the application.     *     * @return Symfony\Component\HttpKernel\HttpKernelInterface     */    public function createApplication()    {        $unitTesting = true;        $testEnvironment = "testing";        return require __DIR__."/../../start.php";    }    /**     * Migrates the database and set the mailer to "pretend".     * This will cause the tests to run quickly.     */    private function prepareForTests()    {        Artisan::call("migrate");        Mail::pretend(true);    }}</pre> <p>Теперь, чтобы написать наши тесты, просто наследуйтесь от <code>TestCase</code>, и база данных будет инициализирована и мигрирована перед каждым тестом.</p> <hr><h2>Тесты</h2> <p>Правильно сказать, что в этой статье мы не будем следить за процессом <strong>TDD</strong>. Проблема здесь дидактична, с целью продемонстрировать, как тесты могут быть написаны. Из-за этого я решил сначала выявить модели, о которых идет речь, а затем связанные с ними тесты. Я считаю, что это лучший способ проиллюстрировать этот урок. </p> <p>Контекст этого демонстрационного приложения - это простой блог/<span>CMS</span>, содержащий пользователей (аутентификация), сообщения и статические страницы (которые показаны в меню).</p> <h3>Модель Post</h3> <p>Обратите внимание, что модель расширяет класс, <span>Ardent</span>, а не Eloquent. Ardent - это пакет, который упрощает проверку при сохранении модели (см. свойство <code>$rules</code>).</p> <p>Затем у нас есть <code>public static $factory</code> массив, который использует пакет <span>FactoryMuff</span>, чтобы помочь при создании объекта для тестирования.</p> <blockquote> <p>Как <strong>Ardentx</strong>, так и <strong>FactoryMuff</strong> доступны через <span>Packagist</span> и Composer.</p> </blockquote> <p>В нашей модели <code>Post</code> мы имеем отношение к модели <code>User</code>, используя магический метод <code>author</code>.</p> <p>Наконец, у нас есть простой метод, который возвращает дату, отформатированную как «<em>day/month/year</em>».</p> <pre class="brush: php noskimlinks noskimwords">// app/models/Post.php&lt;?phpuse LaravelBook\Ardent\Ardent;class Post extends Ardent {    /**     * Table     */    protected $table = "posts";    /**     * Ardent validation rules     */    public static $rules = array(        "title" =&gt; "required",              // Post tittle        "slug" =&gt; "required|alpha_dash",    // Post Url        "content" =&gt; "required",            // Post content (Markdown)        "author_id" =&gt; "required|numeric",  // Author id    );    /**     * Array used by FactoryMuff to create Test objects     */    public static $factory = array(        "title" =&gt; "string",        "slug" =&gt; "string",        "content" =&gt; "text",        "author_id" =&gt; "factory|User", // Will be the id of an existent User.    );    /**     * Belongs to user     */    public function author()    {        return $this-&gt;belongsTo( "User", "author_id" );    }    /**     * Get formatted post date     *     * @return string     */    public function postedAt()    {        $date_obj =  $this-&gt;created_at;        if (is_string($this-&gt;created_at))            $date_obj =  DateTime::createFromFormat("Y-m-d H:i:s", $date_obj);        return $date_obj-&gt;format("d/m/Y");    }}</pre> <h3>Тестирование Post</h3> <p>Чтобы все было организовано, я поместил класс с тестами модели <code>Post</code> в <code>app/tests/models/PostTest.php</code>. Мы пройдем все тесты, по одной секции за раз.</p> <pre class="brush: php noskimlinks noskimwords">// app/tests/models/PostTest.php&lt;?phpuse Zizaco\FactoryMuff\Facade\FactoryMuff;class PostTest extends TestCase{</pre> <p>Мы расширяем класс <code>TestCase</code>, что является требованием для тестирования PHPUnit в Laravel. Кроме того, не забывайте о нашем методе <code>prepareTests</code>, который будет выполняться перед каждым тестом.</p> <pre class="brush: php noskimlinks noskimwords">    public function test_relation_with_author()    {        // Instantiate, fill with values, save and return        $post = FactoryMuff::create("Post");        // Thanks to FactoryMuff, this $post have an author        $this-&gt;assertEquals( $post-&gt;author_id, $post-&gt;author-&gt;id );    }</pre> <p>Этот тест является «необязательным». Мы проверяем, что отношение «<code>Post</code> принадлежит <code>User</code>». Цель здесь - в основном продемонстрировать функциональность FactoryMuff.</p> <p>Когда класс <code>Post</code> имеет статический массив <code>$factory</code>, содержащий <code>"author_id" =&gt; "factory|User"</code> (обратите внимание на исходный код модели, показанный выше), FactoryMuff создает экземпляр нового <code>User</code>, который заполняет его атрибуты, сохраняет в базе данных и, наконец, возвращает его <code>author_id</code> атрибут в <code>Post</code>.</p> <p>Чтобы это было возможно, модель <code>User</code> должна иметь массив <code>$factory</code>, описывающий его поля.</p> <p>Обратите внимание, как вы можете получить доступ к отношениям <code>User</code> через <code>$post-&gt;author</code>. Например, мы можем получить доступ к <code>$post-&gt;author-&gt;username</code> или любому другому существующему пользовательскому атрибуту.</p> <p>Пакет <span>FactoryMuff</span> позволяет быстро создавать последовательные объекты для целей тестирования, соблюдая и создавая любые необходимые отношения. В этом случае, когда мы создаем <code>Post</code> с <code>FactoryMuff::create("Post")</code>, <code>User</code> также будет подготовлен и доступен.</p> <pre class="brush: php noskimlinks noskimwords">    public function test_posted_at()    {        // Instantiate, fill with values, save and return        $post = FactoryMuff::create("Post");        // Regular expression that represents d/m/Y pattern        $expected = "/\d{2}\/\d{2}\/\d{4}/";        // True if preg_match finds the pattern        $matches = ( preg_match($expected, $post-&gt;postedAt()) ) ? true : false;        $this-&gt;assertTrue( $matches );    }}</pre> <p>Чтобы закончить, мы определяем, следует ли строка, возвращаемая методом <code>publishAt()</code>,  формату «день/месяц/год». Для такой проверки мы используем регулярное выражение, если шаблон <code>\d{2}\/\d{2}\/\d{4}</code>(<em>"2 числа" + "bar" + "2 цифры" + "bar «+» 4 числа</em>»).</p> <blockquote><p>В качестве альтернативы мы могли бы использовать <span>assertRegExp</span> PHPUnit.</p></blockquote> <p>На этом этапе файл <code>app/tests/models/PostTest.php</code> выглядит следующим образом:</p> <pre class="brush: php noskimlinks noskimwords">// app/tests/models/PostTest.php&lt;?phpuse Zizaco\FactoryMuff\Facade\FactoryMuff;class PostTest extends TestCase{    public function test_relation_with_author()    {        // Instantiate, fill with values, save and return        $post = FactoryMuff::create("Post");        // Thanks to FactoryMuff this $post have an author        $this-&gt;assertEquals( $post-&gt;author_id, $post-&gt;author-&gt;id );    }    public function test_posted_at()    {        // Instantiate, fill with values, save and return        $post = FactoryMuff::create("Post");        // Regular expression that represents d/m/Y pattern        $expected = "/\d{2}\/\d{2}\/\d{4}/";        // True if preg_match finds the pattern        $matches = ( preg_match($expected, $post-&gt;postedAt()) ) ? true : false;        $this-&gt;assertTrue( $matches );    }}</pre> <blockquote> <p>PS: Я решил не писать названия тестов в CamelCase для удобства чтения. PSR-1 простите меня, но <code>testRelationWithAuthor</code> не так читается, как я бы предпочел лично. Конечно, вы можете использовать стиль, который вам больше всего нравится.</p> </blockquote> <h3>Модель Page</h3> <p>Нашей <span>CMS</span> нужна модель для представления статических страниц. Эта модель реализована следующим образом:</p> <pre class="brush: php noskimlinks noskimwords">&lt;?php// app/models/Page.phpuse LaravelBook\Ardent\Ardent;class Page extends Ardent {    /**     * Table     */    protected $table = "pages";    /**     * Ardent validation rules     */    public static $rules = array(        "title" =&gt; "required",              // Page Title        "slug" =&gt; "required|alpha_dash",    // Slug (url)        "content" =&gt; "required",            // Content (markdown)        "author_id" =&gt; "required|numeric",  // Author id    );    /**     * Array used by FactoryMuff     */    public static $factory = array(        "title" =&gt; "string",        "slug" =&gt; "string",        "content" =&gt; "text",        "author_id" =&gt; "factory|User",  // Will be the id of an existent User.    );    /**     * Belongs to user     */    public function author()    {        return $this-&gt;belongsTo( "User", "author_id" );    }    /**     * Renders the menu using cache     *     * @return string Html for page links.     */    public static function renderMenu()    {        $pages = Cache::rememberForever("pages_for_menu", function()        {            return Page::select(array("title","slug"))-&gt;get()-&gt;toArray();        });        $result = "";        foreach( $pages as $page )        {            $result .= HTML::action( "PagesController@show", $page["title"], ["slug"=&gt;$page["slug"]] )." | ";        }        return $result;    }    /**     * Forget cache when saved     */    public function afterSave( $success )    {        if( $success )            Cache::forget("pages_for_menu");    }    /**     * Forget cache when deleted     */    public function delete()    {        parent::delete();        Cache::forget("pages_for_menu");    }}</pre> <p>Мы можем заметить, что статический метод <code>renderMenu()</code> предоставляет ряд ссылок для всех существующих страниц. Это значение сохраняется в кеше под ключом  <code>"pages_for_menu"</code>. Таким образом, в будущем вызовы <code>renderMenu()</code> не будут нуждаться в реальной базе данных. Это может значительно улучшить производительность нашего приложения.</p> <p>Однако, если <code>Page</code> сохранена или удалена (методы <code>afterSave()</code> и <code>delete()</code>), значение кеша будет очищено, в результате <code>renderMenu()</code> будет отражать новое состояние базы данных. Итак, если имя страницы изменено или если оно удалено, ключ «<code>pages_for_menu</code>» очищается из кеша. (<code>Cache::forget( "pages_for_menu");</code>)</p> <blockquote> <p>ПРИМЕЧАНИЕ. Метод <code>afterSave()</code> доступен через пакет <span>Ardent</span>. В противном случае было бы необходимо реализовать метод <code>save()</code> для очистки кеша и вызвать <code>parent::save()</code>;</p> </blockquote> <h3>Тестирование Page</h3> <p>В: <code>app/tests/models/PageTest.php</code>, мы напишем следующие тесты:</p> <pre class="brush: php noskimlinks noskimwords">&lt;?php// app/tests/models/PageTest.phpuse Zizaco\FactoryMuff\Facade\FactoryMuff;class PageTest extends TestCase{    public function test_get_author()    {        $page = FactoryMuff::create("Page");        $this-&gt;assertEquals( $page-&gt;author_id, $page-&gt;author-&gt;id );    }</pre> <p>Еще раз, у нас есть «необязательный» тест, подтверждающий отношения. Поскольку отношениями являются <code>Illuminate\Database\Eloquent</code>, которые уже охвачены собственными тестами Laravel, нам не нужно писать еще один тест, чтобы подтвердить, что этот код работает так, как ожидалось. </p> <pre class="brush: php noskimlinks noskimwords">    public function test_render_menu()    {        $pages = array();        for ($i=0; $i &lt; 4; $i++) {            $pages[] = FactoryMuff::create("Page");        }        $result = Page::renderMenu();        foreach ($pages as $page)        {            // Check if each page slug(url) is present in the menu rendered.            $this-&gt;assertGreaterThan(0, strpos($result, $page-&gt;slug));        }        // Check if cache has been written        $this-&gt;assertNotNull(Cache::get("pages_for_menu"));    }</pre> <p>Это один из самых важных тестов для модели <code>Page</code>. Сначала в цикле <code>for</code> создаются четыре страницы. После этого результат вызова <code>renderMenu()</code> сохраняется в переменной <code>$result</code>. Эта переменная должна содержать строку HTML, содержащую ссылки на существующие страницы.</p> <p>Цикл <code>foreach</code> проверяет, присутствует ли слаг (url) каждой страницы в <code>$result</code>. Этого достаточно, поскольку точный формат HTML не имеет отношения к нашим потребностям.</p> <p>Наконец, мы определяем, хранит ли кэш какие-нибудь данные по ключу <code>pages_for_menu</code>. Другими словами, действительно ли вызов <code>renderMenu()</code> фактически сохранил некоторое значение в кеше?</p> <pre class="brush: php noskimlinks noskimwords">    public function test_clear_cache_after_save()    {        // An test value is saved in cache        Cache::put("pages_for_menu","avalue", 5);        // This should clean the value in cache        $page = FactoryMuff::create("Page");        $this-&gt;assertNull(Cache::get("pages_for_menu"));    }</pre> <p>Этот тест предназначен для проверки того, сохраняется ли при сохранении новой <code>Page</code> ключ кеша <code>"pages_for_menu"</code>. <code>FactoryMuff::create("Page");</code> в конечном итоге вызывает метод <code>save()</code>, поэтому для ключа должно быть достаточно <code>pages_for_menu</code>, которое должно быть очищено.</p> <pre class="brush: php noskimlinks noskimwords">    public function test_clear_cache_after_delete()    {        $page = FactoryMuff::create("Page");        // An test value is saved in cache        Cache::put("pages_for_menu","value", 5);        // This should clean the value in cache        $page-&gt;delete();        $this-&gt;assertNull(Cache::get("pages_for_menu"));    }</pre> <p>Как и в предыдущем тесте, это определяет, правильно ли освобождается ключ <code>"pages_for_menu"</code> после удаления <code>Page</code>.</p> <p>Ваш <code>PageTest.php</code> должен выглядеть так:</p> <pre class="brush: php noskimlinks noskimwords">&lt;?php// app/tests/models/PageTest.phpuse Zizaco\FactoryMuff\Facade\FactoryMuff;class PageTest extends TestCase{    public function test_get_author()    {        $page = FactoryMuff::create("Page");        $this-&gt;assertEquals( $page-&gt;author_id, $page-&gt;author-&gt;id );    }    public function test_render_menu()    {        $pages = array();        for ($i=0; $i &lt; 4; $i++) {            $pages[] = FactoryMuff::create("Page");        }        $result = Page::renderMenu();        foreach ($pages as $page)        {            // Check if each page slug(url) is present in the menu rendered.            $this-&gt;assertGreaterThan(0, strpos($result, $page-&gt;slug));        }        // Check if cache has been written        $this-&gt;assertNotNull(Cache::get("pages_for_menu"));    }    public function test_clear_cache_after_save()    {        // An test value is saved in cache        Cache::put("pages_for_menu","avalue", 5);        // This should clean the value in cache        $page = FactoryMuff::create("Page");        $this-&gt;assertNull(Cache::get("pages_for_menu"));    }    public function test_clear_cache_after_delete()    {        $page = FactoryMuff::create("Page");        // An test value is saved in cache        Cache::put("pages_for_menu","value", 5);        // This should clean the value in cache        $page-&gt;delete();        $this-&gt;assertNull(Cache::get("pages_for_menu"));    }}</pre> <h3>Модель User</h3> <p>В связи с ранее представленными моделями у нас теперь есть <code>User</code>. Вот код для этой модели:</p> <pre class="brush: php noskimlinks noskimwords">&lt;?php// app/models/User.phpuse Zizaco\Confide\ConfideUser;class User extends ConfideUser {    // Array used in FactoryMuff    public static $factory = array(        "username" =&gt; "string",        "email" =&gt; "email",        "password" =&gt; "123123",        "password_confirmation" =&gt; "123123",    );    /**     * Has many pages     */    public function pages()    {        return $this-&gt;hasMany( "Page", "author_id" );    }    /**     * Has many posts     */    public function posts()    {        return $this-&gt;hasMany( "Post", "author_id" );    }}</pre> <p><strong>Эта модель отсутствует в тестах.</strong></p> <p>Мы можем заметить, что, за исключением отношений (которые могут быть полезны для тестирования), здесь нет никакой реализации. Как насчет аутентификации? Ну, использование пакета <span>Confide</span> уже обеспечивает реализацию и тесты для этого.</p> <blockquote> <p>Тесты для <code>Zizaco\Confide\ConfideUser</code> расположены в <span>ConfideUserTest.php</span>.</p> </blockquote> <p>Перед написанием тестов важно определить обязанности класса. Тестирование опции «<em>сброса пароля</em>» <code>User</code> будет избыточным. Это связано с тем, что надлежащая ответственность за этот тест принадлежит <code>Zizaco\Confide\ConfideUser</code>; а не  <code>User</code>.</p> <p>То же самое верно для тестов проверки данных. Поскольку пакет, <span>Ardent</span>, справляется с этой ответственностью, не имеет смысла снова тестировать эту функциональность.</p> <div> <p><strong>Короче говоря</strong>: держите свои тесты в чистоте и организованности. Определите надлежащую ответственность каждого класса и проверяйте только то, что является его ответственностью.</p> </div> <hr><h2>Вывод</h2> <div><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://dl.dropbox.com/u/12506137/libs_bundles/test_model_in_action.png" class="lazy07" alt="Тестирование в Laravel: Модели..." title="Тестирование в Laravel: Модели..." width="50" height="50"></div> <p>Использование базы данных в памяти - хорошая практика для быстрого выполнения тестов с базой данных. Благодаря помощи некоторых пакетов, таких как <span>Ardent</span>, <span>FactoryMuff</span> и <span>Confide</span>, вы можете минимизировать количество кода в своих моделях, сохраняя при этом тесты чистыми и объективными.</p> <p>В продолжении этой статьи мы рассмотрим тестирование <strong>контроллера</strong>. Будьте на связи!</p> <p><em><span>Все еще новичок в Laravel 4</span>, давайте научим вас основам!</em></p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="PHP" href="https://norma-studio.github.io/article5/220825590-testirovanie-v-laravel-modeli" class="tm-article-body__tags-item-link">PHP</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
39054</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
593</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
