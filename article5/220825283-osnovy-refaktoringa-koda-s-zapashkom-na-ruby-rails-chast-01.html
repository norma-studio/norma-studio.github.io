
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное....">
<meta property="og:description" content="Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное....">
<meta name="twitter:description" content="Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное....">
<meta property="aiturec:description" content="Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html" title="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io" title="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/636534636.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html" class="tm-user-info__username" title="
С. Новичков" aria-label="
С. Новичков">
С. Новичков</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01" class="tm-article-snippet__hubs-item-link"><span>Ruby on Rails</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png">
    <meta itemprop="headline name" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25261%2Fimage-1455803561842.png" alt="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01..." title="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 01..." width="50" height="50"></figure><h2>Темы</h2><ul><li>Основы</li> <li>Сопротивление</li> <li>Большой класс / Божественный класс</li> <li>Извлечение класса</li> <li>Длинный метод</li> <li>Длинный список параметров</li> </ul><h2>Основы</h2> <p>Следующая короткая серия статей предназначена для Ruby разработчиков с небольшим опытом и новичков. У меня создалось впечатление, что «код с запашком» и его рефакторинг, может быть очень сложным и запугивающим для новичков, особенно если им не повезло с наставниками, которые могут превратить концепции программирования в что-то скучное.</p> <p>Я очевидно и сам побывал в таких ситуациях, я вспомнил, что было излишне туманно погружаться в «код с запашком» и рефакторинг.</p> <p>С одной стороны, авторы ожидают определенного уровня профессионализма и, следовательно, могут проявить себя не достаточно компетентно, чтобы предоставить читателю нужный контекст необходимый новичкам. Возможно, потребуется более комфортное погружение в этот мир чуть позже.</p> <p>Как следствие, возможно, у новичков, с другой стороны, создается впечатление, что им нужно немного подождать, пока они не станут более продвинутыми, чтобы познакомится с «кодом с запашком» и рефакторингом. Я не согласен с этим подходом, и считаю, что если сделать эту тему более доступной, то это поможет им лучше разрабатывать программное обеспечение в начале своей карьеры. По крайней мере, я надеюсь, что это поможет новичкам  получить качественный старт.</p> <p>Итак, о чем мы говорим, когда люди упоминают «код с запашком»? Это всегда проблема в коде? Не обязательно! Можете ли вы полностью их избежать? Я так не думаю! Вы имеете в виду «код с запашком», приводящий к поломке кода? Ну, иногда, а иногда и нет. Должно ли их исправление быть приоритетом? Тот же ответ, я боюсь: иногда да, а иногда вы, конечно, должны сначала обжарить большую рыбу. Вы ненормальный? Справедливый вопрос на этом этапе!</p> <p>Прежде чем продолжить погружение в этот весь бизнес, не забудьте одно: не пытайтесь исправить каждый «код с запашком», с которым вы сталкиваетесь — это, безусловно, пустая трата времени!</p> <p>Мне кажется, что код с запашком немного сложнее обернуть в красивою коробку. Есть всевозможный «код с запашком» с различными вариантами их исправления. Кроме того, разные языки программирования и структуры склонны к разным видам запашков, но среди них определенно много общих «генетических» штаммов. Моя попытка описать «код с запашком» - сравнить их с медицинскими симптомами, которые говорят вам, что у вас может быть проблема. Они могут указывать на всевозможные скрытые проблемы и иметь широкий спектр решений при диагностике.</p> <p>К счастью, они в целом не так сложны, как работа с человеческим телом и психикой. Это подходящее сравнение, хотя, поскольку некоторые из этих симптомов нужно лечить сразу, а некоторые другие дают вам достаточно времени, чтобы придумать решение, которое лучше всего подходит для общего благополучия пациента. Если у вас есть рабочий код, и вы сталкиваетесь с чем-то пахнущим, вам придется принять не простое решение, стоит ли производить фиксы, и улучшит ли этот рефакторинг стабильность вашего приложения.</p> <p>При этом, если вы наткнетесь на код, который вы можете улучшить сразу, это хорошее решение, чтобы держать код немного лучше, чем раньше, — даже крошечный кусочек лучше складывается со временем.</p> <h2>Сопротивление</h2> <p>Качество вашего кода становится сомнительным, если включение нового кода становится более сложным, если решение, куда добавлять новый код, это боль или, например, множество эффектов пульсации на всей вашей кодовой базе. Это называется сопротивлением.</p> <p>В качестве ориентира для качества кода, вы всегда можете взять его легкость введения изменений. Если это становится все труднее и труднее, то настало время для реорганизации и более серьезного использования последней части <em>Red-green-REFACTOR</em> в будущем.</p> <h2>Большой класс / Божественные классы</h2> <p>Начнем с чего-то фантастический звучащего — «Божественные классы», я думаю, что их особенно легко понять новичкам. Божественные классы - это особый случай «кода с запашком», называемого <em>Большими классами</em>. В этом разделе я расскажу об обоих. Если вы потратили немного времени на Rails, вы, вероятно, видели их так часто, что они выглядят нормальными для вас.</p> <p>Вы наверняка помните мантру «толстые модели, тонкие контроллеры»? Ну, на самом деле, тонкий, это хорошо для всех этих классов, но, я полагаю, как правило, это хороший совет для новичков.</p> <p>Божественные классы — это объекты, которые поглощают всевозможные знания и поведение, как черная дыра. Ваши обычные предположения чаще всего включают модель пользователя и любую проблему (надеюсь,!), Которую ваше приложение пытается решить - в первую очередь, по крайней мере. Приложение todo может состоять из модели <em>Todos</em>, приложение для покупок на <em>Products</em>, приложение для фотографий на <em>Photos</em> - вы получаете тенденцию.</p> <p>Люди называют их «божественными классами», потому что они слишком много знают. У них слишком много связей с другими классами — в основном потому, что кто-то лениво их моделировал. Однако тяжелая работа заключается в том, чтобы держать «божественные классы» под контролем. Они легко поддаются снятию с них большой обязанности и как свидетельствуют многие греческие герои, требуется разделить и победить «богов».</p> <p>Проблема с ними заключается в том, что их становится все труднее и труднее понять, особенно для новыми членами команды, их сложнее изменить, и их повторное использование становится все менее и менее доступным. О да, вы правы, ваши тесты излишне сложнее писать. Короче говоря, на самом деле нет причины к тому, чтобы иметь большие классы и, в частности, «божественные классы».</p> <p>Есть пара общих симптомов/признаков того, что вашему классу нужны какие-то изменения:</p> <ul><li>Вам нужно много скроллить!</li> <li>Имеется тонна приватных методов?</li> <li>В вашем классе есть семь или более методов?</li> <li>Трудно сказать, что делает ваш класс на самом деле - в краткой форме!</li> <li>У вашего класса есть много причин для изменения, когда ваш код развивается?</li> </ul><p>Кроме того, если вы прищуриваетесь глядя на свой класс и думаете: «а? Фу!» вы так-же можете что-то предпринять. Если все это звучит знакомо, есть хорошие шансы, что вы нашли себе прекрасный образец.</p> <pre class="brush: ruby noskimlinks noskimwords">class CastingInviter  EMAIL_REGEX = /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/  attr_reader :message, :invitees, :casting  def initialize(attributes = {})    @message  = attributes[:message]  || ""  @invitees = attributes[:invitees] || ""  @sender   = attributes[:sender]  @casting  = attributes[:casting]enddef valid?  valid_message? &amp;&amp; valid_invitees?enddef deliver    if valid?      invitee_list.each do |email|        invitation = create_invitation(email)        Mailer.invitation_notification(invitation, @message)      end  else    failure_message  = "Your #{ @casting } message couldn’t be sent. Invitees emails or message are invalid"    invitation = create_invitation(@sender)      Mailer.invitation_notification(invitation, failure_message )  endendprivatedef invalid_invitees  @invalid_invitees ||= invitee_list.map do |item|      unless item.match(EMAIL_REGEX)      item    end  end.compactenddef invitee_list  @invitee_list ||= @invitees.gsub(/\s+/, "").split(/[\n,;]+/)enddef valid_message?  @message.present?enddef valid_invitees?  invalid_invitees.empty?end  def create_invitation(email)    Invitation.create(      casting:       @casting,      sender:        @sender,      invitee_email: email,      status:        "pending"    )  endend</pre> <p>Уродливо, да? Можете ли вы увидеть, сколько здесь гадости? Конечно, я положил немного вишни сверху, но рано или поздно вы столкнетесь с таким кодом. Давайте подумаем о том, какие обязанности этот класс <code class="inline">CastingInviter</code> должен выполнять.</p> <ul><li>Отправка электронной почты</li> <li>Валидация сообщений и адресов электронной почты</li> <li>Избавление от пробелов</li> <li>Разделение адресов электронной почты на запятые и точки с запятой</li> </ul><p>Следует ли все это сбрасывать на класс, который просто хочет доставить кастинг через <code class="inline">deliver</code>? Конечно нет! Если ваш метод внесения приглашений изменится, вы можете рассчитывать на то, что вы столкнетесь с некоторыми <span>операциями с дробовиком</span>. CastingInviter не должен знать большинстве этих деталей. Это больше зависит от класса, который специализируется на работе с материалами, связанными с электронной почтой. В будущем вы найдете много причин изменить здесь код.</p> <h3>Извлечение класса</h3> <p>Итак, как мы должны справляться с этим? Часто, извлечение класса — это удобный шаблон рефакторинга, который будет представлять собой разумное решение таких проблем, как большие запутанные классы — особенно если рассматриваемый класс имеет несколько обязанностей.</p> <p>Приватные методы часто являются хорошими кандидатами для начала — и легкими для оценки. Иногда вам нужно вывести более одного класса из такого плохого мальчика — просто не делайте этого всего за один шаг. Как только вы найдете достаточно когерентного мяса, которое, по-видимому, принадлежит самому специализированному объекту, вы можете извлечь эту функциональность в новый класс.</p> <p>Вы создаете новый класс, и постепенно перемещаете функциональные возможности один за другим. Перемещайте каждый метод отдельно и переименуйте их, если на это есть причина. Затем укажите новый класс в оригинале и делегируйте необходимые функции. Хорошо, что у вас есть покрытие тестами (надеюсь!), Которое позволяет вам проверять, все ли работает на каждом шагу. Стремитесь к тому, чтобы повторно использовать извлеченные классы. Это легче понять на практике, поэтому давайте прочитаем код:</p> <pre class="brush: ruby noskimlinks noskimwords">class CastingInviter  attr_reader :message, :invitees, :casting  def initialize(attributes = {})    @message  = attributes[:message]  || ""    @invitees = attributes[:invitees] || ""    @casting  = attributes[:casting]    @sender   = attributes[:sender]  end    def valid?    casting_email_handler.valid?  end    def deliver    casting_email_handler.deliver  end    private    def casting_email_handler    @casting_email_handler ||= CastingEmailHandler.new(      message:  message,       invitees: invitees,       casting:  casting,       sender:   @sender    )  endend</pre> <pre class="brush: ruby noskimlinks noskimwords">class CastingEmailHandler   EMAIL_REGEX = /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/  def initialize(attr = {})    @message  = attr[:message]  || ""    @invitees = attr[:invitees] || ""    @casting  = attr[:casting]    @sender   = attr[:sender]  end  def valid?    valid_message? &amp;&amp; valid_invitees?  end  def deliver    if valid?      invitee_list.each do |email|        invitation = create_invitation(email)        Mailer.invitation_notification(invitation, @message)      end    else      failure_message  = "Your #{ @casting } message couldn’t be sent. Invitees emails or message are invalid"      invitation = create_invitation(@sender)      Mailer.invitation_notification(invitation, failure_message )    end  end  private  def invalid_invitees    @invalid_invitees ||= invitee_list.map do |item|      unless item.match(EMAIL_REGEX)        item      end    end.compact  end  def invitee_list    @invitee_list ||= @invitees.gsub(/\s+/, "").split(/[\n,;]+/)  end    def valid_invitees?    invalid_invitees.empty?  end    def valid_message?    @message.present?  end  def create_invitation(email)    Invitation.create(      casting:       @casting,      sender:        @sender,      invitee_email: email,      status:        "pending"    )  endend</pre> <p>В этом решении вы не только увидите, как разделение ответственности влияет на качество вашего кода, код читается намного лучше и становится легче поддерживаемым.</p> <p>Здесь мы делегируем методы новому классу, который специализируется на доставке этих приглашений по электронной почте. У вас есть одно определенное место, которое проверяет правильность сообщений, приглашений и их доставку. <code class="inline">CastingInviter</code> не нужно ничего знать об этих деталях, поэтому мы делегируем эти обязанности новому классу <code class="inline">CastingEmailHandler</code>.</p> <p>Знание того, как доставлять и проверять достоверность этих писем с приглашением, теперь содержится в нашем новом извлеченном классе. У нас теперь больше кода? Стоит ли разделять код на области ответственности? Будьте уверенны! Можем ли мы выйти за рамки этого и реорганизовать <code class="inline">CastingEmailHandler</code>? Абсолютно! Не в чем себе не отказывайте!</p> <p>В случае, если вы волнуетесь о <code class="inline">valid?</code> метод в <code class="inline">CastingEmailHandler</code> и <code class="inline">CastingInviter</code>, это заготовка для RSpec, которая нужна для создания пользовательского матчера. Это позволяет написать что-то вроде:</p> <pre class="brush: ruby noskimlinks noskimwords">expect(casting_inviter).to be_valid</pre> <p>Мне кажется, это очень удобно.</p> <p>Существует больше техник для работы с объектами больших классов / «божественных классов», и в ходе этой серии вы узнаете несколько способов реорганизации таких объектов.</p> <p>Нет никакого конкретного рецепта для решения этих задач — это всегда зависит от предпочтений. Инкрементные методы рефакторинга лучше всего соответствуют этим задачам. Я знаю, это немного расстраивает время от времени. Однако, если следовать <span>принципу единой ответственности</span> (SRP), это будет долгий путь, и это хороший путь.</p> <h2>Длинный метод</h2> <p>Наличие методов, которые получили немного большие, является одним из самых распространенных явлений, с которыми вы сталкиваетесь как разработчик. В общем, вы хотите знать с первого взгляда, что делает метод. Он также должен иметь только один уровень вложенности или один уровень абстракции. Короче говоря, избегайте написание сложных методов.</p> <p>Я знаю, что это звучит сложно, и это часто происходит. Решение, которое часто возникает, заключается в извлечении частей метода в одну или несколько новых функций. Этот метод рефакторинга называется <em>извлечение метода</em> - он один из самых простых, но тем не менее очень эффективный. Как хороший побочный эффект, ваш код становится более читаемым, если вы назовете ваши методы соответствующим образом.</p> <p>Давайте рассмотрим спецификации функций, в которых вам понадобится эта техника. Я помню, как я познакомился с <em>извлечением метода</em> при написании таких спецификаций, и насколько это удивительно, когда лампочка продолжала гореть. Поскольку спецификации функций, подобные этому, легко понять, они являются хорошим кандидатом на демонстрацию. Кроме того, вы будете сталкиваться с подобными сценариями снова и снова при написании своих спецификаций.</p> <p><strong>spec/features/some_feature_spec.rb</strong></p> <pre class="brush: ruby noskimlinks noskimwords">require "rails_helper"feature "M marks mission as complete" do  scenario "successfully" do    visit_root_path    fill_in      "Email", with: "M@mi6.com"    click_button "Submit"    visit missions_path    click_on     "Create Mission"     fill_in      "Mission Name", with: "Project Moonraker"    click_button "Submit"    within "li:contains("Project Moonraker")" do      click_on "Mission completed"    end    expect(page).to have_css "ul.missions li.mission-name.completed", text: "Project Moonraker"  endend</pre> <p>Как вы можете видеть, в этом сценарии много чего происходит. Вы переходите на индексную страницу, входите в систему и создаете миссию для установки, а затем выполняете ее, отмечая миссию как завершенную, и, наконец, проверяете поведение. Никакого рокет сайнс, но также нет ясности и определенно не составлено для повторного использования. Мы можем сделать лучше:</p> <p><strong>spec/features/some_feature_spec.rb</strong></p> <pre class="brush: ruby noskimlinks noskimwords">require "rails_helper"feature "M marks mission as complete" do  scenario "successfully" do    sign_in_as "M@mi6.com"    create_classified_mission_named "Project Moonraker"      mark_mission_as_complete        "Project Moonraker"      agent_sees_completed_mission    "Project Moonraker"  endend  def create_classified_mission_named(mission_name)visit missions_pathclick_on     "Create Mission" fill_in      "Mission Name", with: mission_nameclick_button "Submit"enddef mark_mission_as_complete(mission_name)within "li:contains("#{mission_name}")" do  click_on "Mission completed"endenddef agent_sees_completed_mission(mission_name)expect(page).to have_css "ul.missions li.mission-name.completed", text: mission_nameenddef sign_in_as(email)visit root_pathfill_in      "Email", with: emailclick_button "Submit"end</pre> <p>Здесь мы извлекли четыре метода, которые можно легко использовать повторно в других тестах. Надеюсь, ясно, что мы сбили три птицы одним камнем. Функция более сжата, она читается лучше, и она состоит из извлеченных компонентов без дублирования.</p> <p>Представим себе, что вы написали все подобные сценарии, не извлекая эти методы, и вы хотели бы изменить некоторую реализацию. Теперь вы хотите уделить время на реорганизацию своих тестов и имеете одно центральное место для применения ваших изменений.</p> <p>Конечно, есть еще лучший способ справиться с такими спецификациями, как Page Objects, например, но это не для нашего сегодняшнего обсуждения. Я думаю, это все, что вам нужно знать об извлечении методов. Вы можете применить этот шаблон рефакторинга везде в своем коде, и конечно, не только в спецификациях. С точки зрения частоты использования, я предполагаю, что это будет ваша техника номер один для улучшения качество вашего кода. Время повеселится!</p> <h2>Длинный список параметров</h2> <p>Давайте закончим эту статью на примере того, как вы можете уменьшить количество своих параметров. Это становится довольно утомительным, когда вам приходится передавать своим методам более чем один или два аргумента. Разве было бы неплохо, если бы это был один объект? Это именно то, что вы можете сделать, если ввести <em>объект параметр</em>.</p> <p>Все эти параметры — это не только возня, с тем чтобы писать и сохранять порядок, но это также может привести к дублированию кода — и мы, конечно, хотим избежать этого, где это возможно. Мне особенно нравится эта техника рефакторинга, так как она влияет и на другие методы внутри. Вы часто можете избавиться от большого количества нежелательных продуктов в пищевой цепочки.</p> <p>Давайте рассмотрим этот простой пример. M может назначить новую миссию и ему нужно имя миссии, агент и цели. M также может переключать статус агента double 0, что означает лицензию на убийство.</p> <pre class="brush: ruby noskimlinks noskimwords">class M  def assign_new_mission(mission_name, agent_name, objective, licence_to_kill: nil)    print "Mission #{mission_name} has been assigned to #{agent_name} with the objective to #{objective}."    if licence_to_kill      print " The licence to kill has been granted."    else      print "The licence to kill has not been granted."    end  endendm = M.newm.assign_new_mission("Octopussy", "James Bond", "find the nuclear device", licence_to_kill: true)# =&gt; Mission Octopussy has been assigned to James Bond with the objective to find the nuclear device. The licence to kill has been granted. </pre> <p>Когда вы смотрите на это и спрашиваете, что происходит, когда «параметры» миссии растут по сложности, вы уже готовы на что-то. Это болевая точка, которую вы можете устранить только в том случае, если вы передадите один объект, который имеет всю необходимую информацию. Чаще всего это также помогает вам избегать изменения метода, если по какой-либо причине изменяется объект параметра.</p> <pre class="brush: ruby noskimlinks noskimwords">class Mission  attr_reader :mission_name, :agent_name, :objective, :licence_to_kill  def initialize(mission_name: mission_name, agent_name: agent_name, objective: objective, licence_to_kill: licence_to_kill)  @mission_name    = mission_name  @agent_name      = agent_name  @objective       = objective  @licence_to_kill = licence_to_killenddef assign  print "Mission #{mission_name} has been assigned to #{agent_name} with the objective to #{objective}."  if licence_to_kill    print " The licence to kill has been granted."  else    print " The licence to kill has not been granted."  endendendclass M  def assign_new_mission(mission)  mission.assignendendm = M.newmission = Mission.new(mission_name: "Octopussy", agent_name: "James Bond", objective: "find the nuclear device", licence_to_kill: true)m.assign_new_mission(mission)# =&gt; Mission Octopussy has been assigned to James Bond with the objective to find the nuclear device. The licence to kill has been granted.</pre> <p>Таким образом, мы создали новый объект, <code class="inline">Mission</code>, который сосредоточен исключительно на предоставлении <code class="inline">M</code> информации, необходимой для назначения новой миссии и предоставления <code class="inline">#assign_new_mission</code> с уникальным параметром объекта. Не нужно передавать их в виде надоедливых параметров. Вместо этого вы сообщаете объекту, чтобы он раскрывал необходимую информацию внутри самого метода. Кроме того, мы также извлекли некоторое поведение — информацию о том, как печатать новый объект <code class="inline">Mission</code>.</p> <p>Зачем <code class="inline">M</code> нужно знать о том, как печатать назначения миссий? Новый <code class="inline">#assign</code> также выиграл от извлечения, потеряв некоторый вес, потому что нам не нужно было передавать объект параметра, поэтому не нужно писать такие вещи, как <code class="inline">mission.mission_name</code>, <code class="inline">mission.agent_name</code> и т.д. Теперь мы просто используем наш <code class="inline">attr_reader</code>(s), который намного чище, чем без извлечения. Вы углубляетесь?</p> <p>Что также удобно тем, что <code class="inline">Mission</code> может собирать всевозможные дополнительные методы или состояния, которые хорошо инкапсулированы в одном месте и готовы для вас получить доступ.</p> <p>С помощью этой методики вы получите методы, которые более кратки, лучше читаются и избегают повторений одной и той же группы параметров по всей кодовой базе. Довольно хорошая работа! Избавление от идентичных групп параметров также является важной стратегией для DRY-кода.</p> <p>Попытайтесь найти больше, чем просто ваши данные. Если вы можете разместить поведение в новом классе, у вас будут объекты, которые более полезны, иначе они быстро превратятся в «код с запашком».</p> <p>Конечно, большую часть времени вы будите сталкиваться с более сложными вариантами — и ваши тесты, безусловно, также должны быть одновременно адаптированы во время таких рефакторингов, но если у вас есть этот простой пример под рукой, вы будете готовы к действию.</p> <p>Теперь я собираюсь посмотреть нового Бонда. Слышал, что он не так хорош, хотя...</p> <p>Обновление: Saw Specter. Мой вердикт: по сравнению с Skyfall, который был не очень имхо — Spectre, был wawawiwa!</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825283-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-01" class="tm-article-body__tags-item-link">Ruby on Rails</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
41073</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
521</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
