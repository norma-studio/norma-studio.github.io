
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных...">
<meta property="og:description" content="Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных...">
<meta name="twitter:description" content="Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных...">
<meta property="aiturec:description" content="Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html" title="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io" title="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/543234456.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html" class="tm-user-info__username" title="
А. Гаврилов" aria-label="
А. Гаврилов">
А. Гаврилов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Создаем CMS: nodePress...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="CMS" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress" class="tm-article-snippet__hubs-item-link"><span>CMS</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg">
    <meta itemprop="headline name" content="Создаем CMS: nodePress... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Вы уже успешно создали CMS (* content management system – система управления содержимым; ПО для организации совместных работ по созданию документов и другого контента. Здесь и далее примеч. пер.), работающую на основе плоской файловой системы (* система организации файлов, при которой они не могут иметь одинаковых имен, если даже находятся в разных каталогах), при помощи <span>Go</span>. Следующий шаг – реализовать то же при помощи <span>Node.js</span>. Я покажу вам, как загрузить библиотеки, создать и запустить сервер.</p><p>В этой CMS мы будем использовать ту структуру данных сайта, которая была показана в первом руководстве, <span>«Building a CMS: Structure and Styling»</span>. Поэтому скачайте и распакуйте архив с этой базовой структурой в пустую директорию.</p> <h2>Устанавливаем Node и библиотеки для нее:</h2> <p>Простейший способ установить Node.js на Mac – при помощи <span>Homebrew </span>(* наиболее популярный пакетный менеджер для Mac). Если Homebrew у вас еще не установлен, то можете посмотреть, как это сделать, в руководстве <span>«Homebrew Demystified: OS X’s Ultimate Package Manager»</span>.</p> <p>Для установки Node.js при помощи Homebrew выполните следующую команду в командной строке:</p><pre class="brush: bash noskimlinks noskimwords">brew install node</pre> <p>После ее выполнения на вашем Mac станут доступны все команды с node и npm. Для установки Node.js на все остальные платформы придерживайтесь инструкций, приведенных на веб-сайте Node.js.</p> <p>Будьте осторожны: многие пакетные менеджеры в данный момент устанавливают Node.js версии 0.10. В этом руководстве предполагается, что вы используете версию 5.3 или более новую. Вы можете проверить, какую версию вы используете при помощи:</p><pre class="brush: bash noskimlinks noskimwords">node --version</pre> <p>При помощи команды с <code class="inline">node </code>запускается интерпретатор JavaScript. При помощи команды с <code class="inline">npm </code>в дело вступает пакетный менеджер Node.js для установки библиотек, создания новых проектов и запуска скриптов для проекта. На <span>Envato Tuts+</span> имеется множество замечательных руководств и курсов по Node.js и npm.</p> <p>Для установки библиотек для сервера вам необходимо выполнить следующие команды в программе Terminal.app или iTerm.app:</p><pre class="brush: bash noskimlinks noskimwords">npm install express --savenpm install handlebars --savenpm install moment --savenpm install marked --savenpm install jade --savenpm install morgan --save</pre> <p><span>Express </span>– фреймворк для разработки веб-приложений. Он подобен библиотеке goWeb в Go. <span>Handlebars </span>– шаблонизатор (* программное обеспечение для комбинирования шаблонов с моделью данных для получения конечных документов) для создания страниц. <span>Moment </span>– библиотека для работы с датами. <span>Marked </span>– отличный конвертер <span>Markdown </span>в HTML для JavaScript. <span>Jade </span>– уровень абстракции HTML для более простого создания HTML-страниц. <span>Morgan</span> – библиотека промежуточного программного обеспечения для Express, при помощи которой генерируются лог-файлы (* запись в журнале регистрации событий, фиксирующая действие и событие, произошедшее в компьютерной системе) <span>стандарта Apache</span> (* Common Log Format – общепринятый формат лог-файлов).</p> <p>Альтернативный вариант установки необходимых библиотек – <span>скачать исходные файлы для этого руководства</span>. После скачивания архива и его распаковки выполните следующую команду в главной папке проекта:</p><pre class="brush: bash noskimlinks noskimwords">npm --install</pre> <p>За счет нее будет установлено все, что необходимо для создания рассматриваемого тут проекта.</p> <h2>nodePress.js</h2> <p>Теперь мы можем приступить к созданию сервера. В корневой папке проекта создайте файл под названием nodePress.js, откройте его в своем любимом редакторе и начинайте добавлять туда следующий код. Я буду объяснять код по мере его добавления в файл.</p><pre class="brush: javascript noskimlinks noskimwords">//// Load the libraries used.//var fs = require("fs");var path = require("path");var child_process = require("child_process");var process = require("process");var express = require("express"); // http://expressjs.com/en/var morgan = require("morgan"); // https://github.com/expressjs/morganvar Handlebars = require("handlebars"); // http://handlebarsjs.com/var moment = require("moment"); // http://momentjs.com/var marked = require("marked"); // https://github.com/chjj/markedvar jade = require("jade"); // http://jade-lang.com/</pre> <p>Код начинается с подключения всех необходимых для реализации сервера библиотек. Библиотеки, для которых не указаны комментарии с веб-адресами, поставляются в составе самой платформы Node.js.</p><pre class="brush: javascript noskimlinks noskimwords">//// Setup Global Variables.//var parts = JSON.parse(fs.readFileSync("./server.json", "utf8"));var styleDir = process.cwd() + "/themes/styling/" + parts["CurrentStyling"];var layoutDir = process.cwd() + "/themes/layouts/" + parts["CurrentLayout"];var siteCSS = null;var siteScripts = null;var mainPage = null;</pre> <p>Затем я задаю значения всех глобальных переменных и настройки библиотеки. Подход с использованием глобальных переменных не относится к устоявшейся практике создания приложений, но работает и ускоряет процесс разработки.</p> <p>Переменная <code class="inline">parts </code>– хэш (* коллекция пар ключ-значение, причем ключом является строка), содержащий все части веб-страницы. Ее контент используется при создании каждой страницы. Контент этой переменной начинается с содержимого файла server.json, что находится в корневой паке сервера.</p> <p>Затем я использую информацию из файла server.json для создания полных путей к папкам <code class="inline">styles </code>и <code class="inline">layouts</code>, используемых для нашего сайта.</p> <p>Далее в качестве значений трех переменных (<code class="inline">siteCSS</code>, <code class="inline">siteScripts </code>и <code class="inline">mainPage</code>) задается null. В этих глобальных переменных будет содержаться контент всех файлов CSS, JavaScript и главной страницы. Эти три элемента запрашиваются наиболее часто на всех серверах. Поэтому за счет размещения их в памяти мы ускоряем работу сайта. Если значением свойства <code class="inline">Cache </code>в файле server.json является false, то эти элементы считываются заново при каждом запросе.</p><pre class="brush: javascript noskimlinks noskimwords">marked.setOptions({  renderer: new marked.Renderer(),  gfm: true,  tables: true,  breaks: false,  pedantic: false,  sanitize: false,  smartLists: true,  smartypants: false});</pre> <p>В этом коде настраивается библиотека Marked для получения HTML из Markdown. Главным образом, тут я активирую поддержку таблиц и «умных» списков (* smartList; список с поддержкой фильтров).</p><pre class="brush: javascript noskimlinks noskimwords">parts["layout"] = fs.readFileSync(layoutDir + "/template.html", "utf8");parts["404"] = fs.readFileSync(styleDir + "/404.html", "utf8");parts["footer"] = fs.readFileSync(styleDir + "/footer.html", "utf8");parts["header"] = fs.readFileSync(styleDir + "/header.html", "utf8");parts["sidebar"] = fs.readFileSync(styleDir + "/sidebar.html", "utf8");//// Read in the page parts.//var partFiles = fs.readdirSync(parts["Sitebase"] + "parts/");partFiles.forEach(function(ele, index, array) {   parts[path.basename(ele, path.extname(ele))] = figurePage(parts["Sitebase"] + "parts/" + path.basename(ele, path.extname(ele)));});</pre> <p>Затем в переменную <code class="inline">parts </code>добавляется контент папок <code class="inline">styles</code> и <code class="inline">layouts</code>. Контент каждого файла папки <code class="inline">parts</code>, что располагается в папке <code class="inline">site </code>также загружается в глобальную переменную <code class="inline">parts</code>. Имя файла без расширения – имя, используемое для сохранения контента файла. Эти имена заменяются набором инструкций в макросах (* (от греческого makros - большой, длинный) последовательность команд и/или нажатий клавиш, записанная макрорегистратором под уникальным именем. Эта последовательность затем может быть исполнена путём указания данного имени) Handlebars.</p><pre class="brush: javascript noskimlinks noskimwords">//// Setup Handlebar"s Helpers.////// HandleBars Helper:     save//// Description:   This helper expects a// "&lt;name&gt;" "&lt;value&gt;" where the name// is saved with the value for future// expansions. It also returns the// value directly.//Handlebars.registerHelper("save", function(name, text) {//// Local Variables.//var newName = "", newText = "";//// See if the name and text is in the first argument// with a |. If so, extract them properly. Otherwise,// use the name and text arguments as given.//if(name.indexOf("|") &gt; 0) {var parts = name.split("|");newName = parts[0];newText = parts[1];} else {newName = name;newText = text;}//// Register the new helper.//   Handlebars.registerHelper(newName, function() {      return newText;   });   //   // Return the text.   //   return newText;});//// HandleBars Helper: date//// Description: This helper returns the date// based on the format given.//Handlebars.registerHelper("date", function(dFormat) {   return moment().format(dFormat);});//// HandleBars Helper: cdate//// Description: This helper returns the date given//  in to a format based on the format//given.//Handlebars.registerHelper("cdate", function(cTime, dFormat) {   return moment(cTime).format(dFormat);});</pre> <p>В следующей части кода идет определение хелперов Handlebars, которые будем использовать в веб-сервере: <code class="inline">save</code>, <code class="inline">date</code> и <code class="inline">cdate</code>. В хелпере save предусматривается создание переменных на странице. Эта версия хелпера поддерживает версию CMS goPress, в которой в параметре одновременно присутствуют имя и значение вместе, разделенные при помощи “|”. Также можно задать используемые в хелпере значения при помощи двух параметров. Например:</p><pre class="brush: plain noskimlinks noskimwords">{{save "name|Richard Guay"}}{{save "newName" "Richard Guay"}}Name is: {{name}}newName is: {{newName}}</pre> <p>В обоих случаях получается одинаковый результат. Я предпочитаю использовать второй подход, однако в библиотеке Handlebars, используемой для Go не предусматривается передача более одного параметра.</p> <p>При помощи хелперов <code class="inline">date </code>и <code class="inline">cdate </code>форматируется текущее значение даты (<code class="inline">date</code>) или указанное (<code class="inline">cdate</code>) в соответствии с правилами форматирования, указанными в библиотеке <strong><span>moment.js</span></strong>. При использовании хелпера <code class="inline">cdate </code>предполагается, что подлежащая форматированию дата будет передана в качестве первого параметра в формате ISO 8601 (* международный стандарт, выданный организацией ISO (International Organization for Standardization – Международная организация по стандартизации), который описывает форматы дат и времени и дает рекомендации для его использования в международном контексте).</p><pre class="brush: javascript noskimlinks noskimwords">//// Create and configure the server.//var nodePress = express();//// Configure middleware.//nodePress.use(morgan("combined"))</pre> <p>Далее в коде создается образец Express для настройки собственно веб-сервера. При помощи функции <code>nodePress.use()</code> происходит настройка промежуточного программного обеспечения. Промежуточное программное обеспечение – любой код, который выполняется при каждом запросе к серверу. Тут я настраиваю библиотеку Morgan.js для получения необходимого формата записей в журнале регистрации событий.</p><pre class="brush: javascript noskimlinks noskimwords">//// Define the routes.//nodePress.get("/", function(request, response) {   setBasicHeader(response);   if((parts["Cache"] == true) &amp;&amp; (mainPage != null)) {       response.send(mainPage);   } else {   mainPage = page("main");   response.send(mainPage);   }});nodePress.get("/favicon.ico", function(request, response) {   var options = {      root: parts["Sitebase"] + "images/",      dotfiles: "deny",      headers: {         "x-timestamp": Date.now(),         "x-sent": true      }   };   response.set("Content-Type", "image/ico");   setBasicHeader(response);   response.sendFile("favicon.ico", options, function(err) {      if (err) {         console.log(err);         response.status(err.status).end();      } else {         console.log("Favicon was sent:", "favicon.ico");      }   });});nodePress.get("/stylesheets.css", function(request, response) {   response.set("Content-Type", "text/css");   setBasicHeader(response);   response.type("css");   if((parts["Cache"] == true) &amp;&amp; (siteCSS != null)) {   response.send(siteCSS);   } else {   siteCSS = fs.readFileSync(parts["Sitebase"] + "css/final/final.css");   response.send(siteCSS);   }});nodePress.get("/scripts.js", function(request, response) {   response.set("Content-Type", "text/javascript");   setBasicHeader(response);   if((parts["Cache"] == true) &amp;&amp; (siteScripts != null)) {   response.send(siteScripts);   } else {   siteScripts = fs.readFileSync(parts["Sitebase"] + "js/final/final.js", "utf8");   response.send(siteScripts);   }});nodePress.get("/images/:image", function(request, response) {   var options = {      root: parts["Sitebase"] + "images/",      dotfiles: "deny",      headers: {         "x-timestamp": Date.now(),         "x-sent": true      }   };   response.set("Content-Type", "image/" + path.extname(request.params.image).substr(1));   setBasicHeader(response);   response.sendFile(request.params.image, options, function(err) {      if (err) {         console.log(err);         response.status(err.status).end();      } else {         console.log("Image was sent:", request.params.image);      }   });});nodePress.get("/posts/blogs/:blog", function(request, response) {   setBasicHeader(response);   response.send(post("blogs", request.params.blog, "index"));});nodePress.get("/posts/blogs/:blog/:post", function(request, response) {   setBasicHeader(response);   response.send(post("blogs", request.params.blog, request.params.post));});nodePress.get("/posts/news/:news", function(request, response) {   setBasicHeader(response);   response.send(post("news", request.params.news, "index"));});nodePress.get("/posts/news/:news/:post", function(request, response) {   setBasicHeader(response);   response.send(post("news", request.params.news, request.params.post));});nodePress.get("/:page", function(request, response) {   setBasicHeader(response);   response.send(page(request.params.page));});</pre> <p>В этом разделе кода определяются все необходимые для реализации сервера маршруты. Во всех маршрутах выполняется функция <code>setBasicHeader() </code>для установки необходимых значений заголовков. В результате любых запросов на получение страниц будет вызвана функция <code>page()</code>, в то время как в результате любых запросов на получение постов будет вызвана функция <code>post()</code>.</p><p>Значение по умолчанию для заголовка <code class="inline">Content-Type</code> – HTML. Поэтому при отправлении CSS, JavaScript и изображений мы специально задаем для <code class="inline">Content-Type</code> соответственное значение.</p> <p>Также вы можете определять маршруты при помощи методов REST (* Representational State Transfer – передача репрезентативного состояния; способ обеспечения способности к взаимодействию компьютерных систем в Интернете) <code>put</code>, <code>delete </code>и <code>post</code>. В этом небольшом сервере используется только метод <code>get</code>.</p><pre class="brush: javascript noskimlinks noskimwords">//// Start the server.//var addressItems = parts["ServerAddress"].split(":");var server = nodePress.listen(addressItems[2], function() {   var host = server.address().address;   var port = server.address().port;   console.log("nodePress is listening at http://%s:%s", host, port);});</pre> <p>Нам осталось теперь, перед определением различных используемых в коде функций, только запустить сервер. В файле server.json содержится DNS-имя (у нас <code>localhost</code>) и порт для сервера. После парсинга (* разбиение строки текста на составные части) в функции <code>listen()</code> используется номер порта для запуска сервера. После открытия порта сервера за счет скрипта в консоль выводится адрес и порт сервера.</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:     setBasicHeader//// Description: This function will set the basic header information// needed.//// Inputs://response The response object//function setBasicHeader(response) {   response.append("Cache-Control", "max-age=2592000, cache");   response.append("Server", "nodePress - a CMS written in node from Custom Computer Tools: http://customct.com.");}</pre> <p>Первая функция, которую будем определять, – <code>setBasicHeader()</code>. При помощи этой функции устанавливается значение специального заголовка ответа для сообщения браузеру о необходимости кэширования страницы на один месяц. Также благодаря ней браузеру сообщается, что сервер – это сервер nodePress. Если бы вы хотели добавить еще какие-либо стандартные заголовки, то добавили бы их при помощи функции <code>response.append()</code> .</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:         page//// Description:      This function processes a page request//// Inputs://                  page The requested page//function page(page) {   //   // Process the given page using the standard layout.   //   return (processPage(parts["layout"], parts["Sitebase"] + "pages/" + page));}</pre> <p>В функции <code>page()</code> шаблон разметки страницы и адрес страницы на сервере передаются в функцию <code>processPage()</code>.</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:         post//// Description:      This function processes a post request//// Inputs://                  type The type of post.//                  cat The category of the post.//                  post The requested post//function post(type, cat, post) {   //   // Process the post given the type and the post name.   //   return (processPage(parts["layout"], parts["Sitebase"] + "posts/" + type + "/" + cat + "/" + post));}</pre> <p>Функция <code>post()</code> подобна функции <code>page()</code>, за исключением того, что при создании поста используется больше информации. В создаваемых в этой серии руководств серверах пост содержит <code>тип</code>, категорию и собственно <code>пост</code>. Типом поста является либо <code>blogs</code>, либо <code>news</code>. Категория – <code>flatcms</code>. Поскольку ими являются имена директорий, то вы можете давать им любые имена. Просто подберите имя так, чтобы оно совпадало с тем, что используется в вашей файловой системе.</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:         processPage//// Description:      This function processes a page for the CMS.//// Inputs://                  layout The layout to use for the page.//                  page Path to the page to render.//function processPage(layout, page) {   //   // Get the pages contents and add to the layout.   //   var context = {};   context = MergeRecursive(context, parts);   context["content"] = figurePage(page);   context["PageName"] = path.basename(page, path.extname(page));   //   // Load page data.   //   if(fileExists(page + ".json")) {   //   // Load the page"s data file and add it to the data structure.   //   context = MergeRecursive(context, JSON.parse(fs.readFileSync(page + ".json", "utf8")));   }   //   // Process Handlebars codes.   //   var template = Handlebars.compile(layout);   var html = template(context);   //   // Process all shortcodes.   //   html = processShortCodes(html);   //   // Run through Handlebars again.   //   template = Handlebars.compile(html);   html = template(context);   //   // Return results.   //   return (html);}</pre> <p>Функция <code>processPage()</code> принимает макет и путь к необходимому для отображения контенту страницы. Код функции начинается с создания локальной копии глобальной переменной <code>parts </code>и добавления ключа, используемого для размещения “контента”, значением которого является результат выполнения функции <code>figurePage()</code>. Далее в качестве значения <code>PageName </code>задается имя страницы.</p> <p>Далее происходит компиляция контента страницы в шаблон с разметкой при помощи Handlebars. Затем за счет функции <code>processShortCodes()</code> весь сокращенный код на странице будет преобразован в полный. После этого шаблонизатор Handlebars прогоняет код через себя еще раз. И затем браузер получает результат.</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:     processShortCodes//// Description: This function takes a string and// processes all of the shortcodes in // the string.//// Inputs:// content String to process//function processShortCodes(content) {   //   // Create the results variable.   //   var results = "";   //   // Find the first match.   //   var scregFind = /\-\[([^\]]*)\]\-/i;   var match = scregFind.exec(content);   if (match != null) {   results += content.substr(0,match.index);      var scregNameArg = /(\w+)(.*)*/i;      var parts = scregNameArg.exec(match[1]);      if (parts != null) {         //         // Find the closing tag.         //         var scregClose = new RegExp("\-\[\/" + parts[1] + "\]\-");         var left = content.substr(match.index + 4 + parts[1].length);         var match2 = scregClose.exec(left);         if (match2 != null) {            //            // Process the enclosed shortcode text.            //            var enclosed = processShortCodes(content.substr(match.index + 4 + parts[1].length, match2.index));            //            // Figure out if there were any arguments.            //            var args = "";            if (parts.length == 2) {               args = parts[2];            }            //            // Execute the shortcode.            //            results += shortcodes[parts[1]](args, enclosed);            //            // Process the rest of the code for shortcodes.            //            results += processShortCodes(left.substr(match2.index + 5 + parts[1].length));         } else {            //            // Invalid shortcode. Return full string.            //            results = content;         }      } else {         //         // Invalid shortcode. Return full string.         //         results = content;      }   } else {      //      // No shortcodes found. Return the string.      //      results = content;   }   return (results);}</pre> <p>Функция <code>processShortCodes()</code> принимает контент веб-страницы в качестве строки и производит поиск всех частей кода в сокращенным виде. Сокращенный код – это блок кода, подобный тегам HTML. Примером мог бы послужить:</p><pre class="brush: html noskimlinks noskimwords">-[box]-    &lt;p&gt;This is inside a box&lt;/p&gt;-[/box]-</pre> <p>В этом коде имеется сокращенный код для <code>box </code>вокруг параграфа HTML. Там, где в HTML используется<code> &lt;</code> и <code>&gt;</code>, в сокращенном коде используется <code>-[</code> и <code>]-</code>. После имени может при необходимости добавляться строка с аргументами для сокращенного кода.</p> <p>В функции <code>processShortCodes()</code> происходит поиск сокращенного кода, получение его имени и аргументов, нахождение его конца для получения контента, обработка этого контента, исполнение сокращенного кода с учетом аргументов и контента, добавление результата к финальной странице и поиск оставшихся на странице частей сокращенного кода. Введение цикла осуществляется за счет рекурсивного вызова функции.</p><pre class="brush: javascript noskimlinks noskimwords">//// Define the shortcodes function array.//var shortcodes = {   "box": function(args, inside) {      return ("&lt;div class="box"&gt;" + inside + "&lt;/div&gt;");   },   "Column1": function(args, inside) {      return ("&lt;div class="col1"&gt;" + inside + "&lt;/div&gt;");   },   "Column2": function(args, inside) {      return ("&lt;div class="col2"&gt;" + inside + "&lt;/div&gt;");   },   "Column1of3": function(args, inside) {      return ("&lt;div class="col1of3"&gt;" + inside + "&lt;/div&gt;");   },   "Column2of3": function(args, inside) {      return ("&lt;div class="col2of3"&gt;" + inside + "&lt;/div&gt;");   },   "Column3of3": function(args, inside) {      return ("&lt;div class="col3of3"&gt;" + inside + "&lt;/div&gt;");   },   "php": function(args, inside) {      return ("&lt;div class="showcode"&gt;&lt;pre type="syntaxhighlighter" class="brush: php"&gt;" + inside + "&lt;/pre&gt;&lt;/div&gt;");   },   "js": function(args, inside) {      return ("&lt;div class="showcode"&gt;&lt;pre type="syntaxhighlighter" class="brush: javascript"&gt;" + inside + "&lt;/pre&gt;&lt;/div&gt;");   },   "html": function(args, inside) {      return ("&lt;div class="showcode"&gt;&lt;pre type="syntaxhighlighter" class="brush: html"&gt;" + inside + "&lt;/pre&gt;&lt;/div&gt;");   },   "css": function(args, inside) {      return ("&lt;div class="showcode"&gt;&lt;pre type="syntaxhighlighter" class="brush: css"&gt;" + inside + "&lt;/pre&gt;&lt;/div&gt;");   }};</pre> <p>В этой части идет json-структура <code>сокращенного кода</code>, в которой определяются имена сокращенного кода со связанными с ними функциями. Все функции для сокращенного кода принимают два параметра: <code>args </code>и <code>inside</code>. <code>аrgs</code> – все, что идет после имени и пробела до конца тега. <code>inside</code> – все, что располагается между открывающим и закрывающим тегами сокращенного кода. Это базовые функции, однако вы можете создать сокращенный код для выполнения чего-угодно на JavaScript, что приходит вам в голову.</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:        figurePage//// Description:     This function figures the page type//                  and loads the contents appropriately//                  returning the HTML contents for the page.//// Inputs://                  page The page to load contents.//function figurePage(page) {   var result = "";   if (fileExists(page + ".html")) {      //      // It"s an HTML file. Read it in and send it on.      //      result = fs.readFileSync(page + ".html");   } else if (fileExists(page + ".amber")) {      //      // It"s a jade file. Convert to HTML and send it on. I      // am still using the amber extension for compatibility      // to goPress.      //      var jadeFun = jade.compileFile(page + ".amber", {});      // Render the function      var result = jadeFun({});   } else if (fileExists(page + ".md")) {      //      // It"s a markdown file. Convert to HTML and send      // it on.      //      result = marked(fs.readFileSync(page + ".md").toString());      //      // This undo marked"s URI encoding of quote marks.      //      result = result.replace(/\&amp;quot\;/g,"\"");   }   return (result);}</pre> <p>Функция <code>figurePage()</code> получает полный путь на страницу на сервере. Затем в этой функции проверяется формат страницы (HTML, Markdown или Jade) на основании расширения. Я по-прежнему использую .amber для кода на Jade, поскольку я использовал библиотеку Аmber при создании сервера goPress. Весь контент на Markdown и Jade транслируется в HTML перед его передачей рутинной функции (* return). Поскольку процессор Markdown преобразует все кавычки в <code>&amp;quot;</code>, я преобразую их обратно перед возвращением результата.</p><pre class="brush: javascript noskimlinks noskimwords">//// Function:     fileExists//// Description: This function returns a boolean true if // the file exists. Otherwise, false.//// Inputs:// filePath Path to a file in a string.//function fileExists(filePath) {   try {      return fs.statSync(filePath).isFile();   } catch (err) {      return false;   }}</pre> <p>Функция <code>fileExists()</code> – замена для функции <code>fs.exists()</code>, которая была частью библиотеки <code>fs </code>Node.js (* до версии 1.0.0). В ней используется функция <code>fs.statSync()</code>, чтобы попытаться получить статус файла. В случае ошибки функция возвращает <code>false</code>. В ином случае возвращается <code>true</code>.</p><pre class="brush: javascript noskimlinks noskimwords">////  Function:        MergeRecursive////  Description:     Recursively merge properties of two objects////  Inputs://                   obj1    The first object to merge//                   obj2    The second object to merge//function MergeRecursive(obj1, obj2) {   for (var p in obj2) {      try {         // Property in destination object set; update its value.         if (obj2[p].constructor == Object) {            obj1[p] = MergeRecursive(obj1[p], obj2[p]);         } else {            obj1[p] = obj2[p];         }      } catch (e) {         // Property in destination object not set; create it and set its value.         obj1[p] = obj2[p];      }   }   return obj1;}</pre> <p>Переходим к последней функции – <code>MergeRecursive()</code>. В ней происходит копирование второго переданного объекта в первый. Я ее использую для копирования содержимого основной глобальной переменной <code>parts </code>в локальную копию перед добавлением частей, присущих различным страницам.</p> <h3>Запускаем сервер локально:</h3> <p>После сохранения файла вы можете запустить сервер при помощи:</p><pre class="brush: bash noskimlinks noskimwords">node nodePress.js</pre> <p>В качестве альтернативного варианта вы можете использовать указанный в файле package.json скрипт, запускаемый при помощи команды <code class="inline">npm</code>. Запуск скриптов при помощи npm выполняется следующим образом:</p><pre class="brush: bash noskimlinks noskimwords">npm start</pre> <p>При помощи этой команды будет выполнен скрипт <code>start</code>, указанный в файле package.json.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/71/posts/25633/image/BuildingCMS-node-01.jpg" alt="Создаем CMS: nodePress..." title="Создаем CMS: nodePress..." width="50" height="50"><figcaption>Главная страница сервера nodePress</figcaption></figure><p>Перейдите в вашем браузере по <code>http://localhost:8080</code> и вы увидите страницу, показанную выше. Вы, должно быть, заметили, что я добавил дополнительный код для тестирования сайта на главную страницу. С внесенными на страницы изменениями вы можете ознакомиться в присоединенных файлах. Это, по большей части, просто некоторые небольшие поправки, внесенные для более полного тестирования функциональных возможностей и подгонки кода под требования различных библиотек. Наиболее значительное различие состоит в том, что в библиотеке Jade не используется <code class="inline">$ </code>при наименования переменных, а в Amber используется.</p> <h2>Заключение</h2> <p>Теперь у вас есть идентичные CMS, работающие на основе плоской файловой системы, реализованные при помощи Gо и Node.js. Мы воспользовались только базовыми возможностями этой платформы. Поэкспериментируйте и попробуйте что-нибудь новое. Это самое интересное при создании собственного сервера.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="CMS" href="https://norma-studio.github.io/article5/220825278-sozdaem-cms-nodepress" class="tm-article-body__tags-item-link">CMS</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
34878</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
660</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
