
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как безо...">
<meta property="og:description" content="Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как безо...">
<meta name="twitter:description" content="Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как безо...">
<meta property="aiturec:description" content="Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как безо...">
<meta property="og:image" content="//www.gravatar.com/avatar/99c40eb6a15d5177d940890784cc797d?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="aiturec:image" content="//www.gravatar.com/avatar/99c40eb6a15d5177d940890784cc797d?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta name="twitter:image" content="//www.gravatar.com/avatar/99c40eb6a15d5177d940890784cc797d?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="vk:image" content="//www.gravatar.com/avatar/99c40eb6a15d5177d940890784cc797d?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="og:type" content="article">
<link image_src="image" href="//www.gravatar.com/avatar/99c40eb6a15d5177d940890784cc797d?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html" title="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io" title="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/543234456.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html" class="tm-user-info__username" title="
А. Гаврилов" aria-label="
А. Гаврилов">
А. Гаврилов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Пользовательские таблицы базы данных: безопасность прежде всего...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Plugins" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego" class="tm-article-snippet__hubs-item-link"><span>Plugins</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego.html" />
    <link itemprop="image" href="//www.gravatar.com/avatar/99c40eb6a15d5177d940890784cc797d?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
    <meta itemprop="headline name" content="Пользовательские таблицы базы данных: безопасность прежде всего... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как безо...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как безо...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Это вторая часть серии о пользовательских таблицах базы данных в WordPress. В первой части мы рассмотрели все за и против использования пользовательских таблиц. Мы рассмотрели некоторые детали, которые необходимо учитывать, - именование столбцов, типы столбцов - а также способы создания таблицы. Прежде чем идти дальше, мы должны обсудить, как <em>безопасно</em> взаимодействовать с этой новой таблицей. В <span>предыдущей статье</span> я рассмотрел общие вопросы санитарии и проверки - в этом руководстве мы рассмотрим это более подробно в контексте баз данных.</p><p><!--more--></p> <p>Безопасность при взаимодействии с таблицей базы данных имеет первостепенное значение, поэтому мы рассмотрим ее в начале этой серии. Если все сделано неправильно, вы можете оставить свою таблицу открытой для манипуляций с помощью SQL-инъекции. Это может позволить хакеру извлечь информацию, заменить контент или даже изменить поведение вашего сайта - и ущерб, который они могут нанести, не ограничивается вашей пользовательской таблицей.</p> <p>Предположим, мы хотим разрешить администраторам удалять записи из нашего журнала активности. Распространенная ошибка, которую я видел, заключается в следующем:</p> <pre class="brush: php noskimlinks noskimwords">     if ( !empty($_GET["action"])          &amp;&amp; "delete-activity-log" == $_GET["action"]           &amp;&amp; isset($_GET["log_id"]) ) {                              global $wpdb;               unsafe_delete_log($_GET["log_id"]);               }      function unsafe_delete_log( $log_id ){          global $wpdb;          $sql = "DELETE FROM {$wpdb-&gt;wptuts_activity_log} WHERE log_id = $log_id";          $deleted = $wpdb-&gt;query( $sql );     }</pre> <p>Так что здесь не так? Много чего: они не проверяли разрешения, поэтому любой может удалить журнал активности. Они также не проверяли одноразовые номера, поэтому даже при проверке разрешений пользователь-администратор может быть обманут в удалении журнала. Все это было <span>описано в этом уроке</span>. Но их третья ошибка объединяет первые две: функция <code>unsafe_delete_log()</code> использует переданное значение в команде SQL, не экранируя его первым. Это оставляет его широко открытым для манипуляций.</p> <p>Давайте предположим, что его предполагаемое использование это</p> <pre class="brush: php noskimlinks noskimwords">  www.unsafe-site.com?action=delete-activity-log&amp;log_id=7</pre> <p>Что делать, если злоумышленник посетил (или обманул администратора): <code>www.unsafe-site.com?action=delete-activity-log&amp;log_id=1;%20DROP%20TABLE%20wp_posts</code>. <code>Log_id</code> содержит команду SQL, которая впоследствии вводится в <code>$sql</code> и будет выполняться как:</p> <pre class="brush: php noskimlinks noskimwords">    DELETE from wp_wptuts_activity_log WHERE log_id=1; DROP TABLE wp_posts</pre> <p>Результат: вся таблица <code>wp_posts</code> удалена. Я видел такой код на форумах, и в результате любой посетитель их сайта может обновить или удалить <em>любую</em> таблицу в своей базе данных.</p> <p>Если первые две ошибки были исправлены, то это затруднит работу этого типа атак - но возможно, и это не защитит от «злоумышленника», у которого есть разрешение на удаление журналов активности. Невероятно важно защитить свой сайт от SQL-инъекций. Это также невероятно просто: WordPress предоставляет метод <code>prepare</code>. В этом конкретном примере:</p> <pre class="brush: php noskimlinks noskimwords">     function safe_delete_log( $log_id ){         global $wpdb;         $sql = $wpdb-&gt;prepare("DELETE from {$wpdb-&gt;wptuts_activity_log} WHERE log_id = %d", $log_id);         $deleted = $wpdb-&gt;query( $sql )     }</pre> <p>Команда SQL теперь будет выполняться как</p> <pre class="brush: php noskimlinks noskimwords">    DELETE from wp_wptuts_activity_log WHERE log_id=1;</pre> <hr><h2>Санитарная обработка запросов к базе данных</h2> <p>Большую часть санации можно выполнить исключительно с использованием <code>$wpdb</code> global, особенно с помощью <span>метода <code>prepare</code></span>. Он также предоставляет методы для вставки и обновления данных в таблицы безопасно. Обычно они работают путем замены неизвестного ввода или связывания ввода с заполнителем формата. Этот формат сообщает WordPress, какие данные ожидать:</p> <ul><li> <code>%s</code> обозначает строку</li> <li> <code>%d</code> обозначает целое число </li> <li> <code>%f</code> обозначает float</li> </ul><p> Мы начнем с рассмотрения трех методов, которые не только очищают запросы, но и создают их для вас. </p> <h3>Вставка данных</h3> <p>WordPress предоставляет метод <span><code>$wpdb-&gt; insert()</code></span>. Это обложка для вставки данных в базу данных и обработки санации. Требуется три параметра:</p> <ul><li> <strong>Table name</strong> - название таблицы</li> <li> <strong>Data</strong> - массив данных для вставки в виде пар столбец-&gt; значение</li> <li> <strong>Formats</strong> - массив форматов для соответствующего значения в массиве данных (например,<code>%s</code>,<code>%d</code>,<code>%f</code>)</li> </ul><p>Обратите внимание, что ключи данных должны быть столбцами: если есть ключ, который не соответствует столбцу, может быть выдана ошибка.</p> <p> В следующих примерах мы явно установили данные - но, конечно, в целом, эти данные были бы получены из пользовательского ввода - так что это может быть что угодно. Как обсуждалось в <span>этой статье</span>, данные <em>должны</em> были быть проверены в первую очередь, чтобы возвратить любые ошибки пользователю - но нам все еще нужно очистить данные перед добавлением их в нашу таблицу. Мы будем смотреть на проверку в следующей статье этой серии.</p> <pre class="brush: php noskimlinks noskimwords">global $wpdb;// $user_id = 1;$activity = 1;$object_id = 1479;$activity_date = date_i18n("Y-m-d H:i:s", false, true);$inserted = $wpdb-&gt;insert(     $wpdb-&gt;wptuts_activity_log,     array(        "user_id"=&gt;$user_id,        "activity"=&gt;$activity,        "object_id"=&gt;$object_id,        "activity_date"=&gt; $activity_date,      ),     array (        "%d",        "%s",        "%d",        "%s",     ) ); if( $inserted ){    $insert_id = $wpdb-&gt;insert_id; }else{    //Insert failed }</pre> <h3>Обновление данных</h3> <p>Для обновления данных в базе данных у нас есть <span><code>$wpdb-&gt; update()</code></span>. Этот метод принимает пять аргументов:</p> <ul><li> <strong>Table name</strong> - название таблицы</li> <li> Data - массив данных для обновления в виде пар столбец-&gt; значение</li> <li> <strong>Where</strong> - массив данных для сопоставления в виде столбца -&gt; пары значений</li> <li> <strong>Data Format</strong> - массив форматов для соответствующих значений данных</li> <li> <strong>Where Format</strong> - массив форматов для соответствующих значений «where»</li> </ul><p>Это обновляет все строки, которые соответствуют массиву where, значениями из массива данных. Как и в случае <code>$wpdb-&gt;insert()</code>, ключи массива данных должны соответствовать столбцу. Возвращает <code>false</code> в случае ошибки или количества обновленных строк.</p> <p> В следующем примере мы обновляем любые записи с идентификатором журнала "14"(который должен быть не более одной записи, так как это наш первичный ключ). Обновляет идентификатор пользователя до 2, а активность - до «отредактировано».</p> <pre class="brush: php noskimlinks noskimwords">global $wpdb;$user_id=2;$activity="edited";$log_id = 14;$updated = $wpdb-&gt;update(     $wpdb-&gt;wptuts_activity_log,     array(        "user_id"=&gt;$user_id,         "activity"=&gt;$activity,     ),     array("log_id"=&gt;$log_id,),     array( "%d", "%s"),     array( "%d"), ); if( $updated ){    //Number of rows updated = $updated }</pre> <h3>Удаление</h3> <p>Начиная с 3.4, WordPress также предоставляет метод <span><code>$wpdb-&gt;delete()</code></span> для простого (и безопасного) удаления строк. Этот метод принимает три параметра:</p> <ul><li> <strong>Table name</strong> - название таблицы</li> <li> <strong>Where</strong> - массив данных для сопоставления в виде столбца -u003e пары значений</li> <li> <strong>Formats</strong> - массив форматов для соответствующего типа значения (например,<code>%s</code>,<code>%d</code>,<code>%f</code>)</li> </ul><p>Если вы хотите, чтобы ваш код был совместим с WordPress pre-3.4, вам нужно будет использовать метод <code>$wpdb-&gt;prepare</code> для очистки соответствующего оператора SQL. Пример этого был приведен выше. Метод <code>$wpdb-&gt;delete</code> возвращает количество удаленных строк, в противном случае - false, чтобы вы могли определить, было ли удаление успешным.</p> <pre class="brush: php noskimlinks noskimwords">global $wpdb;$deleted = $wpdb-&gt;delete(     $wpdb-&gt;wptuts_activity_log,     array("log_id"=&gt;14,),     array( "%d"), ); if( $deleted ){    //Number of rows deleted = $deleted }</pre> <h3>esc_sql</h3> <p>В свете описанных выше методов и более общего метода <code>$wpdb-&gt;prepare()</code>, обсуждаемого далее, эта функция немного избыточна. Он предоставляется как полезная оболочка для метода <code>$wpdb-&gt;escape()</code>, который сам по себе является прославленной <code>addslashes</code>. Поскольку обычно более целесообразно и целесообразно использовать вышеупомянутые три метода или <code>$wpdb-&gt;prepare()</code>, вы, вероятно, обнаружите, что вам редко требуется использовать <span><code>esc_sql()</code></span>.</p> <p> В качестве простого примера:</p> <pre class="brush: php noskimlinks noskimwords">$activity = "commented";$sql = "DELETE FROM {$wpdb-&gt;wptuts_activity_log} WHERE activity="".esc_sql($activity)."";";</pre> <h3> Общие запросы </h3> <p> Для общих команд SQL, где (то есть те, которые не вставляют, удаляют или обновляют строки), мы должны использовать метод <code>$wpdb-&gt;prepare()</code>. Он принимает переменное количество аргументов. Первый - это SQL-запрос, который мы хотим выполнить со всеми «неизвестными» данными, замененными заполнителями соответствующего формата. Эти значения передаются как дополнительные аргументы в порядке их появления.</p> <p> Например, вместо:</p> <pre class="brush: php noskimlinks noskimwords">$sql = "SELECT* FROM {$wpdb-&gt;wptuts_activity_log}          WHERE user_id = $user_id          AND object_id = $object_id          AND activity = $activity          ORDER BY activity_date $order";$logs = $wpdb-&gt;get_results($sql);</pre> <p>у нас есть</p> <pre class="brush: php noskimlinks noskimwords">$sql = $wpdb-&gt;prepare("SELECT* FROM {$wpdb-&gt;wptuts_activity_log}                 WHERE user_id = %d                 AND object_id = %d                 AND activity = %s                 ORDER BY activity_date %s",                $user_id,$object_id,$activity, $order  );$logs = $wpdb-&gt;get_results($sql);</pre> <p>Метод <code>prepare</code> делает две вещи.</p> <ol><li>Он применяет <span><code>mysql_real_escape_string()</code></span> (или <span><code>addlashes()</code></span>) к вставляемым значениям. В частности, это предотвратит выпадение значений, содержащих кавычки, из запроса. </li> <li>Он применяет <code>vsprintf()</code> при добавлении значений в запрос, чтобы убедиться, что они соответствующим образом отформатированы (целые числа являются целыми числами, числами с плавающей точкой и т.д.) Вот почему наш пример в самом начале статьи вычеркнул все, кроме «1».</li> </ol><h3>Более сложные запросы</h3> <p> Вы должны обнаружить, что <code>$wpdb-&gt;prepare</code>, а также методы вставки, обновления и удаления - все, что вам действительно нужно. Иногда, хотя бывают обстоятельства, когда требуется более «ручной» подход, иногда просто с точки зрения читабельности. Например, предположим, у нас есть неизвестный массив действий, для которых мы хотим все журналы. Мы *могли бы* динамически добавить заполнители <code>%s</code> в SQL-запрос, но более прямой подход кажется более простым:</p> <pre class="brush: php noskimlinks noskimwords"> //An unknown array that should contain strings being queried for $activities = array( ... );  //Sanitize the contents of the array $activities = array_map("esc_sql",$activities); $activities = array_map("sanitize_title_for_query",$activities); //Create a string from the sanitised array forming the inner part of the IN( ... ) statement $in_sql = """. implode( "","", $activities ) . """; //Add this to the query $sql = "SELECT* FROM $wpdb-&gt;wptuts_activity_log WHERE activity IN({$in_sql});" //Perform the query $logs = $wpdb-&gt;get_results($sql);</pre> <p>Идея состоит в том, чтобы применить <code>esc_sql</code> и <span><code>sanitize_title_for_query</code></span> к каждому элементу в массиве. Первый добавляет косую черту, чтобы избежать терминов - аналогично тому, что делает <code>$wpdb-&gt;prepare()</code>. Второй просто применяет <span><code>sanitize_title_with_dashes()</code></span> - хотя поведение может быть полностью изменено с помощью фильтров. Фактический оператор SQL формируется путем вставки очищенного массива в строку, разделенную запятыми, которая добавляется в часть <code>IN(...)</code>.</p> <p>Если ожидается, что массив будет содержать целые числа, тогда достаточно использовать <code>intval()</code> или <code>absint()</code> для очистки каждого элемента в массиве.</p> <h3>Whitelisting</h3> <p>В других случаях белый список может быть уместным. Например, неизвестный ввод может быть массивом столбцов, которые должны быть возвращены в запросе. Поскольку мы знаем, что такое столбцы базы данных, мы можем просто внести их в белый список - удалив любые поля, которые мы не распознаем. Однако, чтобы сделать наш код понятным для человека, мы должны учитывать регистр символов. Для этого мы преобразуем все, что мы получаем, в нижний регистр - поскольку в первой части мы специально использовали имена столбцов в нижнем регистре.</p> <pre class="brush: php noskimlinks noskimwords"> //An unknown array that should contain columns to be included in the query $fields = array( ... );  //A whitelist of allowed fields $allowed_fields = array( ... );     //Convert fields to lowercase (as our column names are all lower case - see part 1) $fields = array_map("strtolower",$fields); //Sanitize by white listing $fields = array_intersect($fields, $allowed_fields); //Return only selected fields. Empty $fields is interpreted as all if( empty($fields) ){     $sql = "SELECT* FROM {$wpdb-&gt;wptuts_activity_log}"; }else{     $sql = "SELECT ".implode(",",$fields)." FROM {$wpdb-&gt;wptuts_activity_log}"; } //Perform the query    $logs = $wpdb-&gt;get_results($sql);</pre> <p>Белый список также удобен при установке части запроса <code>ORDER BY</code> (если это установлено пользовательским вводом): данные можно упорядочить только как <code>DESC</code> или <code>ASC</code>.</p> <pre class="brush: php noskimlinks noskimwords">     //Unknown user input (expected to be asc or desc)     $order = $_GET["order"];      //Allow input to be any, or mixed, case     $order = strtoupper($order);          //Sanitised order value     $order = ( "ASC" == $order ? "ASC" : "DEC" );</pre> <h3>Как запросы</h3> <p>Операторы SQL LIKE поддерживают использование подстановочных знаков, таких как <code>%</code> (ноль или более символов) и <code>_</code> (ровно один символ), при сопоставлении значений в запросе Например, значение <code>foobar</code> будет соответствовать любому из запросов:</p> <pre class="brush: php noskimlinks noskimwords"> SELECT * FROM $wpdb-&gt;wptuts_activity_log WHERE activity LIKE "foo%" SELECT * FROM $wpdb-&gt;wptuts_activity_log WHERE activity LIKE "%bar" SELECT * FROM $wpdb-&gt;wptuts_activity_log WHERE activity LIKE "%oba%" SELECT * FROM $wpdb-&gt;wptuts_activity_log WHERE activity LIKE "fo_bar%"</pre> <p>Однако эти специальные символы могут фактически присутствовать в искомом термине - и, таким образом, чтобы их нельзя было интерпретировать как символы подстановки - нам нужно избегать их. Для этого WordPress предоставляет функцию <span><code>like_escape()</code></span>. Обратите внимание, что это не предотвращает внедрение SQL-кода, а только экранирует символы <code>%</code> и <code>_</code>: вам все еще нужно использовать <code>esc_sql()</code> или <code>$wpdb-&gt;prepare()</code>.</p> <pre class="brush: php noskimlinks noskimwords"> //Collect term $term = $_GET["activity"]; //Escape any wildcards $term = like_escape($term); $sql = $wpdb-&gt;prepare("SELECT* FROM $wpdb-&gt;wptuts_activity_log WHERE activity LIKE %s", "%".$term."%"); $logs = $wpdb-&gt;get_results($sql);</pre> <h3>Query Wrapper Функции</h3> <p>В примерах, которые мы посмотрели, мы использовали два других метода <code>$wpdb</code>:</p> <ul><li> <code>$wpdb-&gt;query( $sql )</code> - выполняет любой заданный ему запрос и возвращает количество затронутых строк.</li> <li> <code>$wpdb-&gt;get_results( $sql, $ouput)</code> - выполняет заданный ему запрос и возвращает соответствующий набор результатов (т.е. соответствующие строки) <code>$output</code> устанавливает формат возвращаемых результатов: <ul><li> <code>ARRAY_A</code> - числовой массив строк, где каждая строка представляет собой ассоциативный массив, снабженный столбцами.</li> <li> <code>ARRAY_N</code> - числовой массив строк, где каждая строка является числовым массивом.</li> <li> <code>OBJECT</code> - числовой массив строк, где каждая строка является объектом строки. По умолчанию.</li> <li> <code>OBJECT_K</code> - ассоциативный массив строк (определяется значением первого столбца), где каждая строка является ассоциативным массивом.</li> </ul></li> </ul><p>Есть и другие, о которых мы тоже не упомянули:</p> <ul><li> <code>$wpdb-&gt;get_row( $sql, $ouput, $row)</code> - выполняет запрос и возвращает одну строку. <code>$row</code> устанавливает, какая строка должна быть возвращена, по умолчанию это 0, первая подходящая строка. <code>$output</code> устанавливает формат строки: <ul><li> <code>ARRAY_A</code> - строка представляет собой <code>column=&gt;value</code>.</li> <li> <code>ARRAY_N</code> - строка представляет собой числовой массив значений.</li> <li> <code>OBJECT</code> - строка возвращается как объект. По умолчанию.</li> </ul></li> <li> <code>$wpdb-&gt;get_col( $sql, $column)</code> - выполняет запрос и возвращает числовой массив значений из указанного столбца. <code>$column</code> указывает, какой столбец нужно вернуть как целое число. По умолчанию это 0, первый столбец. </li> <li> <code>$wpdb-&gt;get_var( $sql, $column, $row)</code> - выполняет запрос и возвращает определенное значение. <code>$row</code> и <code>$column</code> такие же, как указано выше, и указывают, какое значение вернуть. Например, <pre class="brush: php noskimlinks noskimwords">$activities_by_user_1 = $wpdb-&gt;get_var("SELECT COUNT(*) FROM {$wpdb-&gt;wptuts_activity_log} WHERE user_id = 1");</pre> </li> </ul><p>Важно отметить, что эти методы являются просто оболочками для выполнения запроса SQL и форматирования результата. <em>Они не очищают запрос</em>, поэтому вам не следует использовать их в одиночку, когда запрос содержит некоторые «неизвестные» данные.</p> <hr><h2> Подведем итоги </h2> <p>В этом уроке мы довольно много рассмотрели - и очистка данных - важная тема для понимания. В следующей статье мы применим его к нашему плагину. Мы рассмотрим разработку набора функций-оболочек (похожих на такие функции, как <code>wp_insert_post()</code>, <code>wp_delete_post()</code> и т. д.), Которые добавят слой абстракции между нашим плагином и базой данных.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Plugins" href="https://norma-studio.github.io/article5/220825609-polzovatelskie-tablitsy-bazy-dannyh-bezopasnost-prezhde-vsego" class="tm-article-body__tags-item-link">Plugins</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
42500</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
669</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
