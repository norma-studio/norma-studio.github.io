
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим спосо...">
<meta property="og:description" content="Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим спосо...">
<meta name="twitter:description" content="Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим спосо...">
<meta property="aiturec:description" content="Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим спосо...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/final_image/final.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/final_image/final.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/final_image/final.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/final_image/final.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/final_image/final.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html" title="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io" title="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/543234456.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html" class="tm-user-info__username" title="
А. Гаврилов" aria-label="
А. Гаврилов">
А. Гаврилов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Покупки в приложениях iOS со Swift 3...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="iOS SDK" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3" class="tm-article-snippet__hubs-item-link"><span>iOS SDK</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/final_image/final.jpg">
    <meta itemprop="headline name" content="Покупки в приложениях iOS со Swift 3... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим спосо...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим спосо...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<h2>Вступление</h2><p>Покупки в приложениях - отличная возможность для разработчиков, которые хотят получать больше дохода и предлагают дополнительный контент и функции через свои приложения. Например, для игр вы можете купить камни или монеты, а для фото-приложений разблокировать новые эффекты или инструменты. Всё это делается с помощью кредитной карты или другим способом, не выходя из приложения. </p><p>В этом уроке я опишу все шаги по созданию <b>Consumable</b> и <b>Non-Consumable</b> IAP в iTunes Connect и покажу код, который вам нужен для покупки обоих продуктов. Я сделал <span>sample Xcode project with a label and two buttons</span>, загрузите его и следуйте по указаниям, чтобы понять, как он работает.</p><h3>Создание Sandbox Tester в iTunes Connect<br></h3><p>Я предполагаю, что вы уже создали приложение iOS в разделе <strong>My Apps</strong> в iTunes Connect. Теперь сделаем <strong>Sandbox Tester</strong> для проверки IAP на вашем реальном устройстве (не Simulator - он не поддерживает In-App покупки). </p><p>Войдите в <strong>Users and Roles</strong>, далее на вкладку <strong>Sandbox Tester</strong>, нажмите (<strong>+</strong>) рядом с <strong>Tester</strong>.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/01.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Заполните форму, чтобы добавить новый sandbox tester. После сохранения вернитесь в раздел <strong>My App</strong> и щёлкните значок своего приложения, чтобы ввести его данные и создать продукты IAP.</p><h3>Создание продуктов IAP в iTunes Connect</h3><h4>Consumable Products</h4><p>Во вкладке <strong>Features</strong> нажмите (<strong>+</strong>) рядом с <strong>In-App Purchases.</strong> Можно создавать только один продукт за раз, поэтому начнём с <strong>Consumable</strong>.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/03.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p><strong>Consumable</strong> IAP, как следует из названия, является продуктом, который можно купить многократно. Мы будем использовать его для сбора дополнительных «монет» в нашем демонстрационном приложении. <br></p><p>Нажмите <strong>Create</strong>, чтобы инициализировать элемент IAP. На следующем экране вы настроите всю информацию о своем продукте:</p><ul><li> <strong>Reference Name</strong>: это имя будет использоваться в отчётах iTunes Connect и в <strong>Sales and Trends</strong>. Оно может быть любым, но не длиннее 64 символов, в App Store оно отражаться не будет.</li> <li> <strong>Product ID</strong>: уникальный алфавитно-цифровой идентификатор для распознавания вашего продукта. Разработчики часто используют для него синтаксис web-reverse. В нашем примере это <strong>com.iaptutorial.coins.</strong> Позже мы вставим этот ID в строку нашего кода.</li> <li> <strong>Price</strong>: выберите ценовой разряд из выпадающего меню. Помните: чтобы продать ваш продукт через приложение в App Store, вы должны подать заявку на получение <strong>Paid Application Agreement</strong> в <strong>Agreements, Tax &amp; Banking</strong>.</li> <li> <strong>Localizations</strong>: для этого урока мы выбрали только английский язык, но вы можете добавить, нажав кнопку (<strong>+</strong>). Введите <strong>Display Name</strong> и <strong>Description</strong>. Оба они будут видны в App Store. </li> <li> <strong>Screenshot</strong>: загрузите скриншот для обзора. Он не отобразится в App Store, и должен быть допустимого для платформы приложений размера, поэтому, если ваше приложение Universal, можете загрузить скриншот iPad.</li> <li> <strong>Review Notes</strong>: любая дополнительная информация о вашем IAP, которая может быть полезна для рецензента.</li> </ul><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/04.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Закончив, нажмите <strong>Save</strong> и получите предупреждение:</p><blockquote>Ваша первая покупка In-App должна быть представлена в новой версии приложения. Выберите его из раздела In-App Purchases и нажмите Submit.</blockquote><h4>Non-Consumable Products</h4><p>Теперь нажмите кнопку In-App Purchases в левом списке, прямо над кнопкой <strong>Game Center</strong> и добавьте новый продукт IAP. На этот раз выберите опцию <strong>Non-Consumable</strong>:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/05.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Нажмите <strong>Create</strong> и повторите шаги, описанные выше. Поскольку этот продукт <strong>Non-Consumable</strong> и пользователи смогут купить его только раз, Apple требует подтверждения возможности оплаты. Это на случай, если вы удалите приложение и установите его повторно или зайдёте с другого устройства с тем же Apple ID и вам нужно будет вернуть свои покупки, не заплатив за них дважды. Поэтому позже мы добавим функцию <strong>Restore Purchase</strong> в нашем коде.<br></p><p>ID продукта, который мы создали - <em>com.iaptutorial.premium</em> с ценовым уровнем USD $2.99. Мы назвали его <strong>Unlock Premium Version.</strong></p><p>Когда вы заполните поля, сохраните свой продукт и вернитесь на страницу In-App Purchases. У вас будет список из двух продуктов, с их <strong>Name</strong>, <strong>Type</strong>, <strong>ID</strong> и <strong>Status</strong>, <strong>Ready to Submit.</strong></p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/06.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Вернитесь на страницу своего приложения, нажав на кнопки <strong>App Store</strong> и <strong>Prepare for Submission</strong>. Прокрутите вниз до раздела <strong>In-App Purchases</strong> прямо под <strong>General App Information</strong>, нажмите кнопку (<strong>+</strong>), чтобы добавить свои продукты IAP. <br></p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/07.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Выберите их и нажмите <strong>Done</strong>.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/08.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Наконец, нажмите <strong>Save</strong> в правом верхнем углу экрана, и вы сможете настроить продукты In-App Purchase на iTunes Connect.</p><h3>Войдите в Тестер Sandbox на устройстве iOS</h3><p>Прежде чем перейти к коду, сделайте ещё шаг. Нажмите <strong>Settings</strong> &gt; <strong>iTunes &amp; App Store</strong> на устройстве iOS. Если вы уже вошли в систему со своим Apple ID, нажмите на него и выберите <strong>Sign Out</strong>. Затем войдите в систему с учётными данными для sandbox tester, которые вы создали. После входа в систему может появиться предупреждение:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=837/uploads/users/1455/posts/27595/image/9.PNG" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Просто нажмите <strong>Cancel.</strong> Ваше устройство снова попросит sandbox login, пытаясь совершить покупку и узнает вашу тестовую учётную запись, чтобы вы не платили ни копейки по кредитной карте за любую покупку, которую совершаете.</p><p>Выйдите из <strong>Settings</strong>, подключите устройство к компьютеру Mac через USB-кабель и, наконец, начните кодирование!</p><h2>Код</h2><p>Если вы откроете наш демонстрационный проект, то увидите, что весь необходимый код для In-App Purchase написан:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/11.PNG" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Если вы хотите протестировать приложение, то должны изменить <strong>Bundle Identifier</strong> на свой id. В противном случае Xcode не позволит вам запускать приложение на реальном устройстве и приложение не узнает два ваших IAP-продукта.<br></p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/769/posts/27595/image/10.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"><br></p><p>Войдите в <strong>ViewController.swift</strong> и проверьте код. Прежде всего, мы добавили инструкцию import для <code class="inline">StoreKit</code> и делегатов, которые нам нужны для отслеживания транзакций и запросов продукта.<br></p><pre class="brush: objc noskimlinks noskimwords">import StoreKitclass ViewController: UIViewController,SKProductsRequestDelegate,SKPaymentTransactionObserver{</pre><p>Затем мы объявили несколько полезных просмотров.<br></p><pre class="brush: objc noskimlinks noskimwords"> /* Views */    @IBOutlet weak var coinsLabel: UILabel!    @IBOutlet weak var premiumLabel: UILabel!    @IBOutlet weak var consumableLabel: UILabel!    @IBOutlet weak var nonConsumableLabel: UILabel!    </pre><p><code class="inline">CoinsLabel</code> и <code class="inline">premiumLabel</code> будут использоваться для показа результатов покупок обоих продуктов. <code class="inline">ConsumableLabel</code> и <code class="inline">nonConsumableLabel</code> покажут описание и цену каждого продукта IAP, которые мы ранее создали в iTunes Connect. </p><p>Теперь добавим некоторые переменные:</p><pre class="brush: objc noskimlinks noskimwords">/* Variables */    let COINS_PRODUCT_ID = "com.iaptutorial.coins"    let PREMIUM_PRODUCT_ID = "com.iaptutorial.premium"        var productID = ""    var productsRequest = SKProductsRequest()    var iapProducts = [SKProduct]()    var nonConsumablePurchaseMade = UserDefaults.standard.bool(forKey: "nonConsumablePurchaseMade")    var coins = UserDefaults.standard.integer(forKey: "coins")    </pre><p>Первые две строки - это напоминание об ID продуктов. Важно, чтобы эти строки точно соответствовали тем, которые были зарегистрированы в разделе iTunes Connect In-App Purchase.<br></p><ul><li> <code class="inline">productID</code> - это строка, которую мы будем использовать для определения продукта для покупки.</li> <li> <code class="inline">productsRequest</code> - это экземпляр <code class="inline">SKProductsRequest</code>, необходимый для поиска продуктов IAP из вашего приложения в iTC.</li> <li> <code class="inline">iapProducts</code> просто набор <code class="inline">SKProducts</code>. Обратите внимание, что префикс SK означает StoreKit, структуру iOS для обработки покупок.</li> </ul><p>Последние две строки загружают две переменные типа <code class="inline">Boolean</code> и <code class="inline">Integer</code>, необходимые для отслеживания покупок монет и премиальной версии, consumable и non-consumable продуктов.</p><p>Следующий код в <code class="inline">viewDidLoad()</code> выполняет несколько действий сразу после запуска приложения:</p><pre class="brush: objc noskimlinks noskimwords">    // Check your In-App Purchases    print("NON CONSUMABLE PURCHASE MADE: \(nonConsumablePurchaseMade)")    print("COINS: \(coins)")        // Set text    coinsLabel.text = "COINS: \(coins)"        if nonConsumablePurchaseMade { premiumLabel.text = "Premium version PURCHASED!"    } else { premiumLabel.text = "Premium version LOCKED!"}        // Fetch IAP Products available    fetchAvailableProducts()</pre><p>Сначала мы просто регистрируем каждую покупку в консоли Xcode. Затем мы показываем общее количество монет, которые мы купили с помощью <code class="inline">coinsLabel</code>. Поскольку мы запускаем демонстрационное приложение впервые, оно отображает <strong>COINS: 0.</strong><br></p><p><code class="inline">if</code> ставится в текст <code class="inline">premiumLabel</code> в зависимости от того, был ли приобретен non-consumable продукт. Для начала он будет показывать <strong>Premium version LOCKED!</strong> пока мы не сделали премиальную покупку.</p><p>Последняя строка кода вызывает метод, его мы увидим позже, он извлекает продукты, которые мы хранили в iTC.</p><p>Теперь давайте посмотрим, что делают две кнопки покупки, которые мы установили в нашем demo app:</p><pre class="brush: objc noskimlinks noskimwords">// MARK: -  BUY 10 COINS BUTTON@IBAction func buy10coinsButt(_ sender: Any) {    purchaseMyProduct(product: iapProducts[0])}        // MARK: - UNLOCK PREMIUM BUTTON@IBAction func unlockPremiumButt(_ sender: Any) {    purchaseMyProduct(product: iapProducts[1])}</pre><p>Оба метода вызовут функцию, которая проверит, может ли устройство совершать покупки, а если это возможно, приложение вызовет методы StoreKit для их обработки.<br></p><p>Как упоминалось ранее, нам нужна третья кнопка для восстановления нашей non-consumable покупки. Вот её код:</p><pre class="brush: objc noskimlinks noskimwords">// MARK: - RESTORE NON-CONSUMABLE PURCHASE BUTTON@IBAction func restorePurchaseButt(_ sender: Any) {    SKPaymentQueue.default().add(self)    SKPaymentQueue.default().restoreCompletedTransactions()}    func paymentQueueRestoreCompletedTransactionsFinished(_ queue: SKPaymentQueue) {    nonConsumablePurchaseMade = true    UserDefaults.standard.set(nonConsumablePurchaseMade, forKey: "nonConsumablePurchaseMade")            UIAlertView(title: "IAP Tutorial",    message: "You"ve successfully restored your purchase!",    delegate: nil, cancelButtonTitle: "OK").show()} </pre><p>Функция <code class="inline">IBAction</code> подключается к кнопке <strong>Restore Purchase</strong> в <strong>Storyboard</strong> и подсоединяется к системе Apple"s In-App Purchase, чтобы восстановить покупку, если она уже была сделана.<br></p> <p><code class="inline">paymentQueueRestoreCompletedTransactionsFinished()</code> - это метод из фреймворка StoreKit, который подтвердит переменную <code class="inline">nonConsumablePurchaseMade</code>  после того, как покупка будет успешно восстановлена.</p><p>Мы закончили с кнопками, поэтому давайте посмотрим, что делает функция <code class="inline">fetchAvailableProducts ()</code>:</p><pre class="brush: objc noskimlinks noskimwords">// MARK: - FETCH AVAILABLE IAP PRODUCTSfunc fetchAvailableProducts()  {            // Put here your IAP Products ID"s    let productIdentifiers = NSSet(objects:        COINS_PRODUCT_ID,        PREMIUM_PRODUCT_ID    )            productsRequest = SKProductsRequest(productIdentifiers: productIdentifiers as! Set&lt;String&gt;)    productsRequest.delegate = self    productsRequest.start()}    </pre> <p>Сначала мы создаем экземпляр <code class="inline">NSSet</code>, который в основном представляет собой массив строк. Мы сохраним два ID продукта, которые мы ранее объявили.</p><p>Затем мы запускаем <code class="inline">SKProductsRequest</code> на основе этих ID для отображения информации о продуктах (описании и цене) IAP, которые будут обрабатываться этим методом:</p><pre class="brush: objc noskimlinks noskimwords">// MARK: - REQUEST IAP PRODUCTSfunc productsRequest (_ request:SKProductsRequest, didReceive response:SKProductsResponse) {    if (response.products.count &gt; 0) {        iapProducts = response.products                    // 1st IAP Product (Consumable) ------------------------------------        let firstProduct = response.products[0] as SKProduct                // Get its price from iTunes Connect        let numberFormatter = NumberFormatter()        numberFormatter.formatterBehavior = .behavior10_4        numberFormatter.numberStyle = .currency        numberFormatter.locale = firstProduct.priceLocale        let price1Str = numberFormatter.string(from: firstProduct.price)                // Show its description        consumableLabel.text = firstProduct.localizedDescription + "\nfor just \(price1Str!)"        // ------------------------------------------------                                // 2nd IAP Product (Non-Consumable) ------------------------------        let secondProd = response.products[1] as SKProduct                // Get its price from iTunes Connect        numberFormatter.locale = secondProd.priceLocale        let price2Str = numberFormatter.string(from: secondProd.price)                // Show its description        nonConsumableLabel.text = secondProd.localizedDescription + "\nfor just \(price2Str!)"        // ------------------------------------    }}    </pre> <p>В приведённой выше функции сначала проверим, есть ли продукты, зарегистрированные в iTunes Connect и соответственно настроим наш массив <code class="inline">iapProducts</code>. Затем мы можем инициализировать два <strong>SKProducts</strong> и распечатать их описание и цену на этикетках.</p><p>Прежде чем перейти к ядру кода In-App Purchase, добавим ещё пару функций:</p><pre class="brush: plain noskimlinks noskimwords">// MARK: - MAKE PURCHASE OF A PRODUCTfunc canMakePurchases() -&gt; Bool {  return SKPaymentQueue.canMakePayments()  }func purchaseMyProduct(product: SKProduct) {    if self.canMakePurchases() {        let payment = SKPayment(product: product)        SKPaymentQueue.default().add(self)        SKPaymentQueue.default().add(payment)                print("PRODUCT TO PURCHASE: \(product.productIdentifier)")        productID = product.productIdentifier                    // IAP Purchases dsabled on the Device    } else {        UIAlertView(title: "IAP Tutorial",        message: "Purchases are disabled in your device!",        delegate: nil, cancelButtonTitle: "OK").show()    }}</pre><p>Первая проверяет, может ли наше устройство совершать покупки. Вторую функцию мы вызываем с двух кнопок. Запуская очередь платежей и изменяя нашу переменную <code class="inline">productID</code> в выбранный <code class="inline">productIdentifier</code>. </p><p>Теперь мы наконец пришли к последнему методу делегирования, он обрабатывает результаты платежей:</p><pre class="brush: objc noskimlinks noskimwords">// MARK:- IAP PAYMENT QUEUEfunc paymentQueue(_ queue: SKPaymentQueue, updatedTransactions transactions: [SKPaymentTransaction]) {    for transaction:AnyObject in transactions {            if let trans = transaction as? SKPaymentTransaction {                switch trans.transactionState {                                    case .purchased:                    SKPaymentQueue.default().finishTransaction(transaction as! SKPaymentTransaction)                                        // The Consumable product (10 coins) has been purchased -&gt; gain 10 extra coins!                   if productID == COINS_PRODUCT_ID {                                                // Add 10 coins and save their total amount                        coins += 10                        UserDefaults.standard.set(coins, forKey: "coins")                        coinsLabel.text = "COINS: \(coins)"                                                UIAlertView(title: "IAP Tutorial",                        message: "You"ve successfully bought 10 extra coins!",                        delegate: nil,                        cancelButtonTitle: "OK").show()                                                                                            // The Non-Consumable product (Premium) has been purchased!                    } else if productID == PREMIUM_PRODUCT_ID {                                                // Save your purchase locally (needed only for Non-Consumable IAP)                        nonConsumablePurchaseMade = true                        UserDefaults.standard.set(nonConsumablePurchaseMade, forKey: "nonConsumablePurchaseMade")                                            premiumLabel.text = "Premium version PURCHASED!"                                                UIAlertView(title: "IAP Tutorial",                        message: "You"ve successfully unlocked the Premium version!",                        delegate: nil,                        cancelButtonTitle: "OK").show()                    }                                        break                                    case .failed:                    SKPaymentQueue.default().finishTransaction(transaction as! SKPaymentTransaction)                    break                case .restored:                    SKPaymentQueue.default().finishTransaction(transaction as! SKPaymentTransaction)                    break                                    default: break    }}}}</pre><p>Эта функция имеет сообщение <code class="inline">switch</code> и проверяет каждое состояние платежа. Первый <code class="inline">case</code> вызывается, если покупка была успешно выполнена и завершает транзакцию. </p><p>Внутри этого блока мы проверим выбор ID продукта и выполним необходимые действия для обновления приложения, поэтому, если мы купим 10 дополнительных монет, мы добавим 10 к переменной <code class="inline">coins</code>, сохраним её значение с помощью <code class="inline">UserDefaults</code>, отобразим новое количество монет и заявим об этом. </p><p>Обратите внимание, что вы можете совершать эту покупку без ограничений, поскольку это consumable IAP.</p><p>Точно так же, если мы купили продукт non-consumable, приложение устанавливает переменную <code class="inline">nonConsumablePurchaseMade</code> в <code class="inline">true</code>, сохраняет её, изменяет текст <code class="inline">premiumLabel</code> и запускает предупреждение о том, что покупка прошла успешно. </p><p>Другие два <code class="inline">cases</code> обрабатывают результаты платежей за отказ и восстановление. Приложение запустит оповещение, если ваша транзакция завершится неудачей или если вы восстановили non-consumable покупку.</p><p>Вот так! Теперь войдите в систему со своими учётными данными Sandbox Tester и запустите проверку приложения. Сначала появится предупреждение:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/12.PNG" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p>Выберите <strong>Use Existing Apple ID</strong> и снова введите данные Sandbox Tester для входа в систему. Это потому, что приложение распознаёт реального пользователя из настроек <strong>iTunes и App Store,</strong> а не из Sandbox.</p><p>После входа в систему, вы сможете совершать покупки обоих продуктов.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/13.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><p></p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads/users/1455/posts/27595/image/14.png" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"></figure><h2>Шаблоны CodeCanyon  <br></h2><p>Если вы работаете с iOS и хотите глубже узнать язык Swift и разработку приложений, смотрите <span>my iOS app templates on CodeCanyon</span>. </p><p>Есть сотни других <span>iOS app templates on the Envato Market</span>, готовых к работе и ускорению вашего приложения. Покопайтесь в них! Возможно, этим вы сэкономите часы работы в своём следующем приложении.</p><h2>Заключение<br></h2><p>В этом уроке мы рассмотрели все шаги по созданию продуктов In-App Purchase в iTunes Connect и написанию кода для вашего приложения. Надеюсь, вы сможете использовать эти знания в своём следующем iOS app!</p><p>Спасибо за чтение, и до встречи! Ознакомьтесь с другими нашими курсами и пособиями по разработке iOS app с помощью Swift.</p><ul class="roundup-block__contents posts--half-width roundup-block--list"><li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/41/posts/25154/preview_image/preview-image@2x.jpg" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"><div class="roundup-block__primary-category topic-code">iOS</div> <div class="roundup-block__content-title">iOS From Scratch With Swift: Exploring the iOS SDK</div> <div class="roundup-block__author">Bart Jacobs</div></span></li> <li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/1455/posts/27403/preview_image/preview.jpg" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"><div class="roundup-block__primary-category topic-code">iOS</div> <div class="roundup-block__content-title">How to Add AdMob Banner Ads to Your iOS Swift App</div> <div class="roundup-block__author">Francesco Franchini</div></span></li> <li class="roundup-block__content"><span><img class="lazy07" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=400/uploads/users/41/posts/24979/preview_image/swift@2x.jpg" alt="Покупки в приложениях iOS со Swift 3..." title="Покупки в приложениях iOS со Swift 3..." width="50" height="50"><div class="roundup-block__primary-category topic-code">Swift</div> <div class="roundup-block__content-title">Protocol-Oriented Programming in Swift 2</div> <div class="roundup-block__author">Davis Allie</div></span></li> </ul>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="iOS SDK" href="https://norma-studio.github.io/article5/220825072-pokupki-v-prilozheniyah-ios-so-swift-3" class="tm-article-body__tags-item-link">iOS SDK</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
35132</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
714</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
