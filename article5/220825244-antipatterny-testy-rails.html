
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас....">
<meta property="og:description" content="Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас....">
<meta name="twitter:description" content="Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас....">
<meta property="aiturec:description" content="Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html" title="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io" title="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/64533gfdsgf.jpg" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html" class="tm-user-info__username" title="
А. Лукичев" aria-label="
А. Лукичев">
А. Лукичев</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Антипаттерны: тесты Rails...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails" class="tm-article-snippet__hubs-item-link"><span>Ruby</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
    <meta itemprop="headline name" content="Антипаттерны: тесты Rails... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Эта статья представляет собой введение в передовые воды антипаттернов тестирования в Rails. Если вы еще новичок в Test-Driven-Development и хотите собрать пару очень ценных лучших практик, эта статья была точно написана для вас.<br></p><h2>Темы</h2><ul><li>Let</li> <li>Тайные гости</li> <li>Неясные тесты </li> <li>Медленные тесты</li> <li>Фикстуры</li> <li>Хрупкие тесты</li> <li>Атрибуты данных</li> </ul><h2>Let</h2><pre class="brush: rails noskimlinks noskimwords">describe Mission do  let(:james_bond)   { build_stubbed(:agent, name: "James Bond", number: "007") }  let(:mission)      { build_stubbed(:mission, title: "Moonraker") }...end</pre><p>Метод <code class="inline">let</code> helper в RSpec очень часто используется для создания переменных экземпляра, доступных между несколькими тестами. Будучи нетерпеливым учеником практики TDD, вы, вероятно, написали свою справедливую долю этих данных, но после этого практика может легко привести к появлению большого количества таинственных гостей - см. ниже - это определенно не то, что нам нужно! </p><p>Этот конкретный побочный эффект <code class="inline">let</code> получил репутацию, что, возможно, вызвало повышенное обслуживание тестов и низкую читаемость во всем тестовом наборе. <code class="inline">let</code> звучит соблазнительно, потому что он лениво оценивается и помогает придерживаться концепции DRY. Поэтому кажется слишком хорошим чтобы не использовать его на регулярной основе. Его тесный родственника <code class="inline">subject</code> также следует избегать большую часть времени.</p><p>Это становится хуже, когда вы начинаете соединять эти вещи. <code class="inline">let</code> утверждения, оштукатуренные во всех вложенных блоках <code class="inline">describe</code>, являются фаворитом во все времена. Я думаю, что это было не несправедливо назвать быстрым способов для повешивания. Более ограниченную область, как правило, легче понять и следовать. </p><p>Мы не хотим строить карточный домик с полу-глобальными let фикстурами, которые скрывают понимание и увеличивают шансы на разрыв соответствующих тестов. Шансы на создание качественного кода будут против нас при таком подходе. Извлечение общей настройки объекта также легче сделать с помощью простых старых руби методов или даже классов, если это необходимо.</p><p>Это <code class="inline">let</code> создание - широко распространенное приспособление, которое часто нужно будет расшифровать первым, прежде чем вы точно узнаете, что делает этот объект в ваших тестах. Кроме того, нужно будет идти взад и вперед, чтобы понять, из чего они сделаны, и какие отношения, они имеют посредством ассоциаций, что может стать настоящей головной болью. </p><p>Ясность этих деталей в вашей тестовой настройке обычно помогает рассказать другим разработчикам все, что им нужно для работы со всеми частями вашего тестового набора, - не забывайте о своем будущем! В мире, где вам никогда не придется пересматривать конкретные тесты и даже никогда не рефакторировать части своего тестового набора, это может быть не так важно, но сейчас это только лишь мечта!</p><p>Мы хотим иметь как можно меньше вовлеченных объектов и как можно меньше данных для каждого теста. <code class="inline">let</code> работает против вас и на этом фронте. Эти let фикстуры позволяют собирать множество атрибутов и методов, которые делают их слишком большими. </p><p>Если вы пойдете по дороге использования let вы часто закончите с довольно жирными объектами, которые стараются сделать много тестов счастливыми одновременно. Конечно, вы можете создавать множество вариаций этих <code class="inline">let</code> вещей, но это, по-моему, делает их совершенно неважными. Почему бы не пойти на один шаг дальше, избегать препятствий и полагаться на Ruby без магии RSpec DSL?</p><p>Я больше придерживаюсь лагеря, в котором дублируют код установки для каждого теста, чем быть чрезмерно сухим, неясным или загадочным в моем наборе тестов. Я всегда на стороне читабельности кода. Метод тестирования должен четко указывать на причину и влияние его задействованных частей - использование объектов, которые, возможно, определены далеко от вашего теста будет явно не в ваших интересах. Если вам нужно извлечь материал, используйте выразительные методы, которые инкапсулируют эти знания. </p><p>Это почти всегда безопасно. Таким образом, вы также можете настроить параметры, которые вам действительно нужны для каждого теста, и не станет причиной медленных тестов, потому что у вас есть ненужные данные. Хорошие старые переменные, методы и классы часто все, что вам нужно, чтобы обеспечить более быстрые, стабильные тесты, которые легче читать. </p><h2>Тайные гости</h2><p>Тайные гости - RSpec DSL Puzzles. Некоторое время различные объекты, определенные через RSpec DSL <code class="inline">let</code>, не так уж сложно держать под контролем, но вскоре, когда набор тестов растет, вы приглашаете в своих спецификациях множество таинственных гостей. Это дает вашим будущим «я» и другим разработчикам ненужные контекстные головоломки. </p><p>Результатом станут неясные тесты, которые потребуют от вас полного режима Шерлока Холмса. Думаю, это звучит намного веселее, чем есть на самом деле. Итог, это пустая трата времени.</p><p>Тайные гости задают два проблемных вопроса:</p><ul><li>Откуда этот объект?</li> <li>Из чего именно состоит?</li> </ul><pre class="brush: rails noskimlinks noskimwords">describe Mission do  let(:agent_01)   { build_stubbed(:agent, name: "James Bond", number: "007") }  let(:agent_02)   { build_stubbed(:agent, name: "Moneypenny", number: "243") }  let(:title)   { "Moonraker" }  let(:mission) { build_stubbed(:mission, title: title) }  mission.agents &lt;&lt; agent_01 &lt;&lt; agent_02  ...  ...  ...  #lots of other tests  describe "#top_agent" do    it "returns highest ranking agent associated to a mission" do      expect(mission.top_agent).to eq("James Bond")    end  endend</pre><p>Этот блок описания для <code class="inline">#top_agent</code> не несет ясности и контекста. Какой агент задействован и о какой миссии мы говорим здесь? Это заставляет разработчиков охотиться за объектами, которые внезапно появляются в ваших тестах. </p><p>Классический пример загадочного гостя. Когда у нас есть много кода между соответствующим тестом и происхождением этих объектов, вы увеличиваете вероятность затенения того, что происходит в наших тестах.</p><p>Решение довольно простое: вам нужны свежие «светильники» - локальные версии объектов именно с теми данными, которые вам нужны - и не более того! Factory Girl - хороший выбор для решения этой проблемы. </p><p>Этот подход можно считать более подробным, и вы можете дублировать код, иногда извлечение кода в метод часто является хорошей идеей, но оно намного более выразительно и сохраняет ваши тесты акцентированными при обеспечении контекста.</p><pre class="brush: rails noskimlinks noskimwords">describe Mission do  #...  #...  #...  #lots of other tests  describe "#top_agent" do    it "returns a list of all agents associated to a mission" do      agent_01 = build_stubbed(:agent, name: "James Bond", number "007")      agent_02 = build_stubbed(:agent, name: "Moneypenny", number "243")      mission  = build_stubbed(:mission, title: "Moonraker")      mission.agents &lt;&lt; agent_01 &lt;&lt; agent_02      expect(mission.top_agent).to eq("James Bond")    end  endend</pre><p>В приведенном выше примере строятся все объекты, необходимые для наших тестов, в реальном тестовом примере и предоставляется весь контекст. Разработчик может сосредоточиться на конкретном тестовом сценарии и не нуждается в «загрузке» другого, возможно, полностью несвязанного теста, чтобы справиться с ситуацией. Нет больше безвестности!</p><p>Да, вы правы, этот подход означает, что мы не достигаем самого низкого уровня дублирования, но ясность в этих случаях гораздо важнее для качества вашего набора тестов и, следовательно, для надежности вашего проекта. Скорость, в которой вы можете эффективно применять изменения в своих тестах, также играет определенную роль в этом отношении. </p><p>Другим важным аспектом тестирования является то, что ваш набор тестов должен функционировать как документация! Нулевое дублирование не является целью, которая имеет положительный эффект для спецификаций, документирующих ваше приложение. Сохранение ненужного дублирования под контролем, тем не менее, важная цель - здесь нужно всегда следить за балансом! </p><h2>Неясные тесты</h2><p>Ниже приведен еще один пример, который пытается настроить все, что вам нужно локально в тесте, но также терпит неудачу, потому что это не говорит нам о полной истории.</p><pre class="brush: rails noskimlinks noskimwords">...  context "agent status" do    it "returns the status of the mission’s agent" do      double_o_seven = build_stubbed(:agent)      mission = build_stubbed(:mission, agent: double_o_seven)      expect(mission.agent_status).to eq(double_o_seven.status)    end  end</pre><p>Мы создаем общий агент. Откуда мы знаем, что это 007? Мы также проверяем статус агента, но его также нигде не найти - ни в настройке, ни в явном виде на этапе проверки в нашем <code class="inline">expect</code> выражении. Отношения между <code class="inline">double_o_seven.status</code> и статусом миссии могут сбивать с толку, поскольку оно выходит из ниоткуда. Мы можем сделать лучше:</p><pre class="brush: rails noskimlinks noskimwords">...  context "agent status" do    it "returns the status of the mission’s agent" do      double_o_seven = build_stubbed(:agent, name: "James Bond", status: "Missing in action"))      mission = build_stubbed(:mission, agent: double_o_seven)      expect(mission.agent_status).to eq("James Bond: Missing in action")    end  end</pre><p>Опять же, здесь у нас есть все, что нам нужно рассказать. Все данные, которые нам нужны, находятся прямо перед нами.</p><h2>Медленные тесты</h2><p>Итак, вы начали заниматься Test-Driven-Development, и вы начали понимать, что он предлагает. Kudos, это здорово! Я уверен, что ни решение сделать это, ни курс обучения, чтобы добраться туда, не были куском пирога. Но то, что часто случается после этого начального шага, заключается в том, что вы очень стараетесь иметь полное тестовое покрытие, и вы начинаете понимать, что что-то не работает, когда скорость ваших тестов начинает вас раздражать. </p><p>Почему ваш тестовый набор становится все медленнее и медленнее, хотя вы думаете, что делаете все правильно? Чувствуете себя наказанным за написание тестов? Медленные тесты высасывают кучу времени! Есть пара проблем с ними. Самая важная проблема заключается в том, что медленные тесты приводят к пропуску тестов в долгосрочной перспективе. Как только вы окажетесь в том месте, где ваш тестовый набор потребует вечность для завершения,  вы будете гораздо более охотно будете думать о том, чтобы пропустить его. У меня есть более важные дела, чем ждать, пока он закончится. «И вы абсолютно правы, у вас есть все, что нужно делать.</p><p>Дело в том, что медленные тесты с большей вероятностью будут заключаться в компромиссах качества вашего кода. Я думаю, что медленные тесты также несправедливо подпитывают аргументы людей против TDD. Я даже не хочу знать, что должны сказать нетехнические менеджеры по продуктам, если вам приходится регулярно выходить на улицу для приятного долгого перерыва на кофе, просто чтобы запустить тесты, прежде чем вы сможете продолжить свою работу.</p><p>Давайте не будем идти по этой дороге! Когда вам нужно всего лишь немного времени, чтобы выполнить свои тесты и, как результат, получить супер быстрые циклы обратной связи для разработки каждого шага новых функций, практика TDD становится намного более привлекательной и менее аргументированной. С небольшим количеством изменений мы можем избежать медленных тестов достаточно эффективно. </p><p>Медленные тесты также являются убийцей для попадания в «зону». Если вы часто выходите из потока в своем процессе, качество вашей общей работы может также пострадать, если вам придется ждать медленные тесты, чтобы вернуться из дорогой поездки туда и обратно. Вы хотите получить как можно больше «времени в зоне» - невыносимо медленные тесты - это основные убийцы потока.</p><p>Еще один вопрос, который стоит упомянуть в этом контексте, заключается в том, что это может привести к тестированию, которое покрывает ваш код, но поскольку вы не ждете конца выполнения всего пакета, то ваш дизайн больше не будет управляться тестами. Если вы не участвуете в тестовом поезде с тестовым управлением, это может не сильно вас беспокоить, но для людей TDD этот аспект необходим и его нельзя пренебрегать. </p><p>Итог, чем быстрее ваши тесты, тем больше вы будете готовы их использовать, что является лучшим способом разработки приложений, а также для раннего и частого обнаружения ошибок. </p><p>Что мы можем сделать для ускорения тестов? Здесь важны два аспекта:</p><ul><li>Скорость, с которой ваши тесты могут действительно выполнять ваш набор</li> <li>Скорость получения отзывов от вашего тестового набора для разработки вашего приложения</li> </ul><h3>Максимально избегайте записи в базу данных</h3><p>Это не означает, что вы должны избегать всех этих затрат. Часто вам не нужно писать тесты, которые используют базу данных, и вы можете заметно уменьшить время, которое нужно вашим тестам для выполнения. Для создания тестовых установок часто бывает достаточно просто <code class="inline">new</code> новый экземпляр объекта. Выделение объектов, которые не подвергаются прямому тестированию, является еще одним жизнеспособным вариантом. </p><p>Создание тестовых заглушек - отличный способ ускорить ваши тесты, сохраняя при этом объекты совместной работы, которые вам нужны для вашей настройки, сфокусированы и легки. <span>Factory Girl</span> также предоставляет вам различные варианты, чтобы «создать» ваши тестовые данные. Но иногда нет возможности избежать записи в базу данных (что случается намного реже, чем вы могли бы ожидать), и это именно то, где вы должны провести черту. В любое другое время, избегайте его, как ад, и ваш набор тестов будет оставаться быстрым и проворным. </p><p>В этом отношении вы также должны стремиться к минимальному количеству зависимостей, а это значит, минимальное количество объектов, которые вам нужны для того чтобы ваши тесты проходили, как можно меньше используя базу данных на своем пути. Делая заглушки для объектов, которые являются просто коллабораторами, а не непосредственно находятся под тестированием, часто также упрощает процесс настройки. Хорошее ускорение скорости в целом с очень небольшим усилием.</p><h3>Постройте свои тесты с тестовой пирамидой в уме</h3><p>Это означает, что вы хотите иметь большинство модульных тестов в нижней части этой иерархии, которые полностью сосредоточены на очень специфических частях вашего приложения в отдельности, и наименьшее количество интеграционных тестов в верхней части этой пирамиды. Интеграционные тесты имитируют пользователя, проходящего через вашу систему, взаимодействуя с кучей компонентов, которые выполняются в одно и то же время. </p><p>Они просты в написании, но их не так просто поддерживать, и потери скорости не стоят того, чтобы идти по легкому пути. Интеграционные тесты в значительной степени противоположны модульным тестам в отношении высокого уровня и использовании большого количества компонентов, которые вам нужно настроить в своих тестах, что является одной из основных причин, по которым они медленнее, чем модульные тесты. </p><p>Я думаю, это дает понять, почему они должны быть на вершине вашей тестовой пирамиды, чтобы избежать значительных потерь скорости. Еще одна важная проблема заключается в том, что вы хотите иметь как можно меньшее совпадений между этими двумя категориями тестов - вы в идеале хотите проверить вещи только один раз. Вы не можете рассчитывать на идеальное разделение, но должны к этому стремиться.</p><p>В отличие от модульных тестов, вы хотите проверить как можно больше деталей с интеграционными тестами. Внутренняя механика должна быть охвачена обширными модульными испытаниями. Вместо этого сосредоточьтесь только на наиболее важных частях, которые должны быть способны взаимодействовать друг с другом! Другая основная причина заключается в том, что веб-драйверу необходимо моделировать переход через браузер и взаимодействие со страницей. Такой подход тяжело эмулировать в тестах, при этом происходит сохранение данных в базе данных и используется пользовательский интерфейс. </p><p>Это также одна из причин, по которым их можно назвать приемочными тестами, потому что эти тесты пытаются имитировать реальный пользовательский опыт. Это еще один важный удар по скорости. Если у вас есть тонна этих тестов - я думаю, более 10% от вашего общего числа тестов - вы должны замедлить и уменьшить это число до минимальной возможной суммы. </p><p>Кроме того, имейте в виду, что иногда вам не нужно использовать все приложение - меньший, сфокусированный просмотр теста часто при этом помогает. Вы будете намного быстрее, если перепишите пару своих интеграционных тестов, которые просто проведут немного логики, что не потребует полной проверки интеграции. Но не пишите тонну подобных тестов. Интеграционные тесты жизненно важны для качества вашего набора тестов, и вам нужно найти баланс между ними и модульными тестами.</p><h3>Получение обратной связи от вашего приложения и тестов</h3><p>Быстрая обратная связь и быстрые итерационные циклы являются ключевыми для проектирования ваших объектов. Как только вы начнете часто избегать этих тестов, вы теряете это преимущество, которое является большой помощью при проектирования объектов. Не ждите, пока ваш сервис «Непрерывная интеграция» будет выбран, чтобы протестировать все ваше приложение. </p><p>Итак, какое волшебное число мы должны иметь в виду при выполнении тестов? Ну, разные люди расскажут вам о разных тестах. Я думаю, что выполнение менее 30 секунд - это очень разумное число, которое делает его очень вероятным для проведения полного теста на регулярной основе.  Это будет стоить того, и это заставит вас чувствовать себя намного более комфортно, потому что вы можете регулярно проводить проверки. Скорее всего, вы будете двигаться вперед намного быстрее.</p><p>Вы хотите, чтобы этот диалог с вашими тестами был как можно быстрее. Уменьшение этого цикла обратной связи с помощью редактора, который также может выполнять ваши тесты, нельзя недооценивать. Переключение между вашим редактором и вашим терминалом <em>не</em> является лучшим решением для этого. Это уже вышло из моды. </p><p>Если вам нравится использовать Vim, у вас есть еще одна причина потратить некоторое время на то, чтобы стать более эффективным при использовании вашего редактора. Для редактора Vim доступно множество удобных инструментов. Я помню, что Sublime Text также предлагает запускать тесты из редактора, но кроме этого вам нужно провести немного исследований, чтобы узнать, на что способен ваш редактор. Аргумент, который вы часто слышите от энтузиастов TDD, заключается в том, что вы не хотите покидать свой редактор, потому что в целом вы будете тратить слишком много времени на это. Вы хотите оставаться намного больше в зоне и не терять ход мыслей, когда вы можете создать быстрый ярлык внутри вашего редактора кода, который будет запускать ваши тесты. </p><p>Еще одна вещь, которую нужно отметить, это то, что вы также захотите разделить тесты, которые хотите запустить. Если вам не нужно запускать весь файл, приятно запустить один тест или блок, который фокусируется именно на том, что вам нужно, чтобы получить обратную связь прямо сейчас. Имея ярлыки, которые помогут вам запускать одиночные тесты, одиночные файлы или только последний тест снова сэкономит вам массу времени и удержит вас в зоне, не говоря уже о высокой степени удобства и чувстве супер денди. Просто удивительно, какими иногда могут быть инструменты для написания кода.</p><p>Последнее на дорожку. Используйте предварительный загрузчик, например <span>Spring</span>. Вы будете удивлены, сколько времени вы можете сэкономить, когда вам не нужно загружать Rails для каждого тестового прогона. Ваше приложение будет работать в фоновом режиме и не должно загружаться все время. Сделайте это!</p><h2>Фикстуры</h2><p>Я не уверен, что фикстуры по-прежнему остаются проблемой для новичков, приходящих на территорию Ruby/Rails. В случае, если никто не проинструктировал вас о них, я постараюсь рассказать вам об этих страшных вещах. </p><p>Фикстуры ActiveRecord - отличные примеры того, что в вашем тестовом наборе есть тонны Mystery Guests. В первые дни Rails и Ruby TDD фикстуры YAML были стандартом де-факто для настройки тестовых данных в вашем приложении. Они сыграли важную роль и помогли продвинуть отрасль вперед. В наши дни у них есть довольно плохая репутация.</p><h3>YAML Фикстуры</h3><pre class="brush: xml noskimlinks noskimwords">Quartermaster:  name: Q  favorite_gadget: Broom radio  skills: Inventing gizmos and hacking00Agent:  name: James Bond  favorite_gadget: Submarine Lotus Esprit  skills: Getting Bond Girls killed and covert infiltration</pre><p>Хэш-подобная структура, несомненно, удобна и проста в использовании. Вы даже можете ссылаться на другие узлы, если хотите имитировать ассоциации с вашими моделями. Но здесь музыка останавливается, и многие говорят, что их боль только начинается. Для наборов данных, которые немного более активны, фикстуры YAML трудно поддерживать и трудно изменять, не влияя на другие тесты. Я имею в виду, вы можете заставить их работать, конечно же, в конце концов, разработчики использовали их в прошлом, но тонны разработчиков согласятся с тем, что цена за управление фикстурами просто скудна.</p><p>Один из сценариев, которые мы, безусловно, хотим избежать, заключается в изменении небольших деталей в существующей фикстуре и сбое тонны тестов. Если эти неудачные тесты не связаны, ситуация еще хуже - хороший пример слишком хрупких тестов. Чтобы «защитить» существующие тесты от этого сценария, это также может привести к тому, что ваша фикстура будет рости за пределы любого разумного размера - DRY с такими фикстурами врятли подружится. </p><p>Чтобы избежать нарушения ваших тестовых данных, когда происходят неизбежные изменения, разработчики с радостью приняли новые стратегии, предлагающие большую гибкость и динамичное поведение. Именно там появилась <span>Factory Girl</span> и поцеловала YAML на прощание. </p><p>Другая проблема заключается в сильной зависимости между тестом и файлом текстуры .yml. Поскольку фикстуры определены в отдельном файле .yml, тайные гости также являются основной болью, ожидающей укусить вас из-за неясности. Я упоминал, что фикстуры импортируются в тестовую базу данных без каких-либо проверок и не соответствуют жизненному циклу Active Record? Да, это тоже не самое удачное решение - с какого угла ни посмотри! </p><p>Factory Girl позволяет вам избежать всего этого, создавая объекты, относящиеся к тестам, и только с данными, необходимыми для этого конкретного случая. Девиз - определить минимальный минимум в ваших фабричных определениях и добавить остальное на основе теста. Локально (в ваших тестах) переопределение значений по умолчанию, определенных на ваших фабриках, - это гораздо лучший подход, чем тонны единорогов, ожидающих устаревания в файле фикстур. </p><p>Этот подход также более масштабируемый. Factory Girl дает вам множество инструментов для создания всех необходимых вам данных, но также предоставляет вам массу боеприпасов, чтобы оставаться DRY там, где это необходимо. Думаю, плюсы и минусы прекрасно сбалансированы с этой библиотекой.  Я думаю, что использование шаблона фабрики для тестовых данных более чем разумно и является одной из основных причин, почему Factory Girl была так хорошо воспринята сообществом. </p><p>Сложность - быстрорастущий враг, и фикстуры YAML вряд ли способны эффективно с ним справиться. В некотором роде, я думаю о фикстурах, как о <code class="inline">let</code> на стероидах. Вы не только размещаете их еще дальше - находясь в отдельном файле, вы также потенциально можете загружать больше инструментов, чем вам может понадобиться. ПОКОЙСЯ С МИРОМ!</p><h2>Хрупкие тесты</h2><p>Если изменения в ваших спецификациях приводят к кажущимся несвязанным отказам в других тестах, вы, вероятно, смотрите на набор тестов, который стал хрупким из-за причин, упомянутых выше. Эти часто загадочные, загадочно-зараженные тесты легко приводят к неустойчивому карточному домику. </p><p>Когда объекты, необходимые для тестов, определяются «далеко» от фактического тестового сценария, не так уж сложно учесть отношения, которые эти объекты имеют с их тестами. Когда код удаляется, корректируется или просто объект установки, о котором идет речь, становится случайно переопределенным - не осознавая, как это может повлиять на другие тесты, падающие тесты не являются редкостью. Они легко выглядят как абсолютно несвязанные неудачи. Я считаю справедливым включение таких сценариев в категорию тесно связанного кода.</p><pre class="brush: rails noskimlinks noskimwords">describe Mission do  let(:agent)   { build_stubbed(:agent, name: "James Bond", number: "007") }  let(:title)   { "Moonraker" }  let(:mission) { build_stubbed(:mission, title: title) }  #...  #...  #...  #lots of other tests  describe "#joint_operation_agent_name" do    let(:agent) { build_stubbed(:agent, name: "Felix Leiter", agency: "CIA")    mission.agents &lt;&lt; agent    it “returns mission’s joint operation’s agent name” do      expect(mission.joint_operation_agent_name).to eq("Felix Leiter")    end  endend</pre><p>В этом сценарии мы четко изменили локально состояние объекта, которое было определено в нашей настройке. Этот <code class="inline">agent</code> теперь является оператором ЦРУ и имеет другое имя. <code class="inline">mission</code> так же приходит из ниоткуда. </p><p>Это не удивительно, когда другие тесты, которые, возможно, полагаются на другую версию <code class="inline">agent</code>, начинают падать. Давайте избавимся от <code class="inline">let</code> бессмыслицы и построим нужные нам объекты прямо там, где мы их тестируем, конечно, только с атрибутами, которые нам нужны для тестового примера. </p><pre class="brush: rails noskimlinks noskimwords">describe Mission do  #...  #...  #...  #lots of other tests  describe "#joint_operation_agent_name" do    agent   = build_stubbed(:agent, name: "Felix Leiter", agency: "CIA")    mission = build_stubbed(:mission)    mission.agents &lt;&lt; agent    it “returns mission’s joint operation’s agent name” do      expect(mission.joint_operation_agent_name).to eq("Felix Leiter")    end  endend</pre><p>Важно понимать, как связаны объекты - в идеале - с минимальным количеством кода установки. Вы не хотите посылать других разработчиков на охоту на диких гусей, чтобы понять это, когда они натыкаются на ваш код. </p><p>Если это очень сложно быстро понять, и новая функция должна быть реализована вчера, эти головоломки не могут рассчитывать на то, что им будет присвоен наивысший приоритет. Это, в свою очередь, часто означает, что новый материал развивается поверх этого неясного контекста - это хрупкая основа для продвижения вперед, а также отличное приглашение для ошибок в будущем. Урок, который нужно здесь усвоить, заключается не в том, чтобы, по возможности, переопределять код где это возможно.</p><h2>Атрибуты данных</h2><p>Конечным полезным советом для избежания хрупких тестов является использование атрибутов данных в ваших тегах HTML. Просто сделайте себе одолжение и используйте их - и вы будете позже мне благодарны. Это позволяет отделить необходимые элементы тестирования от информации о стиле, которую ваши дизайнеры могут затронуть часто, без вашего участия. </p><p>Если вы жестко кодируете класс, например <code class="inline">class="mission-wrapper"</code> в своем тесте, и умный дизайнер решает изменить это плохое имя, ваш тест будет подвергнут неоправданно затронут. Разумеется, дизайнер не виноват. Как она узнает, что это влияет на часть вашего набора тестов - по крайней мере, это было маловероятно. </p><pre class="brush: ruby noskimlinks noskimwords">&lt;div class="mission data-role="single-mission"&gt;  &lt;h2&gt;&lt;% = @mission.agent_status %&gt;&lt;/h2&gt;  ...&lt;/div&gt;</pre><pre class="brush: rails noskimlinks noskimwords">  context "mission’s agent status" do    it "does something with a mission" do      ...      ...      expect(page).to have_css "[data-role=single-mission]"    end  end</pre><p>Мы ожидаем увидеть некоторый HTML-элемент на странице и пометить его с помощью <code class="inline">data-role</code>. У дизайнеров нет причин касаться этого, и вы защищены от хрупких тестов, которые происходят из-за изменений в стилях. </p><p>Это довольно эффективная и полезная стратегия, которая в принципе не стоит вам ничего. Единственное, что может потребоваться, - это короткая беседа с дизайнерами!</p><h2>Финальные мысли</h2><p>Не нужно отвлекать или мешать или даже запутывать людей, которые будут читать наши тесты. Это открывает дверь для ошибок, но также может быть дорогостоящим, потому что это может стоить кучу времени и мощности мозга. Когда вы создаете свои тесты, старайтесь не переопределять вещи - это не помогает в придании им ясности. Скорее всего, это приведет к тонким, трудоемким ошибкам и не повлияет положительно на аспект документирования вашего кода. </p><p>Это создает ненужное бремя, которого мы можем избежать. Так же не стоит постоянно менять тестовые данные от одного теста к другому. Держите все как можно проще! Это действительно поможет вам избежать отправки других разработчиков или вашего будущего себя на дикие гусиные погони. </p><p>Еще многое предстоит узнать о том, что вам следует избегать во время тестирования, но я считаю, что это хорошее начало. Люди, которые являются абсолютными новичками в TDD должны иметь возможность разглядеть эти несколько антипаттернов.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby" href="https://norma-studio.github.io/article5/220825244-antipatterny-testy-rails" class="tm-article-body__tags-item-link">Ruby</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
37733</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
401</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
