
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API....">
<meta property="og:description" content="Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API....">
<meta name="twitter:description" content="Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API....">
<meta property="aiturec:description" content="Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/34/profiles/213/profileImage/4cssCOaK.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/34/profiles/213/profileImage/4cssCOaK.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/34/profiles/213/profileImage/4cssCOaK.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/34/profiles/213/profileImage/4cssCOaK.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/34/profiles/213/profileImage/4cssCOaK.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html" title="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io" title="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/65404fb3f3f8602d7f5b3bdc85cbef02.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html" class="tm-user-info__username" title="
А. Крайнов" aria-label="
А. Крайнов">
А. Крайнов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Улучшенные методы Ajax для WordPress: процедурное программирование...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="WordPress" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie" class="tm-article-snippet__hubs-item-link"><span>WordPress</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/34/profiles/213/profileImage/4cssCOaK.jpg">
    <meta itemprop="headline name" content="Улучшенные методы Ajax для WordPress: процедурное программирование... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Несколько лет назад я написал серию сообщений о том, как использовать Ajax в WordPress Frontend. Цель серии проста:</p><blockquote>Мы собираемся дать очень краткий обзор того, что такое Ajax, как он работает, как настроить его на передней панели и понять, какие ловушки поддерживает WordPress. Мы также создадим небольшой проект, который воплотит эту теорию в жизнь. Мы пройдем через исходный код, и мы также убедимся, что он доступен и на GitHub.<br></blockquote><p>Вообще говоря, серия держится хорошо, но, как и во всем программном обеспечении при постоянной разработке, методы, API и подходы меняются. Более того, по мере того, как проходят годы, и мы продолжаем совершенствовать свои навыки, мы совершенствуемся при разработке, и мы лучше используем новые API.</p><p>Из-за всего вышеизложенного я хочу вернуться к концепции Ajax в WordPress, чтобы вы увидели некоторые из новых API и как использовать их в своей повседневной работе или как реорганизовать некоторый код, который вы можете использовать С прямо сейчас.</p><p>Слово предостережения, прежде чем зайти слишком далеко в этот учебник: я предполагаю, что вы уже прочитали серию, связанную во введении этой статьи, и что у вас есть некоторый опыт создания плагинов WordPress.</p><h2>Определение плагина</h2><p>Как и в любом плагине WordPress, важно удостовериться, что вы определяете заголовок, чтобы WordPress мог прочитать файл, чтобы добавить новые функции в основное приложение.</p><p>Я называю этот вариант плагина <em>Simple Ajax Demo</em>, и он находится в <code class="inline">wp-content/plugin/wp-simple-ajax</code>. Первый созданный файл находится в корневом каталоге <code class="inline">wp-simple-ajax</code> и называется <code class="inline">wp-simple-ajax.php</code>.</p><p>Это выглядит так:</p><pre class="brush: php noskimlinks noskimwords">&lt;?php/** * Plugin Name:       Simple Ajax Demo * Description:       A simple demonstration of the WordPress Ajax APIs. * Version:           1.0.0 * Author:            Tom McFarlin * Author URI:        https://tommcfarlin.com/ * License:           GPL-2.0+ * License URI:       https://www.gnu.org/licenses/gpl-2.0.txt */</pre><p>Код должен быть понятным, особенно если вы привыкли работать с плагинами WordPress; Однако, самое важное, понять, что вся информация выше - это то, что будет управлять тем, что видит пользователь на панели инструментов WordPress.</p><p>То есть, пользователи будут видеть имя, описание и версию плагина, а также имя автора (которое будет связано с указанным URL-адресом), когда им будет предложено активировать плагин.</p><h2>Добавление файла Ajax для WordPress</h2><p>На данный момент плагин появится в панели инструментов WordPress Plugin, но на самом деле он ничего еще не делает, потому что мы не написали никакого кода. Чтобы код заработал, мы использовать в этом плагине процедурный подход к программированию, а не к объектно-ориентированный, который я использовал в большинстве моих обучающих программ.</p><h3>Как мы первоначально добавили поддержку Ajax</h3><p>Причина, по которой в настоящее время избегают объектно-ориентированного программирования, двоякая:</p><ol><li>Это связано с тем, что плагин будет очень простым. Мне больше интересно сосредоточиться на указанных API, предоставляемых WordPress, чтобы вы могли сконцентрировать внимание на самых важных вещах, на которых нужно сосредоточиться в этой работе.</li> <li>Вторая часть этой серии будет посвящена рефакторингу этого кода в объектно-ориентированную систему, чтобы вы могли увидеть, как все это может выглядеть в контексте более крупной системы, использующей классы.</li> </ol><p>В конечном счете, эта серия будет охватывать оба типа программирования, поддерживаемые PHP и WordPress.</p><p>Скорее всего, если вы уже работали с Ajax в прошлом, вы делали что-то подобное, чтобы предоставить вашему плагину поддержку для выполнения асинхронных вызовов:</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpadd_action( "wp_head","acme_add_ajax_support" );function acme_add_ajax_support() {?&gt;    &lt;script type="text/javascript"&gt;  var ajaxurl = "&lt;?php echo admin_url( "admin-ajax.php" ); ?&gt;";&lt;/script&gt;&lt;?php}</pre><p>Этот специфический метод не является по своей сути неправильным, но он пренебрегает некоторыми новыми API, которые я рассмотрю вкратце. Он также смешивает PHP, HTML и JavaScript в одной функции.</p><p>Это не очень здорово, поскольку он выполняет свою работу, но есть более чистый способ сделать это.</p><h3>Как мы добавляем поддержку Ajax</h3><p>Во-первых, чтобы убедиться, что плагин не может быть напрямую доступен кому-либо, добавьте следующее условное под заголовком плагина:</p><pre class="brush: php noskimlinks noskimwords">&lt;?php// If this file is called directly, abort.if ( ! defined( "WPINC" ) ) {    die;}</pre><p>Обратите внимание, что открывающий тег PHP не понадобится, поскольку этот код появится позже в уже существующем файле PHP (это необходимо для подсветки синтаксиса прямо сейчас).</p><p>Далее давайте настроим функцию для включения поддержки WordPress для Ajax с помощью некоторых из существующих API, которые не предполагают смешение языков. </p><p>Вот что нам нужно сделать:</p><ol><li>Мы собираемся создать функцию, отвечающую за добавление поддержки Ajax.</li> <li>Мы подключим эту функцию в действие<code class="inline"> wp_enqueue_script</code>.</li> <li>Мы воспользуемся вызовом API <code class="inline">wp_localize_script</code>, чтобы включить поддержку WordPress для Ajax (которая поступает из <code class="inline">admin-ajax.php</code>).</li> </ol><p>Выглядит достаточно просто, не так ли? Обратите внимание, если у вас есть какие-либо вопросы, вы всегда можете задать их в комментариях. Прочитайте следующий код, чтобы узнать, можете ли вы следовать вместе со мной дальше:</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpadd_action( "wp_enqueue_scripts", "sa_add_ajax_support" );/** * Adds support for WordPress to handle asynchronous requests on both the front-end * and the back-end of the website. * * @since    1.0.0 */function sa_add_ajax_support() {    wp_localize_script("ajax-script","sa_demo",array("ajaxurl" =&gt; admin_url( "admin-ajax.php" )));}</pre><p>Опять же, обратите внимание, что открывающий тег PHP не потребуется в окончательной версии плагина, так как здесь он используется только для подсветки синтаксиса.</p><p>С учетом сказанного, взгляните на <code class="inline">wp_localize_script</code>. Прежде чем рассматривать каждый параметр, давайте рассмотрим назначение этой функции. Из <span>Codex</span> короткая версия выглядит следующим образом:</p><blockquote>Локализует зарегистрированный сценарий с данными для переменной JavaScript.<br></blockquote><p>Однако более важное значение имеет более длинное описание:</p><blockquote>Это позволяет вам предлагать правильно локализованные переводы любых строк, используемых в вашем скрипте. Это необходимо, потому что WordPress в настоящее время предлагает API локализации только в PHP, а не непосредственно в JavaScript.</blockquote><blockquote>Хотя локализация - это основное применение, ее можно использовать для того, чтобы любые имеющиеся в вашем скрипте данные были доступны только с сервера WordPress.</blockquote><p>Теперь просмотрите параметры, которые он принимает:</p><ol><li>Первый параметр называется <code class="inline">handle</code> и используется для уникальной идентификации скрипта, который добавляется на страницу.</li> <li>Второй параметр - <code class="inline">name</code> важный, поскольку именно так вы будете идентифицировать сценарий в своем коде. Вы увидите это более подробно позже в этом уроке.</li> <li>Третий параметр - это параметр данных. Он ссылается на массив, который будет отправлен в браузер как объект JavaScript. Поскольку мы передаем URL-адрес пути к файлу, будет предоставлена поддержка Ajax.</li> </ol><p>Обратите внимание, что первым параметром является<code class="inline"> ajax-script</code>. Помните об этом, когда мы обращаем внимание на написание и добавление в очередь нашего собственного JavaScript, поскольку нам нужно использовать этот дескриптор еще раз. </p><p>Также не забудьте указать имя, которое вы выбрали для своего вызова API, поскольку мы будем использовать его при работе с клиентским кодом далее в этом уроке.</p><h3>Важная информация о поддержке Ajax</h3><p>Обратите внимание, что мы используем только хук <code class="inline">wp_enqueue_script</code>, и мы не используем <code class="inline">admin_enqueue_script</code>. Это связано с тем, что <code class="inline">ajaxurl</code> уже определен в панели мониторинга.</p><p>Это означает, что если вы хотите сделать Ajax-запросы в области администрирования WordPress, вам не нужно ничего ставить в очередь. Все, что мы делаем в контексте этого учебника, направлено для внешнего интерфейса веб-сайта.</p><h2>Настройка вашего кода на стороне сервера</h2><p>Теперь пришло время написать функцию, которую ваш JavaScript вызовет через Ajax. Это может быть все, что вы хотите, но для целей этого плагина мы собираемся настроить функцию, которая будет возвращать информацию о пользователе, который зарегистрирован на сайте.</p><p>Плагин выполнит следующие действия:</p><ul><li>Выполните запрос к серверу, запрашивая информацию о текущем пользователе.</li> <li>Если пользователь зарегистрируется на сайте, он вернет ответ JSON от информации пользователя.</li> <li>Если пользователь не вошел в систему, он вернет код ошибки.</li> </ul><p>Мы будем использовать объект <code class="inline">console</code>  доступный в большинстве современных браузеров, поэтому убедитесь, что используете Chrome, Safari или Firefox при работе с исходным кодом JavaScript, который вы будете писать.</p><h2>Отправляем запрос</h2><p>Теперь, когда мы наметили, как именно код будет работать, когда пользователь отправит запрос Ajax на сервер, давайте начнем писать функцию для этого. Мы назовем его <code class="inline">sa_get_user_information</code>.</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpadd_action( "wp_ajax_get_current_user_info", "sa_get_current_user_info" );add_action( "wp_ajax_nopriv_get_current_user_info", "sa_get_current_user_info" );/** * Retrieves information about the user who is currently logged into the site. * * This function is intended to be called via the client-side of the public-facing * side of the site. * * @since    1.0.0 */function sa_get_current_user_info() {}</pre><p>Реализация функции будет позже в этом уроке, но основной вывод из вышеприведенного кода состоит в том, что мы подключились как к <code class="inline">wp_ajax_get_current_user_info</code>, так и к <code class="inline">wp_ajax_nopriv_get_current_user_info</code>. </p><p>Эти два хука хорошо документированы в Codex, но <span>первый хук</span> позволит тем, кто вошел на сайт, получить доступ к этой функции. <span>Второй хук</span> позволит тем, кто <em>не</em> вошел на этот сайт, получить доступ к этой функции.</p><p>Также обратите внимание, что все после <code class="inline">wp_ajax_</code> и <code class="inline">wp_ajax_nopriv_</code> зависит от вас, как разработчика, это должны определить вы сами. Это будет имя функции, которую вы вызываете с клиентской стороны, как вы увидите далее в этом уроке.</p><h3>Обработка ошибочных запросов</h3><p>Перед реализацией функции был вызван исходный файл JavaScript (который еще не был написан), и нам нужно убедиться, что мы сможем справиться с любыми ошибками, которые могут произойти.</p><p>В нашем случае потенциальными ошибками могут быть:</p><ol><li>Никто не подключен.</li> <li>ИД пользователя не существует в системе.</li> </ol><p>Очень маловероятно, что второй случай будет правдой, но это поможет нам узнать больше о еще нескольких API-интерфейсах WordPress и о том, как мы можем использовать их для обработки ошибочных запросов.</p><p>Первое, что нужно понять, это <code class="inline">WP_Error</code>. Как и многие API, это доступно в <span>Codex</span>:</p><blockquote>Экземпляры кодов ошибок и сообщений об ошибках WP_Error, представляющие одну или несколько ошибок, и возможность того, является ли переменная экземпляром WP_Error, могут быть определены с помощью функции is_wp_error().<br></blockquote><p>Конструктор принимает до трех параметров (хотя мы будем использовать только первые два):</p><ol><li>Первый аргумент - это код ошибки. Это то, что мы можем использовать на стороне клиента для разбора и определения того, что пошло не так. Это также позволяет нам записывать информацию в файл журнала и так далее.</li> <li>Второй аргумент - это сообщение, которое может сопровождать код ошибки. Это полезно, если мы хотим отобразить сообщение пользователю.</li> <li>Последний аргумент - массив информации, обычно коды ошибок и сообщения. Несмотря на это, мы не будем использовать его в нашем коде.</li> </ol><p>Затем мы отправим результаты ошибок обратно клиенту с помощью функции <code class="inline">wp_send_json_error</code>. Это очень просто сделать:</p><blockquote>Отправьте ответ JSON обратно на запрос Ajax, указывая на сбой. Объект ответа всегда будет иметь ключ успеха со значением false. Если что-либо передается функции в параметре $data, то оно будет закодирована как значение для ключа данных.<br></blockquote><p>Объединив оба <code class="inline">WP_Error</code> и <code class="inline">wp_send_json_error</code>, мы можем создать функции, которые помогут нам предоставить коды ошибок JavaScript, вызывающим серверную часть.</p><p>Например, предположим, что у нас есть функция, предоставляющая сообщение об ошибке, если пользователь не вошел на сайт. Это может быть реализовано с помощью следующей функции:</p><pre class="brush: php noskimlinks noskimwords">&lt;?php/** * Determines if a user is logged into the site using the specified user ID. If not, * then the following error code and message will be returned to the client: * * -2: The visitor is not currently logged into the site. * * @access   private * @since    1.0.0 * * @param    int    $user_id    The current user"s ID. */function _sa_user_is_logged_in( $user_id ) {    if ( 0 === $user_id ) {wp_send_json_error(new WP_Error( "-2", "The visitor is not currently logged into the site." ));}}</pre><p>Обратите внимание: функция отмечена как private, даже если она находится в глобальном пространстве имен. Он имеет префикс с подчеркиванием, чтобы обозначить эту функцию конфиденциальной.</p><p>Мы вернемся к этому в следующей статье.</p><p>Во-вторых, мы должны обработать сценарий, если пользователь не существует. Для этого мы можем создать функцию, которая выполняет следующее:</p><pre class="brush: javascript noskimlinks noskimwords">&lt;?php/** * Determines if a user is logged into the site using the specified user ID. If not, * then the following error code and message will be returned to the client: * * -2: The visitor is not currently logged into the site. * * @access   private * @since    1.0.0 * * @param    int    $user_id    The current user"s ID. */function _sa_user_is_logged_in( $user_id ) {    if ( 0 === $user_id ) {wp_send_json_error(new WP_Error( "-2", "The visitor is not currently logged into the site." ));}}</pre><p>Теперь у нас есть две функции, каждая из которых будет отправлять информацию клиенту, если что-то не пошло не так, но что мы будем делать, если обе эти функции пройдут?<br></p><h3>Обработка успешных запросов</h3><p>Если приведенные выше функции не приводят к ошибкам, нам нужно иметь способ отправить запрос обратно клиенту с успешным сообщением и информацией, которую он запрашивает.</p><p>А именно, нам нужно отправить информацию обратно клиенту, которая содержит данные текущего пользователя в формате JSON.</p><p>Для этого мы можем воспользоваться сообщением <code class="inline">wp_send_json_success</code>. Оно делает то, что, по вашему мнению и должно делать:</p><blockquote>Отправляет ответ JSON обратно на запрос Ajax, указывая на успех. Объект ответа всегда будет иметь ключ успеха со значением true. Если что-либо передано функции, оно будет закодировано как значение для ключа данных.<br></blockquote><p>Давайте объединим работу, которую мы сделали до сих пор, чтобы написать функцию, которую JavaScript в конечном итоге вызовет, и которая использует две меньшие функции, которые мы разместили выше. Фактически, это будет реализация функции, которую мы пропустили ранее в этом уроке:</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpadd_action( "wp_ajax_get_current_user_info", "sa_get_current_user_info" );add_action( "wp_ajax_nopriv_get_current_user_info", "sa_get_current_user_info" );/** * Retrieves information about the user who is currently logged into the site. * * This function is intended to be called via the client-side of the public-facing * side of the site. * * @since    1.0.0 */function sa_get_current_user_info() {    // Grab the current user"s ID$user_id = get_current_user_id();    // If the user is logged in and the user exists, return success with the user JSONif ( _sa_user_is_logged_in( $user_id ) &amp;&amp; _sa_user_exists( $user_id ) ) {wp_send_json_success(json_encode( get_user_by( "id", $user_id ) ));}}</pre><p>Если пользователь зарегистрирован и пользователь существует, то мы отправим клиенту сообщение об успешном завершении, содержащее JSON представление пользователя. На этом этапе пришло время написать немного JavaScript.</p><h2>Запрос на стороне клиента</h2><p>Сначала добавьте файл с именем <code class="inline">frontend.js</code> в корневой каталог вашего плагина. Первоначально он должен содержать следующий код:</p><pre class="brush: javascript noskimlinks noskimwords">;(function( $ ) {    "use strict";$(function() {});})( jQuery );</pre><p>Реализация функции будет покрыта на мгновение, но нам нужно убедиться, что мы добавим этот файл JavaScript в плагин. Вернитесь к функции <code class="inline">sa_add_ajax_support</code> и добавьте следующий выше вызов <code class="inline">wp_localize_script</code>:</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpwp_enqueue_script("ajax-script",plugin_dir_url( __FILE__ ) . "frontend.js",array( "jquery" ));</pre><p>Помните, этот скрипт должен иметь тот же дескриптор, что и тот, который определен в wp_localize_script. Теперь мы можем вернуться к нашему файлу JavaScript и сделать звонок на серверный код, над которым мы работали всю эту статью.</p><p>В файле <code class="inline">frontend.js</code> добавьте следующий код:</p><pre class="brush: javascript noskimlinks noskimwords">/** * This file is responsible for setting up the Ajax request each time * a WordPress page is loaded. The page could be the main index page, * a single page, or any other type of information that WordPress renders. * * Once the DOM is ready, it will make an Ajax call to the server where * the `get_current_user_info` function is defined and will then handle the * response based on the information returned from the request. * * @since    1.0.0 */;(function( $ ) {    "use strict";$(function() {/* Make an Ajax call via a GET request to the URL specified in the * wp_enqueue_script call. For the data parameter, pass an object with * the action name of the function we defined to return the user info. */$.ajax({url:    sa_demo.ajax_url,method: "GET",data:   { action: "get_current_user_info" }}).done(function( response ) {/* Once the request is done, determine if it was successful or not. * If so, parse the JSON and then render it to the console. Otherwise, * display the content of the failed request to the console. */if ( true === response.success ) {console.log( JSON.parse( response.data ) );} else {console.log( response.data );}});});})( jQuery );</pre><p>Учитывая количество комментариев в коде и предполагая, что вы знакомы с написанием плагинов WordPress и имеете некоторый опыт работы с Ajax, все это для вас должно было быть относительно легко.</p><p>Короче говоря, код выше делает вызов серверной стороны, когда страница загружается, а затем записывает информацию на консоль браузера о текущем пользователе. </p><p>Если пользователь вошел в систему, информация записывается в консоль в виде объекта JavaScript, поскольку он обрабатывается из JSON.</p><p>Если, с другой стороны, пользователь <em>не</em> вошел в систему, тогда будет выписан другой объект, отображающий код ошибки вместе с сообщением, которые вы сможете увидеть в консоли.</p><h2>Заключение</h2><p>К настоящему времени у вас должно быть четкое представление о API-интерфейсах, которые WordPress может использовать для работы с запросами Ajax для пользователей, которые вошли на сайт, а также для тех, кто этого не сделал.</p><p>В конечном счете, наша цель не заключалась в том, чтобы написать самый чистый, самый поддерживаемый код, а наоборот в том, чтобы у нас была возможность продолжить работу с этим кодом по мере продвижения в будущее. Кроме того, мы должны написать такой код, чтобы другие пользователи, которые могут воспользоваться нашей кодовой базы, получили четкое представление о том, что мы пытаемся сделать.</p><p>В этом уроке я использовал процедурный подход к программированию для всего кода, который был совместно использован, продемонстрирован и предоставлен через GitHub. Как уже упоминалось ранее, в этом нет ничего изначально неправильного, но я действительно думаю, что стоит посмотреть, как это выглядит с объектно-ориентированной точки зрения.</p><p>В следующем уроке мы рассмотрим рефакторинг этого кода в объектно-ориентированную парадигму, которая также использует <span>стандарты кодирования WordPress</span> для дальнейшего документирования нашей работы, и которая использует четкую организацию файлов, чтобы сделать наш код максимально понятным.</p><p>Помните, что вы можете отслеживать все мои курсы и учебные материалы на <span>моей странице в профиле</span>, и вы можете следить за мной в моем <span>блоге</span> и/или Twitter в <span>@tommcfarlin</span>, где я рассказываю о разработке программного обеспечения в контексте WordPress.</p><p>Тем временем, пожалуйста, не стесняйтесь оставлять любые вопросы или комментарии в фиде ниже, и я постараюсь ответить на каждый из них. </p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="WordPress" href="https://norma-studio.github.io/article5/220825321-uluchshennye-metody-ajax-dlya-wordpress-protsedurnoe-programmirovanie" class="tm-article-body__tags-item-link">WordPress</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
42153</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
537</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
