
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Есть достаточно гемов, которые предназначены для загрузки файлов, такие как CarrierWave, Paperclip и Dragonfly, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и -вероятно, Вы уже использовали хотя бы один из этих гемов....">
<meta property="og:description" content="Есть достаточно гемов, которые предназначены для загрузки файлов, такие как CarrierWave, Paperclip и Dragonfly, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и -вероятно, Вы уже использовали хотя бы один из этих гемов....">
<meta name="twitter:description" content="Есть достаточно гемов, которые предназначены для загрузки файлов, такие как CarrierWave, Paperclip и Dragonfly, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и -вероятно, Вы уже использовали хотя бы один из этих гемов....">
<meta property="aiturec:description" content="Есть достаточно гемов, которые предназначены для загрузки файлов, такие как CarrierWave, Paperclip и Dragonfly, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и -вероятно, Вы уже использовали хотя бы один из этих гемов....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1463/profiles/19974/profileImage/AAEAAQAAAAAAAAPnAAAAJGMwZGE5NzIzLTAxM2UtNDVjNi04YTI5LTU5NDg2Nzk2MjMwZg.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1463/profiles/19974/profileImage/AAEAAQAAAAAAAAPnAAAAJGMwZGE5NzIzLTAxM2UtNDVjNi04YTI5LTU5NDg2Nzk2MjMwZg.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1463/profiles/19974/profileImage/AAEAAQAAAAAAAAPnAAAAJGMwZGE5NzIzLTAxM2UtNDVjNi04YTI5LTU5NDg2Nzk2MjMwZg.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1463/profiles/19974/profileImage/AAEAAQAAAAAAAAPnAAAAJGMwZGE5NzIzLTAxM2UtNDVjNi04YTI5LTU5NDg2Nzk2MjMwZg.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1463/profiles/19974/profileImage/AAEAAQAAAAAAAAPnAAAAJGMwZGE5NzIzLTAxM2UtNDVjNi04YTI5LTU5NDg2Nzk2MjMwZg.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html" title="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io" title="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/653463654.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html" class="tm-user-info__username" title="
С. Салин" aria-label="
С. Салин">
С. Салин</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Загрузка файлов с помощью Rails и Shrine...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine" class="tm-article-snippet__hubs-item-link"><span>Ruby on Rails</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1463/profiles/19974/profileImage/AAEAAQAAAAAAAAPnAAAAJGMwZGE5NzIzLTAxM2UtNDVjNi04YTI5LTU5NDg2Nzk2MjMwZg.jpg">
    <meta itemprop="headline name" content="Загрузка файлов с помощью Rails и Shrine... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Есть достаточно гемов, которые предназначены для загрузки файлов, такие как CarrierWave, Paperclip и Dragonfly, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и -вероятно, Вы уже использовали хотя бы один из этих гемов....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Есть достаточно гемов, которые предназначены для загрузки файлов, такие как CarrierWave, Paperclip и Dragonfly, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и -вероятно, Вы уже использовали хотя бы один из этих гемов....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Есть достаточно гемов, которые предназначены для загрузки файлов, такие как <span>CarrierWave</span>, <span>Paperclip</span> и <span>Dragonfly</span>, несколько из них, которые стоит упомянуть. У всех есть свои особенности, и  вероятно, Вы уже использовали хотя бы один из этих гемов.</p><p>Однако сегодня я хочу представить относительно новое, но очень крутое решение, называемое <span>Shrine</span>, созданное Янко Мароничем. В отличие от некоторых других подобных гемов, он имеет модульный подход, что означает, что каждая функция упакована в виде модуля (или <em>плагина</em> в терминологии Shrine). Хотите поддержку валидации? Добавьте плагин. Желаете сделать некоторую обработку файлов? Добавить плагин! Мне очень нравится этот подход, поскольку он позволяет вам легко контролировать, какие функции будут доступны для конкретной модели.<br></p><p>В этой статье я расскажу вам, как:</p><ul><li>Интегрировать Shrine в Rails приложение</li> <li>Конфигурировать его (глобально и для каждой модели)</li> <li>Добавить возможность загрузки файлов</li> <li>Обработка файлов</li> <li>Добавить правила валидации</li> <li>Хранить дополнительные метаданные и использовать хранилище файлов с Amazon S3</li> </ul><p>Исходный код этой статьи доступен на <span>GitHub</span>.</p><p>Рабочее демо можно найти <span>здесь</span>.</p><h2>Интеграция Shrine<br></h2><p>Чтобы начать, создайте новое Rails приложение без тестового фреймворка по умолчанию:</p><pre class="brush: bash noskimlinks noskimwords">rails new FileGuru -T</pre><p>Я буду использовать Rails 5 для этой демонстрации, но большинство концепций подходят к версиям 3 и 4.<br></p><p>Добавьте <span>гем Shrine</span> в свой Gemfile:</p><pre class="brush: rails noskimlinks noskimwords">gem "shrine"</pre><p>Затем выполните:</p><pre class="brush: bash noskimlinks noskimwords">bundle install</pre><p>Теперь нам <span>понадобится</span> модель, которую я собираюсь назвать <code class="inline">Photo</code>. Shrine хранит всю связанную с файлами информацию в специальном текстовом столбце, заканчивающемся суффиксом <code class="inline">_data</code>. Создайте и примените соответствующую миграцию:</p><pre class="brush: plain noskimlinks noskimwords">rails g model Photo title:string image_data:textrails db:migrate</pre><p>Обратите внимание, что для старых версий Rails последняя команда должна быть:</p><pre class="brush: plain noskimlinks noskimwords">rake db:migrate</pre><p>Параметры конфигурации для Shrine могут быть установлены как глобально, так и для каждой модели. Глобальные настройки выполняются, внутри файла инициализации. Там я собираюсь подключить необходимые файлы и <em><span>плагины</span></em>. В Shrine плагины используются для отделения частей функциональности в отдельные модули, что дает Вам полный контроль над всеми доступными функциями. Например, есть плагины для валидации, обработки изображений, кэширования вложений и т.д.</p><p>Пока добавим два плагина: один <span>для поддержки ActiveRecord</span> и еще один для настройки <span>логирования</span>. Они будут включены глобально. Кроме того, настроим <span>файловое хранилище</span>:</p><h4>config/initializers/shrine.rb</h4><pre class="brush: rails noskimlinks noskimwords">require "shrine"require "shrine/storage/file_system"Shrine.plugin :activerecordShrine.plugin :logging, logger: Rails.loggerShrine.storages = {  cache: Shrine::Storage::FileSystem.new("public", prefix: "uploads/cache"),  store: Shrine::Storage::FileSystem.new("public", prefix: "uploads/store"),}</pre><p>Logger будет просто выводить некоторую отладочную информацию внутри консоли, показывая, сколько времени было потрачено на обработку файла. Это может пригодиться.</p><pre class="brush: plain noskimlinks noskimwords">2015-10-09T20:06:06.676Z #25602: STORE[cache] ImageUploader[:avatar] User[29543] 1 file (0.1s)2015-10-09T20:06:06.854Z #25602: PROCESS[store]: ImageUploader[:avatar] User[29543] 1-3 files (0.22s)2015-10-09T20:06:07.133Z #25602: DELETE[destroyed]: ImageUploader[:avatar] User[29543] 3 files (0.07s)</pre><p>Все загруженные файлы будут храниться в каталоге <em>public/uploads</em>. Я не хочу отслеживать эти файлы в Git, поэтому исключу эту папку:</p><h4>.gitignore</h4><pre class="brush: plain noskimlinks noskimwords">public/uploads</pre><p>Теперь создайте специальный класс загрузчик, в котором будут размещаться конфиги для модели. Пока этот класс будет пустым:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">class ImageUploader &lt; Shrineend</pre><p>Наконец, включите этот класс в модель <code class="inline">Photo</code>:</p><h4>models/photo.rb</h4><pre class="brush: rails noskimlinks noskimwords">include ImageUploader[:image]</pre><p><code class="inline">[:Image]</code> добавляет виртуальный атрибут, который будет использоваться при создании формы. Вышеупомянутая строка может быть переписана так:</p><pre class="brush: rails noskimlinks noskimwords">  include ImageUploader.attachment(:image)    # or  include ImageUploader::Attachment.new(:image) </pre><p>Хорошо! Теперь модель оснащена функциональностью Shrine, и мы можем перейти к следующему шагу.</p><h2>Контроллер, представление и роутинг</h2><p>Для целей этой демонстрации нам нужен только один контроллер для управления фотографиями. Страница <code class="inline">index</code> будет служить в качестве корня:</p><h4>pages_controller.rb</h4><pre class="brush: rails noskimlinks noskimwords">class PhotosController &lt; ApplicationController  def index    @photos = Photo.all  endend</pre><p>Представление:</p><h4>views/photos/index.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;h1&gt;Photos&lt;/h1&gt;&lt;%= link_to "Add Photo", new_photo_path %&gt;&lt;%= render @photos %&gt;</pre><p>Для рендеринга массива <code class="inline">@photos</code> требуется партиал:</p><h4>views/photos/_photo.html.erb<br></h4><pre class="brush: rails noskimlinks noskimwords">&lt;div&gt;  &lt;% if photo.image_data? %&gt;    &lt;%= image_tag photo.image_url %&gt;  &lt;% end %&gt;  &lt;p&gt;&lt;%= photo.title %&gt; | &lt;%= link_to "Edit", edit_photo_path(photo) %&gt;&lt;/p&gt;&lt;/div&gt;</pre><p><code class="inline">image_data?</code> Это метод, предоставленный Shrine, который проверяет, имеет ли запись изображение.</p><p><code class="inline">image_url</code> - еще один метод Shrine, который просто возвращает ссылку исходного изображения. Конечно, гораздо лучше отобразить небольшое уменьшенное изображение, но мы позаботимся об этом позже.<br></p><p>Добавим все необходимые роуты:</p><h4>config/routes.rb</h4><pre class="brush: rails noskimlinks noskimwords">  resources :photos, only: [:new, :create, :index, :edit, :update]  root "photos#index"</pre><p>Фундамент создан, теперь мы можем перейти к интересной части!</p><h2>Загрузка файлов</h2><p>В этом разделе я покажу вам, как добавить функциональность для загрузки файлов. Действия контроллера очень просты:</p><h4>photos_controller.rb</h4><pre class="brush: rails noskimlinks noskimwords">def new    @photo = Photo.newenddef create    @photo = Photo.new(photo_params)    if @photo.save        flash[:success] = "Photo added!"        redirect_to photos_path    else        render "new"    endend</pre><p>Единственная проблема заключается в том, что для strong parameters, Вы должны разрешать виртуальный атрибут <code class="inline">image</code>, а не <code class="inline">image_data</code>.</p><h4>photos_controller.rb<br></h4><pre class="brush: rails noskimlinks noskimwords">privatedef photo_params    params.require(:photo).permit(:title, :image)end</pre><p>Создадим представление <code class="inline">new</code>:</p><h4>views/photos/new.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;h1&gt;Add photo&lt;/h1&gt;&lt;%= render "form" %&gt;</pre><p>Партиал формы также тривиален:</p><h4>views/photos/_form.html.erb<br></h4><pre class="brush: rails noskimlinks noskimwords">&lt;%= form_for @photo do |f| %&gt;  &lt;%= render "shared/errors", object: @photo %&gt;  &lt;%= f.label :title %&gt;  &lt;%= f.text_field :title %&gt;  &lt;%= f.label :image %&gt;  &lt;%= f.file_field :image %&gt;  &lt;%= f.submit %&gt;&lt;% end %&gt;</pre><p>Еще раз отметим, что мы используем атрибут <code class="inline">image</code>, а не <code class="inline">image_data</code>.</p><p>Наконец, добавим еще один партиал для отображения ошибок:</p><h4>views/shared/_errors.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;% if object.errors.any? %&gt;  &lt;h3&gt;The following errors were found:&lt;/h3&gt;  &lt;ul&gt;    &lt;% object.errors.full_messages.each do |message| %&gt;      &lt;li&gt;&lt;%= message %&gt;&lt;/li&gt;    &lt;% end %&gt;  &lt;/ul&gt;&lt;% end %&gt;</pre><p>Это почти все - можете начать загрузку изображений прямо сейчас.</p><h3>Валидация</h3><p>Конечно же, для завершения демонстрационного приложения нужно сделать гораздо больше работы. Основная проблема заключается в том, что пользователи могут загружать абсолютно любой тип файла с любым размером, что не очень хорошо. Поэтому, добавим еще один плагин для <span>поддержки валидации</span>:</p><h4>config/inititalizers/shrine.rb</h4><pre class="brush: rails noskimlinks noskimwords">Shrine.plugin :validation_helpers</pre><p>Конфигурация логики валидации для <code class="inline">ImageUploader</code>:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">Attacher.validate do    validate_max_size 1.megabyte, message: "is too large (max is 1 MB)"    validate_mime_type_inclusion ["image/jpg", "image/jpeg", "image/png"]end</pre><p>Я разрешаю загружать только изображения JPG и PNG менее 1 МБ. Поправьте эти правила в соответствии вашим требованиям.</p><h3>MIME типы</h3><p>Еще одна важная вещь, которую следует отметить, заключается в том, что по умолчанию Shrine будет определять MIME-тип файла, используя HTTP-заголовок Content-Type. Этот заголовок передается браузером и устанавливается только на основе расширения файла, что не всегда желательно.</p><p>Если вы хотите определить MIME-тип на основе содержимого файла, используйте плагин <span>define_mime_type</span>. Я включу его в класс загрузчика, так как другие модели могут и не требовать этого функционала:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">plugin :determine_mime_type</pre><p>Этот плагин по умолчанию будет использовать утилиту <span>file</span> из ОС Linux.</p><h3>Кэширование прикрепленных изображений</h3><p>В настоящее время, когда пользователь отправляет форму с неверными данными, форма снова будет отображаться с ошибками, представленными выше. Однако, проблема в том, что прикрепленное изображение будет потеряно, и пользователю нужно будет выбрать его еще раз. Это очень легко исправить, используя еще один плагин <span>cached_attachment_data</span>:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">plugin :cached_attachment_data</pre><p>Теперь, просто добавьте скрытое поле в вашу форму.</p><h4>views/photos/_form.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;%= f.hidden_field :image, value: @photo.cached_image_data %&gt;&lt;%= f.label :image %&gt;&lt;%= f.file_field :image %&gt;</pre><h2>Редактирование фотографии</h2><p></p><p>Теперь изображения могут быть загружены, но нет возможности редактировать их, поэтому давайте сразу исправим это. Действия соответствующего контроллера довольно тривиальны:</p><h4>photos_controller.rb</h4><pre class="brush: rails noskimlinks noskimwords">def edit    @photo = Photo.find(params[:id])enddef update    @photo = Photo.find(params[:id])    if @photo.update_attributes(photo_params)      flash[:success] = "Photo edited!"      redirect_to photos_path    else      render "edit"    endend</pre><p>Будет использоваться тот же партиал <code class="inline">_form</code>:</p><h4>views/photos/edit.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;h1&gt;Edit Photo&lt;/h1&gt;&lt;%= render "form" %&gt;</pre><p>Удобно, но недостаточно: пользователи по-прежнему не могут удалить загруженное изображение. Для того, чтобы исправить это, думаю, что нам понадобится <span>еще один плагин</span>: </p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">plugin :remove_attachment</pre><p>Он использует виртуальный атрибут: <code class="inline">remove_image</code>, поэтому разрешим его внутри контроллера:</p><h4>photos_controller.rb</h4><pre class="brush: rails noskimlinks noskimwords">def photo_params    params.require(:photo).permit(:title, :image, :remove_image)end</pre><p>Теперь просто установите флажок, чтобы удалить изображение, если запись имеет вложение:</p><h4>views/photos/_form.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;% if @photo.image_data? %&gt;    Remove attachment: &lt;%= f.check_box :remove_image %&gt;&lt;% end %&gt;</pre><h2>Создание эскиза изображения</h2><p>В настоящее время мы показываем оригинальные изображения, которые не подходят для предварительного просмотра: фотографии могут быть большими и занимать слишком много места. Конечно, Вы могли бы просто использовать CSS атрибуты <code class="inline">width</code> и <code class="inline">height</code>, но это тоже плохая идея. Как видите, даже если изображение установлено как уменьшенное с помощью стилей, пользователю все равно нужно будет загрузить исходный файл, который может быть довольно большим.</p><p>Поэтому гораздо лучше создать небольшое предварительное изображение на стороне сервера во время начальной загрузки. Это включает в себя два плагина и два дополнительных гема. Сначала добавим гемы:</p><pre class="brush: rails noskimlinks noskimwords">gem "image_processing"gem "mini_magick", "&gt;= 4.3.5"</pre><p><span>Image_processing</span> - это особый гем, созданный автором Shrine. В нем представлены некоторые вспомогательные методы для управления изображениями на высоком уровне. Этот гем, в свою очередь, полагается на <span>mini_magick</span> - оболочку Ruby для ImageMagick. Как Вы уже догадались, нам понадобится <span>ImageMagick</span> в системе, чтобы запустить этот пример.</p><p>Установим эти гемы:</p><pre class="brush: bash noskimlinks noskimwords">bundle install</pre><p>Теперь включите плагины вместе с их зависимостями:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">require "image_processing/mini_magick"class ImageUploader &lt; Shrine    include ImageProcessing::MiniMagick    plugin :processing    plugin :versions    # other code...end</pre><p><span>Processing</span> - это плагин для манипулирования изображением (например, сжатие, поворот, преобразование в другой формат и т. д.). <span>Versions</span>, в свою очередь, позволяют нам иметь изображение в разных вариантах. Для этой демонстрации будут сохранены две версии: "original" и "thumb"  (размер изменён на <code class="inline">300x300</code>).</p><p>Вот код для обработки изображения и хранения его двух версий:</p><h4>models/image_uploader.rb<br></h4><pre class="brush: rails noskimlinks noskimwords">class ImageUploader &lt; Shrine    process(:store) do |io, context|        { original: io, thumb: resize_to_limit!(io.download, 300, 300) }    endend</pre><p><code class="inline">resize_to_limit!</code> Это метод, предоставляемый гемом обработки изображений. Он просто уменьшает изображение до <code class="inline">300x300</code>, если оно больше, и ничего не делает, если оно меньше. Кроме того, он сохраняет исходное соотношение сторон.</p><p>Теперь, когда мы показываем изображение, нам просто нужно предоставить аргумент: <code class="inline">original</code> или: <code class="inline">thumb</code> для метода <code class="inline">image_url</code>:</p><h4>views/photos/_photo.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;div&gt;  &lt;% if photo.image_data? %&gt;    &lt;%= image_tag photo.image_url(:thumb) %&gt;  &lt;% end %&gt;  &lt;p&gt;&lt;%= photo.title %&gt; | &lt;%= link_to "Edit", edit_photo_path(photo) %&gt;&lt;/p&gt;&lt;/div&gt;</pre><p>То же самое можно сделать и в форме:</p><h4>views/photos/_form.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;% if @photo.image_data? %&gt;    &lt;%= image_tag @photo.image_url(:thumb) %&gt;    Remove attachment: &lt;%= f.check_box :remove_image %&gt;&lt;% end %&gt;</pre><p>Чтобы автоматически удалить обработанные файлы после завершения загрузки, можно добавить плагин <span>delete_raw</span>:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">plugin :delete_raw</pre><h2>Метаданные изображения</h2><p>Помимо рендеринга изображения, также можно получить его метаданные. Давайте, например, покажем размер оригинальной фотографии и MIME-тип:</p><h4>views/photos/_photo.html.erb<br></h4><pre class="brush: plain noskimlinks noskimwords">&lt;div&gt;  &lt;% if photo.image_data? %&gt;    &lt;%= image_tag photo.image_url(:thumb) %&gt;    &lt;p&gt;      Size &lt;%= photo.image[:original].size %&gt; bytes&lt;br&gt;      MIME type &lt;%= photo.image[:original].mime_type %&gt;&lt;br&gt;    &lt;/p&gt;  &lt;% end %&gt;  &lt;p&gt;&lt;%= photo.title %&gt; | &lt;%= link_to "Edit", edit_photo_path(photo) %&gt;&lt;/p&gt;&lt;/div&gt;</pre><p>Как насчет его размеров? К сожалению, они не сохраняются по умолчанию, но это возможно с помощью плагина <span>store_dimensions</span>.</p><h3>Размеры изображения</h3><p>Плагин store_dimensions опирается на гем <span>fastimage</span>, поэтому подключим его сейчас:</p><pre class="brush: rails noskimlinks noskimwords">gem "fastimage"</pre><p>Не забудем запустить:</p><pre class="brush: bash noskimlinks noskimwords">bundle install</pre><p>Теперь просто включим плагин:</p><h4>models/image_uploader.rb</h4><pre class="brush: rails noskimlinks noskimwords">plugin :store_dimensions</pre><p>И покажем размеры с помощью методов <code class="inline">width</code> и <code class="inline">height</code>:</p><h4>views/photos/_photo.html.erb</h4><pre class="brush: rails noskimlinks noskimwords">&lt;div&gt;  &lt;% if photo.image_data? %&gt;    &lt;%= image_tag photo.image_url(:thumb) %&gt;    &lt;p&gt;      Size &lt;%= photo.image[:original].size %&gt; bytes&lt;br&gt;      MIME type &lt;%= photo.image[:original].mime_type %&gt;&lt;br&gt;      Dimensions &lt;%= "#{photo.image[:original].width}x#{photo.image[:original].height}" %&gt;    &lt;/p&gt;  &lt;% end %&gt;  &lt;p&gt;&lt;%= photo.title %&gt; | &lt;%= link_to "Edit", edit_photo_path(photo) %&gt;&lt;/p&gt;&lt;/div&gt;</pre><p>Кроме того, существует доступный метод <code class="inline">dimensions</code>, который возвращает массив, содержащий ширину и высоту (например, <code class="inline">[500, 750]</code>).</p><h2>Перемещение в облако</h2><p>Разработчики часто выбирают облачные сервисы для размещения загруженных файлов, и Shrine действительно <span>представляет</span> такую ​​возможность. В этом разделе я покажу Вам, как загружать файлы на Amazon S3.</p><p>В качестве первого шага включите еще два гема в <em>Gemfile</em>:</p><pre class="brush: plain noskimlinks noskimwords">gem "aws-sdk", "~&gt; 2.1"group :development do    gem "dotenv-rails"end</pre><p><span>aws-sdk</span> требуется для работы с SDK S3, тогда как <span>dotenv-rails</span> будет использоваться для управления переменными окружения в процессе разработки.</p><pre class="brush: bash noskimlinks noskimwords">bundle install</pre><p>Прежде чем продолжить, Вы должны получить пару ключей для доступа к S3 через API. Чтобы получить его, войдите в систему (или зарегистрируйтесь) в <span>Amazon Web Services Console</span> и перейдите к <strong>Security Credentials &gt; Users</strong>. Создайте пользователя с правами для управления файлами на S3. Вот простая политика, предоставляющая полного доступа к S3:</p><pre class="brush: javascript noskimlinks noskimwords">{  "Version": "2016-11-14",  "Statement": [    {      "Effect": "Allow",      "Action": "s3:*",      "Resource": "*"    }  ]}</pre><p>Загрузите пару ключей созданного пользователя. Кроме того, вы можете использовать ключи доступа root, но я <em>сильно отговариваю</em> вас от этого, поскольку это очень небезопасно.</p><p>Затем создайте S3 bucket для размещения ваших файлов и добавьте файл в корень проекта для размещения вашей конфигурации:</p><h4>.env</h4><pre class="brush: rails noskimlinks noskimwords">S3_KEY=YOUR_KEYS3_SECRET=YOUR_SECRETS3_BUCKET=YOUR_BUCKETS3_REGION=YOUR_REGION</pre><p><em>Никогда не публикуйте</em> этот файл и исключите его из Git:</p><h4>.gitignore</h4><pre class="brush: plain noskimlinks noskimwords">.env</pre><p>Теперь изменим глобальную конфигурацию Shrine и добавим новое хранилище:</p><h4>config/initializers/shrine.rb</h4><pre class="brush: plain noskimlinks noskimwords">require "shrine"require "shrine/storage/s3"s3_options = {  access_key_id:     ENV["S3_KEY"],  secret_access_key: ENV["S3_SECRET"],  region:            ENV["S3_REGION"],  bucket:            ENV["S3_BUCKET"],}Shrine.storages = {  cache: Shrine::Storage::S3.new(prefix: "cache", **s3_options),  store: Shrine::Storage::S3.new(prefix: "store", **s3_options),}</pre><p>Вот именно! Никакие изменения не должны быть внесены в другие части приложения, теперь Вы можете сразу проверить это новое хранилище. Если вы получаете ошибки от S3, связанные с неправильными ключами, убедитесь, что Вы точно скопировали ключи, без каких-либо конечных пробелов и невидимых специальных символов.</p><h2>Заключение</h2><p>Мы подошли к концу статьи. Надеюсь, к настоящему моменту Вы чувствуете себя уверенно в использовании Shrine и готовы использовать его в одном из своих проектов. Мы обсудили многие особенности этого гема, но их еще больше, например, способность сохранять дополнительный контекст вместе с файлами и механизм прямой загрузки. </p><p>Поэтому просмотрите <span>документацию Shrine</span> и <span>официальный сайт</span>, в котором подробно описаны все доступные плагины. Если у вас остались другие вопросы об геме, не стесняйтесь задавать их. Я благодарю вас за то, что оставались со мной, скоро увидимся! </p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825075-zagruzka-fajlov-s-pomoschyu-rails-i-shrine" class="tm-article-body__tags-item-link">Ruby on Rails</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
32931</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
623</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
