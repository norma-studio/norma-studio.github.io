
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Приветствую вас в последнем руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отр...">
<meta property="og:description" content="Приветствую вас в последнем руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отр...">
<meta name="twitter:description" content="Приветствую вас в последнем руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отр...">
<meta property="aiturec:description" content="Приветствую вас в последнем руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отр...">
<meta property="og:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png">
<meta property="aiturec:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png">
<meta name="twitter:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png">
<meta property="vk:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html" title="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io" title="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/65404fb3f3f8602d7f5b3bdc85cbef02.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html" class="tm-user-info__username" title="
А. Крайнов" aria-label="
А. Крайнов">
А. Крайнов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Работа с базой IndexedDB - Часть 3
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Web Development" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3" class="tm-article-snippet__hubs-item-link"><span>Web Development</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3.html" />
    <link itemprop="image" href="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png">
    <meta itemprop="headline name" content="Работа с базой IndexedDB - Часть 3
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Приветствую вас в последнем руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отр...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Приветствую вас в последнем руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отр...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Приветствую вас в <em>последнем </em>руководстве серии, посвященной IndexedDB. Когда я начал эту серию руководств, моей целью было объяснить вам, как работает технология, которую не всегда... легко использовать. Действительно, когда я впервые попробовал работать с IndexedDB в прошлом году, у меня сложилось слегка отрицательное впечатление о ней («Слегка отрицательное» почти так же, как Вселенная «слегка стара»). Не легко было ее освоить, но в конце концов мне стало довольно легко работать с IndexedDB, и я отдаю должное тому, какие возможности она предлагает. Это по-прежнему технология, которая не поддерживается всеми операционными системами (к сожалению, она не поддерживается iOS7), однако я искренне верю, что это та технология, которую разработчики могут осваивать и использовать сегодня.</p><p>В этом последнем руководстве мы продемонстрируем некоторые дополнительные концепции, используя в качестве основы «полную» версию, созданную нами в <span>предыдущем руководстве</span>. Если честно, вы <em>должны</em> хорошо помнить, о чем шла речь в предыдущих руководствах, иначе вам будет не легко работать с этим, так что, возможно, вам захочется также ознакомиться с <span>первым</span>.</p> <p><!--more--></p> <hr><h2>Подсчет данных</h2> <p>Давайте начнем с чего-то простого. Представьте, что вам необходимо разбить ваши данные на страницы. Как бы вы подсчитали ваши данные, чтобы корректно реализовать эту возможность? Я уже показал вам, как вы можете получить <em>все </em>ваши данные, и без сомнений вы могли бы воспользоваться тем способом для подсчета данных, однако при этом вам необходимо было бы получать все данные. Если у вас огромная локальная база данных, то подсчет мог бы происходить очень медленно. К счастью, спецификация IndexedDB предоставляет значительно более простой способ подсчета данных. </p> <p>В результате выполнения метода count() objectStore будет возвращено количество данных. Как и все, что мы ранее выполнили, эта операция будет выполняться асинхронно, однако вы можете упростить код до одного вызова. Для базы нашего приложения для ведения записей я написал функцию <code>doCount()</code>, которая именно это и выполняет:</p> <pre class="brush: js noskimlinks noskimwords">function doCount() {    db.transaction(["note"],"readonly").objectStore("note").count().onsuccess = function(event) {        $("#sizeSpan").text("("+event.target.result+" Notes Total)");    };}</pre> <p>Помните, что если с кодом выше тяжеловато работать, то вы можете разбить его на блоки. Обратитесь к предыдущим руководствам, где я показал, как это выполнить. Обработчику результата передается результат вычислений, который представляет из себя общее количество доступных в хранилище объектов. Я изменил интерфейс пользователя нашей демоверсии для добавления пустого элемента span в заголовке.</p> <pre class="brush: js noskimlinks noskimwords">&lt;span class="navbar-brand" &gt;Note Database &lt;span id="sizeSpan"&gt;&lt;/span&gt;&lt;/span&gt;</pre> <figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot1.png" alt="Работа с базой IndexedDB - Часть 3..." title="Работа с базой IndexedDB - Часть 3..." width="50" height="50"><br></figure><p>Последнее, что мне нужно выполнить, – добавить вызов doCount для тех частей кода, где происходит запуск приложения, и после выполнения любых операций по добавлению или удалению записей. Ниже показано, как это выполнить на примере обработчика, запускаемого в случае успешного открытия базы данных.</p> <pre class="brush: js noskimlinks noskimwords">openRequest.onsuccess = function(e) {    db = e.target.result;    db.onerror = function(event) {      // Generic error handler for all errors targeted at this database"s      // requests!      alert("Database error: " + event.target.errorCode);    };    displayNotes();    doCount();};</pre> <p>Вы можете ознакомиться с полным кодом этого примера в скачанном вами архиве, где этот код располагается в папке  <code>fulldemo2</code>. (К вашему сведению, в папке <code>fulldemo1</code> располагается код приложения, каким оно было в конце предыдущего руководства)</p> <hr><h2>Фильтрация записей на лету</h2> <p>Что касается нашей следующей возможности, мы добавим базовый фильтр для списка с записями. В предыдущих руководствах этой серии я объяснил вам, что в IndexedDB <em>не </em>предусмотрена поддержка поиска в свободном формате (* формат ввода данных, в котором нет жестко заданных границ полей и/или их последовательности). Вы не можете (что ж, вам будет не просто) искать контент по ключевому слову. Однако за счет возможностей, предоставляемых диапазонами, можно легко, по крайней мере, добавить поддержку возможности сопоставления вводимых символов с началом строки. </p> <p>Если вы помните, диапазон позволяет нам выбрать данные из хранилища, которые либо начинаются с определенного значения, либо заканчиваются определенным значением, либо располагаются между указанными значениями. Мы можем воспользоваться этим для реализации базового фильтра для сопоставления вводимых символов с содержимым поля для добавления заголовка наших записей. Для начала нам необходимо добавить индекс для этого свойства. Помните, что это можно только выполнить в обработчике для события onupgradeneeded. </p> <pre class="brush: js noskimlinks noskimwords">    if(!thisDb.objectStoreNames.contains("note")) {        console.log("I need to make the note objectstore");        objectStore = thisDb.createObjectStore("note", { keyPath: "id", autoIncrement:true });        objectStore.createIndex("title", "title", { unique: false });    }</pre> <p>Далее я добавил простое поле формы к UI:</p> <figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot2.png" alt="Работа с базой IndexedDB - Часть 3..." title="Работа с базой IndexedDB - Часть 3..." width="50" height="50"><br></figure><p>Затем я добавил обработчик "keyup" для этого поля, благодаря чему мы тут же будем наблюдать обновления при наборе текста в нем.</p> <pre class="brush: js noskimlinks noskimwords">$("#filterField").on("keyup", function(e) {    var filter = $(this).val();    displayNotes(filter);});</pre> <p>Обратите внимание на то, как я вызываю displayNotes. Это та же функция, которую я использовал ранее для отображения всех записей. Я обновлю ее так, чтобы в ней имелась поддержка как операции для «извлечения всех данных», так и операции для «извлечения отфильтрованных данных». Давайте разберем ее.</p> <pre class="brush: js noskimlinks noskimwords">function displayNotes(filter) {    var transaction = db.transaction(["note"], "readonly");      var content="&lt;table class="table table-bordered table-striped"&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Title&lt;/th&gt;&lt;th&gt;Updated&lt;/th&gt;&lt;th&gt;&amp; &lt;/td&gt;&lt;/thead&gt;&lt;tbody&gt;";    transaction.oncomplete = function(event) {        $("#noteList").html(content);    };    var handleResult = function(event) {        var cursor = event.target.result;        if (cursor) {          content += "&lt;tr data-key=\""+cursor.key+"\"&gt;&lt;td class=\"notetitle\"&gt;"+cursor.value.title+"&lt;/td&gt;";        content += "&lt;td&gt;"+dtFormat(cursor.value.updated)+"&lt;/td&gt;";        content += "&lt;td&gt;&lt;a class=\"btn btn-primary edit\"&gt;Edit&lt;/a&gt; &lt;a class=\"btn btn-danger delete\"&gt;Delete&lt;/a&gt;&lt;/td&gt;";        content +="&lt;/tr&gt;";        cursor.continue();        }        else {          content += "&lt;/tbody&gt;&lt;/table&gt;";      }      };    var objectStore = transaction.objectStore("note");    if(filter) {        //Credit: https://stackoverflow.com/a/8961462/52160        var range = IDBKeyRange.bound(filter, filter + "\uffff");        var index = objectStore.index("title");        index.openCursor(range).onsuccess = handleResult;    } else {        objectStore.openCursor().onsuccess = handleResult;    }}</pre> <p>На самом деле мы внесли изменение только внизу кода. В результате открытия курсора с диапазоном или без него выходит тот же самый тип результата, передаваемого в обработчик события. Это играет нам на руку, поскольку за счет этого обновить наш код очень просто. Единственная сложность – собственно задание диапазона. Обратите внимание на то, что я здесь выполнил. Передаваемый аргумент, filter, – то, что ввел пользователь. Представьте, что это "The". Нам необходимо выбрать записи с заголовком, начинающимся на "The" и оканчивающимся любым символом. Это можно реализовать просто за счет задания в качестве значения конца диапазона конечного символа ASCII. Это не моя идея. Перейдите по ссылке, указанной в коде, чтобы узнать, кому она принадлежит.</p> <p>Вы можете ознакомиться с этой демоверсией в папке <code>fulldemo3</code>. Обратите внимание на то, что здесь мы используем новую базу данных, так что если вы выполнили код предыдущего примера, то после первого запуска кода этого примера записей не будет.</p> <p>Хотя этот код и работает, у нас имеется одна небольшая проблема. Представьте запись с заголовком "Saints Rule." (* Верующие рулят) (Потому что это действительно так. Это просто к слову). Скорее всего, вы попробуете найти запись с этим заголовком, набирая "saints". В этом случае фильтр не сработает, поскольку он чувствителен к регистру (* заглавных или строчных букв). Как нам разрешить эту проблему?</p> <p>Один из вариантов – просто сохранить копию заголовка в нижнем регистре. Это довольно просто выполнить. Для начала я изменил индекс для использования нового свойства под названием <code>titlelc</code>.</p> <pre class="brush: js noskimlinks noskimwords">        objectStore.createIndex("titlelc", "titlelc", { unique: false });</pre> <p>Затем я изменил код, при помощи которого сохраняются записи, для создания копии содержимого поля для задания заголовка:</p> <pre class="brush: js noskimlinks noskimwords">$("#saveNoteButton").on("click",function() {    var title = $("#title").val();    var body = $("#body").val();    var key = $("#key").val();    var titlelc = title.toLowerCase();    var t = db.transaction(["note"], "readwrite");    if(key === "") {        t.objectStore("note")                        .add({title:title,body:body,updated:new Date(),titlelc:titlelc});    } else {        t.objectStore("note")                        .put({title:title,body:body,updated:new Date(),id:Number(key),titlelc:titlelc});    }</pre> <p>Наконец, я изменил поисковый запрос, чтобы просто перевести введенные пользователем данные в нижний регистр. Благодаря этому, если вы вводите "Saints", то фильтр сработает так же, как и при вводе "saints".</p> <pre class="brush: js noskimlinks noskimwords">        filter = filter.toLowerCase();        var range = IDBKeyRange.bound(filter, filter + "\uffff");        var index = objectStore.index("titlelc");</pre> <p>На этом все. Вы можете ознакомиться с рассматриваемым в этом разделе примером в папке <code>fulldemo4</code>. </p> <hr><h2>Работаем со свойствами массива</h2> <p>Что касается нашего последнего улучшения, я добавлю новую возможность для нашего приложения для ведения записей – тегирование (* сопровождение данных тегами).<br> Благодаря этому у вас будет возможность добавить любое количество тегов (считайте, ключевых слов, при помощи которых описывается запись), за счет чего вы сможете позже найти другие записи с тем же тегом.<br> Теги будут храниться в виде массива. Это не так уж и сложно реализовать. Я упомянул в начале этой серии, что вы могли бы с легкостью хранить массивы в качестве свойств (* объектов, передаваемых в базу). Немного сложнее реализовать поиск по тегам. Давайте начнем с реализации возможности добавления тегов к записи.</p> <p>Для начала я добавил в форму для добавления записей новое поле для ввода данных. Благодаря этому у пользователя будет возможность вводить теги, разделенные запятой:</p> <figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot3.png" alt="Работа с базой IndexedDB - Часть 3..." title="Работа с базой IndexedDB - Часть 3..." width="50" height="50"><br></figure><p>Я могу сохранить их, изменив мой код, при помощи которого происходит создание/обновление записи.</p> <pre class="brush: js noskimlinks noskimwords">    var tags = [];    var tagString = $("#tags").val();    if(tagString.length) tags = tagString.split(",");</pre> <p>Обратите внимание на то, что в качестве значения по умолчанию я установил пустой массив. Я наполняю его только в том случае, если пользователь добавил какие-то теги. Мы сохраняем теги просто за счет добавления массива к объекту, передаваемому в IndexedDB:</p> <pre class="brush: js noskimlinks noskimwords">    if(key === "") {        t.objectStore("note")                        .add({title:title,body:body,updated:new Date(),titlelc:titlelc,tags:tags});    } else {        t.objectStore("note")                        .put({title:title,body:body,updated:new Date(),id:Number(key),titlelc:titlelc,tags:tags});    }</pre> <p>И все. Если вы добавите несколько записей и откроете вкладку Resources в Chrome, то, собственно, увидите сохраненные данные.</p> <figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot4.png" alt="Работа с базой IndexedDB - Часть 3..." title="Работа с базой IndexedDB - Часть 3..." width="50" height="50"><br></figure><p>Теперь давайте добавим теги к представлению при отображении записи. Для нашего приложения я выбрал простой способ реализации этой возможности. Если при отображении записи имеются теги, то я их вывожу. Каждый тег будет ссылкой. Если вы нажмете такую ссылку, то в результате будет отображен список родственных записей, в которых используется тот же тег. Давайте сперва взглянем на логику этого решения.</p> <pre class="brush: js noskimlinks noskimwords">function displayNote(id) {    var transaction = db.transaction(["note"]);      var objectStore = transaction.objectStore("note");      var request = objectStore.get(id);    request.onsuccess = function(event) {          var note = request.result;        var content = "&lt;h2&gt;" + note.title + "&lt;/h2&gt;";         if(note.tags.length &gt; 0) {            content += "&lt;strong&gt;Tags:&lt;/strong&gt; ";            note.tags.forEach(function(elm,idx,arr) {                content += "&lt;a class="tagLookup" title="Click for Related Notes" data-noteid=""+note.id+""&gt; " + elm + "&lt;/a&gt; ";              });            content += "&lt;br/&gt;&lt;div id="relatedNotesDisplay"&gt;&lt;/div&gt;";        }        content += "&lt;p&gt;" + note.body + "&lt;/p&gt;";         I        $noteDetail.html(content).show();        $noteForm.hide();               };  }</pre> <p>В этой функции (новом дополнении к нашему приложению) содержится код для отображения записи, выполняемый при возникновении события click, генерируемого при выборе ячейки таблицы. Мне необходим более абстрактный код (* по сравнению с displayNotes()), и этот код как раз таки для этого и служит. По большей части код – тот же самый, однако обратите внимание на логику для проверки длины массива, содержащегося в свойстве tags. Если массив не пуст, то контент обновляется для добавления простого списка тегов. Каждый тег оборачивается в элемент для добавления ссылки со специальным классом, который я буду использовать позже для поиска родственных записей. Также я добавил элемент div именно для того, чтобы выводить результаты того поиска.</p> <figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/uploads/2013/12/shot5.png" alt="Работа с базой IndexedDB - Часть 3..." title="Работа с базой IndexedDB - Часть 3..." width="50" height="50"><br></figure><p>На данном этапе мы реализовали возможность добавления тегов к записи и их отображения. Также я планировал добавить для пользователей возможность выбирать те теги, благодаря чему они могут найти другие записи, в которых используется тот же тег. Теперь начинается сложная часть.</p> <p>Вы уже видели, как можете достать контент при помощи индексов. Но как это работает, когда мы имеем дело со свойствами массива? Оказывается, что в спецификации имеется специальный флажок для этих случаев – multiEntry. При создании индекса на основании массива вы должны задать в качестве этого значения true. Ниже показано, как это реализовано в моем приложении:</p> <pre class="brush: js noskimlinks noskimwords">objectStore.createIndex("tags","tags", {unique:false,multiEntry:true});</pre> <p>При помощи вышеуказанного кода удачно решается проблема сохранения тегов. Теперь давайте разбираться с поиском. Ниже приводится обработчик события click для элемента a с классом tagLookup:</p> <pre class="brush: js noskimlinks noskimwords">$(document).on("click", ".tagLookup", function(e) {    var tag = e.target.text;    var parentNote = $(this).data("noteid");    var doneOne = false;    var content = "&lt;strong&gt;Related Notes:&lt;/strong&gt;&lt;br/&gt;";    var transaction = db.transaction(["note"], "readonly");    var objectStore = transaction.objectStore("note");    var tagIndex = objectStore.index("tags");    var range = IDBKeyRange.only(tag);    transaction.oncomplete = function(event) {        if(!doneOne) {            content += "No other notes used this tag.";         }        content += "&lt;p/&gt;";        $("#relatedNotesDisplay").html(content);    };    var handleResult = function(event) {        var cursor = event.target.result;        if(cursor) {            if(cursor.value.id != parentNote) {                doneOne = true;                content += "&lt;a class="loadNote" data-noteid=""+cursor.value.id+""&gt;" + cursor.value.title + "&lt;/a&gt;&lt;br/&gt; ";            }            cursor.continue();        }               };    tagIndex.openCursor(range).onsuccess = handleResult;});</pre> <p>Здесь довольно много кода, но по правде говоря, он очень подобен тому, что мы обсудили ранее. Когда вы выбираете тег, то вначале при помощи кода происходит извлечение содержимого ссылки. Я создаю объекты для транзакции, хранилища объектов и индекса так же, как и ранее. Диапазон в этой раз задается по-другому. Вместо создания диапазона для какого-то промежутка, мы можем воспользоваться методом only() API для указания, что нам необходим диапазон, состоящий только из одного значения. И да, подобный код и мне кажется странноватым. Однако он замечательно работает. Вы видите, что далее мы открываем курсор, и можем выполнить итерацию над результатами таким же образом, как и ранее. Также имеется еще некоторый дополнительный код для тех случаев, когда отсутствуют совпадения. Также я позаботился об <em>оригинальной</em> записи, то есть той, что вы просматриваете в данный момент, так, чтобы она также не отображалась. Вот, собственно, и все. Есть еще последний небольшой фрагмент кода, при помощи которого обрабатываются события click, возникающие при выборе тех родственных записей, благодаря чему вы с легкостью можете их просмотреть:</p> <pre class="brush: js noskimlinks noskimwords">$(document).on("click", ".loadNote", function(e) {    var noteId = $(this).data("noteid");    displayNote(noteId);});</pre> <p>Вы можете ознакомиться с этой демоверсией в папке <code>fulldemo5</code>.</p> <hr><h2>Заключение</h2> <p>Я искренне надеюсь, что эта серия руководств была полезной для вас. Как я упомянул вначале, IndexedDB поначалу мне не понравилась. Но чем дольше я работал с этой технологией, чем больше пытался разобраться с тем, как она работает, тем больше я ценил то, насколько эта технология может помочь нам, как веб-разработчикам. Весь потенциал этой технологии еще не раскрыт, и я точно знаю, что некоторые предпочитают использовать библиотеки-обертки, но я думаю, что эту технологию ждет замечательное будущее!</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Web Development" href="https://norma-studio.github.io/article5/220825540-rabota-s-bazoj-indexeddb--chast-3" class="tm-article-body__tags-item-link">Web Development</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
44551</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
361</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
