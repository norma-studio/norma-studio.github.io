
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. ...">
<meta property="og:description" content="В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. ...">
<meta name="twitter:description" content="В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. ...">
<meta property="aiturec:description" content="В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. ...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html" title="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io" title="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/64533ghhjgjj.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html" class="tm-user-info__username" title="
С. Парфенов" aria-label="
С. Парфенов">
С. Парфенов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Запросы в Rails, часть 2...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2" class="tm-article-snippet__hubs-item-link"><span>Ruby on Rails</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/851/profiles/19371/profileImage/edgar_avatar_400x.png">
    <meta itemprop="headline name" content="Запросы в Rails, часть 2... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. ...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. ...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>В этой второй статье мы немного погрузимся в запросы Active Record в Rails. В случае, если вы все еще новичок в SQL, я добавлю примеры, которые будут достаточно простыми, и вы можете отметить их и понять синтаксис по мере нашего продвижения. <br></p><p>Это, как говорится, определенно поможет, если вы пройдете какой-нибудь быстрый учебник по SQL, прежде чем вернуться, чтобы продолжить чтение. В противном случае не спешите разбираться с SQL-запросами, которые мы использовали, и я надеюсь, что к концу этой серии они больше не заставят вас испытывать страх. </p><p>Большая часть из них очень проста, но синтаксис немного странный, если вы только начали писать код, особенно в Ruby. Держитесь там, это не ракетостроение!</p><h2>Темы</h2><ul><li>Includes и ранняя загрузка</li> <li>Соединение таблиц</li> <li>Предварительная загрузка</li> <li>Скоупы</li> <li>Агрегации</li> <li>Динамические фаиндеры</li> <li>Конкретные поля</li> <li>Кастомный SQL</li> </ul><h2>Includes и предварительная загрузка<br></h2><p>Эти запросы включают в себя более одной таблицы базы данных для работы и скорее всего в этой статье они самые важные. Все сводится к следующему: вместо того, чтобы делать несколько запросов для получения необходимой информации, которая распространяется по нескольким таблицам, <code class="inline">includes</code> пытается свести их к минимуму. Ключевая концепция этого подхода называется «предварительная загрузка» и означает, что мы загружаем связанные объекты, когда совершаем поиск.</p><p>Если бы мы это сделали, выполнив итерацию по набору объектов, а затем попытались получить доступ к связанным с ней записям из другой таблицы, мы столкнулись бы с проблемой, которая называется «проблемой запроса N + 1». Например, для каждого <code class="inline">agent.handler</code> в коллекции агентов мы будем запускать отдельные запросы для обоих агентов и их обработчиков. Этого нам нужно избегать, поскольку это вообще не масштабируется. Вместо этого мы делаем следующее:</p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">agents = Agent.includes(:handlers)</pre><p>Если мы теперь перебираем такую коллекцию агентов- мы не ограничиваем количество записей, возвращенных на данный момент, мы получим два запроса вместо, возможно, газиллиона. <br></p><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents"SELECT "handlers".* FROM "handlers" WHERE "handlers"."id" IN (1, 2)</pre><p>У этого одного агента в списке есть два обработчика, и когда мы теперь запрашиваем объект-агент для его обработчиков, никаких дополнительных запросов к базе данных не нужно. Разумеется, мы можем шагнуть еще дальше и загрузить несколько связанных записей таблицы. Если нам нужна была загрузка не только обработчиков, но и связанных с ними миссий агента по любой причине, мы могли бы использовать <code class="inline">includes</code> следующим образом.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">agents = Agent.includes(:handlers, :mission)</pre><p>Просто! Просто будьте осторожны с использованием уникальных и множественных версий для includes. Они зависят от ваших ассоциаций. У ассоциации <code class="inline">has_many</code> используется множественное число, в то время как <code class="inline">belongs_to</code> или <code class="inline">has_one</code> нуждаются в особой версии. Если вам нужно, вы также можете использовать выражение <code class="inline">where</code> для указания дополнительных условий, но предпочтительным способом указания условий для связанных таблиц, которые загружаются, является использование вместо них <code class="inline">joins</code>. </p><p>Одна вещь, о которой нужно помнить, - это то, что данные, которые будут добавлены, будут полностью отправлены в Active Record, которая, в свою очередь, строит объекты Ruby, включая эти атрибуты. Это контрастирует с «просто» объединением данных, где вы получите виртуальный результат, который вы можете использовать для вычислений, например, и будет меньше утечки памяти.</p><h2>Соединение таблиц</h2><p>Объединение таблиц - еще один инструмент, который позволяет избежать отправки слишком большого количества ненужных запросов. Общим сценарием является объединение двух таблиц с одним запросом, который возвращает какую-то комбинированную запись. <code class="inline">joins</code> - это еще один метод поиска Active Record, который позволяет вам использовать SQL-термины - <code class="inline">JOIN</code> таблиц. Эти запросы могут возвращать записи, объединенные из нескольких таблиц, и вы получаете виртуальную таблицу, которая объединяет записи из этих таблиц. Это довольно удобно, когда вы сравниваете это с выполнением кучи разных запросов для каждой таблицы. Существует несколько различных видов перекрытия данных, которые вы можете получить с помощью этого подхода. </p><p>Внутреннее соединение является операцией по умолчанию для <code class="inline">joins</code>. Это соответствует всем результатам, которые соответствуют определенному идентификатору и его представлению в качестве внешнего ключа из другого объекта или таблицы. В приведенном ниже примере просто укажите: дайте мне все миссии, где <code class="inline">id</code> миссии отображается как <code class="inline">mission_id</code> в таблице агента. <code class="inline">"agents"."mission_id" = "missions"."id"</code>. Внутренние соединения исключают отношения, которые не существуют.</p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Mission.joins(:agents)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "missions".* FROM "missions" INNER JOIN "agents" ON "agents"."mission_id" = "mission"."id"</pre><p>Таким образом, мы сопоставляем миссии и сопровождающих эти миссии агентов - в одном запросе! Конечно, мы могли бы сначала получить миссии, перебирать их один за другим и запросить их агентов. Но тогда мы вернемся к нашей ужасной «проблеме запроса N + 1». Нет уж, спасибо! </p><p>Что также приятно в таком подходе, так это то, что мы не получим ни одного nil в случае с внутренними соединениями; мы получаем только возвращаемые записи, которые соответствуют их идентификаторам для внешних ключей в связанных таблицах. Если нам нужно найти миссии, например, которые не имеют каких-либо агентов, нам потребуется внешнее соединение. Поскольку в настоящее время речь идет о написании собственного <code class="inline">OUTER JOIN</code> SQL, мы рассмотрим это в последней статье. Возвращаясь к стандартным соединениям, вы также можете соединить несколько связанных таблиц.</p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Mission.joins(:agents, :expenses, :handlers)</pre><p>И вы можете добавить к ним некоторые, выражения <code class="inline">where</code>, чтобы сделать ваших фаиндеров еще более специфичными. Ниже мы рассматриваем только миссии, которые выполняются Джеймсом Бондом и только агенты, принадлежащие миссии «Moonraker» во втором примере.</p><pre class="brush: rails noskimlinks noskimwords">Mission.joins(:agents).where( agents: { name: "James Bond" })</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "missions".* FROM "missions" INNER JOIN "agents" ON "agents"."mission_id" = "missions"."id" WHERE "agents"."name" = ?  [["name", "James Bond"]]</pre><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:mission).where( missions: { mission_name: "Moonraker" })</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."mission_name" = ?  [["mission_name", "Moonraker"]]</pre><p>При использовании <code class="inline">joins</code> вы также должны обратить внимание на исключительное и множественное использование ваших ассоциаций моделей. Поскольку мой класс <code class="inline">Mission</code> <code class="inline">has_many: agents</code>, мы можем использовать множественное число. С другой стороны, для класса <code class="inline">Agent</code> <code class="inline">belongs_to: mission</code>, единственная версия отлично работает. Важная небольшая деталь: часть <code class="inline">where</code> здесь проще. Поскольку вы просматриваете несколько строк в таблице, которые выполняют определенное условие, множественная форма всегда имеет смысл.</p><h2>Скоупы</h2><p>Скоупы - это удобный способ извлечения общих запросов в хорошо известные методы. Таким образом, их немного легче передавать, а также, возможно, легче понять, должны ли другие работать с вашим кодом, или если вам нужно пересмотреть некоторые запросы в будущем. Вы можете определить их для отдельных моделей, но также использовать их для своих ассоциаций. </p><p>Здесь вас ограничивает только фантазия - <code class="inline">joins</code>, <code class="inline">includes</code> и <code class="inline">where</code>, все что угодно! Поскольку скоупы также возвращают объекты <code class="inline">ActiveRecord::Relations</code>, вы можете сделать цепочку вызовов и без колебаний вызвать другие скоупы. Извлечение таких скоупов и объединение их в более сложные запросы очень удобно и делает более длинные из них все более читаемыми. Скоупы определяются с помощью синтаксиса «прочный лямбда»:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  has_many: agents  scope :successful, -&gt; { where(mission_complete: true) }endMission.successful</pre><pre class="brush: rails noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :mission  scope :licenced_to_kill, -&gt; { where(licence_to_kill: true) }  scope :womanizer,        -&gt; { where(womanizer: true) }  scope :gambler,          -&gt; { where(gambler: true) } end# Agent.gambler# Agent.womanizer# Agent.licenced_to_kill# Agent.womanizer.gamblerAgent.licenced_to_kill.womanizer.gambler</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents".* FROM "agents" WHERE "agents"."licence_to_kill" = ? AND "agents"."womanizer" = ? AND "agents"."gambler" = ?  [["licence_to_kill", "t"], ["womanizer", "t"], ["gambler", "t"]]</pre><p>Как видно из приведенного выше примера, найти Джеймса Бонда намного лучше, если вы можете просто объединить скоупы. Таким образом, вы можете смешивать и сопоставлять различные запросы и одновременно оставаться DRY. Если вам нужны скоупы с помощью ассоциаций, они также в вашем распоряжении:</p><pre class="brush: rails noskimlinks noskimwords">Mission.last.agents.licenced_to_kill.womanizer.gambler</pre><pre class="brush: sql noskimlinks noskimwords">SELECT  "missions".* FROM "missions"  ORDER BY "missions"."id" DESC LIMIT 1SELECT "agents".* FROM "agents" WHERE "agents"."mission_id" = ? AND "agents"."licence_to_kill" = ? AND "agents"."womanizer" = ? AND "agents"."gambler" = ?  [["mission_id", 33], ["licence_to_kill", "t"], ["womanizer", "t"], ["gambler", "t"]]</pre><p>Вы также можете переопределить <code class="inline">default_scope</code>, когда вы используете что-то вроде <code class="inline">Mission.all</code>.</p><pre class="brush: rails noskimlinks noskimwords">class Mission &lt; ActiveRecord::Base  default_scope { where status: "In progress" }endMission.all</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords"> SELECT "missions".* FROM "missions" WHERE "missions"."status" = ?  [["status", "In progress"]]</pre><h2>Агрегации<br></h2><p>Этот раздел не настолько продвинут с точки зрения понимания, но вы будете нуждаться в них чаще, чем не в сценариях, которые можно считать более продвинутыми, чем ваш обычный поиск, похожий на <code class="inline">.all</code>, <code class="inline">.first</code>, <code class="inline">.find_by_id</code> или что-то еще. Например, фильтрация, основанная на базовых расчетах, скорее всего - то, с чем новички не сразу начинают работать. На что мы смотрим именно здесь?</p><ul><li><code class="inline">sum</code></li> <li><code class="inline">count</code></li> <li><code class="inline">minimum</code></li> <li><code class="inline">maximum</code></li> <li><code class="inline">average</code></li> </ul><p>Просто, не так ли? Самое приятное в том, что вместо того, чтобы перебирать возвращаемую коллекцию объектов для выполнения этих вычислений, мы можем позволить Active Record сделать все это для нас и возвращать эти результаты в одном запросе. Приятно, да?</p><ul><li><code class="inline">count</code></li></ul><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Mission.count# =&gt; 24</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT COUNT(*) FROM "missions"</pre><ul><li><code class="inline">average</code></li></ul><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.average(:number_of_gadgets).to_f# =&gt; 3.5</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT AVG("agents"."number_of_gadgets") FROM "agents"</pre><p>Поскольку мы теперь знаем, как мы можем использовать <code class="inline">joins</code>, мы можем сделать шаг дальше и спросить, например, среднее количество гаджетов, которые агенты берут на конкретную миссию.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:mission).where(missions: {name: "Moonraker"}).average(:number_of_gadgets).to_f# =&gt; 3.4</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT AVG("agents"."number_of_gadgets") FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" WHERE "missions"."name" = ?  [["name", "Moonraker"]]</pre><p>Группировка этого среднего количества гаджетов по именам миссий становится теперь весьма тривиальной. Подробнее о группировках см. ниже:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:mission).group("missions.name").average(:number_of_gadgets)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT AVG("agents"."number_of_gadgets") AS average_number_of_gadgets, missions.name AS missions_name FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" GROUP BY missions.name</pre><ul><li><code class="inline">sum</code></li></ul><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.sum(:number_of_gadgets) Agent.where(licence_to_kill: true).sum(:number_of_gadgets) Agent.where.not(licence_to_kill: true).sum(:number_of_gadgets)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT SUM("agents"."number_of_gadgets") FROM "agents"SELECT SUM("agents"."number_of_gadgets") FROM "agents" WHERE "agents"."licence_to_kill" = ?  [["licence_to_kill", "t"]]SELECT SUM("agents"."number_of_gadgets") FROM "agents" WHERE ("agents"."licence_to_kill" != ?)  [["licence_to_kill", "t"]]</pre><ul><li><code class="inline">maximum</code></li></ul><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.maximum(:number_of_gadgets)Agent.where(licence_to_kill: true).maximum(:number_of_gadgets) </pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT MAX("agents"."number_of_gadgets") FROM "agents"SELECT MAX("agents"."number_of_gadgets") FROM "agents" WHERE "agents"."licence_to_kill" = ?  [["licence_to_kill", "t"]]</pre><ul><li><code class="inline">minimum</code></li></ul><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.minimum(:iq)Agent.where(licence_to_kill: true).minimum(:iq) </pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT MIN("agents"."iq") FROM "agents"SELECT MIN("agents"."iq") FROM "agents" WHERE "agents"."licence_to_kill" = ?  [["licence_to_kill", "t"]]</pre><h2>Внимание!<br></h2><p>Все эти методы агрегирования не позволяют вам подключаться к другим вещам - они являются терминальными. Порядок для расчетов имеет значение. Мы не получаем объект <code class="inline">ActiveRecord::Relation</code> из этих операций, что заставляет музыку останавливаться в этой точке - вместо этого мы получаем хэш или цифры. Нижеприведенные примеры не будут работать:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.maximum(:number_of_gadgets).where(licence_to_kill: true)Agent.sum(:number_of_gadgets).where.not(licence_to_kill: true)Agent.joins(:mission).average(:number_of_gadgets).group("missions.name")</pre><h3>Сгруппированные<br></h3><p>Если вы хотите, чтобы расчеты разбивались и сортировались в логические группы, вы должны использовать выражение <code class="inline">GROUP</code>, а не делать это в Ruby. Я имею в виду, что вам следует избегать итерации над группой, которая производит потенциально тонны запросов.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.joins(:mission).group("missions.name").average(:number_of_gadgets)# =&gt; { "Moonraker"=&gt; 4.4, "Octopussy"=&gt; 4.9 }</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT AVG("agents"."number_of_gadgets") AS average_number_of_gadgets, missions.name AS missions_name FROM "agents" INNER JOIN "missions" ON "missions"."id" = "agents"."mission_id" GROUP BY missions.name</pre><p>В этом примере обнаруживаются все агенты, которые сгруппированы в конкретную миссию и возвращают хэш с вычисленным средним числом гаджетов в качестве его значений - в одном запросе! Ага! То же самое относится и к другим вычислениям. В этом случае на самом деле имеет смысл позволить SQL выполнять всю эту работу. Количество запросов, которые мы запускаем для этих агрегатов, слишком важно.</p><h2>Динамические фаиндеры</h2><p>Для каждого атрибута ваших моделей, например <code class="inline">name</code>, <code class="inline">email_address</code>, <code class="inline">favorite_gadget</code> и т.д., Active Record позволяет использовать очень читаемые методы поиска, которые динамически создаются для вас. Звучит загадочно, я знаю, но это не значит ничего, кроме <code class="inline">find_by_id</code> или <code class="inline">find_by_favorite_gadget</code>. Часть <code class="inline">find_by</code> является стандартной, и Active Record просто подставляет имя атрибута для вас. Вы даже можете добавить<code class="inline">!</code> если вы хотите, чтобы этот фаиндер выбрасывал ошибку, если ничего не найдено. Более того, вы можете даже объединить эти методы динамического поиска вместе. Именно так:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.find_by_name("James Bond")Agent.find_by_name_and_licence_to_kill("James Bond", true)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT  "agents".* FROM "agents" WHERE "agents"."name" = ? LIMIT 1  [["name", "James Bond"]]SELECT  "agents".* FROM "agents" WHERE "agents"."name" = ? AND "agents"."licence_to_kill" = ? LIMIT 1  [["name", "James Bond"], ["licence_to_kill", "t"]]</pre><p>Конечно, вы можете начать сходить с ума, но я думаю, что это все теряет свой шарм и полезность, если вы выходите за пределы двух атрибутов:<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.find_by_name_and_licence_to_kill_and_womanizer_and_gambler_and_number_of_gadgets("James Bond", true, true, true, 3)</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT  "agents".* FROM "agents" WHERE "agents"."name" = ? AND "agents"."licence_to_kill" = ? AND "agents"."womanizer" = ? AND "agents"."gambler" = ? AND "agents"."number_of_gadgets" = ? LIMIT 1  [["name", "James Bond"], ["licence_to_kill", "t"], ["womanizer", "t"], ["gambler", "t"], ["number_of_gadgets", 3]]</pre><p>В этом примере, тем не менее, приятно видеть, как все это работает под капотом. Каждый новый <code class="inline">_and_</code> добавляет оператор SQL <code class="inline">AND</code> для логического связывания атрибутов вместе. В целом, основное преимущество динамических фаиндеров - легкость чтения при слишком большом количестве динамических атрибутов, тем не менее, теряет преимущество. Я редко использую это, может быть, в основном, когда я играю в консоли, но, безусловно, хорошо знать, что Rails предлагает эту приятную небольшую хитрость.<br></p><h2>Определенные поля<br></h2><p>Active Record дает вам возможность возвращать объекты, которые немного более сфокусированы на атрибутах, которые они несут. Обычно, если не указано иначе, запрос будет запрашивать все поля в строке с помощью <code class="inline">*</code> (<code class="inline">SELECT "agents".*</code>), А затем Active Record строит объекты Ruby с полным набором атрибутов. Однако вы можете выбрать <code class="inline">select</code> только определенные поля, которые должны быть возвращены запросом, и ограничить количество атрибутов, которые ваши объекты Ruby должны «переносить».<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.select("name") =&gt; #&lt;ActiveRecord::Relation [#&lt;Agent 7: nil, name: "James Bond"&gt;, #&lt;Agent id: 8, name: "Q"&gt;, ...]&gt;</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents"."name" FROM "agents"</pre><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.select("number, favorite_gadget") =&gt; #&lt;ActiveRecord::Relation [#&lt;Agent id: 7, number: "007", favorite_gadget: "Walther PPK"&gt;, #&lt;Agent id: 8, name: "Q", favorite_gadget: "Broom Radio"&gt;, ... ]&gt;</pre><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT "agents"."number", "agents"."favorite_gadget" FROM "agents"</pre><p>Как вы можете видеть, возвращенные объекты будут иметь только выбранные атрибуты, плюс их идентификаторы, - это данные с любым объектом. Не имеет значения, если вы используете строки, как указано выше, или символы - запрос будет таким же.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.select(:number_of_kills)Agent.select(:name, :licence_to_kill)</pre><p>Предупреждение: если вы попытаетесь получить доступ к атрибутам объекта, который не был выбран в ваших запросах, вы получите <code class="inline">MissingAttributeError</code>. Так как <code class="inline">id</code> будет автоматически предоставлен для вас в любом случае, вы можете запросить идентификатор, не выбирая его.<br></p><h2>Пользовательский SQL<br></h2><p>И последнее, но не менее важное: вы можете написать свой собственный SQL-запрос через <code class="inline">find_by_sql</code>. Если вы достаточно уверены в своем собственном SQL-Fu и нуждаетесь в некоторых пользовательских запросах к базе данных, этот метод может оказаться очень удобным. Но это уже совсем другая история. Просто не забудьте сначала проверить методы обертки Active Record чтобы избежать повторного изобретения колеса, где Rails пытается встретиться с вами более чем на полпути.<br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">Agent.find_by_sql("SELECT * FROM agents")Agent.find_by_sql("SELECT name, licence_to_kill FROM agents") </pre><p>Неудивительно, что это приводит к:<br></p><h4>SQL</h4><pre class="brush: sql noskimlinks noskimwords">SELECT * FROM agentsSELECT name, licence_to_kill FROM agents</pre><p>Поскольку скоупы и собственные методы классов могут использоваться взаимозаменяемо для ваших пользовательских поисковых запросов, мы можем сделать еще на один шаг к более сложным SQL-запросам. <br></p><h4>Rails</h4><pre class="brush: rails noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  ...  def self.find_agent_names    query = &lt;&lt;-SQL      SELECT name      FROM agents    SQL    self.find_by_sql(query)  endend</pre><p>Мы можем написать методы класса, которые инкапсулируют SQL внутри документа Here. Это позволяет нам писать многострочные строки очень легко читаемым образом, а затем хранить эту строку SQL внутри переменной, которую мы можем повторно использовать и передать в <code class="inline">find_by_sql</code>. Таким образом, мы не замазываем тонны кода запроса внутри вызова метода. Если у вас есть несколько мест для использования этого запроса, это также следует принципу DRY.<br></p><p>Поскольку эта статья предполагалась для новичков, и не была учебником по SQL, я по этой причине использовал максимально минималистичные примеры. Тем не менее, для более сложных запросов все может быть совсем по-другому. Легко представить, что там есть собственный SQL-запрос, который простирается на десять строк кода. </p><p>Используйте если вам это нужно! Это может быть оказаться для вас спасением. Слово о синтаксисе здесь. Часть <code class="inline">SQL</code> является всего лишь идентификатором здесь, чтобы отметить начало и конец строки. Бьюсь об заклад, вы не будете нуждаться в этом методе так часто, будем надеяться! Это определенно имеет место быть, и Rails земля не будет такой без этой возможности - в редких случаях вы наверняка захотите максимально точно настроить свой собственный SQL.<br></p><h2>Заключение<br></h2><p>Надеюсь, вы теперь себя чувствуете более уверенно при написании и чтении SQL запросов. Большинство тем, которые мы затронули в этой статье, необходимы для написания запросов, которые касаются более сложной бизнес-логики. Потратьте время, чтобы понять их и немного поиграть с запросами в консоли. </p><p>Я почти уверен, что когда вы покинете эту статью, рано или поздно ваши навыки Rails значительно возрастут, если вы будете работать над своими первыми реалистичными проектами и должны создавать свои собственные пользовательские запросы. Если вы все еще немного стесняетесь этой темы, я бы сказал, просто получайте удовольствие от этого - это действительно не ракетостроение!</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825223-zaprosy-v-rails-chast-2" class="tm-article-body__tags-item-link">Ruby on Rails</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
44814</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
345</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
