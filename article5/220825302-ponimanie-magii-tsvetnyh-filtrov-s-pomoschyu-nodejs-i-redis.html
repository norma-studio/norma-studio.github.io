
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js....">
<meta property="og:description" content="При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js....">
<meta name="twitter:description" content="При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js....">
<meta property="aiturec:description" content="При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1197/profiles/19707/profileImage/1959290_10100419202676841_330393073_n.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1197/profiles/19707/profileImage/1959290_10100419202676841_330393073_n.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1197/profiles/19707/profileImage/1959290_10100419202676841_330393073_n.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1197/profiles/19707/profileImage/1959290_10100419202676841_330393073_n.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1197/profiles/19707/profileImage/1959290_10100419202676841_330393073_n.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html" title="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io" title="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/543543242.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html" class="tm-user-info__username" title="
А. Морозов" aria-label="
А. Морозов">
А. Морозов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Понимание магии цветных фильтров с помощью Node.js и Redis...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Redis" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis" class="tm-article-snippet__hubs-item-link"><span>Redis</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=80/uploads/users/1197/profiles/19707/profileImage/1959290_10100419202676841_330393073_n.jpg">
    <meta itemprop="headline name" content="Понимание магии цветных фильтров с помощью Node.js и Redis... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>При правильном использовании фильтры Bloom окажутся магией. Это смелое утверждение, но в этом уроке мы рассмотрим любопытную структуру данных, как лучше всего ее использовать и несколько практических примеров с использованием Redis и Node.js.</p><p>Фильтры Bloom - это вероятностная односторонняя структура данных. Слово «фильтр» может запутать в этом контексте; фильтр подразумевает, что это активная вещь, глагол, но было бы легче думать об этом как о хранилище, существительном. С помощью простого фильтра Bloom вы можете сделать две вещи:</p> <ol><li>Добавить элемент.</li> <li>Проверить, <em>не был ли</em> добавлен элемент ранее.</li> </ol><p>Это важные ограничения для понимания: вы не можете удалить элемент и не можете перечислить элементы в фильтре Bloom. Кроме того, вы не можете с уверенностью сказать, если элемент был добавлен в фильтр в прошлом. Именно здесь возможен вероятностный характер фильтра Bloom, ложные срабатывания возможны, но ложных негативов нет. Если фильтр настроен правильно, ложные срабатывания могут быть крайне редкими.</p> <p>Существуют фильтры Bloom, и они добавляют другие способности, такие как удаление или масштабирование, но также добавляют сложности и ограничения. Важно сначала понять простые фильтры Bloom, прежде чем перейти к вариантам. В этой статье будут рассмотрены только простые фильтры Bloom.</p> <p>С этими ограничениями вы получаете ряд преимуществ: фиксированный размер, шифрование на основе хэшей и быстрый поиск.</p> <p>Когда вы устанавливаете фильтр Bloom, вы придаете ему размер. Этот размер фиксирован, поэтому, если у вас есть один элемент или один миллиард элементов в фильтре, он никогда не будет расти за указанный размер. Когда вы добавляете больше элементов в свой фильтр, вероятность ложного позитива увеличивается. Если вы указали меньший фильтр, эта ложная положительная скорость будет увеличиваться быстрее, чем если бы вы имели больший размер.</p> <p>Фильтры Bloom построены на концепции одностороннего хеширования. Как и в случае правильного хранения паролей, фильтры Bloom используют алгоритм хеширования для определения уникального идентификатора для переданных в него элементов. Хеши по своей природе не могут быть отменены и представлены кажущейся случайной строкой символов. Итак, если кто-то получает доступ к фильтру Bloom, он не будет напрямую раскрывать содержимое.</p> <p>Наконец, фильтры Bloom бывают быстрыми. Операция предполагает гораздо меньшее количество сравнений, чем другие методы, и ее можно легко сохранить в памяти, не допуская попадания в базу данных производительности.</p> <p>Теперь, когда вы знаете ограничения и преимущества фильтров Bloom, давайте рассмотрим некоторые ситуации, в которых вы можете их использовать.</p> <h2>Настройка</h2> <p>Мы будем использовать Redis и Node.js для иллюстрации фильтров Bloom. Redis - это среда для вашего фильтра Bloom; он быстрый, работает в памяти и имеет несколько конкретных команд (<code class="inline">GETBIT</code>, <code class="inline">SETBIT</code>), которые делают реализацию эффективной. Я предполагаю, что у вас есть Node.js, npm и Redis, установленные в вашей системе. Ваш Redis-сервер должен работать на <code class="inline">localhost</code> в порту по умолчанию, чтобы наши примеры работали.</p> <p>В этом уроке мы не будем внедрять фильтр с нуля; вместо этого мы сосредоточимся на практических применениях с предварительно построенным модулем в npm: <span>bloom-redis</span>. bloom-redis имеет очень сжатый набор методов: <code class="inline">add</code>, <code class="inline">contains</code> и <code class="inline">clear</code>.</p> <p>Как упоминалось ранее, фильтры Bloom нуждаются в алгоритме хеширования для генерирования уникальных идентификаторов для элемента. bloom-redis использует известный алгоритм MD5, который, хотя, может быть, и не идеально подходит для фильтра Блума (немного медленный), будет работать нормально.</p> <h2>Уникальные имена пользователей</h2> <p>Имена пользователей, особенно те, которые идентифицируют пользователя в URL-адресе, должны быть уникальными. Если вы создаете приложение, которое позволяет пользователям изменять имя пользователя, тогда вам, скорее всего, понадобится имя пользователя, которое <em>никогда</em> не использовалось, чтобы избежать путаницы и перехвата имен пользователей.</p> <p>Без фильтра Bloom вам нужно будет ссылаться на таблицу с каждым именем пользователя, когда она используется, и в масштабе это может быть очень дорого. Фильтры Bloom позволяют добавлять элемент каждый раз, когда пользователь принимает новое имя. Когда пользователь проверяет, требуется ли имя пользователя, все, что вам нужно сделать, это проверить фильтр Bloom. Он сможет с полной уверенностью сказать вам, если ранее было добавлено запрошенное имя пользователя. Возможно, что фильтр будет ложно возвращаться к тому, что имя пользователя использовалось, когда оно на самом деле не было, но это ошибочно на стороне предостережения и не может нанести никакого реального вреда (кроме того, что пользователь, возможно, не может претендовать на «k3w1d00d47») ,</p> <p>Чтобы проиллюстрировать это, давайте построим быстрый сервер REST с помощью Express. Сначала <span>создайте</span> файл <code class="inline">package.json</code> и запустите следующие команды терминала.</p> <p><code class="inline">npm install bloom-redis --save</code></p> <p><code class="inline">npm install express --save</code></p> <p><code class="inline">npm install redis --save</code></p> <p>Параметры по умолчанию для bloom-redis имеют размер, заданный в двух мегабайтах. Это ошибочно на стороне осторожности, но оно довольно велико. Настройка размера фильтра Bloom имеет решающее значение: слишком большой и вы теряете память, слишком маленький, и ваш ложный положительный уровень будет слишком высоким. Математика, участвующая в определении размера, довольно сложная и выходит за рамки этого урока, но, к счастью, есть <span>калькулятор размера Bloom</span>.</p> <p>Теперь создайте приложение <code class="inline">app.js</code> следующим образом:</p> <pre class="brush: javascript noskimlinks noskimwords">var  Bloom         =   require("bloom-redis"),  express       =   require("express"),  redis         =   require("redis"),    app,  client,  filter;//setup our Express serverapp = express();//create the connection to Redisclient = redis.createClient();filter = new Bloom.BloomFilter({   client    : client, //make sure the Bloom module uses our newly created connection to Redis  key       : "username-bloom-filter", //the Redis key    //calculated size of the Bloom filter.  //This is where your size / probability trade-offs are made  //http://hur.st/bloomfilter?n=100000&amp;p=1.0E-6  size      : 2875518, // ~350kb  numHashes : 20});app.get("/check", function(req,res,next) {  //check to make sure the query string has "username"  if (typeof req.query.username === "undefined") {    //skip this route, go to the next one - will result in a 404 / not found    next("route");  } else {   filter.contains(     req.query.username, // the username from the query string     function(err, result) {       if (err) {         next(err); //if an error is encountered, send it to the client        } else {          res.send({             username : req.query.username,             //if the result is false, then we know the item has *not* been used            //if the result is true, then we can assume that the item has been used            status : result ? "used" : "free"           });        }      }    );  }});app.get("/save",function(req,res,next) {  if (typeof req.query.username === "undefined") {    next("route");  } else {    //first, we need to make sure that it"s not yet in the filter    filter.contains(req.query.username, function(err, result) {      if (err) { next(err); } else {        if (result) {          //true result means it already exists, so tell the user          res.send({ username : req.query.username, status : "not-created" });        } else {          //we"ll add the username passed in the query string to the filter          filter.add(            req.query.username,             function(err) {              //The callback arguments to `add` provides no useful information, so we"ll just check to make sure that no error was passed              if (err) { next(err); } else {                res.send({                   username : req.query.username, status : "created"                 });              }            }          );        }      }    });  }});app.listen(8010);</pre> <p>Для запуска этого сервера: <code class="inline">node app.js</code>. Перейдите в свой браузер и откройте <code class="inline">https://localhost: 8010/check?username=kyle</code>. Ответ должен быть: <code class="inline">{"username": "kyle", "status": "free"}</code>.</p> <p>Теперь давайте сохраним это имя пользователя, открыв ваш браузер на <code class="inline">http://localhost:8010/save?гsername=kyle</code>. Ответ будет следующим: <code class="inline">{"username": "kyle", "status": "created"}</code>. Если вы вернетесь к адресу <code class="inline">http://localhost:8010/check?username=kyle</code>, ответ будет <code class="inline">{"username": "kyle", "status": "used"}</code>. Аналогичным образом, вернемся к <code class="inline">http://localhost:8010/save?username=kyle</code> приведет к <code class="inline">{"username": "kyle", "status": "not-created"}</code>.</p> <p>С терминала вы можете увидеть размер фильтра: <code class="inline">redis-cli strlen username-bloom-filter</code>.</p> <p>Прямо сейчас, с одним элементом, он должен показать <code class="inline">338622</code>.</p> <p>Теперь попробуйте добавить дополнительные имена пользователей с помощью маршрута <code class="inline">/save</code>. Постарайтесь побольше.</p> <p>Если вы затем снова проверите размер, вы можете заметить, что ваш размер немного вырос, но не для каждого добавления. Любопытно, правда? Внутри фильтр Bloom устанавливает отдельные биты (1"s / 0"s) в разных положениях строки, сохраненной в username-bloom. Однако они не смежны, поэтому, если вы установите бит в индексе 0, а затем на индекс 10 000, все между ними будет 0. Для практического использования сначала не важно понимать точную механику каждой операции - просто знайте, что это нормально, и что ваше хранилище в Redis никогда не превысит указанное вами значение.</p> <h2>Свежий контент</h2> <p>Свежий контент на веб-сайте позволяет пользователю вернуться, так как вы каждый раз показываете пользователю что-то новое? Используя традиционный подход к базе данных, вы можете добавить новую строку в таблицу с идентификатором пользователя и идентификатором истории, а затем вы будете запрашивать эту таблицу при выборе части содержимого. Как вы можете себе представить, ваша база данных будет расти чрезвычайно быстро, особенно с ростом как пользователей, так и контента.</p> <p>В этом случае ложный негатив (например, не показывающий невидимую часть контента) имеет очень мало последствий, что делает Bloom фильтром хороши решением. На первый взгляд, вы можете подумать, что для каждого пользователя вам понадобится фильтр Bloom, но мы будем использовать простую конкатенацию идентификатора пользователя и идентификатора содержимого, а затем вставьте эту строку в наш фильтр. Таким образом, мы можем использовать один фильтр для всех пользователей.</p> <p>В этом примере давайте создадим еще один базовый Express-сервер, который отображает контент. Каждый раз, когда вы посещаете маршрут <code class="inline">/show-content/any-username</code> (с <em>любым</em> именем пользователя, являющимся любым безопасным значением URL), будет отображаться новый фрагмент контента до тех пор, пока на сайте будет доступен новый контент. В этом примере контент является первой строкой из десяти лучших книг по <span>проекту Gutenberg.</span></p> <p>Нам понадобится установить еще один модуль npm. С терминала запустите: <code class="inline">npm install async --save</code></p> <p>Ваш новый файл app.js:</p> <pre class="brush: javascript noskimlinks noskimwords">var  async         =   require("async"),  Bloom         =   require("bloom-redis"),  express       =   require("express"),  redis         =   require("redis"),    app,  client,  filter,    // From Project Gutenberg - opening lines of the top 10 public domain ebooks  // https://www.gutenberg.org/browse/scores/top  openingLines = {    "pride-and-prejudice" :       "It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife.",    "alices-adventures-in-wonderland" :       "Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, \"and what is the use of a book,\" thought Alice \"without pictures or conversations?\"",    "a-christmas-carol" :      "Marley was dead: to begin with.",    "metamorphosis" :       "One morning, when Gregor Samsa woke from troubled dreams, he found himself transformed in his bed into a horrible vermin.",    "frankenstein"  :       "You will rejoice to hear that no disaster has accompanied the commencement of an enterprise which you have regarded with such evil forebodings.",    "adventures-of-huckleberry-finn" :       "YOU don\"t know about me without you have read a book by the name of The Adventures of Tom Sawyer; but that ain\"t no matter.",    "adventures-of-sherlock-holmes" :      "To Sherlock Holmes she is always the woman.",    "narrative-of-the-life-of-frederick-douglass" :      "I was born in Tuckahoe, near Hillsborough, and about twelve miles from Easton, in Talbot county, Maryland.",    "the-prince" :      "All states, all powers, that have held and hold rule over men have been and are either republics or principalities.",    "adventures-of-tom-sawyer" :      "TOM!"  };app = express();client = redis.createClient();filter = new Bloom.BloomFilter({   client    : client,  key       : "3content-bloom-filter", //the Redis key  size      : 2875518, // ~350kb  //size      : 1024,  numHashes : 20});app.get("/show-content/:user", function(req,res,next) {  //we"re going to be looping through the contentIds, checking to see if they are in the filter.  //Since this spends time on each contentId wouldn"t be advisable to do over a high number of contentIds  //But, in this case the number of contentIds is small / fixed and our filter.contains function is fast, it is okay.  var    //creates an array of the keys defined in openingLines    contentIds = Object.keys(openingLines),    //getting part of the path from the URI    user = req.params.user,    checkingContentId,    found = false,    done = false;     //since filter.contains is asynchronous, we"re using the async library to do our looping   async.whilst(    //check function, where our asynchronous loop will end    function () { return (!found &amp;&amp; !done); },    function(cb) {      //get the first item from the array of contentIds      checkingContentId = contentIds.shift();            //false means we"re sure that it isn"t in the filter      if (!checkingContentId)  {         done = true; // this will be caught by the check function above         cb();      } else {        //concatenate the user (from the URL) with the id of the content        filter.contains(user+checkingContentId, function(err, results) {          if (err) { cb(err); } else {            found = !results;            cb();          }        });      }    },    function(err) {      if (err) { next(err); } else {        if (openingLines[checkingContentId]) {          //before we send the fresh contentId, let"s add it to the filter to prevent it from showing again          filter.add(            user+checkingContentId,             function(err) {              if (err) { next(err); } else {                //send the fresh quote                res.send(openingLines[checkingContentId]);              }            }          );        } else {          res.send("no new content!");        }      }    }  );});app.listen(8011);</pre> <p>Если вы внимательно обратите внимание на время прохождения в Dev Tools, вы заметите, что чем больше вы запрашиваете один путь с именем пользователя, тем больше времени требуется. Хотя проверка фильтра занимает фиксированное время, в этом примере мы проверяем наличие большего количества элементов. Фильтры Bloom ограничены тем, что они могут вам сказать, поэтому вы проверяете наличие каждого элемента. Конечно, в нашем примере это довольно просто, но тестирование на сотни предметов будет неэффективным.</p> <h2>Старые данные</h2> <p>В этом примере мы построим небольшой сервер Express, который будет делать две вещи: принимать новые данные через POST и отображать текущие данные (с запросом GET). Когда новые данные отправляются на сервер, приложение проверяет наличие их в фильтре. Если их там нет, мы добавим их в набор в Redis, иначе мы вернем null. Запрос GET выберет из Redis и отправит клиенту.</p> <p>Это отличается от предыдущих двух ситуаций, поскольку ложные срабатывания нам уже не подойдут. Мы будем использовать фильтр Bloom в качестве первой линии защиты. Учитывая свойства фильтров Bloom, мы будем точно знать, что что-то не в фильтре, поэтому в этом случае мы можем двигаться дальше и передавать данные. Если фильтр Bloom возвращается, вероятно, данные находятся в фильтре, мы проведем проверку по сравнению с фактическим источником данных.</p> <p>Итак, что мы получаем? Мы получаем скорость, которую вам не нужно проверять в сравнении с фактическим источником каждый раз. В ситуациях, когда источник данных работает медленно (внешние API, базы данных pokey, середина плоского файла), увеличение скорости действительно необходимо. Чтобы продемонстрировать скорость, давайте добавим реалистичную задержку в 150 мс в нашем примере. Мы также будем использовать <code class="inline">console.time</code> / <code class="inline">console.timeEnd</code> для регистрации различий между проверкой фильтра Bloom и проверкой фильтра не-Bloom.</p> <p>В этом примере мы также будем использовать чрезвычайно ограниченное количество бит: всего 1024. Он будет быстро заполняться. По мере того, как он заполняется, он будет показывать все больше и больше ложных срабатываний - вы увидите увеличение времени отклика, когда заполняется ложная положительная ставка.</p> <p>Этот сервер использует те же модули, что и раньше, поэтому установите файл <code class="inline">app.js</code>:</p> <pre class="brush: javascript noskimlinks noskimwords">var  async           =   require("async"),  Bloom           =   require("bloom-redis"),  bodyParser      =   require("body-parser"),  express         =   require("express"),  redis           =   require("redis"),    app,  client,  filter,    currentDataKey  = "current-data",  usedDataKey     = "used-data";  app = express();client = redis.createClient();filter = new Bloom.BloomFilter({   client    : client,  key       : "stale-bloom-filter",  //for illustration purposes, this is a super small filter. It should fill up at around 500 items, so for a production load, you"d need something much larger!  size      : 1024,  numHashes : 20});app.post(  "/",  bodyParser.text(),  function(req,res,next) {    var      used;          console.log("POST -", req.body); //log the current data being posted    console.time("post"); //start measuring the time it takes to complete our filter and conditional verification process        //async.series is used to manage multiple asynchronous function calls.    async.series([      function(cb) {        filter.contains(req.body, function(err,filterStatus) {          if (err) { cb(err); } else {            used = filterStatus;            cb(err);          }        });      },      function(cb) {        if (used === false) {          //Bloom filters do not have false negatives, so we need no further verification          cb(null);        } else {          //it *may* be in the filter, so we need to do a follow up check          //for the purposes of the tutorial, we"ll add a 150ms delay in here since Redis can be fast enough to make it difficult to measure and the delay will simulate a slow database or API call          setTimeout(function() {            console.log("possible false positive");            client.sismember(usedDataKey, req.body, function(err, membership) {              if (err) { cb(err); } else {                //sismember returns 0 if an member is not part of the set and 1 if it is.                //This transforms those results into booleans for consistent logic comparison                used = membership === 0 ? false : true;                cb(err);              }            });          }, 150);        }      },      function(cb) {        if (used === false) {          console.log("Adding to filter");          filter.add(req.body,cb);        } else {          console.log("Skipped filter addition, [false] positive");          cb(null);        }      },      function(cb) {        if (used === false) {          client.multi()            .set(currentDataKey,req.body) //unused data is set for easy access to the "current-data" key            .sadd(usedDataKey,req.body) //and added to a set for easy verification later            .exec(cb);         } else {          cb(null);        }      }      ],      function(err, cb) {        if (err) { next(err); } else {          console.timeEnd("post"); //logs the amount of time since the console.time call above          res.send({ saved : !used }); //returns if the item was saved, true for fresh data, false for stale data.        }      }    );});app.get("/",function(req,res,next) {  //just return the fresh data  client.get(currentDataKey, function(err,data) {    if (err) { next(err); } else {      res.send(data);    }  });});app.listen(8012);</pre> <p>Поскольку отправлять POST запрос на сервер в браузере не очень удобно, давайте использовать <span>curl</span> для тестирования.</p> <p><code class="inline">curl --data “your data goes here" --header "Content-Type: text/plain" http://localhost:8012/</code></p> <p>Быстрый сценарий bash можно использовать, чтобы показать, как выглядит заполнение всего фильтра:</p> <pre class="brush: bash noskimlinks noskimwords">#!/bin/bashfor i in `seq 1 500`;do  curl --data “data $i" --header "Content-Type: text/plain" http://localhost:8012/done   </pre> <p>Интересно смотреть на заполняющийся или полный фильтр. Так как наш совсем маленький, вы можете легко просмотреть его с помощью <code class="inline">redis-cli</code>. Запустив команду <code class="inline">redis-cli get stale-filter</code> из своего терминала между добавлением элементов, вы увидите увеличение отдельных байтов. Полный фильтр будет <code class="inline">\xf</code>f для каждого байта. На этом этапе фильтр всегда будет возвращать положительный ответ.</p> <h2>Заключение</h2> <p>Фильтры Bloom не являются панацеей, но в правильной ситуации фильтр Bloom может обеспечить быстрое и эффективное дополнение к другим структурам данных.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Redis" href="https://norma-studio.github.io/article5/220825302-ponimanie-magii-tsvetnyh-filtrov-s-pomoschyu-nodejs-i-redis" class="tm-article-body__tags-item-link">Redis</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
39646</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
727</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
