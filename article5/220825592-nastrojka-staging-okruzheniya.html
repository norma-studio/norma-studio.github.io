
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производ...">
<meta property="og:description" content="Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производ...">
<meta name="twitter:description" content="Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производ...">
<meta property="aiturec:description" content="Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производ...">
<meta property="og:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png">
<meta property="aiturec:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png">
<meta name="twitter:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png">
<meta property="vk:image" content="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html" title="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io" title="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/ded38a8520cf75a955c11fc92a1a403e.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html" class="tm-user-info__username" title="
В. Самсонов" aria-label="
В. Самсонов">
В. Самсонов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Настройка-Staging окружения...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Web Development" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya" class="tm-article-snippet__hubs-item-link"><span>Web Development</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya.html" />
    <link itemprop="image" href="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png">
    <meta itemprop="headline name" content="Настройка-Staging окружения... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производ...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производ...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Общепринятая практика заключается в том, чтобы работать локально в проекте и выкатывать ревизии на производственный сервер, но шаг, который люди часто пропускают, является промежуточным сервером. Промежуточный сервер представляет собой смесь между производством и разработкой; вы можете проверить свое приложение так, как если бы оно было на производстве. Давайте рассмотрим некоторые из проблем, которые вам придется рассмотреть, а также шаги, необходимые для репликации производственной платформы как службы (PAAS). </p><p><!--more--></p><p>Это произошло не один раз: я выкатываю ревизию моего приложения в производство, только чтобы найти проблему после ее публикации. Эти проблемы могут быть такими же простыми, как забывать добавлять изображения в ваш репозиторий, или же может быть такой же большой, как изменение структуры базы данных локально, и забыть обновить производственную базу данных. Проблемы случаются со всеми, особенно когда вы устремились к крайним срокам. В этих ситуациях разумной идеей является создание промежуточного окружения. Идея состоит в том, чтобы иметь сервер, который тесно реплицирует производственное окружение, чтобы протестировать ваше приложение перед публикацией.</p> <blockquote><p>Промежуточное окружение не только позволяет отследить человеческие ошибки, но и проблемы, связанные с программным обеспечением.</p></blockquote> <p>Вы можете найти и исправить эти проблемы, поскольку в промежуточном окружение есть то же программное обеспечение, что и в вашем производственном окружении. Это резко контрастирует с вашей локальной машиной, где у вас могут быть установлены разные версии программного обеспечения (например, PHP 5.3 vs PHP 5.4) или даже разные функции. Я выкатывал код, содержащий вызовы <code>file_get_contents</code>, только чтобы найти, что производственный сервер не поддерживает эту функцию.</p> <p>Итак, как вы собираетесь настраивать промежуточный сервер? Ну, первый шаг - небольшая разведка.</p> <hr><h2>Это все в деталях (в основном)</h2> <blockquote class="pullquote"><p>Проблемы случаются со всеми, особенно когда вы устремились к крайним срокам.</p></blockquote> <p>Создание промежуточной среды зависит от вашей производственной среды. Нет волшебного решения, которое работает в любой ситуации. Но в большинстве случаев следуют аналогичной схеме, и я расскажу о всех ключевых моментах.</p> <p>Справедливо предположить, что большинство людей развертывают свои приложения с помощью какого-то средства управления версиями (например, GIT). Если есть вероятность того, что вы работаете над старым проектом, который все еще использует FTP, сайты, такие как <span>ftploy.com</span> или <span>deployHQ.com</span>, могут выступать в качестве буфера между GIT и вашим сервером. Джеффри Уэй собрал <span>информативное видео</span>, в котором подробно описывается, как это сделать.</p> <p>Помимо GIT, вам нужно подумать о языках, программном обеспечении и «специальных» функциях, предлагаемых вашими производственными серверами. Я использую PAAS на основе PHP, названный <span>Fortrabbit</span>, потому что они предлагают обновленную поддержку PHP, Apache и GIT. Они также предоставляют возможность добавить ключевое слово в сообщение GIT commit, которое запускает Composer для установки зависимостей вашего проекта.</p> <p>Это система, которую я установлю в остальной части этой статьи. Его стандартный набор функций, а также специальная функция композитора делают Fortrabbit идеальным для широкого круга хостов. Просто помните: это не волшебное решение, но шаги, которые вы делаете, следуют тому же шаблону, который вы использовали бы для настройки промежуточной среды для большинства проектов. Подготовьте процесс к вашим конкретным потребностям.</p> <p>Поэтому без дальнейших церемоний, давайте уже приступим.</p> <hr><h2>Создание сервера</h2> <blockquote class="pullquote"><p>Создание промежуточного окружения напрямую зависит от вашего производственного окружения.</p></blockquote> <p>Существует множество различных операционных систем, которые вы можете запускать на сервере. Fortrabbit запускает Debian Squeeze на своих серверах, и поскольку мы пытаемся их сопоставить, я решил запустить его также.</p> <p>Я воспользуюсь <span>Vagrant</span>, чтобы настроить это. Не беспокойтесь, если вы никогда не использовали Vagrant; мы не будем делать ничего сложного. Убедитесь, что у вас установлен <span>VirtualBox</span> и <span>Vagrant</span> (Vagrant - это CLI для VirtualBox, поэтому требуется VirtualBox).</p> <p>Vagrant принимает виртуальный снимок операционной системы в качестве базового «бокса», и затем вы можете создавать несколько виртуальных машин из этого образа. Итак, сначала нужно загрузить базовое поле для Debian Squeeze. Я не совсем уверен, откуда моя копия, поэтому я загрузил ее в DropBox для загрузки и использования. Чтобы установить, откройте окно терминала и введите:</p> <pre class="brush: bash noskimlinks noskimwords">vagrant box add debian https://dl.dropbox.com/u/30949096/debian.box</pre> <p>Это добавляет бокс в Vagrant с именем «debian». Теперь мы можем создать экземпляр этого бокса для нашего промежуточного окружения. Сначала создадим новую папку:</p> <pre class="brush: bash noskimlinks noskimwords">mkdir ~/staging_servercd ~/staging_server</pre> <p>Затем создайте конфигурационный файл Vagrant, введя:</p> <pre class="brush: bash noskimlinks noskimwords">vagrant init debian</pre> <p>Это создает файл конфигурации с именем «VagrantFile», который содержит все настройки для вашего сервера. Это выглядит весьма громоздко, когда вы его открываете, но большинство строк - это комментарии. Вам нужно только раскомментировать строку, в которой говорится: <code>config.vm.network: bridge</code>. Удаление всех остальных комментариев оставляет вам файл, который выглядит так:</p> <pre class="brush: ruby noskimlinks noskimwords">Vagrant::Config.run do |config|    config.vm.box = "debian"    config.vm.network :bridgedend</pre> <p>Эти параметры говорят Vagrant о создании новой виртуальной машины на основе нашего базового блока Debian Squeeze. Затем он устанавливает сетевой режим в « bridged». Виртуальная машина с мостовой сетью отображается как новая физическая машина для вашего маршрутизатора, поэтому она автоматически получает свой собственный IP-адрес. Это позволяет получить доступ к устройству с любого устройства в сети (возможно, вне сети, если вы настроите маршрутизатор).</p> <blockquote><p>Теперь мы можем запустить нашу виртуальную машину с помощью команды: «<code>vagrant up</code>» (без кавычек).</p></blockquote> <p>Вы должны увидеть вывод Vagrant, создающий вашу виртуальную машину. Если ваш компьютер имеет несколько сетевых адаптеров, подключенных к сети, Vagrant предложит вам выбрать NIC для моста.</p> <p>Мы будем использовать SSH для входа в систему, но нам нужно будет использовать встроенную в систему Vagrant команду «<code>vagrant ssh</code>» для входа. Согласно лучшим практикам Vagrant, все боксы должны иметь пользователя с именем «vagrant» с паролем, как для root, так и для vagrant, «vagrant». Пользователь vagrant добавляется как пользователь <code>sudo</code>, которому не нужно вводить пароль, поэтому вы можете напрямую использовать команды <code>sudo</code>.</p> <p>Давайте перейдем и настроим программное обеспечение сервера.</p> <hr><h2>Программное обеспечение</h2> <p>Настройка Fortrabbit включает в себя:</p> <ul><li>Apache 2.2</li> <li>PHP 5.4</li> <li>Composer</li> </ul><p>Кроме того, они используют репозиторий dotdeb для установки основной части. Для тех, кто незнаком, <span>dotdeb</span> - это проект <span>Гийома Плессиса</span>, который устанавливает самые современные версии популярных пакетов веб-серверов.</p> <p>Мы готовы начать. Убедитесь, что окно терминала открыто и вы залогинены на сервере через SSH. Во-первых, добавьте dotdeb repo в APT (менеджер пакетов), добавив новый файл в каталог <code>sources.d</code>:</p> <pre class="brush: bash noskimlinks noskimwords">sudo vim /etc/apt/sources.list.d/dotdeb.list</pre> <p>Это открывает новый файл с именем <code>dotdeb.list</code> в vim (текстовый редактор). Имя не важно, потому что все файлы в этом каталоге считываются в APT. Нам нужно добавить четыре строки в этот файл. Если вы никогда не использовали VIM, просто введите «<code>i</code>», чтобы войти в режим вставки и скопируйте/вставьте следующие четыре строки:</p> <pre class="brush: bash noskimlinks noskimwords">deb http://packages.dotdeb.org squeeze alldeb-src http://packages.dotdeb.org squeeze alldeb http://packages.dotdeb.org squeeze-php54 alldeb-src http://packages.dotdeb.org squeeze-php54 all</pre> <p>Для сохранения нажмите клавишу <code>esc</code> и введите: <code>wq</code>. Это команда сохранить изменения и выйти, что в основном означает сохранение и выход.</p> <blockquote><p>Нажатие Enter сохраняет файл и возвращает вас в командную строку.</p></blockquote> <p>Теперь мы добавили репозитории, но нам еще нужно добавить подпись, прежде чем мы сможем их использовать. Чтобы добавить ключ GNU, введите следующее:</p> <pre class="brush: bash noskimlinks noskimwords">curl http://www.dotdeb.org/dotdeb.gpg | sudo apt-key add -</pre> <p>Это загружает ключ dotdeb и добавляет его как подписанный источник. Теперь обновите APT, чтобы вытащить новый пакет, набрав:</p> <pre class="brush: bash noskimlinks noskimwords">sudo apt-get update</pre> <p>Это может занять около минуты, но у вас будут все пакеты dotdeb, перечисленные в APT, когда выполнится команда. Благодаря тому, как dotdeb настроен и как загружаются зависимости APT, мы можем одновременно установить Apache и PHP, набрав:</p> <pre class="brush: bash noskimlinks noskimwords">sudo apt-get install php5</pre> <p>С помощью этой отдельной строки APT устанавливает и настраивает Apache2 и PHP5. Если вы используете дополнение Memcache Fortrabbit, вы можете установить его с помощью:</p> <pre class="brush: bash noskimlinks noskimwords">sudo apt-get install memcached</pre> <p>Но я не собираюсь касаться memcache в нашем примере в этой статье.</p> <p>Теперь нам нужно установить расширения, которые использует Fortrabbit. Выполните следующую команду:</p> <pre class="brush: bash noskimlinks noskimwords">sudo apt-get install php5-xdebug php5-tidy php5-sqlite php5-redis php5-pgsql \php5-mysqlnd php5-memcache php5-memcached php5-mcrypt php5-imagick php5-http \php5-gmp php5-gd php5-curl php5-apc php5-intl</pre> <p>Последнее, что нам нужно установить, это Composer. Я собираюсь установить его глобально, потому что мы будем использовать его в нескольких разных местах. Команды для глобальной установки Composer:</p> <pre class="brush: bash noskimlinks noskimwords">curl -s https://getcomposer.org/installer | phpsudo mv composer.phar /usr/local/bin/composer</pre> <p>Первая команда загружает и выполняет установку; вторая команда перемещает Composer в папку bin, чтобы мы могли использовать ее без объявления пути. Перейдем к конфигурации.</p> <hr><h2>Настройка Apache</h2> <p>Скорее всего, вы можете работать над несколькими проектами. Если это так, наличие промежуточного сервера для каждого проекта создает много накладных расходов. Чтобы разрешить использование нескольких сайтов на одном сервере, нам нужно добавить виртуальные хосты на основе имени в Apache и разделить каталоги и репозитории для каждого проекта.</p> <p>Начнем с виртуального хоста.</p> <blockquote><p>Я собираюсь продолжать использовать vim, но знаю, что если вы хотите работать в своих собственных программах, вы можете скопировать и вставить или сохранить его в папке <code>staging_server</code>, созданной на вашем компьютере.</p></blockquote> <p>Эта папка шарится на вашу виртуальную машину, и вы можете получить доступ к файлам в корневом каталоге <code>vagrant</code>. Затем вы можете использовать: <code>sudo cp /vagrant/file newfile</code> или <code>sudo mv /vagrant/filee newfile</code> для копирования или перемещения файлов соответственно.</p> <p>Чтобы создать новый виртуальный хост, нам нужно создать файл в каталоге <code>/etc/apache2/sites-available/</code>. Чтобы сделать это с помощью VIM, введите следующее:</p> <pre class="brush: bash noskimlinks noskimwords">sudo vim /etc/apache2/sites-available/demo.site</pre> <p>Внутри введите следующее (помните, чтобы нажать «<code>i</code>» для режима вставки):</p> <pre class="brush: bash noskimlinks noskimwords">&lt;VirtualHost *:80&gt;  ServerAdmin youremail@provider.comServerName demo.devDocumentRoot /var/www/demo&lt;Directory /var/www/demo&gt;Options Indexes FollowSymLinks MultiViewsAllowOverride ALLOrder allow,denyallow from all&lt;/Directory&gt;ErrorLog ${APACHE_LOG_DIR}/demo.logLogLevel debug&lt;/VirtualHost&gt;</pre> <p>Первая строка объявляет виртуальный хост, который прослушивает запросы на любом IP-адресе на порту 80. Затем мы устанавливаем адрес электронной почты администратора и имя сервера. Адрес электронной почты предназначен для сообщений об ошибках, а параметр имени сервера сообщает Apache, когда он читает этот виртуальный хост. Регулярные виртуальные хосты работают с IP-адресами. Например, каждый vhost прослушивает другой IP; так Apache различает их.</p> <blockquote><p>Поскольку у вас, вероятно, есть только один IP-адрес, мы можем использовать виртуальные хосты на основе имен, позволяя вам указать другое имя на одном IP-адресе.</p></blockquote> <p>В нашем примере любые запросы, направленные на demo.dev, собираются этим виртуальным хостом.</p> <p>Следующая строка устанавливает корневую папку документа. Здесь Apache извлекает файлы для этого vhost. Выражения внутри директивы <code>Directory</code> устанавливают разрешения для этого vhost. Я не буду вдаваться в подробности, но мы сначала задали параметры директорий для Apache, затем устанавливаем, что можно переопределить в файле .htaccess, и, наконец, мы установили, кто может получить доступ к сайту (каждый может в нашем случае).</p> <p>Последние две строки говорят Apache, как назвать файл лога и что писать в этот лог. Наш файл лога называется demo.log в папке логов Apache, расположенной в <code>/var/log/apache2/</code> на этой виртуальной машине.</p> <p>Чтобы включить этот vhost, введите следующее:</p> <pre class="brush: bash noskimlinks noskimwords">sudo a2ensite demo.site</pre> <p>Это создает символическую связь между файлом в папке sites-available с файлом в папке sites-enabled. После запуска этой команды вам будет предложено перезапустить Apache. Вы получите сообщение об ошибке, если попытаетесь перезапустить Apache, потому что мы не создали каталог сайта. Это легко поправить, создав папку <code>demo</code>, на которую мы ссылались в файле vhost:</p> <pre class="brush: bash noskimlinks noskimwords">sudo mkdir /var/www/demo</pre> <p>Мы не хотим, чтобы пользователь root имел собственную папку, поэтому измените ее на пользователя vagrant с помощью команды <code>chown</code>:</p> <pre class="brush: bash noskimlinks noskimwords">sudo chown -R vagrant:vagrant /var/www/demo</pre> <p>Теперь перезапустите Apache:</p> <pre class="brush: bash noskimlinks noskimwords">sudo service apache2 restart&lt;/code&gt;</pre> <p>Теперь наш новый сайт должен быть полностью функциональным. Следующий шаг - настроить GIT.</p> <hr><h2>Немного Git магии</h2> <p>Убедитесь, что вы находитесь в домашнем каталоге, набрав <code>cd ~</code>. Создайте новую папку для репо: <code>mkdir demo.git</code>, перейдите в папку и инициализируйте новый, пустой репозиторий GIT:</p> <pre class="brush: bash noskimlinks noskimwords">cd demo.gitgit init --bare</pre> <p>Пустой репо является стандартным репо без рабочего каталога. Если вы хотите узнать больше о GIT, <span>посмотрите видеоролик Andrew Burgess</span>.</p> <p>Теперь нам нужна возможность пушить код в папку сайта, и есть много способов сделать это. Но мне нравится делать вещи как можно ближе к сервису, которому я подражаю. Вот картина процесса git fortrabbit,  взятого с их сайта:</p> <div class="tutorial_image"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" border="0" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/fortrabbit_git.png" alt="Настройка Staging окружения..." title="Настройка Staging окружения..." width="50" height="50"></div> <p>Вы можете видеть, что процесс push проходит через три этапа. Он отображает сообщение об обновлении при его подключении и развертывает сайт в каталоге. Заключительный шаг устанавливает все, если сообщение фиксации изменений содержит ключевые слова «[trigger: composer]». Затем, после завершения этих трех шагов, вам будет отображено «&gt;&gt; All Done </p><blockquote><p>Прежде чем создавать хуки, я хочу поговорить о цветах.</p></blockquote> <p>Я выполняю большую часть своей работы в терминале, и чаще всего терминальные приложения оставляют все одинаковым цветом. Добавление различных цветов в ваше приложение гораздо повышает читаемость и упрощает его использование. Так что я займусь распространением «цветовых практик» в терминальных приложениях, я займу минутку, чтобы обсудить, как они работают.</p> <hr><h2>Цвета в терминале</h2> <p>Терминалы поставляются с шестнадцатью цветами ANSI, которые можно настроить и использовать на терминале. Вот изображение экрана настроек iTerm2, показывающего шестнадцать цветовых слотов:</p> <div class="tutorial_image"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" border="0" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/iterm2_colors.png" alt="Настройка Staging окружения..." title="Настройка Staging окружения..." width="50" height="50"></div> <p>Вы можете получить к ним доступ в терминале, набрав escape-символ, за которым следует открытая квадратная скобка, а затем код цвета. Вы можете видеть на этом изображении, что цвета разделены на две строки: одна с надписью «Обычный», а другая «Яркая». Кодами нормальных цветов являются числа 30-37, за которыми следует буква «m», а яркие цвета - от 90-97, а затем m. Вы можете проверить это в окне терминала с помощью <code>echo</code>. Чтобы создать escape-символ, введите <code>ctrl-v</code>, а затем <code>ctrl- [</code>. Вы получите символ, который выглядит как <code>^[</code>, но он не будет работать, если вы просто наберете «^[» (shift-6, а затем откройте квадратную скобку). Поэтому в окне терминала введите:</p> <pre class="brush: bash noskimlinks noskimwords">echo "^[[31m Hello World ^[[0m"</pre> <p>Опять же, первый <code>^[</code> не был напечатан, но был создан с помощью <code>ctrl-v</code>, а затем <code>ctrl-[</code>. Код символа <code>0m</code> является кодом сброса; он удаляет все форматирование. Это связано с тем, что цветовые коды не заканчиваются после следующего слова, они продолжаются до тех пор, пока они не получат другой код.</p> <p>Если все сделано правильно, приведенный выше код выводит слова «hello world» красным цветом (если только этот слот не установлен на другой цвет).</p> <p>Всюду по остальной части учебника я буду добавлять цвета к командам. Не стесняйтесь следовать или опускать их; они не являются строго обязательными. Но если вы хотите использовать цвета, не стесняйтесь использовать <span>мой класс помощник</span>. Теперь давайте вернемся к написанию хуков.</p> <hr><h2>Создание хуков</h2> <p>Если вы еще раз взглянете на скриншот Fortrabbit, вы увидите, что перед обновлением репо отображается сообщение «Шаг 1: Обновление репозитория». Чтобы сделать все правильно, мы должны поместить это сообщение в хук pre-receive, который выполняется до обновления репо. В окне терминала введите:</p> <pre class="brush: bash noskimlinks noskimwords">vim ~/demo.git/hooks/pre-receive</pre> <p>Это открывает хук для редактирования. Добавьте следующий код:</p> <pre class="brush: php noskimlinks noskimwords">#!/usr/bin/php&lt;?php    $yellow = "^[[33m";    $blank = "^[[0m";    echo $yellow . "Step1: Updating repository" . $blank . "\n";?&gt;</pre> <p>Первая строка сообщает ОС, что это файл PHP и запускать его как таковой. Затем мы назначаем цвет и последовательность сброса для переменных. Последний шаг делает <code>echo</code> строки.</p> <p>Следующий хук немного сложнее, потому что он обрабатывает остальные действия. Мы сделаем это шаг за шагом, поэтому сохраните первый хук (: wq) и откройте следующий:</p> <pre class="brush: bash noskimlinks noskimwords">vim ~/demo.git/hooks/post-receive</pre> <p>Хук после приема изменений запускается после обновления репо. Мы должны сначала обновить сайт, а затем проверить триггер Composer. Вот скелет нашей программы, не говоря о новой логике:</p> <pre class="brush: php noskimlinks noskimwords">#!/usr/bin/php&lt;?php    $yellow = "^[[33m";    $cyan   = "^[[36m";    $blank  = "^[[0m";    //print OK for first step     echo " -&gt; " . $cyan . "OK" . $blank . "\n";    echo $yellow . "Step2: Deploying" . $blank . "\n";    /*TODO: Deploy to site */    echo " -&gt; " . $cyan . "OK" . $blank . "\n";    /*TODO: Check if commit has trigger */    echo $yellow . "&gt;&gt; All Done &lt;&lt;" . $blank . "\n";?&gt;</pre> <p>Это всего лишь набросок для работы. Первое, что нам нужно добавить, - это функция, чтобы вытащить новую версию репо в каталог сайта. Традиционно, я бы просто напечатал следующее, если бы я был в папке:</p> <pre class="brush: bash noskimlinks noskimwords">git fetch origingit reset --hard origin/master</pre> <p>Вы можете использовать что-то вроде <code>git pull</code>, но это может привести к ошибкам. Если файл был напрямую изменен или если вы пропустили коммит, то <code>git pull</code> не позволит вам вытащить или удалить ваши необработанные файлы.</p> <blockquote><p>Это две простые команды, но вы получите сообщение об ошибке, если попытаетесь запустить их из хука.</p></blockquote> <p>GIT устанавливает некоторые переменные среды до запуска хуков. Вы можете обойти это одним из двух решений, и я покажу вам оба.</p> <p>Первое - переопределить переменные окружения, передавая информацию напрямую. Второй полностью стирает переменные. Я буду использовать первый вариант в этом примере и второй вариант, когда мы будет работать над триггером композера. Замените комментарий, который я добавил выше, где он говорит «TODO Deploy to site» следующим:</p> <pre class="brush: php noskimlinks noskimwords">    $git = "git --git-dir=/var/www/demo/.git/ --work-tree=/var/www/demo/";    exec("$git fetch -q origin");    exec("$git reset --hard origin/master");</pre> <p>Это переопределяет переменные среды и вызывает вышеупомянутые функции. Добавленный параметр <code>-q</code> указывает, что GIT является «тихим», запрещая GIT выводить любые сообщения.</p> <p>Теперь нам нужно проверить триггер Composer. Давайте разделим это на два шага. Сначала мы проверяем триггер, а затем выполняем composer. Замените второй комментарий TODO следующим:</p> <pre class="brush: php noskimlinks noskimwords">    $msg = exec("$git log -n 1 --format=format:%s%b");    if(strpos($msg, "[trigger:composer]") !== false){        echo $yellow . "Step3: Composer Hook" . $blank . "\n";        echo " -&gt; Triggering install - get a " . $cyan . "coffee" . $blank . "\n";        //run composer        echo " -&gt; " . $cyan . "OK" . $blank . "\n";    }</pre> <p>Первая строка извлекает сообщение фиксации с помощью команды <code>git log</code> и передает в специальном формате, чтобы исключить любую дополнительную информацию. Затем мы проверяем, имеет ли строка специальное триггерное слово и выводим третий шаг и OK-сообщение. Мы проверяем ключевое слово Composer, но вы можете реализовать несколько ключевых слов для других функций, таких как: migrate в Laravel или выполнить модульные тесты. Добавьте что-нибудь, чтобы улучшить рабочий процесс.</p> <p>Последний шаг - выполнить composer. composer имеет две команды: <code>composer install</code> и <code>composer update</code>.</p> <blockquote><p>Команда install не читает файл <code>composer.json</code>, если находит <code>composer.lock</code>, и поскольку некоторые люди могут добавить <code>composer.lock</code> в свой файл .gitignore, безопаснее запускать <code>composer update</code> (он всегда смотрит на файл <code>composer.json</code> ,</p></blockquote> <p>Вторая проблема заключается в том, что иногда Composer использует GIT для загрузки пакетов, и эти попытки терпят неудачу из-за переменных среды. Итак, вот хорошее место, чтобы просто удалить переменную окружения «GIT_DIR». Замените комментарий для запуска Composer следующим образом:</p> <pre class="brush: php noskimlinks noskimwords">    chdir("/var/www/demo");    putenv("GIT_DIR");    exec("composer update");</pre> <p>Этот код прямолинейный. Мы перемещаем процесс PHP в папку сайта, а затем удаляем переменную окружения <code>GIT_DIR</code>, чтобы функция GIT функционировала нормально. Последняя строка выполняет Composer.</p> <hr><h2>Связывание свободных концов</h2> <p>У нас теперь есть настройка обоих хуков, но мы не совсем готовы начать использовать наш сервер. Во-первых, нам нужно сделать эти крючки исполняемыми:</p> <pre class="brush: bash noskimlinks noskimwords">chmod a+x ~/demo.git/hooks/pre-receivechmod a+x ~/demo.git/hooks/post-receive</pre> <p>Затем создайте репозиторий GIT в папке сайта. Мы получим ошибку, если попытаемся запустить наши хуки, потому что папка сайта не является репозиторией GIT. Чтобы исправить этот введите:</p> <pre class="brush: bash noskimlinks noskimwords">cd /var/www/demogit initgit remote add origin /home/vagrant/demo.git</pre> <p>Первые две строки создают репо, а затем мы добавляем голый репозиторий в качестве источника этого репо.</p> <p>Вы также должны добавить свой открытый ключ к авторизованным хостам этого сервера, чтобы вы могли получить доступ к серверу через GIT без пароля. Вы можете скопировать свой открытый ключ, набрав на своем компьютере (а не виртуальной машине):</p> <pre class="brush: bash noskimlinks noskimwords">cat ~/.ssh/id_rsa.pub | pbcopy</pre> <p>Затем просто вставьте его на сервер в файл <code>~/.ssh/authorized_keys</code>:</p> <pre class="brush: bash noskimlinks noskimwords">vim ~/.ssh/authorized_keys</pre> <p>Просто добавьте его в файл, но оставьте все, что уже внутри.</p> <p>Затем нам нужно добавить IP-адрес этого сервера в наш файл hosts. Чтобы найти IP-адрес, введите:</p> <pre class="brush: bash noskimlinks noskimwords">ip -4 -o addr show label eth*</pre> <p>Это показывает IP-адрес всех сетевых устройств на этой виртуальной машине. Добавьте тот, который подключается к вашей локальной сети. Если вы не можете определить, какой IP-адрес использовать, скопируйте и вставьте его в свой браузер. Если он подключается, у вас есть правильный IP-адрес.</p> <p>Возьмите IP-адрес и добавьте его в файл хостов вашего компьютера (а не файл хостов VM). Файл hosts на Mac находится по адресу <code>etc/hosts</code>:</p> <pre class="brush: bash noskimlinks noskimwords">sudo vim /etc/hosts</pre> <p>Затем добавьте следующую строку:</p> <pre class="brush: bash noskimlinks noskimwords">#Format: IP_address  site_name192.168.0.110 demo.dev</pre> <p>Если это будет возможно, вы сможете перейти на <code>http://demo.dev</code> в своем браузере. Находясь на вашем Mac, создайте папку и инициализируйте репозиторий GIT:</p> <pre class="brush: bash noskimlinks noskimwords">mkdir ~/democd ~/demogit initecho "Hello World" &gt; index.phpgit add .git commit -am "added index.php"git remote add staging vagrant@demo.dev:demo.gitgit push staging master</pre> <p>Если все пойдет хорошо, вы должны увидеть ответ от наших хуков GIT. Переход к <code>http://demo.dev</code> должен привести к появлению сообщения «Hello World» в вашем браузере.</p> <div class="tutorial_image"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" border="0" class="lazy07" data-src="https://cdn.tutsplus.com/cdn-cgi/image/width=600/net/authors/gabriel-manricks/final_shot.png" alt="Настройка Staging окружения..." title="Настройка Staging окружения..." width="50" height="50"></div> <hr><h2>Вывод</h2> <p>Таким образом, вы можете создать промежуточное окружение, которое имитирует функциональность типичного PAAS. Если у вас возникли проблемы с этим, или вам нужно настроить несколько промежуточных сред, я создал сценарий, который полностью автоматизирует процесс. Для получения дополнительной информации вы можете посетить <span>stagr.gmanricks.com.</span></p> <p>Надеюсь, вам понравилась статья. Не стесняйтесь задавать любые вопросы, которые могут возникнуть в комментариях. Спасибо за чтение.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Web Development" href="https://norma-studio.github.io/article5/220825592-nastrojka-staging-okruzheniya" class="tm-article-body__tags-item-link">Web Development</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
41155</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
452</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
