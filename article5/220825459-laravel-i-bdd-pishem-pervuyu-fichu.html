
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat....">
<meta property="og:description" content="Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat....">
<meta name="twitter:description" content="Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat....">
<meta property="aiturec:description" content="Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat....">
<meta property="og:image" content="//www.gravatar.com/avatar/f63efc863269f29578f97eb94789ed00?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="aiturec:image" content="//www.gravatar.com/avatar/f63efc863269f29578f97eb94789ed00?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta name="twitter:image" content="//www.gravatar.com/avatar/f63efc863269f29578f97eb94789ed00?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="vk:image" content="//www.gravatar.com/avatar/f63efc863269f29578f97eb94789ed00?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="og:type" content="article">
<link image_src="image" href="//www.gravatar.com/avatar/f63efc863269f29578f97eb94789ed00?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html" title="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io" title="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/45343254534.jpg" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html" class="tm-user-info__username" title="
С. Баранов" aria-label="
С. Баранов">
С. Баранов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Laravel и BDD: пишем первую фичу
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Laravel" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu" class="tm-article-snippet__hubs-item-link"><span>Laravel</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu.html" />
    <link itemprop="image" href="//www.gravatar.com/avatar/f63efc863269f29578f97eb94789ed00?s=200&d=https%3A%2F%2Fassets.tutsplus.com%2Fimages%2Fhub%2Favatar_default.png&r=PG">
    <meta itemprop="headline name" content="Laravel и BDD: пишем первую фичу
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Во второй части этой серии под названием Laravel, BDD и Вы мы начнем описывать и строить нашу первую фичу с помощью Behat и PhpSpec. В последней статье мы настроили все необходимое и увидели, как легко мы можем взаимодействовать с Laravel в наших сценариях Behat.</p><p>Недавно создатель Behat Константин Кудряшов (a.k.a. everzet) написал действительно замечательную статью под названием «<span>Представление моделирования по примерам</span>». Рабочий процесс, который мы собираемся использовать, был вдохновлен тем, который был представлен everzet. </p><p>Короче говоря, мы собираемся <code class="inline">.feature</code> для разработки как нашего основного домена, так и нашего пользовательского интерфейса. Я часто чувствовал, что у меня было много дублирования в моих функциях в моих фичах в приемочных/функциональных и интеграционных пакетах. Когда я прочитал предложение Everzet об использовании одной и той же фичи для нескольких контекстов, я наконец понял как нужно делать. </p><p>В нашем случае у нас будет наш функциональный контекст, который на данный момент также будет служить нашим уровнем принятия и нашим контекстом интеграции, который будет охватывать наш домен. Мы начнем с создания домена, а затем добавим пользовательский интерфейс и специфические для платформы вещи.</p><h2>Небольшой рефакторинг</h2><p>Чтобы использовать подход «общая фича, несколько контекстов», нам нужно сделать несколько рефакторингов нашей существующей установки.</p><p>Во-первых, мы собираемся удалить фичу welcome, которую мы сделали в первой части, так как она нам действительно не нужна, и она не соответствует основному стилю, который нам нужен, чтобы использовать несколько контекстов.</p><div><pre class="brush: bash noskimlinks noskimwords">$ git rm features/functional/welcome.feature</pre></div><p>Во-вторых, у нас будут свои фичи в корне папки <code>features</code>, поэтому мы можем продолжить и удалить атрибут <code>path</code> из нашего файла <code>behat.yml</code>. Мы также переименуем <code>LaravelFeatureContext</code> в <code>FunctionalFeatureContext</code> (не забудьте также изменить имя класса):</p><div><pre class="brush: plain noskimlinks noskimwords">default:    suites:        functional:            contexts: [ FunctionalFeatureContext ]</pre></div><p>Наконец, чтобы немного все подчистить, я думаю, что мы должны переместить все связанные с Laravel вещи в отдельный трейт:</p><div><pre class="brush: php noskimlinks noskimwords"># features/bootstrap/LaravelTrait.php&lt;?phpuse Illuminate\Foundation\Testing\ApplicationTrait;trait LaravelTrait{    /**     * Responsible for providing a Laravel app instance.     */    use ApplicationTrait;    /**     * @BeforeScenario     */    public function setUp()    {        if ( ! $this-&gt;app)        {            $this-&gt;refreshApplication();        }    }    /**     * Creates the application.     *     * @return \Symfony\Component\HttpKernel\HttpKernelInterface     */    public function createApplication()    {        $unitTesting = true;        $testEnvironment = "testing";        return require __DIR__."/../../bootstrap/start.php";    }}</pre></div><p>В <code>FunctionalFeatureContext</code> мы можем затем использовать этот трейт и удалить то, что мы только что переместили:</p><div><pre class="brush: php noskimlinks noskimwords">/** * Behat context class. */class FunctionalFeatureContext implements SnippetAcceptingContext{    use LaravelTrait;    /**     * Initializes context.     *     * Every scenario gets its own context object.     * You can also pass arbitrary arguments to the context constructor through behat.yml.     */    public function __construct()    {    }</pre></div><p>Трейты - отличный способ очистить ваши контексты.</p><h2>Совместное использование фичи</h2><p>Как представлено в первой части, мы собираемся создать небольшое приложение для отслеживания времени. Первая фича будет касаться времени отслеживания и создания временного листа из отслеживаемых записей. Вот эта фича:</p><div><pre class="noskimlinks noskimwords">Feature: Tracking time    In order to track time spent on tasks    As an employee    I need to manage a time sheet with time entries    Scenario: Generating time sheet        Given I have the following time entries            | task        | duration |            | coding      | 90       |            | coding      | 30       |            | documenting | 150      |        When I generate the time sheet        Then my total time spent on coding should be 120 minutes        And my total time spent on documenting should be 150 minutes        And my total time spent on meetings should be 0 minutes        And my total time spent should be 270 minutes</pre></div><p>Помните, что это только пример. Мне легче определять фичи в реальной жизни, так как у вас есть реальная проблема, которую вам нужно решить, и часто получаете возможность обсудить эту функцию с коллегами, клиентами или другими заинтересованными сторонами.</p><p>Хорошо, давайте попробуем Behat создать сценарии для нас:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/behat --dry-run --append-snippets</pre></div><p>Нам нужно немного подстроить сгенерированные шаги. Нам нужно всего лишь четыре шага, чтобы охватить сценарий. Конечный результат должен выглядеть примерно так:</p><div><pre class="brush: php noskimlinks noskimwords">/** * @Given I have the following time entries */public function iHaveTheFollowingTimeEntries(TableNode $table){    throw new PendingException();}/** * @When I generate the time sheet */public function iGenerateTheTimeSheet(){    throw new PendingException();}/** * @Then my total time spent on :task should be :expectedDuration minutes */public function myTotalTimeSpentOnTaskShouldBeMinutes($task, $expectedDuration){    throw new PendingException();}/** * @Then my total time spent should be :expectedDuration minutes */public function myTotalTimeSpentShouldBeMinutes($expectedDuration){    throw new PendingException();}</pre></div><p>Наш функциональный контекст готов к работе, но нам также нужен контекст для нашего пакета интеграции. Сначала мы добавим пакет в файл <code>behat.yml</code>:</p><div><pre class="noskimlinks noskimwords">default:    suites:        functional:            contexts: [ FunctionalFeatureContext ]        integration:            contexts: [ IntegrationFeatureContext ]</pre></div><p>Затем мы можем просто скопировать объект <code>FeatureContext</code> по умолчанию:</p><div><pre class="brush: bash noskimlinks noskimwords">$ cp features/bootstrap/FeatureContext.php features/bootstrap/IntegrationFeatureContext.php</pre></div><p>Не забудьте изменить имя класса на <code>IntegrationFeatureContext</code>, а также скопировать оператор use для <code>PendingException</code>.</p><p>Наконец, поскольку мы используем эту функцию, мы можем просто скопировать четыре определения шага из функционального контекста. Если вы запустите Behat, вы увидите, что фича запускается дважды: один раз для каждого контекста.</p><h2>Проектирование домена</h2><p>На этом этапе мы готовы начать заполнять шаги в нашем контексте интеграции, чтобы разработать основной домен нашего приложения. Первый шаг: <code>Given I have the following time entries</code> , за которыми следует таблица с записями времени. Сделаем все просто и перейдем к строкам таблицы, попробуем создать экземпляр времени для каждого из них и добавить их в массив записей в контексте:</p><div><pre class="brush: php noskimlinks noskimwords">use TimeTracker\TimeEntry;.../** * @Given I have the following time entries */public function iHaveTheFollowingTimeEntries(TableNode $table){    $this-&gt;entries = [];    $rows = $table-&gt;getHash();    foreach ($rows as $row) {        $entry = new TimeEntry;        $entry-&gt;task     = $row["task"];        $entry-&gt;duration = $row["duration"];        $this-&gt;entries[] = $entry;    }}</pre></div><p>Запуск Behat приведет к фатальной ошибке, так как класс <code>TimeTracker\TimeEntry</code> еще не существует. Именно здесь PhpSpec выходит на сцену. В конце концов, <code>TimeEntry</code> станет классом Eloquent, хотя мы пока не беспокоимся об этом. PhpSpec и ORM, такие как Eloquent, не так хорошо сочетаются, но мы все еще можем использовать PhpSpec для генерации класса и даже специфицировать некоторые основные действия. Давайте используем генераторы PhpSpec для генерации класса <code>TimeEntry</code>:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/phpspec desc "TimeTracker\TimeEntry"$ vendor/bin/phpspec runDo you want me to create `TimeTracker\TimeEntry` for you? y</pre></div><p>После создания класса нам необходимо обновить раздел автозагрузки нашего файла <code>composer.json</code>:</p><div><pre class="brush: javascript noskimlinks noskimwords">"autoload": {    "classmap": [        "app/commands",        "app/controllers",        "app/models",        "app/database/migrations",        "app/database/seeds"    ],    "psr-4": {        "TimeTracker\": "src/TimeTracker"    }},</pre></div><p>И, конечно, запустите <code>composer dump-autoload</code>.</p><p>Запуск PhpSpec дает нам зеленый цвет. Бегущий Беат дает нам зеленый цвет. Какое прекрасное начало!</p><p>Перейдем к следующему шагу: <code>When I generate the time sheet</code>.</p><p>Ключевое слово здесь «generate», которое выглядит как термин из нашего домена. В мире программистов перевод «генерировать расписание» в код может означать только создание экземпляра класса <code>TimeSheet</code> с кучей записей времени. При проектировании нашего кода важно попытаться придерживаться языка из домена. Таким образом, наш код поможет описать предполагаемое поведение нашего приложения. </p><p>Я определяю термин <code>generate</code> как важный для домена, поэтому я думаю, что у нас должен быть статический метод генерации в классе <code class="inline">TimeSheet</code>, который служит псевдонимом для конструктора. Этот метод должен принимать коллекцию записей времени и хранить их в расписании. </p><p>Вместо того, чтобы просто использовать массив, я думаю, будет иметь смысл использовать класс <code>Illuminate\Support\Collection</code>, который поставляется с Laravel. Поскольку <code>TimeEntry</code> будет моделью Eloquent, когда мы запрашиваем базу данных для записей времени, мы получим одну из этих коллекций Laravel в любом случае. Как насчет чего-то вроде этого:</p><div><pre class="brush: php noskimlinks noskimwords">use Illuminate\Support\Collection;use TimeTracker\TimeSheet;use TimeTracker\TimeEntry;.../** * @When I generate the time sheet */public function iGenerateTheTimeSheet(){    $this-&gt;sheet = TimeSheet::generate(Collection::make($this-&gt;entries));}</pre></div><p>Кстати, TimeSheet не будет классом Eloquent. По крайней мере, на данный момент нам нужно только сохранить записи времени, а затем временные листы будут только <em>генерироваться</em> из записей.</p><p>Запуск Behat снова приведет к фатальной ошибке, потому что <code>TimeSheet</code> не существует. PhpSpec может помочь нам решить эту проблему:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/phpspec desc "TimeTracker\TimeSheet"$ vendor/bin/phpspec runDo you want me to create `TimeTracker\TimeSheet` for you? y$ vendor/bin/phpspec run$ vendor/bin/behatPHP Fatal error:  Call to undefined method TimeTracker\TimeSheet::generate()</pre></div><p>Мы по-прежнему получаем фатальную ошибку после создания класса, потому что статический метод <code>generate()</code> по-прежнему не существует. Поскольку это действительно простой статический метод, я не думаю, что есть необходимость в спецификации. Это не что иное, как оболочка для конструктора:</p><div><pre class="brush: php noskimlinks noskimwords">&lt;?phpnamespace TimeTracker;use Illuminate\Support\Collection;class TimeSheet{    protected $entries;    public function __construct(Collection $entries)    {        $this-&gt;entries = $entries;    }    public static function generate(Collection $entries)    {        return new static($entries);    }}</pre></div><p>Это вернет Behat к зеленому прохождению тестов, но PhpSpec теперь ругается, говоря: <code class="inline">Argument 1 passed to TimeTracker\TimeSheet::__construct() must be an instance of Illuminate\Support\Collection, none given</code>. Мы можем решить это, написав простую функцию <code>let()</code>, которая будет вызываться перед каждой спецификацией:</p><div><pre class="brush: php noskimlinks noskimwords">&lt;?phpnamespace spec\TimeTracker;use PhpSpec\ObjectBehavior;use Prophecy\Argument;use Illuminate\Support\Collection;use TimeTracker\TimeEntry;class TimeSheetSpec extends ObjectBehavior{    function let(Collection $entries)    {        $entries-&gt;put(new TimeEntry);        $this-&gt;beConstructedWith($entries);    }    function it_is_initializable()    {        $this-&gt;shouldHaveType("TimeTracker\TimeSheet");    }}</pre></div><p>Это вернет нас к зеленому цвету. Функция гарантирует, что временной лист всегда строится с моком класса Collection.</p><p>Теперь мы можем безопасно перейти к следующему шагу <code>Then my total time spent on...</code>  Нам нужен метод, который принимает имя задачи и возвращает накопленную продолжительность всех записей с этим именем задачи. Непосредственно переведенный из gherkin в код, это может быть что-то вроде <code>totalTimeSpentOn($task)</code>:</p><div><pre class="brush: php noskimlinks noskimwords">/*** @Then my total time spent on :task should be :expectedDuration minutes*/public function myTotalTimeSpentOnTaskShouldBeMinutes($task, $expectedDuration){    $actualDuration = $this-&gt;sheet-&gt;totalTimeSpentOn($task);    PHPUnit::assertEquals($expectedDuration, $actualDuration);}</pre></div><p>Метод не существует, поэтому вызов Behat даст нам вызов неопределенного метода <code>TimeTracker\TimeSheet::totalTimeSpentOn()</code>.</p><p>Чтобы специфицировать метод, мы напишем спецификацию, которая выглядит как-то похожее на то, что мы уже имеем в нашем сценарии:</p><div><pre class="brush: php noskimlinks noskimwords">function it_should_calculate_total_time_spent_on_task(){    $entry1 = new TimeEntry;    $entry1-&gt;task = "sleeping";    $entry1-&gt;duration = 120;    $entry2 = new TimeEntry;    $entry2-&gt;task = "eating";    $entry2-&gt;duration = 60;    $entry3 = new TimeEntry;    $entry3-&gt;task = "sleeping";    $entry3-&gt;duration = 120;    $collection = Collection::make([$entry1, $entry2, $entry3]);    $this-&gt;beConstructedWith($collection);    $this-&gt;totalTimeSpentOn("sleeping")-&gt;shouldBe(240);    $this-&gt;totalTimeSpentOn("eating")-&gt;shouldBe(60);}</pre></div><p>Обратите внимание, что мы не используем моки для экземпляров <code>TimeEntry</code> и <code>Collection</code>. Это наш пакет интеграции, и я не думаю, что есть необходимость мотать его. Объекты довольно просты, и мы хотим убедиться, что объекты в нашем домене взаимодействуют, как мы ожидаем. На счет этого существует много мнений, но для меня это имеет смысл.</p><p>Двигаемся вперед:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/phpspec runDo you want me to create `TimeTracker\TimeSheet::totalTimeSpentOn()` for you? y$ vendor/bin/phpspec run  25  ✘ it should calculate total time spent on task      expected [integer:240], but got null.</pre></div><p>Чтобы отфильтровать записи, мы можем использовать метод <code>filter()</code> в классе <code>Collection</code>. Простое решение, которое дает нам зеленый цвет:</p><div><pre class="brush: php noskimlinks noskimwords">public function totalTimeSpentOn($task){    $entries = $this-&gt;entries-&gt;filter(function($entry) use ($task)    {        return $entry-&gt;task === $task;    });    $duration = 0;    foreach ($entries as $entry) {        $duration += $entry-&gt;duration;    }    return $duration;}</pre></div><p>Наша спецификация зеленая, но я чувствую, что здесь мы могли бы сделать рефакторинг. Метод, кажется, выполняет две разные вещи: фильтрует записи и накапливает продолжительность. Перенесем последнее в собственный метод:</p><div><pre class="brush: php noskimlinks noskimwords">public function totalTimeSpentOn($task){    $entries = $this-&gt;entries-&gt;filter(function($entry) use ($task)    {        return $entry-&gt;task === $task;    });    return $this-&gt;sumDuration($entries);}protected function sumDuration($entries){    $duration = 0;    foreach ($entries as $entry) {        $duration += $entry-&gt;duration;    }    return $duration;}</pre></div><p>PhpSpec по-прежнему зеленый, и теперь у нас есть три зеленых шага в Бехате. Последний шаг должен быть легко реализован, так как он несколько похож на тот, который мы только что сделали.</p><div><pre class="brush: php noskimlinks noskimwords">/** * @Then my total time spent should be :expectedDuration minutes */public function myTotalTimeSpentShouldBeMinutes($expectedDuration){    $actualDuration = $this-&gt;sheet-&gt;totalTimeSpent();    PHPUnit::assertEquals($expectedDuration, $actualDuration);}</pre></div><p>Запуск Behat даст нам <code>Call to undefined method TimeTracker\TimeSheet::totalTimeSpent()</code>. Вместо того, чтобы делать отдельный пример в нашей спецификации для этого метода, как насчет того, чтобы просто добавить его к тому, который у нас уже есть? Это может быть не совсем в соответствии с тем, как делать «правильно», но давайте быть немного прагматичными:</p><div><pre class="brush: php noskimlinks noskimwords">...$this-&gt;beConstructedWith($collection);$this-&gt;totalTimeSpentOn("sleeping")-&gt;shouldBe(240);$this-&gt;totalTimeSpentOn("eating")-&gt;shouldBe(60);$this-&gt;totalTimeSpent()-&gt;shouldBe(300);</pre></div><p>Пусть PhpSpec генерирует метод:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/phpspec runDo you want me to create `TimeTracker\TimeSheet::totalTimeSpent()` for you? y$ vendor/bin/phpspec run  25  ✘ it should calculate total time spent on task      expected [integer:300], but got null.</pre></div><p>Получить зеленые тесты теперь легко, когда у нас есть метод <code>sumDuration()</code>:</p><div><pre class="brush: php noskimlinks noskimwords">public function totalTimeSpent(){    return $this-&gt;sumDuration($this-&gt;entries);}</pre></div><p>И теперь у нас есть зеленая фича. Наш домен постепенно развивается!</p><h2>Проектирование пользовательского интерфейса</h2><p>Теперь мы переходим к нашему функциональному набору. Мы собираемся разрабатывать пользовательский интерфейс и обрабатывать все специфические для Laravel вещи, которые не являются предметом нашего домена.</p><p>Во время работы в набором тестов мы можем добавить флаг <code>-s</code>, чтобы инструктировать Behat запускать наши фичи только через <code>FunctionalFeatureContext</code>:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/behat -s functional</pre></div><p>Первый шаг будет похож на первый из контекста интеграции. Вместо того, чтобы просто вносить записи в контекст в массиве, нам нужно положить их в базу данных, чтобы их можно было найти позже:</p><div><pre class="brush: php noskimlinks noskimwords">use TimeTracker\TimeEntry;.../** * @Given I have the following time entries */public function iHaveTheFollowingTimeEntries(TableNode $table){    $rows = $table-&gt;getHash();    foreach ($rows as $row) {        $entry = new TimeEntry;        $entry-&gt;task     = $row["task"];        $entry-&gt;duration = $row["duration"];        $entry-&gt;save();    }}</pre></div><p>Запуск Behat даст нам фатальную ошибку <code>Call to undefined method TimeTracker\TimeEntry::save()</code>, поскольку <code>TimeEntry</code> по-прежнему не является моделью Eloquent. Это легко исправить:</p><div><pre class="brush: php noskimlinks noskimwords">namespace TimeTracker;class TimeEntry extends \Eloquent{}</pre></div><p>Если мы снова запустим Behat, Laravel пожалуется, что он не сможет подключиться к базе данных. Мы можем исправить это, добавив файл <code>database.php</code> в каталог <code>app/config/testing</code>, чтобы добавить сведения о соединении для нашей базы данных. Для более крупных проектов вы, вероятно, захотите использовать один и тот же сервер базы данных для своих тестов и производственного кода, но в нашем случае мы просто используем базу данных в памяти SQLite. Это очень просто настроить с помощью Laravel:</p><div><pre class="brush: php noskimlinks noskimwords">&lt;?phpreturn array(    "default" =&gt; "sqlite",    "connections" =&gt; array(        "sqlite" =&gt; array(            "driver"   =&gt; "sqlite",            "database" =&gt; ":memory:",            "prefix"   =&gt; "",        ),    ),);</pre></div><p>Теперь, если мы запустим Behat, который скажет нам, что нет таблицы <code>time_entries</code>. Чтобы исправить это, нам нужно выполнить миграцию:</p><div><pre class="brush: bash noskimlinks noskimwords">$ php artisan migrate:make createTimeEntriesTable --create="time_entries"</pre></div><div><pre class="brush: php noskimlinks noskimwords">Schema::create("time_entries", function(Blueprint $table){    $table-&gt;increments("id");    $table-&gt;string("task");    $table-&gt;integer("duration");    $table-&gt;timestamps();});</pre></div><p>Мы все еще не зеленые, так как нам нужен способ научить Behat выполнять наши миграции перед каждым сценарием, поэтому каждый раз мы получаем чистый список. Используя аннотации Behat, мы можем добавить эти два метода к трейту <code>LaravelTrait</code>:</p><div><pre class="brush: php noskimlinks noskimwords">/** * @BeforeScenario */public function setupDatabase(){    $this-&gt;app["artisan"]-&gt;call("migrate");}/** * @AfterScenario */public function cleanDatabase(){    $this-&gt;app["artisan"]-&gt;call("migrate:reset");}</pre></div><p>Это довольно аккуратно, и наш первый шаг к зеленому.</p><p>Следующий шаг - <code>When I generate the time sheet</code>. Я его вижу следующим образом: создание листа времени - это эквивалент посещения действия <code>index</code> ресурса записи времени, поскольку временной лист - это сбор всех временных записей. Таким образом, объект временного листа похож на контейнер для всех записей времени и дает нам хороший способ обработки записей. Вместо того, чтобы переходить в <code class="inline">/time-entries</code>, чтобы увидеть временной лист, я думаю, что работник должен перейти на <code>/time-sheet</code>. Мы должны добавить это в наше определение шага:</p><div><pre class="brush: php noskimlinks noskimwords">/** * @When I generate the time sheet */public function iGenerateTheTimeSheet(){    $this-&gt;call("GET", "/time-sheet");    $this-&gt;crawler = new Crawler($this-&gt;client-&gt;getResponse()-&gt;getContent(), url("/"));}</pre></div><p>Это вызовет исключение <code>NotFoundHttpException</code>, поскольку маршрут еще не определен. Как я только что объяснил, я думаю, что этот URL-адрес должен сопоставляться с действием <code>index</code> на ресурсе записи времени:</p><div><pre class="brush: php noskimlinks noskimwords">Route::get("time-sheet", ["as" =&gt; "time_sheet", "uses" =&gt; "TimeEntriesController@index"]);</pre></div><p>Чтобы получить зеленый цвет, нам нужно сгенерировать контроллер:</p><div><pre class="brush: bash noskimlinks noskimwords">$ php artisan controller:make TimeEntriesController$ composer dump-autoload</pre></div><p>Готово.</p><p>Наконец, нам нужно просканировать страницу, чтобы найти общую продолжительность записей времени. Я считаю, что у нас будет какая-то таблица, в которой суммируются длительности. Последние два шага настолько похожи, что мы собираемся их реализовать одновременно:</p><div><pre class="brush: php noskimlinks noskimwords">/** * @Then my total time spent on :task should be :expectedDuration minutes */public function myTotalTimeSpentOnTaskShouldBeMinutes($task, $expectedDuration){    $actualDuration = $this-&gt;crawler-&gt;filter("td#" . $task . "TotalDuration")-&gt;text();    PHPUnit::assertEquals($expectedDuration, $actualDuration);}/** * @Then my total time spent should be :expectedDuration minutes */public function myTotalTimeSpentShouldBeMinutes($expectedDuration){    $actualDuration = $this-&gt;crawler-&gt;filter("td#totalDuration")-&gt;text();    PHPUnit::assertEquals($expectedDuration, $actualDuration);}</pre></div><p>Мы ищем тег <code>&lt;td&gt;</code> с идентификатором <code>[task_name]TotalDuration</code> или <code>totalDuration</code> в последнем примере.</p><p>Поскольку у нас пока нет представления, сканер сообщает нам, что <code>The current node list is empty</code>.</p><p>Чтобы исправить это, построим действие <code>index</code>. Во-первых, мы получаем коллекцию записей времени. Во-вторых, мы создаем временной лист из записей и отправляем его в (все еще несуществующее) отображение.</p><div><pre class="brush: php noskimlinks noskimwords">use TimeTracker\TimeSheet;use TimeTracker\TimeEntry;class TimeEntriesController extends \BaseController {    /**     * Display a listing of the resource.     *     * @return Response     */    public function index()    {        $entries = TimeEntry::all();        $sheet = TimeSheet::generate($entries);        return View::make("time_entries.index", compact("sheet"));    }...</pre></div><p>В настоящее время представление будет состоять из простой таблицы с суммарными значениями продолжительности:</p><div><pre class="brush: php noskimlinks noskimwords">&lt;h2&gt;Time Sheet&lt;/h2&gt;&lt;table&gt;    &lt;thead&gt;        &lt;th&gt;Task&lt;/th&gt;        &lt;th&gt;Total duration&lt;/th&gt;    &lt;/thead&gt;    &lt;tbody&gt;        &lt;tr&gt;            &lt;td&gt;coding&lt;/td&gt;            &lt;td id="codingTotalDuration"&gt;{{ $sheet-&gt;totalTimeSpentOn("coding") }}&lt;/td&gt;        &lt;/tr&gt;        &lt;tr&gt;            &lt;td&gt;documenting&lt;/td&gt;            &lt;td id="documentingTotalDuration"&gt;{{ $sheet-&gt;totalTimeSpentOn("documenting") }}&lt;/td&gt;        &lt;/tr&gt;        &lt;tr&gt;            &lt;td&gt;meetings&lt;/td&gt;            &lt;td id="meetingsTotalDuration"&gt;{{ $sheet-&gt;totalTimeSpentOn("meetings") }}&lt;/td&gt;        &lt;/tr&gt;        &lt;tr&gt;            &lt;td&gt;&lt;strong&gt;Total&lt;/strong&gt;&lt;/td&gt;            &lt;td id="totalDuration"&gt;{{ $sheet-&gt;totalTimeSpent() }}&lt;/td&gt;        &lt;/tr&gt;    &lt;/tbody&gt;&lt;/table&gt;</pre></div><p>Если вы снова запустите Behat, вы увидите, что мы успешно реализовали эту функцию. Может быть, нам стоит подумать, что даже однажды мы не открыли браузер! Это значительное улучшение нашего рабочего процесса, и в качестве прекрасного бонуса теперь у нас есть автоматические тесты для нашего приложения. Ура!</p><h2> Вывод</h2><p>Если вы запустите vendor / bin / behat, чтобы запустить оба набора Behat, вы увидите, что оба они теперь зеленые. Если вы запустите PhpSpec, то, к сожалению, вы увидите, что наши спецификации сломаны. Мы получаем фатальную ошибку. Класс «Красноречивый» не найден в .... Это потому, что Eloquent является псевдонимом. Если вы посмотрите в <code>app/config/app.php</code> под псевдонимами, вы увидите, что <code>Eloquent</code> на самом деле является псевдонимом для <code>Illuminate\Database\Eloquent\Model</code>. Чтобы вернуть PhpSpec в зеленый цвет, нам нужно импортировать этот класс:</p><div><pre class="brush: php noskimlinks noskimwords">namespace TimeTracker;use Illuminate\Database\Eloquent\Model as Eloquent;class TimeEntry extends Eloquent{}</pre></div><p>Если вы запустите эти две команды:</p><div><pre class="brush: bash noskimlinks noskimwords">$ vendor/bin/phpspec run; vendor/bin/behat</pre></div><p>Вы увидите, что мы вернулись к зеленому, как с Behat, так и с PhpSpec. Ура! </p><p>Мы описали и разработали нашу первую функцию, полностью используя подход BDD. Мы видели, как мы можем извлечь выгоду из разработки основного домена нашего приложения, прежде чем мы будем беспокоиться о пользовательском интерфейсе и конкретном материале. Мы также видели, как легко взаимодействовать с Laravel и особенно с базой данных в наших контекстах Behat. </p><p>В следующей статье мы собираемся немного порефакторить, чтобы избежать слишком большой логики для наших моделей Eloquent, поскольку их сложнее тестировать изолированно и они тесно связаны с Laravel. Будьте на связи!</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Laravel" href="https://norma-studio.github.io/article5/220825459-laravel-i-bdd-pishem-pervuyu-fichu" class="tm-article-body__tags-item-link">Laravel</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
38387</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
365</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
