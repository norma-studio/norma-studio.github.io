
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем ви...">
<meta property="og:description" content="В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем ви...">
<meta name="twitter:description" content="В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем ви...">
<meta property="aiturec:description" content="В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем ви...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html" title="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io" title="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/64533gfdsgf.jpg" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html" class="tm-user-info__username" title="
А. Лукичев" aria-label="
А. Лукичев">
А. Лукичев</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Полнотекстовый поиск в Rails с использованием Elasticsearch...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch" class="tm-article-snippet__hubs-item-link"><span>Ruby on Rails</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg">
    <meta itemprop="headline name" content="Полнотекстовый поиск в Rails с использованием Elasticsearch... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем ви...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем ви...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>В этой статье я расскажу вам, как реализовать полнотекстовый поиск с использованием Ruby on Rails и Elasticsearch. В настоящее когда вы вводите поисковую фразу, то вы сразу же получаете как результаты поиска, так и предложения по поиску. Если вы опечатались при поиске, то автоматическая корректировка также является хорошей функцией, как мы можем видеть на таких сайтах, как Google или Facebook. </p><p>Для реализации всех этих функций использование только реляционной базы данных, такой как MySQL или Postgres, не достаточно. По этой причине мы используем Elasticsearch, который вы можете рассматривать как базу данных, специально созданную и оптимизированную для поиска. Это решение с открытым исходным кодом, и оно построено поверх Apache Lucene. </p><p>Одна из самых приятных особенностей Elasticsearch заключается в том, что она предоставляет свои функции с использованием REST API, поэтому есть библиотеки, которые обрачивают эту функциональность для большинства языков программирования.</p><h2>Представляем Elasticsearch</h2><p>Ранее я упомянул, что Elasticsearch похож на базу данных для поиска. Было бы полезно, если бы вы были знакомы с некоторой терминологией вокруг него.</p><ul><li> <strong>Field</strong>: Поле похоже на пару «ключ-значение». Значение может быть простым значением (string, integer, date) или вложенной структурой, например массивом или объектом. Поле похоже на столбец таблицы в реляционной базе данных.</li> <li> <strong>Document</strong>: документ представляет собой список полей. Это документ JSON, который хранится в Elasticsearch. Это похоже на строку в таблице в реляционной базе данных. Каждый документ хранится в индексе и имеет тип и уникальный идентификатор. </li> <li> <strong>Type</strong>: Тип подобен таблице в реляционной базе данных. Каждый тип имеет список полей, которые могут быть указаны для документов этого типа.</li> <li> <strong>Index</strong>: индекс является эквивалентом реляционной базы данных. Он содержит определение для нескольких типов и хранит несколько документов.</li> </ul><p>Здесь следует отметить, что в Elasticsearch, когда вы пишете документ в индекс, поля документа анализируются по слову, чтобы сделать поиск простым и быстрым. Elasticsearch также поддерживает геолокацию, поэтому вы можете искать документы, расположенные на определенном расстоянии от определенного места. Именно так <span>Foursquare</span> реализует поиск.</p><p>Я хотел бы упомянуть, что Elasticsearch был построен с высокой масштабируемостью, поэтому очень легко создать кластер с несколькими серверами и иметь высокую доступность, даже если некоторые серверы отключаются. Я не собираюсь описывать особенности планирования и развертывания различных типов кластеров в этой статье.</p><h2>Установка Elasticsearch</h2><p>Если вы используете Linux, возможно, вы можете установить <span>Elasticsearch из одного из репозиториев</span>. Он доступен в APT и YUM.</p><p>Если вы используете Mac, вы можете установить его с помощью Homebrew: <code class="inline">brew install elasticsearch</code>. После установки elasticsearch вы увидите список соответствующих папок в вашем терминале:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elsticsearch-installed.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><p>Чтобы убедиться, что установка работает, введите текст <code class="inline">elasticsearch</code> в своем терминале, чтобы запустить его. Затем выполните <code class="inline">curl localhost: 9200</code> в вашем терминале, и вы увидите что-то вроде:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/Screenshot%202016-03-14%2015.17.48.png" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><h3>Установка Elastic HQ</h3><p><span>Elastic HQ</span> - это плагин мониторинга, который мы можем использовать для управления Elasticsearch в браузере, подобно phpMyAdmin для MySQL. Чтобы установить его, просто запустите в своем терминале:</p><p><code class="inline">/usr/local/Cellar/elasticsearch/2.2.0_1/libexec/bin/plugin -install royrusso / elasticsearch-HQ</code><br></p><p>После его установки перейдите в <span>http://localhost:9200/_plugin/hq</span> в своем браузере:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elastic-hq.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><p>Нажмите <strong>Connect</strong>, и вы увидите экран, показывающий состояние кластера:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/elastic-hq-cluster.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><p>На данный момент, как и следовало ожидать, пока не созданы индексы или документы, но у нас есть наш локальный экземпляр Elasticsearch, установленный и запущенный.</p><h2>Создание приложения Rails</h2><p>Я собираюсь создать очень простое приложение Rails, где вы можете добавлять статьи в базу данных, чтобы мы могли выполнять полнотекстовый поиск по ним с помощью Elasticsearch. Начните с создания нового приложения Rails:</p><p><code class="inline">rails new elasticsearch-rails</code></p><p>Затем мы создаем новый ресурс статьи:</p><p><code class="inline">rails generate scaffold Article title:string text:text</code><br></p><p>Теперь нам нужно добавить новый корневой маршрут, поэтому мы можем по умолчанию просмотреть список статей. Изменим <strong>config/routes.rb</strong>:</p><pre class="brush: ruby noskimlinks noskimwords">Rails.application.routes.draw do  root to: "articles#index"  resources :articlesend</pre><p>Создайте базу данных, выполнив команду <code class="inline">rake db: migrate</code>. Если вы запустите <code class="inline">rails server</code>, откройте свой браузер, перейдите на <span>localhost:3000</span> и добавьте несколько статей в базу данных или просто загрузите файл <span>db/seeds.rb</span> с фиктивными данными, которые я создал, поэтому вам не нужно тратить много времени на заполнение форм.</p><h2>Добавление поиска</h2><p>Теперь, когда у нас есть небольшое приложение Rails со статьями в базе данных, мы готовы добавить наши функции поиска. Мы собираемся начать с добавления ссылки на официальные Elasticsearch Gems:</p><pre class="brush: ruby noskimlinks noskimwords">gem "elasticsearch-model"gem "elasticsearch-rails"</pre><p>На многих веб-сайтах очень часто есть текстовое поле для поиска в верхнем меню на всех страницах. По этой причине я собираюсь создать форму в <strong>app/views/search/_form.html.erb</strong>. Как вы можете видеть, я отправляю форму с помощью GET, поэтому легко скопировать и вставить URL для определенного поиска.</p><pre class="brush: html noskimlinks noskimwords">&lt;%= form_for :term, url: search_path, method: :get do |form| %&gt;  &lt;p&gt;    &lt;%= text_field_tag :term, params[:term] %&gt;    &lt;%= submit_tag "Search", name: nil %&gt;  &lt;/p&gt;&lt;% end %&gt;</pre><p>Добавьте ссылку на форму на основной макет сайта. Изменим <strong>app/views/layouts/application.html.erb</strong>.</p><pre class="brush: html noskimlinks noskimwords">&lt;body&gt;  &lt;%= render "search/form" %&gt;  &lt;%= yield %&gt;&lt;/body&gt;</pre><p>Теперь нам также нужен контроллер для выполнения фактического поиска и отображения результатов, поэтому мы создаем его, запуская команду <code class="inline">rails g new controller Search</code>.</p><pre class="brush: ruby noskimlinks noskimwords">class SearchController &lt; ApplicationController  def search    if params[:term].nil?    @articles = []else  @articles = Article.search params[:term]end  endend</pre><p>Как вы можете видеть, я вызываю метод <code class="inline">search</code> в модели Article. Мы еще не определили его, поэтому, если мы попытаемся выполнить поиск в этот момент, мы получим ошибку. Кроме того, мы не добавили маршрут для SearchController в файле <strong>config/routes.rb</strong>, поэтому давайте сделаем это:</p><pre class="brush: ruby noskimlinks noskimwords">Rails.application.routes.draw do  root to: "articles#index"  resources :articles  get "search", to: "search#search"end</pre><p>Если мы посмотрим на документацию для gem <strong><span>elasticsearch-rails</span></strong>, нам нужно включить два модуля в модели, которые мы хотим проиндексировать в Elasticsearch, в нашем случае <strong>Article.rb</strong>.</p><pre class="brush: ruby noskimlinks noskimwords">require "elasticsearch/model"class Article &lt; ActiveRecord::Base  include Elasticsearch::Model  include Elasticsearch::Model::Callbacksend</pre><p>Первая модель вводит метод поиска, который мы использовали в нашем предыдущем контроллере среди других. Второй модуль интегрируется с обратными вызовами ActiveRecord для индексации каждого экземпляра статьи, которую мы сохраняем в базе данных, а также обновляет индекс, если мы модифицируем или удаляем статью из базы данных. Так что это все прозрачно для нас.</p><p>Если вы ранее импортировали данные в базу данных, эти статьи по-прежнему не входят в индекс Elasticsearch; только новые индексируются автоматически. По этой причине мы должны индексировать их вручную, и это легко сделать запустив <code class="inline">rails console</code>. Затем нам нужно только запустить <code class="inline">irb (main)&gt; Article.import</code>.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/article.import.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><p>Теперь мы готовы попробовать функцию поиска. Если я наберу «ruby» и нажму Поиск, то получу такие результаты:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/search-result.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><h3>Подсветка поиска</h3><p>На многих веб-сайтах вы можете увидеть на странице результатов поиска, как подсвечивается термин, который вы искали. Это очень легко сделать, используя Elasticsearch.</p><p>Измените <strong>app/models/article.rb</strong> и измените метод поиска по умолчанию:</p><pre class="brush: ruby noskimlinks noskimwords">def self.search(query)  __elasticsearch__.search(    {      query: {        multi_match: {          query: query,          fields: ["title", "text"]        }      },      highlight: {        pre_tags: ["&lt;em&gt;"],        post_tags: ["&lt;/em&gt;"],        fields: {          title: {},          text: {}        }      }    }  )end</pre><p>По умолчанию метод <code class="inline">search</code> определяется моделями «elasticsearch-models», а прокси-объект __elasticsearch__ предоставляется для доступа к классу-оболочке для API Elasticsearch. Таким образом, мы можем изменить запрос по умолчанию, используя стандартные параметры JSON, как указано в <span>документации</span>. </p><p>Теперь метод поиска будет обертывать результаты, соответствующие запросу с указанными тегами HTML. По этой причине нам также необходимо обновить страницу результатов поиска, чтобы мы могли безопасно отображать HTML-теги. Для этого отредактируйте <strong>app/views/search/search.html.erb</strong>.</p><pre class="brush: ruby noskimlinks noskimwords">&lt;h1&gt;Search Results&lt;/h1&gt;&lt;% if @articles %&gt;  &lt;ul class="search_results"&gt;    &lt;% @articles.each do |article| %&gt;      &lt;li&gt;    &lt;h3&gt;      &lt;%= link_to article.try(:highlight).try(:title) ?      article.highlight.title[0].html_safe : article.title,              controller: "articles", action: "show", id: article._id %&gt;    &lt;/h3&gt;    &lt;% if article.try(:highlight).try(:text) %&gt;          &lt;% article.highlight.text.each do |snippet| %&gt;          &lt;p&gt;&lt;%= snippet.html_safe %&gt;...&lt;/p&gt;        &lt;% end %&gt;      &lt;% end %&gt;    &lt;/li&gt;  &lt;% end %&gt;&lt;/ul&gt;&lt;% else %&gt;  &lt;p&gt;Your search did not match any documents.&lt;/p&gt;&lt;% end %&gt;</pre><p>Добавьте стиль CSS в <strong>app/assets/stylesheets/search.scss</strong> для нужного тега:</p><pre class="brush: css noskimlinks noskimwords">.search_results em {  background-color: yellow;  font-style: normal;  font-weight: bold;}</pre><p>Попробуйте снова поискать «ruby»:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/search-result-highlight.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><p>Как вы можете видеть, легко выделить термин поиска, но не идеально, поскольку нам нужно отправить запрос JSON, как указано в документации Elasticsearch, и у нас нет какой-либо абстракции.<br></p><h3>Searchkick Gem</h3><p><span>Searchkick gem </span> предоставляется <span>Instacart</span>, и это абстракция поверх официальных gem-ов Elasticsearch. Я собираюсь реорганизовать выделенную функциональность, поэтому мы начинаем с добавления <code class="inline">gem "searchkick"</code> в gemfile. Первым классом, который нам нужно изменить, является модель Article.rb:</p><pre class="brush: ruby noskimlinks noskimwords">class Article &lt; ActiveRecord::Base  searchkickend</pre><p>Как вы можете видеть, это намного проще. Нам нужно снова переопределить статьи и выполнить команду <code class="inline">rake searchkick: reindex CLASS = Article</code>. Чтобы выделить поисковый запрос, нам нужно передать дополнительный параметр методу поиска из нашего <strong>search_controller.rb</strong>.</p><pre class="brush: plain noskimlinks noskimwords">class SearchController &lt; ApplicationController  def search    if params[:term].nil?  @articles = []else  term = params[:term]  @articles = Article.search term, fields: [:text], highlight:  trueend  endend</pre><p>Последним файлом, который нам нужно изменить, является <strong>view/search/search.html.erb</strong>, поскольку результаты возвращаются в другом формате с помощью поиска:</p><pre class="brush: ruby noskimlinks noskimwords">&lt;h2&gt;Search Results for: &lt;i&gt;&lt;%= params[:term] %&gt;&lt;/i&gt;&lt;/h2&gt;&lt;% if @articles %&gt;&lt;ul class="search_results"&gt;  &lt;% @articles.with_details.each do |article, details| %&gt;    &lt;li&gt;  &lt;h3&gt;    &lt;%= link_to article.title, controller: "articles", action: "show", id: article.id %&gt;  &lt;/h3&gt;      &lt;p&gt;&lt;%= details[:highlight][:text].html_safe %&gt;...&lt;/p&gt;&lt;/li&gt;  &lt;% end %&gt;&lt;/ul&gt;&lt;% else %&gt;  &lt;p&gt;Your search did not match any documents.&lt;/p&gt;&lt;% end %&gt;</pre><p>Теперь пришло время снова запустить приложение и протестировать функцию поиска:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/searchkick-highlight.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><p>Обратите внимание, что я ввел поисковый запрос «dato». Я сделал это специально, чтобы показать вам, что по умолчанию searchkick настроен для анализа проиндексированного текста.</p><h3>Автоматические подсказки</h3><p>Autosuggest или typeahead предсказывает, что пользователь вводит, делая поиск быстрее и проще. Имейте в виду, что, если у вас нет тысяч записей, лучше всего фильтровать на стороне клиента.</p><p>Начнем с добавления плагина <span>typeahead</span>, который доступен через <code class="inline">gem "bootstrap-typeahead-rails"</code> и добавьте его в свой Gemfile. Затем нам нужно добавить JavaScript в <strong>app/assets/javascripts/application.js</strong>, чтобы при вводе текста в поле поиска появилось несколько предложений.</p><pre class="brush: javascript noskimlinks noskimwords">//= require jquery//= require jquery_ujs//= require turbolinks//= require bootstrap-typeahead-rails//= require_tree .var ready = function() {  var engine = new Bloodhound({      datumTokenizer: function(d) {          console.log(d);          return Bloodhound.tokenizers.whitespace(d.title);      },      queryTokenizer: Bloodhound.tokenizers.whitespace,      remote: {          url: "../search/typeahead/%QUERY"      }  });  var promise = engine.initialize();  promise      .done(function() { console.log("success"); })      .fail(function() { console.log("error") });  $("#term").typeahead(null, {    name: "article",    displayKey: "title",    source: engine.ttAdapter()  })};$(document).ready(ready);$(document).on("page:load", ready);</pre><p>Несколько комментариев о предыдущем фрагменте. В последних двух строках, поскольку я не отключил turbolinks, это способ подключить код, который я хочу запустить при загрузке страницы. В первой части скрипта вы можете видеть, что я использую <span>Bloodhound</span>. Это движок typeahead.js, и я также настраиваю конечную точку JSON, чтобы сделать запросы AJAX, чтобы получить предложения. После этого я вызываю <code class="inline">initialize()</code> в движке, и я настраиваю typeahead в текстовом поле поиска, используя свой идентификатор «term».</p><p>Теперь нам нужно выполнить бэкэнд-реализацию для предложений, давайте начнем с добавления маршрута, отредактируйте <strong>app/config/routes.rb</strong>.</p><pre class="brush: ruby noskimlinks noskimwords">Rails.application.routes.draw do  root to: "articles#index"  resources :articles  get "search", to: "search#search"  get "search/typeahead/:term" =&gt; "search#typeahead"end</pre><p>Затем я добавлю реализацию на <strong>app/controller/search_controller.rb</strong>.</p><pre class="brush: plain noskimlinks noskimwords">def typeahead  render json: Article.search(params[:term], {    fields: ["title"],    limit: 10,    load: false,    misspellings: {below: 5},  }).map do |article| { title: article.title, value: article.id } endend</pre><p>Этот метод возвращает результаты поиска для введенного термина с использованием JSON. Я только ищу по названию, но я мог бы указать тело статьи тоже. Я также ограничиваю количество результатов поиска до 10 максимум.</p><p>Теперь мы готовы попробовать реализацию typeahead:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/581/posts/22920/image/typeahead.jpg" alt="Полнотекстовый поиск в Rails с использованием Elasticsearch..." title="Полнотекстовый поиск в Rails с использованием Elasticsearch..." width="50" height="50"></figure><h2>Заключение</h2><p>Как вы можете видеть, использование Elasticsearch с Rails делает поиск наших данных очень простым и быстрым. Здесь я показал вам, как использовать gem-ы низкого уровня, предоставляемые Elasticsearch, а также gem Searchkick, который представляет собой абстракцию, которая скрывает некоторые детали того, как работает Elasticsearch. </p><p>В зависимости от ваших конкретных потребностей вы можете использовать Searchkick и быстро и легко выполнять полнотекстовый поиск. С другой стороны, если у вас есть другие сложные запросы, в том числе фильтры или группы, вам может потребоваться больше узнать о деталях языка запросов в Elasticsearch и в конечном итоге использовать gem-ы более низкого уровня, такие как  "elasticsearch-models" и "elasticsearch-rails".<br></p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby on Rails" href="https://norma-studio.github.io/article5/220825155-polnotekstovyj-poisk-v-rails-s-ispolzovaniem-elasticsearch" class="tm-article-body__tags-item-link">Ruby on Rails</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
43062</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
594</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
