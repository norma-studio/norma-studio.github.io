
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что э...">
<meta property="og:description" content="Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что э...">
<meta name="twitter:description" content="Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что э...">
<meta property="aiturec:description" content="Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что э...">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html" title="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io" title="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/543234456.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html" class="tm-user-info__username" title="
А. Гаврилов" aria-label="
А. Гаврилов">
А. Гаврилов</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Антипаттерны: модели Rails...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails" class="tm-article-snippet__hubs-item-link"><span>Ruby</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png">
    <meta itemprop="headline name" content="Антипаттерны: модели Rails... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что э...">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что э...</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p>Анти-что? Вероятно, это звучит намного сложнее, чем есть. За последние пару десятилетий программисты смогли определить полезный выбор шаблонов «дизайна», которые часто встречались во всех их кодовых решениях. Решая подобные проблемы, они смогли «классифицировать» решения, которые избавляли их от постоянного изобретения колеса. Важно отметить, что эти шаблоны следует рассматривать скорее как открытия, чем изобретения группы продвинутых разработчиков.</p><p>Если это для вас совсем не так, и вы видите себя в большей степени на стороне новичка Ruby/Rails, то это точно написано для вас. Я думаю, что лучше всего, если вы посмотрите на это как на очень глубокую тему, постижение которой не произойдет за одну ночь. Тем не менее, я твердо верю, что погружение в нее принесет новичкам огромную пользу.</p> <p>Антипаттерн, как следует из названия, представляет собой почти противоположную структуру. Они являются открытием решений проблем, которые вам следует избегать. Они часто представляют работу неопытных кодеров, которые не знают, чего они еще не знают. Хуже того, они могут быть результатом ленивого человека, который просто игнорирует передовую практику и инструментальные средства без уважительной причины - или они считают, что они им не нужны. То, что они сэкономили время в начале, выбирая быстрые, ленивые или грязные решения, будет преследовать их или какого-нибудь преемника позже в жизненном цикле проекта.</p> <p>Не стоит недооценивать последствия этих плохих решений - они будут вас мучить, несмотря ни на что.</p> <h2>Темы</h2> <ul><li>Жирные модели</li> <li>Отсутствует комплект для тестирования</li> <li>Подглядывающие модели</li> <li>Закон Деметры</li> <li>Спагетти SQL</li> </ul><h2>Жирные модели</h2> <p>Я уверен, что вы слышали о «Толстые модели, тонкие контроллеры», когда вы впервые начали с Rails. Хорошо, теперь забудьте об этом! Разумеется, бизнес-логику нужно хранить в модельном слое, но вы не должны чувствовать себя склонным к тому, чтобы все это происходило бессмысленно, чтобы избежать пересечения линий на территории контроллера.</p> <p>Вот новая цель, к которой вы должны стремиться: «Тощие модели, тощие контроллеры». Вы могли бы спросить: «Ну и как мы должны организовать код для достижения этого? Ведь это игра с нулевой суммой?» Хорошо! Название игры - композиция, а Ruby хорошо оборудован, чтобы дать вам множество вариантов, чтобы избежать ожирения модели.</p> <p>В большинстве (Rails) веб-приложений, поддерживаемых базой данных, большая часть вашего внимания и работы будет сосредоточена вокруг слоя модели, учитывая, что вы работаете с компетентными дизайнерами, которые в состоянии реализовать свои собственные вещи в представлении. Ваши модели будут по своей природе иметь больше «силы тяжести» и привлекать больше сложности.</p> <p>Вопрос в том, как вы намереваетесь справиться с такой сложностью. Active Record определенно дает вам много веревки, чтобы повеситься, делая вашу жизнь невероятно легкой. Это заманчивый подход к дизайну вашего слоя модели, просто следуя пути наивысшего удобства. Тем не менее, будущая архитектура требует гораздо большего внимания, чем культивирование огромных классов и добавление всего в объекты Active Record.</p> <p>Я бы сказал, что реальная проблема, с которой вы имеете дело, - это сложность. Классы, которые собирают тонны кода, становятся сложными только по их размеру. Их труднее поддерживать, трудно разобрать и понять, и все труднее изменить, потому что их состав, вероятно, очень сильно взаимосвязан. Эти модели часто превосходят их рекомендуемую способность справляться с одной ответственностью. В худшем случае они становятся похожими на мусоровозы, обрабатывая весь мусор, который лениво бросается в них.</p> <p>Мы можем сделать лучше! Если вы считаете, что сложность не имеет большого значения - в конце концов, вы особенный, умный и продуманный! Сложность - самый известный серийный убийца проекта, а не ваш дружественный «Темный защитник».</p> <p>«Тонкие модели» очень ценятся среди продвинутых парней в сфере разработки (возможно, гораздо больше профессий, чем кода и дизайна), и мы должны максимально стремиться к простоте! Или, по крайней мере, к тому, что является справедливым компромиссом, если сложность трудно искоренить.</p> <p>Какие инструменты предлагает Ruby чтобы сделать нашу жизнь проще в этом отношении и позволить нам обрезать жир из наших моделей? Простые, другие классы и модули. Вы определяете когерентный код, который вы можете извлечь в другой объект, и тем самым создать слой модели, состоящий из агентов с разумным размером, которые имеют свои собственные уникальные, отличительные обязанности.</p> <p>Подумайте об этом с точки зрения талантливого исполнителя. В реальной жизни такой человек мог бы писать рэп, танцевать брейк, писать тексты и создавать собственные мелодии. В программировании вы предпочитаете динамику группы - здесь, по крайней мере, с четырьмя отличительными членами - где каждый человек отвечает за как можно меньше вещей. Вы хотите создать оркестр классов, которые могут справиться со сложностью композитора, а не класс гениального маэстро из всех профессий.</p> <figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=850/uploads%2Fusers%2F851%2Fposts%2F25636%2Fimage-1451925569542.png" alt="Антипаттерны: модели Rails..." title="Антипаттерны: модели Rails..." width="50" height="50"></figure><p>Давайте посмотрим на пример толстой модели и поиграем с несколькими вариантами для лечения этого ожирения. Разумеется, пример - фиктивный, и, рассказывая эту туповатую маленькую историю, я надеюсь, что будет легче переваривать и следовать за новичками.</p> <p>У нас есть класс Spectre  который имеет слишком много обязанностей и поэтому излишне разрос в размерах. Помимо этих методов, я думаю, что легко представить, что такой образец уже собрал много других вещей, также представленных тремя маленькими точками. Spectre уже на пути к становлению <span>God</span> классом. (Шансы довольно низкие, чтобы разумно сформулировать такое предложение снова в ближайшее время!)</p> <pre class="brush: ruby noskimlinks noskimwords">class Spectre &lt; ActiveRecord::Base  has_many :spectre_members  has_many :spectre_agents  has_many :enemy_agents  has_many :operations  ...  def turn_mi6_agent(enemy_agent)    puts "MI6 agent #{enemy_agent.name} turned over to Spectre"  end  def turn_cia_agent(enemy_agent)    puts "CIA agent #{enemy_agent.name} turned over to Spectre"  end  def turn_mossad_agent(enemy_agent)    puts "Mossad agent #{enemy_agent.name} turned over to Spectre"  end  def kill_double_o_seven(spectre_agent)    spectre_agent.kill_james_bond  end  def dispose_of_cabinet_member(number)    spectre_member = SpectreMember.find_by_id(number)    puts "A certain culprit has failed the absolute integrity of this fraternity. The appropriate act is to smoke number #{number} in his chair. His services won’t be greatly missed"    spectre_member.die  end  def print_assignment(operation)    puts "Operation #{operation.name}’s objective is to #{operation.objective}."  end  private  def enemy_agent    #clever code  end  def spectre_agent    #clever code  end  def operation    #clever code  end  ...end</pre> <p>Spectre превращает различные вражеские агенты, убивает делегатов 007, ребрирует членов кабинета Spectre’s  когда они терпят неудачу, а также распечатывает операционные задания. Явный случай микроменеджмента и, безусловно, нарушение «принципа единой ответственности». Приватные методы также быстро накапливаются.</p> <p>Этот класс не должен знать большую часть материала, который в настоящее время находится в нем. Мы разделим эту функциональность на несколько классов и посмотрим, стоит ли сложность наличия еще нескольких классов/объектов этой липосакции.</p> <pre class="brush: ruby noskimlinks noskimwords">class Spectre &lt; ActiveRecord::Base  has_many :spectre_members  has_many :spectre_agents  has_many :enemy_agents  has_many :operations  ...  def turn_enemy_agent    Interrogator.new(enemy_agent).turn  end  private   def enemy_agent    self.enemy_agents.last  endendclass Interrogator  attr_reader :enemy_agent    def initialize(enemy_agent)    @enemy_agent = enemy_agent  end  def turn    enemy_agent.turn  endendclass EnemyAgent &lt; ActiveRecord::Base  belongs_to :spectre  belongs_to :agency  def turn    puts "After extensive brainwashing, torture and hoards of cash…"  endendclass MI6Agent &lt; EnemyAgent  def turn    super    puts "MI6 agent #{name} turned over to Spectre"  endendclass CiaAgent &lt; EnemyAgent  def turn    super    puts "CIA agent #{name} turned over to Spectre"  endendclass MossadAgent &lt; EnemyAgent  def turn    super    puts "Mossad agent #{name} turned over to Spectre"  endendclass NumberOne &lt; ActiveRecord::Base  def dispose_of_cabinet_member(number)    spectre_member = SpectreMember.find_by_id(number)    puts "A certain culprit has failed the absolute integrity of this fraternity. The appropriate act is to smoke number #{number} in his chair. His services won’t be greatly missed"    spectre_member.die  endendclass Operation &lt; ActiveRecord::Base  has_many :spectre_agents  belongs_to :spectre  def print_assignment    puts "Operation #{name}’s objective is to #{objective}."  endendclass SpectreAgent &lt; ActiveRecord::Base  belongs_to :operation  belongs_to :spectre  def kill_james_bond    puts "Mr. Bond, I expect you to die!"  endendclass SpectreMember &lt; ActiveRecord::Base  belongs_to :spectre    def die    puts "Nooo, nooo, it wasn’t meeeeeeeee! ZCHUNK!"  endend</pre> <p>Я думаю, что самая важная часть, на которую вы должны обратить внимание, - это то, как мы использовали простой класс Ruby, например <code class="inline">Interrogator</code>, для обработки агентов из разных агентств. Реальные примеры могут представлять собой конвертер, который, скажем, преобразует HTML-документ в pdf и наоборот. Если вам не нужны полные функциональные возможности классов Active Record, зачем их использовать, если простой трюк Ruby также может сделать тоже самое? Уже немного меньше веревки, чтобы повеситься.</p> <p>Класс Specter переносит неприятную логику агентов в класс <code class="inline">Interrogator</code> и просто делегирует ему эту задачу. У него теперь есть единственная ответственность за пытки и промывание мозгов захваченными агентами.</p> <p>Все идет нормально. Но почему мы создали отдельные классы для каждого агента? Просто. Вместо прямого извлечения различных методов, таких как <code class="inline">turn_mi6_agent</code>, до <code class="inline">Interrogator</code>, мы предоставили им новое место в своем собственном классе.</p> <p>В результате мы можем эффективно использовать полиморфизм и не заботимся об отдельных случаях для разных агентов. Мы просто вызываем этих разных агентов, и каждый из них знает, что делать. <code class="inline">Interrogator</code> не должен знать особенности того, как работает каждый агент.</p> <p>Поскольку все эти агенты являются объектами Active Record, мы создали общий, <code class="inline">EnemyAgent</code>, который имеет общее представление о том, что означает агент, и мы инкапсулируем этот бит для всех агентов в одном месте. Мы используем наследование, предоставляя методы <code class="inline">turn</code> различных агентов с помощью <code class="inline">super</code>, и поэтому мы получаем доступ к делу по «промыванию мозгов» и пыткам без дублирования. Отдельные обязанности и отсутствие дублирования являются хорошей отправной точкой для продолжения.</p> <p>Другие классы Active Record берут на себя различные обязанности, о которых Spectre не нужно заботиться. «Номер один» обычно делает гриль неудачных членов кабинета Spectre, поэтому почему бы не позволить специализированному объекту справиться с электрическим током? С другой стороны, неспособность членов Спектра умереть самим, когда их поджаривают на электрическом стуле с помощью <code class="inline">NumOne</code> . <code class="inline">Operation</code> cамо собой подсказывает, что больше нет надобности хранить этот код в самом Spectre.</p> <p>И последнее, но не менее важное: убийство Джеймса Бонда обычно предпринимает агент в поле, поэтому <code class="inline">kill_james_bond</code> теперь является методом <code class="inline">SpectreAgent</code>. Разумеется, Голдфингер справился бы с этим по-другому, конечно же, с этой лазерной штучкой.</p> <p>Как вы можете ясно видеть, теперь у нас есть десять классов, а раньше был только один. Разве это не слишком много? Это может быть, конечно. Это проблема, с которой вам придется сражаться большую часть времени, когда вы разделяете такие обязанности. Вы можете определенно переусердствовать. Но взгляд на это под другим углом может помочь:</p> <ul><li>Разделили ли мы ответственности? Абсолютно!</li> <li>У нас есть легкие, тощие классы, которые лучше подходят для решения своих собственных обязанностей? Определенно!</li> <li>Рисуем ли мы теперь более четкую картину того, кто участвует, и отвечает за определенные действия? Я надеюсь, что это так!</li> <li>Легче ли переварить то, что делает каждый класс? Наверняка!</li> <li>Уменьшили ли мы количество приватных методов? Ага!</li> <li>Означает ли это лучшее качество объектно-ориентированного программирования? Поскольку мы использовали композицию и обращались к наследованию только там, где это необходимо для создания этих объектов, то определенно это так!</li> <li>Чувствуется себя чище? Да!</li> <li>Мы лучше вооружены, чтобы была возможность легко изменить наш код, не создавая беспорядка? Конечно!</li> <li>Стоило ли оно того? Как вы думаете?</li> </ul><p>Я не подразумеваю, что эти вопросы нужно проверять каждый раз, но вы должны начать спрашивать их у себя себя, уменьшая ваши модели.</p> <p>Проектирование тощих моделей может быть сложным, но это важная мера, чтобы ваши приложения были здоровыми и проворными. Это также не единственные конструктивные способы борьбы с жирными моделями, но они - хорошее начало, особенно для новичков.</p> <h2>Отсутствует комплект для тестирования</h2> <p>Это, вероятно, самый очевидный AntiPattern. Исходя из тестовой стороны вещей, касаясь зрелого приложения, которое не имеет покрытия тестированием, может быть одним из самых болезненных переживаний. Если вы хотите больше ненавидеть мир и свою профессию, просто потратьте шесть месяцев на такой проект, и вы узнаете, сколько в вас мизантропа. Конечно, шучу, но я сомневаюсь, что это сделает вас счастливее и что вы захотите сделать это снова. Может быть, неделя тоже подойдет. Я почти уверен, что слово «пытка» будет появляться у вас чаще, чем вы думаете.</p> <p>Если тестирование пока не было частью вашего рабочего процесса, и такая боль кажется нормальной для вашей работы, возможно, вам стоит подумать, что тестирование не так уж плохо, и это не ваш враг. Когда ваши уровни радости, связанные с кодом, более или менее постоянно превышают ноль, и вы можете безбоязненно изменить свой код, тогда общее качество вашей работы будет намного выше по сравнению с результатом, который испорчен тревогой и страданиями.</p> <p>Я переоцениваю? На самом деле я так не считаю! Вам нужно иметь очень обширное тестовое покрытие не только потому, что это отличный инструмент для проектирования, который вам действительно нужен, но и потому, что вам нужно будет изменить свой код в какой-то момент в будущем. Вы будете намного легче взаимодействовать с вашей кодовой базой - и намного увереннее - если у вас есть испытательный жгут, который помогает и реорганизует рефакторинг, поддержку и расширения. Они наверняка появятся по мере роста приложения, не сомневайтесь.</p> <p>Это также тот момент, когда тесты начинает выплачивать второй раунд дивидендов, потому что повышенная скорость, с которой вы можете надежно сделать эти качественные изменения, не может быть достигнута путем длительного использования в приложениях, созданных людьми, которые считают, что написание тестов это бессмыслица или занимает слишком много времени.</p> <h2>Подглядывающие модели</h2> <p>Это модели, которые являются слишком шумными и хотят собирать слишком много информации о других объектах или моделях. Это резко контрастирует с одной из самых фундаментальных идей в объектно-ориентированном программировании-инкапсуляции. Мы скорее хотим стремиться к самодостаточным классам и моделям, которые сами управляют своими внутренними делами. С точки зрения концепций программирования эти модели в основном нарушают «Принцип наименьшего знания», а также «Закон Деметры» - как бы вы ни хотели его произнести.</p> <h3>Закон Деметры</h3> <p>Почему это проблема? Это форма дублирования - тонкая - и также приводит к коду, который намного более хрупкий, чем ожидалось.</p> <p>Закон Деметры - про такой запах кода, который вы всегда можете атаковать, не беспокоясь о возможных недостатках.</p> <p>Я предполагаю, что называть это «закон» было бы не таким претенциозным, как это могло бы звучать вначале. Покопайте в этот запах, потому что вам это часто понадобится в ваших проектах. В основном говорится, что с точки зрения объектов вы можете вызывать методы у друга вашего объекта, но не у друга друга.</p> <p>Это общий способ объяснить это, и все это сводится к использованию не более одной точки для вызовов ваших методов. Кстати, совершенно нормально использовать больше точек или вызовов методов, когда вы имеете дело с одним объектом. Что-то вроде <code class="inline">@weapons.find_by_name("Poison dart").formula</code> вполне нормально. Формула просто прекрасна. Иногда объекты могут накапливать несколько точек. Тем не менее, хорошая идея заключается в их инкапсулировании специальными методами.</p> <h4>Нарушения закона Деметры </h4> <p>Давайте рассмотрим пару плохих примеров из вышеперечисленных классов:</p> <pre class="brush: ruby noskimlinks noskimwords">@operation.spectre_agents.first.kill_james_bond@spectre.operations.last.spectre_agents.first.name@spectre.enemy_agents.last.agency.name</pre> <p>Чтобы узнать об этом, вот еще несколько вымышленных:</p> <pre class="brush: ruby noskimlinks noskimwords">@quartermaster.gizmos.non_lethal.favorite@mi6.operation.agent.favorite_weapon@mission.agent.name</pre> <p>Бананы, верно? Выглядит не очень хорошо, не так ли? Как вы можете видеть, этот метод вызывает слишком много внимания в логике других объектов. Важнейшим и очевидным негативным последствием является изменение кучки этих вызовов методов везде по всему приложению, если структура этих объектов должна измениться, что в конечном итоге будет, потому что единственной константой в разработке программного обеспечения является изменение. Кроме того, это выглядит действительно неприятно и не так просто для глаз. Когда вы не знаете, что это проблематичный подход, Rails позволяет вам так сильно зайти так далеко, не крича на вас. Помнишь много веревки?</p> <p>Так что же мы можем с этим поделать? В конце концов, мы хотим как-то получить эту информацию. С одной стороны, мы можем скомпоновать наши объекты в соответствии с нашими потребностями, и мы можем умело использовать делегирование, чтобы одновременно поддерживать наши модели. Давайте погрузимся в какой-то код, чтобы показать вам то, что я имею в виду.</p> <pre class="brush: ruby noskimlinks noskimwords">class SpectreMember &lt; ActiveRecord::Base  has_many :operations  has_many :spectre_agents    ...endclass Operation &lt; ActiveRecord::Base  belongs_to :spectre_member  ...endclass SpectreAgent &lt; ActiveRecord::Base  belongs_to :spectre_member  ...end@spectre_member.spectre_agents.all@spectre_member.operations.last.print_assignment@spectre_member.spectre_agents.find_by_id(1).name@operation.spectre_member.name@operation.spectre_member.number@operation.spectre_member.spectre_agents.first.name@spectre_agent.spectre_member.number</pre> <pre class="brush: ruby noskimlinks noskimwords">class SpectreMember &lt; ActiveRecord::Base  has_many :operations  has_many :spectre_agents    ...  def list_of_agents    spectre_agents.all  end  def print_operation_details    operation = Operation.last    operation.print_operation_details  endendclass Operation &lt; ActiveRecord::Base  belongs_to :spectre_member  ...  def spectre_member_name    spectre_member.name  end  def spectre_member_number    spectre_member.number  end  def print_operation_details    puts "This operation’s objective is #{objective}. The target is #{target}"  endendclass SpectreAgent &lt; ActiveRecord::Base  belongs_to :spectre_member  ...  def superior_in_charge    puts "My boss is number #{spectre_member.number}"  endend@spectre_member.list_of_agents@spectre_member.print_operation_details@operation.spectre_member_name@operation.spectre_member_number@spectre_agent.superior_in_charge</pre> <p>Это определенно шаг в правильном направлении. Как вы можете видеть, мы собрали информацию, которую мы хотели получить, в кучу методов обертки. Вместо того, чтобы напрямую обращаться ко многим объектам, мы абстрагировали эти мосты и оставляем их соответствующим моделям, чтобы поговорить со своими друзьями о необходимой нам информации.</p> <p>Недостатком этого подхода является наличие всех этих дополнительных методов обертки. Иногда это нормально, но мы действительно хотим избежать поддержки этих методов в кучке мест, если объект изменится.</p> <p>Если возможно, особое место для их изменения зависит от их объекта - и только от их объекта. Загрязнение объектов методами, которые имеют мало общего с их собственной моделью, также заслуживает внимания, поскольку это всегда является потенциальной опасностью для опускания отдельных обязанностей.</p> <p>Мы можем сделать лучше. Там, где это возможно, давайте делегируем вызовы методов непосредственно их объектам и стараемся максимально сократить методы обёртки. Rails знает, что нам нужно, и предоставляет нам удобный метод класса <code class="inline">delegate</code>, чтобы сообщить друзьям нашего объекта, какие методы нам нужны.</p> <p>Давайте приблизим что-то из предыдущего примера кода и посмотрим, где мы можем правильно использовать делегирование.</p> <pre class="brush: ruby noskimlinks noskimwords">class Operation &lt; ActiveRecord::Base  belongs_to :spectre_member   delegate :name, :number, to: :spectre_member, prefix: true  ...# def spectre_member_name#   spectre_member.name# end# def spectre_member_number#   spectre_member.number# end  ...end@operation.spectre_member_name@operation.spectre_member_numberclass SpectreAgent &lt; ActiveRecord::Base  belongs_to :spectre_member  delegate :number, to: :spectre_member, prefix: true  ...  def superior_in_charge    puts "My boss is number #{spectre_member_number}"  end  ...end</pre> <p>Как вы можете видеть, мы могли немного упростить работу с помощью делегирования методов. Мы полностью избавились от <code class="inline">Operation#spectre_member_name</code> и <code class="inline">Operation#spectre_member_number</code>, а <code class="inline">SpectreAgent</code> больше не нужно вызывать <code class="inline">number</code> у <code class="inline">spectre_member</code> - <code class="inline">number</code> передается обратно прямо в его «исходный» класс <code class="inline">SpectreMember</code>.</p> <p>Сперва все это немного запутывает, как это работает? Вы указываете делегату, какой <code class="inline">:method_name</code> он должен делегировать <code class="inline">:to</code> какому <code class="inline">:class_name</code> (несколько имен методов тоже нормально).  Часть <code class="inline">prefix: true</code> является необязательной.</p> <p>В нашем случае он предварял имя класса класса в snake-cased формате получающего класса перед именем метода и дал нам возможность вызвать <code class="inline">operator.spectre_member_name</code> вместо потенциально неоднозначного <code class="inline">operation.name</code> если бы мы не использовали опцию префикса. Это очень хорошо работает с ассоциациями <code class="inline">belongs_to</code> и <code class="inline">has_one</code>.</p> <p>Однако на стороне <code class="inline">has_many</code>, музыка остановится, и у вас возникнут проблемы. Эти ассоциации предоставляют вам прокси коллекции, который будет бросать вам имена или ошибки NoMethodErrors, когда вы делегируете методы этим «коллекциям».</p> <h2>Спагетти SQL</h2> <p>Чтобы завершить эту главу об антипаттернах модели в Rails, я хотел бы потратить немного времени на то, чего следует избегать при использовании SQL. Ассоциации Active Record предоставляют варианты, которые значительно упрощают вашу жизнь, когда вы знаете, чего вам следует избегать. Методы поиска - это целая тема сами по себе, и мы не будем их охватывать в полной мере, но я хотел упомянуть несколько общих техник, которые помогут вам.</p> <p>Вещи, которые нас должны волновать, отражают большую часть того, что мы узнали до сих пор. Мы хотим иметь простые и правильно названные методы поиска в наших моделях. Давайте погрузимся прямо в код.</p> <pre class="brush: ruby noskimlinks noskimwords">class Operation &lt; ActiveRecord::Base  has_many :agents  ...endclass Agent &lt; ActiveRecord::Base  belongs_to :operation  ...endclass OperationsController &lt; ApplicationController  def index    @operation = Operation.find(params[:id])    @agents = Agent.where(operation_id: @operation.id, licence_to_kill: true)  endend</pre> <p>Выглядит безвредно, нет? Мы просто ищем кучу агентов, у которых есть лицензия на убийство для нашей страницы ops. Подумайте еще раз. Почему <code class="inline">OperationsController</code> должен копаться во внутренности <code class="inline">Agent</code>? Кроме того, это действительно лучшее, что мы можем сделать, чтобы инкапсулировать поиск <code class="inline">Agent</code>?</p> <p>Если вы думаете, что можете добавить метод класса, такой как <code class="inline">Agent.find_licence_to_kill_agents</code>, который инкапсулирует логику поиска, вы определенно делаете шаг в правильном направлении, но этого еще не достаточно.</p> <pre class="brush: ruby noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :operation  def self.find_licence_to_kill_agents(operation)    where(operation_id: operation.id, licence_to_kill: true)  end  ...endclass OperationsController &lt; ApplicationController  def index    @operation = Operation.find(params[:id])    @agents = Agent.find_licence_to_kill_agents(@operation)  endend</pre> <p>Мы должны быть немного более вовлечены в это. Прежде всего, это не использование ассоциаций в наших интересах, а инкапсуляция. Ассоциации, такие как <code class="inline">has_many</code>, имеют преимущество, которое мы можем добавить к массиву прокси, который мы возвращаем. Мы могли бы сделать это вместо этого:</p> <pre class="brush: ruby noskimlinks noskimwords">class Operation &lt; ActiveRecord::Base  has_many :agents  def find_licence_to_kill_agents    self.agents.where(licence_to_kill: true)  end  ...endclass OperationsController &lt; ApplicationController  def index    @operation = Operation.find(params[:id])    @agents = @operation.find_licence_to_kill_agents  endend</pre> <p>Это работает, конечно, но это еще один маленький шаг в правильном направлении. Да, контроллер немного лучше, и мы хорошо используем ассоциации моделей, но вы все равно должны быть подозрительными относительно того, почему <code class="inline">Operation</code> занимается реализацией поиска определенного типа <code class="inline">Agent</code>. Эта ответственность относится к самой модели <code class="inline">Agent</code>.</p> <p>Именованные области очень удобны. Области определения определяют методы с очень важными классами для ваших моделей и тем самым позволяют указать полезные запросы, которые вы можете использовать в качестве дополнительных вызовов методов поверх своих ассоциаций моделей. Следующие два подхода к <code class="inline">Agent</code> одинаковы.</p> <pre class="brush: ruby noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :operation  scope :licenced_to_kill, -&gt; { where(licence_to_kill: true) }endclass Agent &lt; ActiveRecord::Base  belongs_to :operation  def self.licenced_to_kill    where(licence_to_kill: true)  endendclass OperationsController &lt; ApplicationController  def index    @operation = Operation.find(params[:id])    @agents = @operation.agents.licenced_to_kill  endend</pre> <p>Это намного лучше. В случае, если синтаксис областей не нов для вас, это просто (неубедительные) lambdas - не обаятельно смотреть на них таким образом, между прочим, они являются надлежащим способом вызова областей с Rails 4. <code class="inline">Agent</code> теперь сам отвечает за управление собственными параметрами поиска, а ассоциации могут просто зависеть от того, что им нужно найти.</p> <p>Такой подход позволяет получать запросы как единичные вызовы SQL. Мне лично нравится использовать возможности <code class="inline">scope</code>. Области также очень удобны для цепочки внутри хорошо известных методов поиска - таким образом они увеличивают возможность повторного использования кода и проводят его в соответствие с принципом DRY. Допустим, у нас есть что-то более активное:</p> <pre class="brush: ruby noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :operation  scope :licenced_to_kill, -&gt; { where(licence_to_kill: true) }  scope :womanizer, -&gt; { where(womanizer: true) }  scope :bond, -&gt; { where(name: "James Bond") }  scope :gambler, -&gt; { where(gambler: true) }end</pre> <p>Теперь мы можем использовать все эти области для пользовательской сборки более сложных запросов.</p> <pre class="brush: ruby noskimlinks noskimwords">class OperationsController &lt; ApplicationController  def index    @operation = Operation.find(params[:id])    @double_o_agents = @operation.agents.licenced_to_kill  end  def show    @operation = Operation.find(params[:id])    @bond = @operation.agents.womanizer.gambler.licenced_to_kill  end  ...end</pre> <p>Конечно, это работает, но я хотел бы предложить вам сделать еще один шаг вперед.</p> <pre class="brush: ruby noskimlinks noskimwords">class Agent &lt; ActiveRecord::Base  belongs_to :operation  scope :licenced_to_kill, -&gt; { where(licence_to_kill: true) }  scope :womanizer, -&gt; { where(womanizer: true) }  scope :bond, -&gt; { where(name: "James Bond") }  scope :gambler, -&gt; { where(gambler: true) }  def self.find_licenced_to_kill    licenced_to_kill  end  def self.find_licenced_to_kill_womanizer    womanizer.licenced_to_kill  end  def self.find_gambling_womanizer    gambler.womanizer  end   ...endclass OperationsController &lt; ApplicationController  def index    @operation = Operation.find(params[:id])    @double_o_agents = @operation.agents.find_licenced_to_kill  end  def show    @operation = Operation.find(params[:id])    @bond = @operation.agents.find_licenced_to_kill_womanizer    #or    @bond = @operation.agents.bond  end  ...end</pre> <p>Как вы можете видеть, благодаря такому подходу мы извлекаем выгоду из правильной инкапсуляции, ассоциаций моделей, повторного использования кода и выразительного наименования методов - и все при выполнении одиночных SQL-запросов. Нет больше кода спагетти, потрясающе!</p> <p>Если вы беспокоитесь о нарушении Закона Деметры, вам будет приятно услышать это. Поскольку мы не добавляем точки, входя в связанную модель, но связывая их только с их собственным объектом, мы не совершаем никаких нарушений закона Деметры.</p> <h2>Последние мысли</h2> <p>С точки зрения новичка, я думаю, вы много узнали о лучшей обработке моделей Rails и о том, как их моделировать.</p> <p>Однако не обманывайте себя, думая, что в этой конкретной теме есть мало чему поучиться. Я представил вам несколько антипаттернов, которые, как я думаю, новички могут легко понять и обработать, чтобы защитить себя от них на ранней стадии. Если вы не знаете, чего не знаете, для веревки вокруг шеи будет доступно много места.</p> <p>Несмотря на то, что это стало серьезным началом в этой теме, есть еще много нюансов, которые вам также нужно изучить. Это были основы - очень важные - и вы должны почувствовать себя гораздо лучше, что вы не стали дожидаться момента гораздо позже в своей карьере, чтобы понять их.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby" href="https://norma-studio.github.io/article5/220825246-antipatterny-modeli-rails" class="tm-article-body__tags-item-link">Ruby</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
39730</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
304</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
