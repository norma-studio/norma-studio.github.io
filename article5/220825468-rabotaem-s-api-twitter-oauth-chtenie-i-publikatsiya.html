
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Birdcage использует расширение Yii под названием Yii Twitter от Will Wharton, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом Авраама Уильямса....">
<meta property="og:description" content="Birdcage использует расширение Yii под названием Yii Twitter от Will Wharton, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом Авраама Уильямса....">
<meta name="twitter:description" content="Birdcage использует расширение Yii под названием Yii Twitter от Will Wharton, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом Авраама Уильямса....">
<meta property="aiturec:description" content="Birdcage использует расширение Yii под названием Yii Twitter от Will Wharton, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом Авраама Уильямса....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/final_image/feature-b.jpg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/final_image/feature-b.jpg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/final_image/feature-b.jpg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/final_image/feature-b.jpg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/final_image/feature-b.jpg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html" title="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io" title="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/636534636.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html" class="tm-user-info__username" title="
С. Новичков" aria-label="
С. Новичков">
С. Новичков</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Работаем с API Twitter: OAuth, чтение и публикация...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="PHP" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya" class="tm-article-snippet__hubs-item-link"><span>PHP</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/final_image/feature-b.jpg">
    <meta itemprop="headline name" content="Работаем с API Twitter: OAuth, чтение и публикация... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Birdcage использует расширение Yii под названием Yii Twitter от Will Wharton, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом Авраама Уильямса....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Birdcage использует расширение Yii под названием Yii Twitter от Will Wharton, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом Авраама Уильямса....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p><i>Этот пост является вторым из трех частей серии по использованию API Twitter. Если вы пропустили первую часть, вы можете прочитать</i> <span><i>ее здес</i></span>ь.</p><h2>Аутентификация с помощью Twitter через OAuth</h2><p><span>Birdcage</span> использует расширение Yii под названием <span>Yii Twitter</span> от <span>Will Wharton</span>, в котором используется библиотека PHP OAuth Twitter с открытым исходным кодом <span>Авраама Уильямса</span>.<br></p><p>Я размещаю расширение в дереве Yii в папке <code class="inline">/app/protected/extensions/yiitwitteroauth</code>. В Yii вы настраиваете свойства расширения в файле конфигурации <code class="inline">main.php</code> следующим образом:</p><pre class="brush: php noskimlinks noskimwords">    // application components  "components"=&gt;array(  "twitter" =&gt; array(    "class" =&gt; "ext.yiitwitteroauth.YiiTwitter",    "consumer_key" =&gt; "",    "consumer_secret" =&gt; "",    "callback" =&gt; "",    ),</pre><p>Обычно я загружал эти настройки из моего Yii .ini-файла, но чтобы упростить настройку Birdcage, я настраиваю ключи приложений из модели <code class="inline">UserSettings</code>. Я расширил <code class="inline">YiiTwitter.php</code>, чтобы загрузить ключи приложения по умолчанию во время инициализации:</p><pre class="brush: php noskimlinks noskimwords">    public function init() {  // load twitter app keys from UserSetting table    $result = UserSetting::model()-&gt;loadPrimarySettings();    $this-&gt;consumer_key = $result["twitter_key"];    $this-&gt;consumer_secret = $result["twitter_secret"];    $this-&gt;callback = $result["twitter_url"];$this-&gt;registerScripts();parent::init();}</pre><p>После того, как вы установили и настроили параметры приложения, вам нужно посетить меню «<strong>Учетные записи</strong>» и нажать «<strong>Добавить свою учетную запись Twitter</strong>». </p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/image/accounts.jpg" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><p>Когда вы нажимаете на значок Twitter, он запускает метод <code class="inline">Connect</code> для контроллера Birdcage Twitter:</p><pre class="brush: plain noskimlinks noskimwords">  public function actionConnect()       {        unset(Yii::app()-&gt;session["account_id"]);        Yii::app()-&gt;session["account_id"]=$_GET["id"];       $twitter = Yii::app()-&gt;twitter-&gt;getTwitter();         $request_token = $twitter-&gt;getRequestToken();       //set some session info       Yii::app()-&gt;session["oauth_token"] = $token =$request_token["oauth_token"];       Yii::app()-&gt;session["oauth_token_secret"] = $request_token["oauth_token_secret"];          if ($twitter-&gt;http_code == 200) {              //get twitter connect url              $url = $twitter-&gt;getAuthorizeURL($token);              //send them                            Yii::app()-&gt;request-&gt;redirect($url);          }else{              //error here              $this-&gt;redirect(Yii::app()-&gt;homeUrl);          }      }</pre><p>Это приведет вас обратно в Twitter через OAuth для аутентификации вашей учетной записи Twitter:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/image/oauth-at-twitter.jpg" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><p>После того, как вы войдете в систему, Twitter попросит вас разрешить приложение Birdcage:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/image/oauth-authorize.jpg" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><p>Twitter вернет браузер к вашему обратному URL-адресу, нашему методу обратного вызова контроллера Twitter. Он сохранит ваш токен и секретный токен пользователя Twitter в таблице учетных записей:</p><pre class="brush: php noskimlinks noskimwords">  public function actionCallback() {    /* If the oauth_token is old redirect to the connect page. */            if (isset($_REQUEST["oauth_token"]) &amp;&amp; Yii::app()-&gt;session["oauth_token"] !== $_REQUEST["oauth_token"]) {                Yii::app()-&gt;session["oauth_status"] = "oldtoken";            }/* Create TwitteroAuth object with app key/secret and token key/secret from default phase */            $twitter = Yii::app()-&gt;twitter-&gt;getTwitterTokened(Yii::app()-&gt;session["oauth_token"], Yii::app()-&gt;session["oauth_token_secret"]);               /* Request access tokens from twitter */            $access_token = $twitter-&gt;getAccessToken($_REQUEST["oauth_verifier"]);      /* Save the access tokens. Normally these would be saved in a database for future use. */                        Yii::app()-&gt;session["access_token"] = $access_token;            $account = Account::model()-&gt;findByAttributes(array("user_id"=&gt;Yii::app()-&gt;user-&gt;id,"id"=&gt;Yii::app()-&gt;session["account_id"]));            $account["oauth_token"] = $access_token["oauth_token"];            $account["oauth_token_secret"] = $access_token["oauth_token_secret"];$account-&gt;save();                        /* Remove no longer needed request tokens */            unset(Yii::app()-&gt;session["oauth_token"]);            unset(Yii::app()-&gt;session["oauth_token_secret"]);            if (200 == $twitter-&gt;http_code) {          /* The user has been verified and the access tokens can be saved for future use */                Yii::app()-&gt;session["status"] = "verified";                $this-&gt;redirect(array("account/admin"));            } else {                /* Save HTTP status for error dialog on connnect page.*/                //header("Location: /clearsessions.php");                $this-&gt;redirect(Yii::app()-&gt;homeUrl);            }        }</pre><p>Теперь Birdcage готов начинать запросы на получение данных Twitter через API от имени вашей учетной записи пользователя.</p><p>Как вы увидите, простой вызов с токенами позволяет получить доступ к API:</p><pre class="brush: php noskimlinks noskimwords">$twitter = Yii::app()-&gt;twitter-&gt;getTwitterTokened($account["oauth_token"], $account["oauth_token_secret"]);</pre><h2>Обработка твитов в фоновом режиме</h2><p>Во второй части нашего урока мы используем REST API Twitter. Часть третья будет об API реального времени на Streaming API:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=562/uploads/users/317/posts/22193/image/streaming-intro-1_1.png" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><h3>Получение таймингов Twitter</h3><p>Графики Twitter - это постоянно расширяющийся стек твитов, поэтому активность мониторинга немного сложнее, чем ваш средний REST API. <span>Здесь</span> вы можете узнать больше об уникальных проблемах, которые присутствуют в Twitter. По сути, когда вы пытаетесь прочитать историю хронологии, все время добавляются новые твиты:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=557/uploads/users/317/posts/22193/image/tweet-stack.jpg" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><p>Twitter предоставляет относительно простой способ управления этим. Вы можете просмотреть код, который выполняет это в модели Twitter Birdcage,<code class="inline"> getRecentTweets()</code>.</p><p>Сначала мы просматриваем самый высокий (самый последний) <code class="inline">tweet_id</code> в нашей базе данных и возвращаем увеличенное значение:</p><pre class="brush: php noskimlinks noskimwords">  public function getLastTweet($account_id) {    // get highest tweet_it where account_id = $account_id    $criteria=new CDbCriteria;    $criteria-&gt;select="max(tweet_id) AS max_tweet_id";    $criteria-&gt;condition="account_id = ".$account_id;    $row = Tweet::model()-&gt;find($criteria);    if ($row["max_tweet_id"] ==0)      return 1;    else      return $row["max_tweet_id"]+1;  }</pre><p>Затем мы запрашиваем некоторое количество (например, 100) твитов с самого высокого ранее обработанного. API Twitter распознает значение <code class="inline">from_id</code> как указатель на место на временной шкале, с которой вы хотите начать извлечение. Он вернет все твиты более поздние, чем <code class="inline">from_id</code>. В приведенном ниже примере мы запрашиваем метод REST API <span>statuses/home_timeline</span>. Домашняя временная шкала - это то, что пользователь видит на своем основном экране Twitter.</p><pre class="brush: php noskimlinks noskimwords">    $since_id = $this-&gt;getLastTweet($account-&gt;id);    echo "since: ".$since_id;lb();    // retrieve tweets up until that last stored one    $tweets= $twitter-&gt;get("statuses/home_timeline",array("count"=&gt;100,"since_id"=&gt;$since_id));     if (count($tweets)==0) return false; // nothing returned</pre><p>Также важно проверить, <span>рейт лимиты Twitter"а</span>. Каждому пользовательскому приложению разрешено 180 запросов к домашней временной шкале пользователя за 15-минутное окно, но ограничения по скорости <span>варьируются в зависимости от активности.</span></p><p>Для каждого полученного твита мы вызываем наш метод <code class="inline">Parse()</code> для обработки данных и сохранения их в наших различных таблицах базы данных. Во время обработки мы отслеживаем самый старый/самый низкий <code class="inline">tweet_id</code>, который мы получили от Twitter:</p><pre class="brush: php noskimlinks noskimwords">    foreach ($tweets as $i) {      if ($low_id==0)        $low_id = intval($i-&gt;id_str);      else        $low_id = min(intval($i-&gt;id_str),$low_id);      Tweet::model()-&gt;parse($account-&gt;id,$i);    }</pre><p>Метод parse добавляет информацию о пользователе на основе ссылки, а затем сам твит. В модели <code class="inline">Parse.php</code> можно увидеть это более подробно.</p><pre class="brush: php noskimlinks noskimwords">  public function parse($account_id,$tweet) {      // add user      $tu = TwitterUser::model()-&gt;add($tweet-&gt;user);      // add tweet      $tweet_obj = $this-&gt;add($account_id,$tweet);</pre><p>Затем мы продолжаем запрашивать блоки твитов, используя самый низкий идентификатор из последнего запроса в качестве параметра <code class="inline">max_id</code>, который мы отправляем в Twitter. Мы делаем эти последующие запросы, используя <code class="inline">first_id</code> из твита, с которого мы начали, <i>и</i> <code class="inline">max_id</code> из последнего самого старого твита, который мы получили.</p><pre class="brush: php noskimlinks noskimwords">    // retrieve next block until our code limit reached    while ($count_tweets &lt;= $limit) {      lb(2);      $max_id = $low_id-1;      $tweets= $twitter-&gt;get("statuses/home_timeline",array("count"=&gt;100,"max_id"=&gt;$max_id,"since_id"=&gt;$since_id));      if (count($tweets)==0) break;      if ($this-&gt;isRateLimited($tweets)) return false;      echo "count".count($tweets);lb();      $count_tweets+=count($tweets);      foreach ($tweets as $i) {        $low_id = min(intval($i-&gt;id_str),$low_id);        Tweet::model()-&gt;parse($account-&gt;id,$i);      }                  }</pre><p>Так, например, когда появляются новые твиты, мы их не видим, потому что Twitter только отправляет нам твиты с самого раннего наивысшего <code class="inline">tweet_id</code> (<code class="inline">from_id</code>) из нашей базы данных. Нам придется вернуться позже, чтобы получить более новые твиты, которые выше, чем наш начальный <code class="inline">from_id</code>.</p><p>Важно отметить, что мы не получаем бесконечное количество старых твитов. Twitter возвращает нам только количество твитов, которые мы запрашиваем, которые старше предыдущего низкого ID или (<code class="inline">max_id</code> в нашем следующем вызове).</p><p>Как только вы привыкнете к этой модели, всё станет довольно просто.</p><p>Пока есть команда меню <code class="inline">Fetch</code>, которая будет запускать эту операцию, мы также настраиваем задание <code class="inline">cron</code> для вызова нашего метода <code class="inline">DaemonController</code> каждые пять минут:</p><pre class="brush: bash noskimlinks noskimwords"># To define the time you can provide concrete values for# minute (m), hour (h), day of month (dom), month (mon),# and day of week (dow) or use "*" in these fields (for "any").# # Notice that tasks will be started based on the cron"s system# daemon"s notion of time and timezones.# # For example, you can run a backup of all your user accounts# at 5 a.m every week with:# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/# # m h  dom mon dow   command*/5 * * * * wget -O /dev/null http://birdcage.yourdomain.com/daemon/index</pre><p>Это, в свою очередь, вызывает наш метод <code class="inline">getStreams</code>, который выполняет описанные выше операции (обратите внимание, что функции потоков будут описаны в третьей части этой серии):</p><pre class="brush: php noskimlinks noskimwords">    public function actionIndex() {  // if not using twitter streams, we"ll process tweets by REST API  if (!Yii::app()-&gt;params["twitter_stream"]) {    Tweet::model()-&gt;getStreams();      } else {    Stream::model()-&gt;process();  }  }</pre><p>Конечный результат выглядит примерно так:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/image/birdcage-tweets.jpg" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><p>Однажды я столкнулся с некоторыми проблемами надежности API Twitter. Здесь вы можете проверить <span>статус услуг API Twitter</span>.<br></p><h2>Постинг Tweet</h2><p>Постинг твитов в ваш аккаунт Twitter на самом деле довольно прост. Нам просто нужно использовать <span>метод REST statuses/update</span> . Для выполнения точных подсчетов символов требуется немного больше работы. </p><p>Twitter разрешает все URL-адреса в <span>http://t.co</span> ярлыки, поэтому все URL-адреса считаются 20 символами. Мне нужен JavaScript, который бы подсчитывал символы и любой URL-адрес приводил бы к 20 символам, независимо от длины URL-адреса. Я остановился на сочетании решений jQuery и JavaScript, о которых я расскажу ниже.</p><p>Я решил создать модель специально для составления твитов под названием <code class="inline">Status.php</code>. Это упростило работу с Yii для создания форм для публикации в API. </p><p>Когда вы нажимаете <strong>Compose</strong> в меню Birdcage, он перейдет к методу <code class="inline">Compose</code> <code class="inline">StatusController</code>:</p><pre class="brush: php noskimlinks noskimwords">    public function actionCompose($id=0){    if (!UserSetting::model()-&gt;checkConfiguration(Yii::app()-&gt;user-&gt;id)) {      Yii::app()-&gt;user-&gt;setFlash("warning","Please configure your Twitter settings.");$this-&gt;redirect(array("/usersetting/update"));      }$model=new Status;$model-&gt;account_id = $id;// Uncomment the following line if AJAX validation is needed// $this-&gt;performAjaxValidation($model);if(isset($_POST["Status"])){$model-&gt;attributes=$_POST["Status"];if ($model-&gt;account_id=="" or $model-&gt;account_id==0) {    Yii::app()-&gt;user-&gt;setFlash("no_account","You must select an account before tweeting.");     $this-&gt;redirect(array("status/compose"));}      $model-&gt;created_at =new CDbExpression("NOW()");       $model-&gt;modified_at =new CDbExpression("NOW()");if($model-&gt;save()) {  $account = Account::model()-&gt;findByPK($model-&gt;account_id);  $twitter = Yii::app()-&gt;twitter-&gt;getTwitterTokened($account["oauth_token"], $account["oauth_token_secret"]);        // retrieve tweets up until that last stored one        $tweets= $twitter-&gt;post("statuses/update",array("status"=&gt;$model-&gt;tweet_text)); $this-&gt;redirect(array("view","id"=&gt;$model-&gt;id));        }}$this-&gt;render("compose",array("model"=&gt;$model,));}</pre><p>Это загрузит форму HTML для создания элемента статуса. Проверьте <code class="inline">_form.php</code> в <code class="inline">/app/protected/views/status/</code>.</p><p>Во-первых, я загружу несколько библиотек jQuery и JavaScript-для подсчета количества символов:</p><pre class="brush: php noskimlinks noskimwords">$baseUrl = Yii::app()-&gt;baseUrl; $cs = Yii::app()-&gt;getClientScript();$cs-&gt;registerScriptFile($baseUrl."/js/jquery.simplyCountable.js");$cs-&gt;registerScriptFile($baseUrl."/js/twitter-text.js");$cs-&gt;registerScriptFile($baseUrl."/js/twitter_count.js");</pre><p>Я использовал комбинацию <span>плагина jQuery simpleCountable</span>, <span>twitter-text.js</span> (скрипт для текстовой обработки Twitter на основе JavaScript) и скрипт, который значительно облегчил настройку URL: <span>twitter_count.js</span>.</p><p>Следующий код затем создает остаток формы компоновки и активирует скрипты подсчета символов:</p><pre class="brush: php noskimlinks noskimwords">&lt;?php $form=$this-&gt;beginWidget("bootstrap.widgets.TbActiveForm",array(    "id"=&gt;"status-form","enableAjaxValidation"=&gt;false,)); ?&gt;&lt;?php   if(Yii::app()-&gt;user-&gt;hasFlash("no_account")    ) {  $this-&gt;widget("bootstrap.widgets.TbAlert", array(      "alerts"=&gt;array( // configurations per alert type      "no_account"=&gt;array("block"=&gt;true, "fade"=&gt;true, "closeText"=&gt;"×"),       ),  ));}?&gt;&lt;p class="help-block"&gt;Fields with &lt;span class="required"&gt;*&lt;/span&gt; are required.&lt;/p&gt;&lt;?php echo $form-&gt;errorSummary($model); ?&gt;  &lt;?php     if ($model-&gt;account_id == 0 ) {      echo CHtml::activeLabel($model,"account_id",array("label"=&gt;"Tweet with Account:"));       $model-&gt;account_id = 1;      echo CHtml::activeDropDownList($model,"account_id",Account::model()-&gt;getList(),array("empty"=&gt;"Select an Account"));    } else {      echo CHtml::hiddenField("account_id",$model-&gt;account_id);        }  ?&gt;  &lt;br /&gt;&lt;?php echo $form-&gt;textAreaRow($model,"tweet_text",array("id"=&gt;"tweet_text","rows"=&gt;6, "cols"=&gt;50, "class"=&gt;"span8"));   ?&gt;   &lt;p class="right"&gt;Remaining: &lt;span id="counter2"&gt;0&lt;/span&gt;&lt;/p&gt;&lt;div class="form-actions"&gt;&lt;?php $this-&gt;widget("bootstrap.widgets.TbButton", array("buttonType"=&gt;"submit","type"=&gt;"primary","label"=&gt;$model-&gt;isNewRecord ? "Create" : "Save",)); ?&gt;&lt;/div&gt;&lt;?php $this-&gt;endWidget(); ?&gt;&lt;script type="text/javascript" charset="utf-8"&gt;$(document).ready(function(){  $("#tweet_text").simplyCountable({    counter: "#counter2",      maxCount: 140,      countDirection: "down"  });});&lt;/script&gt;</pre><p>Результат выглядит следующим образом:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/22193/image/feature-b.jpg" alt="Работаем с API Twitter: OAuth, чтение и публикация..." title="Работаем с API Twitter: OAuth, чтение и публикация..." width="50" height="50"></figure><p>Когда твит сохранен, он выполняет этот код в <code class="inline">StatusController</code>, который отправляет полученный tweet_text в Twitter через OAuth:</p><pre class="brush: php noskimlinks noskimwords">    if($model-&gt;save()) {  $account = Account::model()-&gt;findByPK($model-&gt;account_id);  $twitter = Yii::app()-&gt;twitter-&gt;getTwitterTokened($account["oauth_token"], $account["oauth_token_secret"]);        // retrieve tweets up until that last stored one        $tweets= $twitter-&gt;post("statuses/update",array("status"=&gt;$model-&gt;tweet_text)); $this-&gt;redirect(array("view","id"=&gt;$model-&gt;id));        }</pre><h2>Следующие шаги</h2><p>В этой части серии мы рассмотрели, как аутентифицироваться с помощью API Twitter через OAuth, как запрашивать диапазоны твитов на временной шкале пользователя и как подсчитывать символы и отправлять твиты через API. Надеюсь, что этот урок был вам полезен.</p><p>Часть третья будет охватывать использование Twitter Streaming API и его реализацию Phirehose.</p><p>Пожалуйста, размещайте любые комментарии, исправления или дополнительные идеи ниже. Вы можете найти мои другие уроки Tuts + на <span>моей странице автора</span> или подписаться на меня в Twitter <span>@reifman</span>.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="PHP" href="https://norma-studio.github.io/article5/220825468-rabotaem-s-api-twitter-oauth-chtenie-i-publikatsiya" class="tm-article-body__tags-item-link">PHP</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
40445</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
635</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
