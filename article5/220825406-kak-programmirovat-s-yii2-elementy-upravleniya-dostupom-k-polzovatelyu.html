
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: Введение в Yii Framework, в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года....">
<meta property="og:description" content="Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: Введение в Yii Framework, в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года....">
<meta name="twitter:description" content="Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: Введение в Yii Framework, в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года....">
<meta property="aiturec:description" content="Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: Введение в Yii Framework, в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/final_image/status-with-access.jpeg">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/final_image/status-with-access.jpeg">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/final_image/status-with-access.jpeg">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/final_image/status-with-access.jpeg">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/final_image/status-with-access.jpeg">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html" title="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io" title="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/31231313312.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html" class="tm-user-info__username" title="
Д. Грунин" aria-label="
Д. Грунин">
Д. Грунин</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Как программировать с Yii2: элементы управления доступом к пользователю...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="PHP" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu" class="tm-article-snippet__hubs-item-link"><span>PHP</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/final_image/status-with-access.jpeg">
    <meta itemprop="headline name" content="Как программировать с Yii2: элементы управления доступом к пользователю... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: Введение в Yii Framework, в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: Введение в Yii Framework, в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<p><em>Если вы спрашиваете: «Что такое Yii?» ознакомьтесь с моим предыдущим учебным пособием: </em><span><em>Введение в Yii Framework</em></span>, <em>в котором рассматриваются преимущества Yii и которое включает обзор нового в Yii 2.0, выпущенного в октябре 2014 года.</em></p><p>В этой серии статей <span>программирование с Yii2</span> я направляю читателей в использование недавно обновленного Yii2 Framework для PHP. </p><p>В <span>первой части</span> мы настраивали Yii2 локально, создавали приложение Hello World, настраивали удаленный сервер и использовали Github для развертывания нашего кода. Во <span>второй части</span> мы узнали о реализации Yii своей архитектуры Model View Controller и о том, как создавать веб-страницы и формы, которые собирают и валидируют данные. </p><p>В <span>третьей части</span> мы использовали базы данных Yii и возможности ActiveRecord для автоматизации генерации кода для базового веб-приложения. В <span>четвертой части</span> мы узнали, как интегрировать регистрацию пользователей. И в <span>пятой части</span> мы изучили локализацию с I18n для подготовки вашего приложения для глобальных пользователей. </p><p>В этом уроке я покажу вам, как реализовать средства контроля доступа, чтобы гарантировать, что только нужные пользователи смогут получить доступ к частям нашего приложения.</p><p>В этих примерах мы продолжим считать, что мы создаем фреймворк для публикации простых обновлений статуса, например, наш собственный мини-Twitter.</p><p>Просто напоминание, что я участвую в нижеуказанных комментариях. Меня особенно интересует, если у вас разные подходы, дополнительные идеи или вы хотите предложить темы для будущих учебников.</p><h2>Что такое контроль доступа?</h2><p>Контроль доступа интегрируется с функциями аутентификации фреймворка, чтобы разрешить или ограничить доступ к определенным функциям или страницам вашего веб-сайта. </p><p>Код, который мы написали до сих пор, позволяет кому-либо создавать сообщения, даже если они не вошли в систему. Например, в нашем примере приложения вы можете посетить страницу состояния и опубликовать что-нибудь даже не логинясь. </p><p>Мы можем использовать простые функции управления доступом Yii2, чтобы пользователи регистрировались и логинились перед добавлением и просмотром сообщений о статусе. </p><p>Yii2 также предлагает более продвинутый (и комплексный) <span>контроль доступа на основе ролей (RBAC)</span>, который мы не будем внедрять в настоящее время. С RBAC вы определяете сложную иерархию разрешений для каждой возможной деятельности в вашем приложении.</p><p>Встроенный в систему управления доступом Yii2 поддерживает только две роли по умолчанию: гость (не вошедший в систему), представленный «?» и аутентифицированный, представленный «@». С помощью простых элементов управления доступом мы можем просто ограничить доступ к определенным страницам или действиям контроллера в зависимости от состояния входа. Если пользователи не вошли в систему при посещении нужных страниц, Yii перенаправит их на страницу входа.</p><p>В этом уроке я расскажу вам об использовании простых элементов управления Yii2 для нашего тестового приложения. Затем мы расширим простой доступ с дополнительными ролями, такими как модератор и администратор.</p><h2>Внедрение простых элементов управления доступом</h2><p>В настоящее время наше приложение разрешает доступ к StatusController даже без входа. Давайте исправим это.</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/status-signedout.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Фреймворк упрощает реализацию этих элементов управления. Мы просто добавляем поведение к StatusController.php, которое определяет правила доступа для каждого действия, например. index, create, view и т. д. </p><p>Здесь мы рассмотрим поведение доступа, но если вам интересно, <span>фильтры Yii</span> позволяют вам ограничивать операции HTTP-запроса на основе действия вашего контроллера.<br></p><pre class="brush: php noskimlinks noskimwords">public function behaviors()    {        return [            "verbs" =&gt; [                "class" =&gt; VerbFilter::className(),                "actions" =&gt; [                    "delete" =&gt; ["post"],                ],            ],            "access" =&gt; [                        "class" =&gt; \yii\filters\AccessControl::className(),                        "only" =&gt; ["index","create","update","view"],                        "rules" =&gt; [                            // allow authenticated users                            [                                "allow" =&gt; true,                                "roles" =&gt; ["@"],                            ],                            // everything else is denied                        ],                    ],                    ];    }</pre><p>После добавления, если вы нажмете меню <strong>Status</strong>, вы будете перенаправлены на страницу входа:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/status-with-access.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Yii также обрабатывает перенаправление обратно на страницу индекса Status после завершения входа.</p><h2>Добавление владения моделью</h2><p>Теперь, когда пользователи обращаются к страницам Status, мы можем найти текущего пользователя с помощью этого кода:</p><p><code class="inline">Yii::$app-&gt;user-&gt;getId();</code><br></p><p>И мы можем связать сообщения статуса с их создателем в модели.</p><p>Чтобы сделать это, мы должны расширить таблицу Status с новой миграцией таблицы:</p><pre class="brush: bash noskimlinks noskimwords">./yii migrate/create extend_status_table_for_created_byYii Migration Tool (based on Yii v2.0.1)Create new migration "/Users/Jeff/Sites/hello/migrations/m150128_003709_extend_status_table_for_created_by.php"? (yes|no) [no]:yesNew migration created successfully.</pre><p>Вот код миграции, который добавляет столбец для <code class="inline">created_by</code>. Мы также добавляем внешний ключ для создания связи между полем <code class="inline">Status-&gt; created_by</code> и таблицей <code class="inline">User-&gt;id</code>.</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpuse yii\db\Schema;use yii\db\Migration;class m150128_003709_extend_status_table_for_created_by extends Migration{    public function up()    {      $tableOptions = null;      if ($this-&gt;db-&gt;driverName === "mysql") {          $tableOptions = "CHARACTER SET utf8 COLLATE utf8_unicode_ci ENGINE=InnoDB";      }      $this-&gt;addColumn("{{%status}}","created_by",Schema::TYPE_INTEGER." NOT NULL");      $this-&gt;addForeignKey("fk_status_created_by", "{{%status}}", "created_by", "{{%user}}", "id", "CASCADE", "CASCADE");         }    public function down()    {      $this-&gt;dropForeignKey("fk_status_created_by","{{%status}}");      $this-&gt;dropColumn("{{%status}}","created_by");    }}</pre><p>Перейдем к миграции:</p><pre class="brush: bash noskimlinks noskimwords">./yii migrate/upYii Migration Tool (based on Yii v2.0.1)Total 1 new migration to be applied:    m150128_003709_extend_status_table_for_created_byApply the above migration? (yes|no) [no]:yes*** applying m150128_003709_extend_status_table_for_created_by    &gt; add column created_by integer NOT NULL to table {{%status}} ... done (time: 0.009s)    &gt; add foreign key fk_status_created_by: {{%status}} (created_by) references {{%user}} (id) ... done (time: 0.007s)*** applied m150128_003709_extend_status_table_for_created_by (time: 0.020s)Migrated up successfully.</pre><p>Я перезапустил генерацию кода Gii с новой таблицей состояния, скопировал и вставил новые дополнительные элементы. Большинство из них были незначительными, но вы заметите, что добавлен новый ActiveQuery для отношения:</p><pre class="brush: php noskimlinks noskimwords">    /**        * @return \yii\db\ActiveQuery        */       public function getCreatedBy()       {           return $this-&gt;hasOne(User::className(), ["id" =&gt; "created_by"]);       }</pre><p>Итак, перед сохранением новых элементов статуса мы можем обновить поле <code class="inline">created_by</code> для текущего пользователя. И мы можем доверять элементам управления доступом, чтобы обеспечить доступ к методу <code class="inline">create</code> только у пользователей, прошедших аутентификацию:</p><pre class="brush: php noskimlinks noskimwords">public function actionCreate()    {        $model = new Status();        if ($model-&gt;load(Yii::$app-&gt;request-&gt;post())) {          $model-&gt;created_by = Yii::$app-&gt;user-&gt;getId();          $model-&gt;created_at = time();          $model-&gt;updated_at = time();           if ($model-&gt;save()) {                          return $this-&gt;redirect(["view", "id" =&gt; $model-&gt;id]);                        }         }         return $this-&gt;render("create", [            "model" =&gt; $model,        ]);    }</pre><p>Мы также расширим виджет вида, включив в него поле <code class="inline">created_by</code>:</p><pre class="brush: php noskimlinks noskimwords">    &lt;?= DetailView::widget([        "model" =&gt; $model,        "attributes" =&gt; [            "id",            "message:ntext",            "created_by",            "permissions",            "created_at",            "updated_at",        ],    ]) ?&gt;</pre><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/status-view-created_by_a.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Мы также можем использовать отношение <code class="inline">created_by</code> для отображения адреса электронной почты:<br></p><pre class="brush: php noskimlinks noskimwords">    &lt;?= DetailView::widget([        "model" =&gt; $model,        "attributes" =&gt; [            "id",            "createdBy.email",            "message:ntext",            "permissions",            "created_at",            "updated_at",        ],    ]) ?&gt;</pre><p><code class="inline">createdBy.email</code> обращается к методу отношения <code class="inline">Status::getCreatedBy</code>. Появится адрес электронной почты пользователя:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/view-with-relation.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Однако, чтобы поддержать эту возможность с расширением <span>Yii2-user</span>, которое мы реализовали в <span>четвертой части</span>, нам пришлось внести две модификации. Во-первых, в нашем конфигурационном массиве <code class="inline">app\config\web.php</code> мы добавили переопределение модели в <code class="inline">app\models\User.php</code>:</p><pre class="brush: php noskimlinks noskimwords">..."user" =&gt; [            "class" =&gt; "dektrium\user\Module",            "enableUnconfirmedLogin" =&gt; true,            "confirmWithin" =&gt; 21600,            "cost" =&gt; 12,            "modelMap" =&gt; [                    "User" =&gt; "app\models\User",              ],            "admins" =&gt; ["admin"]        ],   </pre><p>Мы также создали эту модель в <code class="inline">app\models</code>:</p><pre class="brush: php noskimlinks noskimwords">&lt;?namespace app\models;use dektrium\user\models\User as BaseUser;class User extends BaseUser{      public function register()    {        // do your magic    }}?&gt;</pre><p>Эти два изменения обеспечили поддержку отношения.</p><h2>Расширение простых элементов управления доступом</h2><p>Что делать, если мы хотим иметь дополнительную возможность для действий контроллера? Например, что делать, если мы хотим ограничить операции удаления модераторами или администраторами? У простого контроля доступа Yii2 нет модератора или концепции администратора, если вы не создадите его с помощью RBAC.</p><p>Обратите внимание, что расширение Yii2-user имеет идентификатор администратора для определенных пользователей, но также не хватает гибкости для дополнительных ролей.</p><p><span>The Code Ninja</span> написал хороший пример расширения простых элементов управления доступом для поддержки модераторов и администраторов (<span>упрощенная авторизация на основе ролей в Yii 2.0</span>), не прибегая к использованию RBAC. Их пример работает с расширенным шаблоном приложения Yii2. </p><p>Наше приложение отличается тем, что мы используем шаблон базового приложения Yii, <em>и</em> мы используем расширение Yii2-user. Поэтому я внес некоторые изменения в их руководство:</p><p>Сначала мы создаем каталог <code class="inline">app\components</code> и файл <code class="inline">AccessRule.php</code>, который расширяет внутреннюю модель Yii <code class="inline">AccessRule</code>:</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpnamespace app\components;use app\models\User;class AccessRule extends \yii\filters\AccessRule {    /**     * @inheritdoc     */    protected function matchRole($user)    {        if (empty($this-&gt;roles)) {            return true;        }        foreach ($this-&gt;roles as $role) {            if ($role == "?") {                if ($user-&gt;getIsGuest()) {                    return true;                }            } elseif ($role == User::ROLE_USER) {                if (!$user-&gt;getIsGuest()) {                    return true;                }            // Check if the user is logged in, and the roles match            } elseif (!$user-&gt;getIsGuest() &amp;&amp; $role == $user-&gt;identity-&gt;role) {                return true;            }        }        return false;    }}</pre><p>Затем мы добавляем определения ролей в нашу модель <code class="inline">app\models\User</code>:</p><pre class="brush: php noskimlinks noskimwords">&lt;?namespace app\models;use dektrium\user\models\User as BaseUser;class User extends BaseUser{  const ROLE_USER = 10;  const ROLE_MODERATOR = 20;  const ROLE_ADMIN = 30;</pre><p><code class="inline">Yii2-user</code> не создает столбец роли при создании новых пользователей. Таким образом, вы можете указать роли для модераторов и администраторов вручную в MySQL или позже создать собственный веб-интерфейс для предоставления ролей.</p><p>В <code class="inline">vendor\dektrium\yii2-user\models\RegistrationForm.php</code> я добавил эту строку, чтобы определить роль пользователя по умолчанию:</p><p><em>Примечание: вам нужно будет внести это изменение вручную, если вы этого захотите, потому что мой каталог vendor не попадает в дерево GitHub, и да, возможно есть более элегантный способ сделать это в основной кодовой базе после регистрации , например расширьте метод createUser в app/models/User.php. Лучшей практикой может быть форк репозитория vendor и внесение его в ваше собственное дерево кода.</em><br></p><pre class="brush: php noskimlinks noskimwords">**     * Registers a new user account.     * @return bool     */    public function register()    {        if ($this-&gt;validate()) {            $user = $this-&gt;module-&gt;manager-&gt;createUser([                "scenario" =&gt; "register",                "email"    =&gt; $this-&gt;email,                "username" =&gt; $this-&gt;username,                "password" =&gt; $this-&gt;password,                "role"=&gt;10, // User::ROLE_USER;                            ]);            return $user-&gt;register();        }        return false;    }</pre><p>Наконец, в <code class="inline">StatusController.php</code> мы добавляем некоторые библиотеки и эти определения доступа. В приведенном ниже примере действия update ограничены модераторами, а действия с удалением ограничиваются администраторами.</p><pre class="brush: php noskimlinks noskimwords">&lt;?phpnamespace app\controllers;use Yii;use app\models\Status;use app\models\StatusSearch;use app\models\User;use app\components\AccessRule;use yii\web\Controller;use yii\web\NotFoundHttpException;use yii\filters\VerbFilter;use yii\filters\AccessControl;/** * StatusController implements the CRUD actions for Status model. */class StatusController extends Controller{     public function behaviors()       {           return [               "verbs" =&gt; [                   "class" =&gt; VerbFilter::className(),                   "actions" =&gt; [                       "delete" =&gt; ["post"],                   ],               ],               "access" =&gt; [                   "class" =&gt; AccessControl::className(),                   // We will override the default rule config with the new AccessRule class                   "ruleConfig" =&gt; [                       "class" =&gt; AccessRule::className(),                   ],                   "only" =&gt; ["index","create", "update", "delete"],                   "rules" =&gt; [                       [                           "actions" =&gt; ["index","create"],                           "allow" =&gt; true,                           // Allow users, moderators and admins to create                           "roles" =&gt; [                               User::ROLE_USER,                               User::ROLE_MODERATOR,                               User::ROLE_ADMIN                           ],                       ],                       [                           "actions" =&gt; ["update"],                           "allow" =&gt; true,                           // Allow moderators and admins to update                           "roles" =&gt; [                               User::ROLE_MODERATOR,                               User::ROLE_ADMIN                           ],                       ],                       [                           "actions" =&gt; ["delete"],                           "allow" =&gt; true,                           // Allow admins to delete                           "roles" =&gt; [                               User::ROLE_ADMIN                           ],                       ],                   ],               ],                       ];       }</pre><p>Теперь, когда вы выходите из системы и просматриваете страницу <strong>Status</strong> на панели навигации, вы попадаете на экран входа в систему:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/status-with-access.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Когда вы войдете в систему, вас снова отправят на страницу index:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/logged-in-status-index.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Однако, если я нажму «<strong>Удалить</strong>», я получу эту ошибку прав доступа, потому что я скромный пользователь, а не администратор:</p><figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads/users/317/posts/23173/image/forbidden-access.jpeg" alt="Как программировать с Yii2: элементы управления доступом к пользователю..." title="Как программировать с Yii2: элементы управления доступом к пользователю..." width="50" height="50"></figure><p>Если вы хотите поднять себя до администратора, вы можете сделать это в базе данных, изменив столбец ролей таблицы пользователя для вашего user_id до 20 для модератора и 30 для администратора. Повторите операцию обновления и удаления, и вам будет разрешено в зависимости от выбранной вами роли.</p><p>Контроль доступа - одна из многих функций, которые делают меня огромным сторонником использования Yii Framework. Yii делает меня намного более эффективным разработчиком, способным предлагать решения гораздо быстрее, чем если бы я делал это с помощью ванильного PHP.<br></p><h2>Что дальше?<br></h2><p>Следите за новыми учебниками из <span>этой серии</span>. Вы также можете ознакомиться с моей серией <span>Пишем свой стартап на PHP</span>, в которой используется расширенный шаблон Yii2, где я создаю реальное приложение.</p><p>Если вы хотите узнать, когда выйдет следующий учебник по Yii2, подпишитесь на меня <span>@reifman</span> в Twitter или посетите <span>мою страницу инструктора</span>. Моя страница инструктора будет включать все статьи из этой серии, как только они будут опубликованы. Вы также можете написать мне по <span>электронной почте на моем веб-сайте Lookahead Consulting</span>.<br></p><h2>Ссылки по теме</h2><ul><li><span>Веб-сайт Yii Framework</span></li> <li><span>Введение в Yii Framework (Tuts +)</span></li> <li> <span>Yii2 Developer Exchange</span>, мой ресурсный сайт по Yii2</li> </ul>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="PHP" href="https://norma-studio.github.io/article5/220825406-kak-programmirovat-s-yii2-elementy-upravleniya-dostupom-k-polzovatelyu" class="tm-article-body__tags-item-link">PHP</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
42788</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
640</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
