
<!DOCTYPE html>
<html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io</title>
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io">
<meta name="twitter:title" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io">
<meta name="aiturec:title" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io">
<meta name="description" content="Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации»....">
<meta property="og:description" content="Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации»....">
<meta name="twitter:description" content="Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации»....">
<meta property="aiturec:description" content="Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации»....">
<meta property="og:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png">
<meta property="aiturec:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png">
<meta name="twitter:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png">
<meta property="vk:image" content="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png">
<meta property="og:type" content="article">
<link image_src="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png">
<meta property="og:locale" content="ru_RU"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name="robots" content="all">
<meta name="author" content="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html">
<meta name="copyright" lang="ru" content="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html">
<link rel="canonical" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html">
<meta property="og:url" content="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html">
<meta name="twitter:site" content="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html">
<meta name="twitter:creator" content="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html">

<meta name="apple-mobile-web-app-status-bar-style" content="#303b44"><meta name="msapplication-TileColor" content="#629FBC">
<link rel="shortcut icon" type="image/ico" sizes="64x64" href="https://norma-studio.github.io//norma-logo-64.png">
<link rel="shortcut icon" href="https://norma-studio.github.io//favicon.ico" type="image/x-icon">
<style>body{opacity: 0;}</style>
<meta name="yandex-verification" content="da91da9b0b6d5dba"><meta name="google-site-verification" content="_BCz7bv6IKv32EI5NSdb9dPwP4PnhlsToVoSOpbZlZI"></head><body>
<div id="app"><div class="tm-layout__wrapper"><div></div>
<header id="extop" class="tm-header"><div class="tm-page-width"><div class="tm-header__container">

<span class="tm-header__logo-wrap"><a aria-label="norma-studio.github.io" href="https://norma-studio.github.io/" class="tm-header__logo tm-header__logo_ru" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге norma-studio.github.io">norma-studio.github.io</a></span><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title><svg id="arrow-down" viewBox="0 0 24 24"><path d="m6.47 9.47c.293-.293.768-.293 1.061 0l4.47 4.47 4.47-4.47c.293-.293.768-.293 1.061 0s.293.768 0 1.061l-5 5c-.293.293-.768.293-1.061 0l-5-5c-.293-.293-.293-.768 0-1.061z"></path></svg></svg></button></div></div><a aria-label="Написать нам" href="https://wa.me/79603570433?text=https://norma-studio.github.io/_Добрый_день" class="tm-header__become-author-btn" title="Подборка эксклюзивных материалов о создании и продвижении сайтов, дизайне сайтов и интернет-маркетинге. Как создать и продвигать сайт, как выбрать дизайн сайта и интернет-стратегию, как защитить свои права в интернете, как продать контент для сайтов? Все ответы в блоге envatomarket.ru.">Написать нам</a><div class="tm-feature tm-header__feature tm-feature_variant-inline"></div></div></div></header>

<div class="tm-layout">
<main class="tm-layout__container"><div class="tm-page"><div class="tm-page-width"><div class="tm-page__wrapper">
<div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down">
<div class="tm-page-article__body data-container" style="background-color: #f0f0f0;" id="data-container">


<article class="tm-page-article__content tm-page-article__content_inner" style="background-color: #fff;">
<!-- article-header -->
<div class="tm-page-article__head-wrapper"><div class="tm-article-snippet tm-page-article__snippet">

<div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a aria-label="author-image" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html" title="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io" title="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io" height="24" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/i3/653463654.webp" width="24" class="tm-entity-image__pic lazy07"></div></a><span class="tm-user-info__user">
<a href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html" class="tm-user-info__username" title="
С. Салин" aria-label="
С. Салин">
С. Салин</a>
</span></span><span class="tm-article-snippet__datetime-published"><time datetime="2023-12-09T15:24:38.000Z" title="22023-12-09, 19:24"> 09.12.2023</time></span></div></div>
<h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1" itemprop="name"><span><span>Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
...</span></span></h1>
<div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02" class="tm-article-snippet__hubs-item-link"><span>Code</span></a></span><span class="tm-article-snippet__hubs-item"><a aria-label="Ruby" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02" class="tm-article-snippet__hubs-item-link"><span>Ruby</span></a></span><br></div></div>

<div itemscope itemtype="https://schema.org/Article" style="display:none;">
    <link itemprop="mainEntityOfPage" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02.html" />
    <link itemprop="image" href="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png">
    <meta itemprop="headline name" content="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02
... | envatomarket.ru | norma-studio.github.io">
    <meta itemprop="description" content="Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации»....">
    <meta itemprop="author" content="norma-studio.github.io">
    <meta itemprop="datePublished" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <meta itemprop="dateModified" datetime="2023-12-09T15:24:38.000Z" content="09.12.2023">
    <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <img class="lazy07" itemprop="url image" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://envatomarket.ru/apple-touch-icon-120.ico" alt="Шаблоны сайтов | Лендинги" title="Шаблоны сайтов | Лендинги" style="display:none;"/>
        </div>
        <meta itemprop="name" content="https://norma-studio.github.io/">
        <meta itemprop="telephone" content="">
        <meta itemprop="address" content="Россия">
    </div>
    <p>Интро</p>
    <span itemprop="articleBody">Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации»....</span>
</div>


<!-- article-body -->

<div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-2">



<figure><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" class="lazy07" data-src="https://cms-assets.tutsplus.com/cdn-cgi/image/width=600/uploads%2Fusers%2F48%2Fposts%2F25315%2Fimage-1455803913830.png" alt="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02..." title="Основы рефакторинга кода с запашком на Ruby/Rails. Часть 02..." width="50" height="50"></figure><p>Это вторая часть небольшой серии статей о «коде с запашком», и возможных рефакторингах. Целевая аудитория, для которой я это писал, — это новички, которые слышали об этой теме, и те кто, возможно, откладывал погружение в эту тему. В следующей статье рассматриваются «Завистливые функции», «Стрельба дробью» и «Расходящиеся модификации».</p><h2>Темы</h2> <ul><li>Завистливые функции</li> <li>Стрельба дробью</li> <li>Расходящиеся модификации</li> </ul><p>То, что вы быстро поймете работая с «кодом с запашком», состоит в том, что некоторые из них являются очень близкими родственниками. Даже их рефакторинг иногда связан — например, <em>Встраивание класса</em> и <em>Извлечение класса</em> не так уж и отличаются.</p> <p>Например, при встраивании класса, вы извлекаете весь класс, в процессе очищения исходно. Таким образом, это что-то типа извлечение класса с небольшим завихрением. То, что я пытаюсь сделать, — это то, что вы не должны себя чувствовать ошеломленным от количества запашков и рефакторингов, и конечно же, не быть обескураженными от их искусных имен. Такие названия, как «Стрельба дробью», «Завистливые функции» и «Расходящиеся модификации», могут показаться фантастическими и запугивающими для людей, которые только начали погружение. Может быть, я ошибаюсь, конечно.</p> <p>Если вы слегка погрузитесь в эту тему, и пробуете различные паттерны рефакторинга «кода с запашком», вы быстро обнаружите, что они очень похожи. Множество паттернов рефакторинга — это просто разные стратегии, для достижения точки, где у вас есть классы, которые являются лаконичными, хорошо организованными и сосредоточены на небольшом объеме обязанностей. Я думаю, будет справедливым сказать, что если вы этого добьетесь, вы будете в большей степени опережать большинство — не то, чтобы быть впереди других это так важно, но, такой дизайн классов часто отсутствует в коде разработчиков, которые не считаются экспертами.</p> <p>Так почему бы вам не попасть в эту лигу раньше и создать конкретную основу для дизайна вашего кода. Не верьте тому, что может быть вашим собственным предубеждением — что это продвинутая тема, которую вы должны отложить на некоторое время, пока не будете готовы. Даже если вы новичок, если вы делаете небольшие шаги, вы можете заняться рефакторингом «кода с запашком» намного раньше, чем вы могли бы подумать.</p> <p>Прежде чем погрузиться в механику, я хочу повторить важный момент из первой статьи. Не каждый «запашок» по своей сути плохой, и не каждый рефакторинг всегда стоит того чтобы им заниматься. Вы должны сразу же решить, есть ли вся соответствующая информация в вашем распоряжении, станет ли ваш код более стабилен после рефакторинга, и стоит ли тратить время на исправление «кода с запашком».</p> <h2>Завистливые функции</h2> <p>Вернемся к примеру из предыдущей статьи. Мы извлекли длинный список параметров для <code class="inline">#assign_new_mission</code> в <em>объект-параметр</em> через класс <code class="inline">Mission</code>. Пока что это круто.</p> <p><strong>M с завистливой функцией</strong></p> <pre class="brush: ruby noskimlinks noskimwords">class M  def assign_new_mission(mission)    print "Mission #{mission.mission_name} has been assigned to #{mission.agent_name} with the objective to #{mission.objective}."    if mission.licence_to_kill      print " The licence to kill has been granted."    else      print " The licence to kill has not been granted."    end  endendclass Mission  attr_reader :mission_name, :agent_name, :objective, :licence_to_kill  def initialize(mission_name: mission_name, agent_name: agent_name, objective: objective, licence_to_kill: licence_to_kill)    @mission_name    = mission_name    @agent_name      = agent_name    @objective       = objective    @licence_to_kill = licence_to_kill  endendm = M.newmission = Mission.new(mission_name: "Octopussy", agent_name: "James Bond", objective: "find the nuclear device", licence_to_kill: true)m.assign_new_mission(mission)# =&gt; "Mission Octopussy has been assigned to James Bond with the objective to find the nuclear device. The licence to kill has been granted."</pre> <p>Я кратко упомянул, как мы можем еще больше упростить класс <code class="inline">M</code>, переместив метод <code class="inline">#assign_new_mission</code> в новый класс для объекта-параметра. Я не обращал внимания на то, что у <code class="inline">M</code> была легко излечимая <em>завистливая функция</em>. <code class="inline">М</code> был слишком много знал об атрибутах <code class="inline">Mission</code>. Иначе говоря, он задавал слишком много «вопросов» об объекте миссии. Это не только плохой случай микроменеджмента, но и очень распространенный «код с запашком».</p> <p>Позвольте мне показать вам, что я имею в виду. В <code class="inline">M#assign_new_mission</code> <code class="inline">M</code> «завидует» данным в новом объекте-параметра и хочет получить к нему доступ по всему месту.</p> <ul><li>mission.mission_name</li> <li>mission.agent_name</li> <li>mission.objective</li> <li>mission.licence_to_kill</li> </ul><p>Кроме того, у вас также есть объект-параметр <code class="inline">Mission</code>, который отвечает только за передачу данных — это еще один «запашок», <em>Класс Данных</em>.</p> <p>Вся эта ситуация говорит вам в основном о том, что <code class="inline">#assign_new_mission</code> должен быть где-то в другом месте, а <code class="inline">M</code> не нуждается в подробностях о том, как назначаются миссии. В конце концов, почему бы не возложить на миссию ответственность за назначение новых миссий? Помните, лучше всегда держать вместе сущности, которые также меняются вместе.</p> <p><strong>M без завистливых функций</strong></p> <pre class="brush: ruby noskimlinks noskimwords">class M  def assign_new_mission(mission)    mission.assign  endendclass Mission  attr_reader :mission_name, :agent_name, :objective, :licence_to_kill  def initialize(mission_name: mission_name, agent_name: agent_name, objective: objective, licence_to_kill: licence_to_kill)    @mission_name    = mission_name    @agent_name      = agent_name    @objective       = objective    @licence_to_kill = licence_to_kill  end  def assign    print "Mission #{mission_name} has been assigned to #{agent_name} with the objective to #{objective}."    if licence_to_kill      print " The licence to kill has been granted."    else      print " The licence to kill has not been granted."    end  endendm = M.newmission = Mission.new(mission_name: "Octopussy", agent_name: "James Bond", objective: "find the nuclear device", licence_to_kill: true)m.assign_new_mission(mission)</pre> <p>Как вы можете видеть, мы немного упростили ситуацию. Метод значительно уменьшился и делегирует поведение ответственному объекту. <code class="inline">M</code> больше не запрашивает спецификацию данных миссии и, конечно, не может участвовать в том, как печатаются задания. Теперь она может сосредоточиться на своей реальной работе, и ее не нужно беспокоить, если какие-либо детали заданий миссии меняются. Больше времени для игр разума и охоты за агентами-изгоями. Беспроигрышно!</p> <p>Завистливые функции порождают запутанность — я не имею в виду хороший вид, который позволяет информации путешествовать быстрее света — я говорю о том, что со временем может подвергнуть ваш импульс развития размалывать все более приближающуюся остановку. Нехорошо! Почему так? Эффекты пульсации во всем коде будут создавать сопротивление! Изменение в одном месте затрагивают много чего во всем проекте. (Хорошо, немного чересчур драматично, но я даю себе B+).</p> <p>В качестве общего противоядия завистливых функций, вы хотите стремиться к разработке классов, которые в основном касаются их собственных свойств и, если возможно, отдельных обязанностей. Короче говоря, занятия должны быть чем-то вроде дружественного отакуса. В социальном плане это может быть не самое здоровое поведение, но для разработки классов это часто является разумным ориентиром, чтобы сохранить свой импульс там, где он должен быть — двигаться вперед!</p> <h2>Стрельба дробью</h2> <p>Название звучит немного глупо, не так ли? Но в то же время это довольно точное описание. Звучит как серьезный бизнес, и это так! К счастью, это не так сложно понять, но, тем не менее, это один из неприятных «запашков». Почему? Потому что он порождает дублирование, как никто другой, и легко упустить из виду все изменения, которые вам нужно будет сделать, чтобы исправить ситуацию. Что происходит во время стрельбы дробью, вы делаете изменения в одном классе/файле, и вам также нужно коснуться многих других классов/файлов, которые необходимо обновить. Надеюсь, это не то что вам нужно.</p> <p>Например, вы можете подумать, что можете уйти с одним небольшим изменением в одном месте, а затем осознать, что вам нужно пробираться через целую кучу файлов, чтобы сделать одно и то же изменение или исправить что-то еще, что было нарушено из-за этого. <em>Нехорошо</em>, совсем нет! Это звучит скорее как хорошая причина, по которой люди начинают ненавидеть код, с которым они имеют дело.</p> <p>Если у вас есть спектр с сухим кодом на одной стороне, то код, который часто требует стрельбы дробью, в значительной степени находится на противоположном конце. Не ленитесь и позвольте себе войти на эту территорию. Я уверен, что вы предпочтете открыть один файл и применить там свои изменения и закончить это. Это такая лень, к которой нужно стремиться!</p> <p>Чтобы избежать этого «запашка», вот краткий список симптомов, на которые вы можете обратить внимание:</p> <ul><li>Завистливые функции</li> <li>Тесная связь</li> <li>Длинный список параметров</li> <li>Любая форма дублирования кода</li> </ul><p>Что мы имеем в виду, когда говорим о коде, который связан? Допустим, у нас есть объекты <code class="inline">A</code> и <code class="inline">B</code>. Если они не связаны, вы можете изменить один из них, не затрагивая другого. В противном случае, вам чаще всего придется иметь дело с другим объектом.</p> <p>Это проблема и «Стрельба дробью» является симптомом для тесной связи. Поэтому всегда следите за тем, как легко вы можете изменить свой код. Если это относительно легко, это означает, что ваш уровень связи приемлемо низкий. Сказав это, я понимаю, что ваши ожидания были бы нереалистичными, если вы ожидаете, что сможете избежать связанности все время любой ценой. Этого не произойдет! Вы найдете веские причины, чтобы принять решение против этой принудительной замены условий с <em>полиморфизмом</em>. В таком случае, немного мутаций, стрельбы дробью и сохранения API объектов в синхронизации, стоят того чтобы избавиться от тонны операторов case через <em>Null Object</em> (подробнее об этом в более поздней части).</p> <p>Чаще всего вы можете применить один из следующих рефакторингов для лечения ран:</p> <ul><li>Перемещение поля</li> <li>Встраивание класса</li> <li>Извлечение класса</li> <li>Перемещение метода</li> </ul><p>Давайте посмотрим на некоторый код. Этот пример представляет собой фрагмент того, как приложение Spectre обрабатывает платежи между их контрагентами и злыми клиентами. Я упростил платежи, немного, за счет стандартных сборов, как для подрядчиков, так и для клиентов. Поэтому не имеет значения, поручено ли Spectre похитить кошку или вымогать целую страну: плата остается прежней. То же самое касается того, что они платят своим подрядчикам. В редком случае операция идет на юг и другая Nr. 2 должна буквально перепрыгнуть акулу, Spectre предлагает полный возврат, чтобы держать злых клиентов счастливыми. Spectre использует какой-то проприетарный гем, который является заполнителем для любого вида платежного процессора.</p> <p>В первом примере ниже, было бы больно, если бы Spectre решил использовать другую библиотеку для обработки платежей. Было бы больше движущихся частей, но для демонстрации стрельбы дробью, эта сложность будет выглядеть следующим образом:</p> <p><strong>Пример с запашком стрельбы дробью:</strong></p> <pre class="brush: ruby noskimlinks noskimwords">class EvilClient  #...  STANDARD_CHARGE = 10000000  BONUS_CHARGE    = 10000000  def accept_new_client    PaymentGem.create_client(email)  end  def charge_for_initializing_operation    evil_client_id = PaymentGem.find_client(email).payments_id    PaymentGem.charge(evil_client_id, STANDARD_CHARGE)  end  def charge_for_successful_operation    evil_client_id = PaymentGem.find_client(email).payments_id    PaymentGem.charge(evil_client_id, BONUS_CHARGE)  endendclass Operation  #...  REFUND_AMOUNT = 10000000  def refund    transaction_id = PaymentGem.find_transaction(payments_id)    PaymentGem.refund(transaction_id, REFUND_AMOUNT)  endend class Contractor  #...  STANDARD_PAYOUT = 200000  BONUS_PAYOUT    = 1000000  def process_payout    spectre_agent_id = PaymentGem.find_contractor(email).payments_id    if operation.enemy_agent == "James Bond" &amp;&amp; operation.enemy_agent_status == "Killed in action"      PaymentGem.transfer_funds(spectre_agent_id, BONUS_PAYOUT)    else      PaymentGem.transfer_funds(spectre_agent_id, STANDARD_PAYOUT)    end  endend</pre> <p>Когда вы смотрите на этот код, вы должны спросить себя: «Должен ли класс <code class="inline">EvilClients</code> действительно беспокоиться о том, как платежный процессор принимает новых злых клиентов и как они взимаются за операции?» Конечно нет! Это хорошая идея, чтобы распределить различные суммы, чтобы заплатить повсюду? Должны ли отображаться детали реализации платежного процессора в любом из этих классов? Скорее всего, нет!</p> <p>Посмотрите на это с другой стороны. Если вы хотите что-то изменить в отношении способов обработки платежей, зачем вам нужно открывать класс <code class="inline">EvilClient</code>? В других случаях это может быть пользователь или клиент. Если вы думаете об этом, нет смысла знакомиться с этим процессом.</p> <p>В этом примере должно быть легко видно, что изменения в способах принятия и передачи платежей создают эффект пульсации во всем коде. Кроме того, если вы хотите изменить сумму, которую вы взимаете или передаете своим подрядчикам, вам понадобятся дополнительные изменения повсюду. Основные примеры стрельбы дробью. И в этом случае мы имеем дело только с тремя классами. Представьте себе свою боль, если речь идет о более реалистичной сложности. Да, это из-за кошмаров. Давайте посмотрим на пример, который будет более разумным:</p> <p><strong>Пример без запаха стрельбы дробью и извлеченного класса:</strong></p> <pre class="brush: ruby noskimlinks noskimwords">class PaymentHandler  STANDARD_CHARGE            = 10000000  BONUS_CHARGE               = 10000000  REFUND_AMOUNT              = 10000000  STANDARD_CONTRACTOR_PAYOUT = 200000  BONUS_CONTRACTOR_PAYOUT    = 1000000  def initialize(payment_handler = PaymentGem)    @payment_handler = payment_handler  end  def accept_new_client(evil_client)    @payment_handler.create_client(evil_client.email)  end  def charge_for_initializing_operation(evil_client)    evil_client_id = @payment_handler.find_client(evil_client.email).payments_id    @payment_handler.charge(evil_client_id, STANDARD_CHARGE)  end  def charge_for_successful_operation(evil_client)    evil_client_id = @payment_handler.find_client(evil_client.email).payments_id    @payment_handler.charge(evil_client_id, BONUS_CHARGE)  end  def refund(operation)    transaction_id = @payment_handler.find_transaction(operation.payments_id)    @payment_handler.refund(transaction_id, REFUND_AMOUNT)  end  def contractor_payout(contractor)    spectre_agent_id = @payment_handler.find_contractor(contractor.email).payments_id    if operation.enemy_agent == "James Bond" &amp;&amp; operation.enemy_agent_status == "Killed in action"      @payment_handler.transfer_funds(spectre_agent_id, BONUS_CONTRACTOR_PAYOUT)    else      @payment_handler.transfer_funds(spectre_agent_id, STANDARD_CONTRACTOR_PAYOUT)    end  endendclass EvilClient  #...  def accept_new_client    PaymentHandler.new.accept_new_client(self)  end  def charge_for_initializing_operation    PaymentHandler.new.charge_for_initializing_operation(self)  end  def charge_for_successful_operation(operation)    PaymentHandler.new.charge_for_successful_operation(self)  endendclass Operation  #...  def refund    PaymentHandler.new.refund(self)  endendclass Contractor  #...  def process_payout    PaymentHandler.new.contractor_payout(self)  endend</pre> <p>Мы здесь применили API <code class="inline">PaymentGem</code> в нашем классе. Теперь у нас есть одно центральное место, где мы применяем наши изменения, если решим, что, например, <code class="inline">SpectrePaymentGem</code> будет лучше для нас работать. Больше не нужно касаться внутренних взаимосвязей с несколькими платежами, если нам нужно адаптироваться к изменениям. В классах, связанных с платежами, мы просто создавали экземпляр <code class="inline">PaymentHandler</code> и делегировали необходимые функции. Легко, стабильно, и нет причин для изменения.</p> <p>И не только мы держали все в одном файле. В классе <code class="inline">PaymentsHandler</code> есть только одно место, которое нам нужно поменять местами и ссылаться на возможный новый процессор платежей — в <code class="inline">initialize</code>. Конечно, если у новой платежной службы есть совершенно другой API, вам нужно настроить тела нескольких методов в <code class="inline">PaymentHandler</code>. Это крошечная цена, которую можно заплатить по сравнению с полной стрельбой дробью — это больше похоже на операцию для небольшого осколка в вашем пальце. Хорошая сделка!</p> <p>Если вы не будете осторожны, когда пишете тесты для такого платежного процессора, как этот, — или любой внешний сервис, на который вы должны положиться, — вы, возможно, испытываете серьезные головные боли, когда меняете свой API. Конечно, они «страдают от изменений». И вопрос не в том, изменит ли он свой API, только тогда.</p> <p>Благодаря нашей инкапсуляции мы находимся в гораздо лучшем положении, чтобы заглушить наши методы для процессора платежей. Зачем? Потому что методы, которые мы заглушаем, являются нашими собственными, и они меняются только тогда, когда мы хотим их. Это большая победа. Если вы новичок в тестировании, и это вам не совсем понятно, не беспокойтесь об этом. Не торопитесь, эта тема может быть сложной вначале. Поскольку это такое преимущество, я просто хотел упомянуть об этом ради полноты.</p> <p>Как вы можете видеть, я упростил обработку платежей в этом простом примере. Я мог бы убрать окончательный результат еще немного, но дело было в том, чтобы четко продемонстрировать «запашок», и то как вы можете избавиться от него через абстракцию.</p> <p>Если вы не совсем довольны этим классом, и видите возможности для рефакторинга, я приветствую вас, и я рад в этом признаться. Хорошее начало может иметь дело с тем, как вы находите <code class="inline">payments_ids</code>. Сам класс тоже немного переполнился...</p> <h2>Расходящиеся модификации</h2> <p>Расходящиеся модификации, в некотором роде, противоположны стрельбе дробью — там, где вы хотите изменить одну вещь, и вам нужно произвести это изменение через кучу разных файлов. Здесь один класс часто изменяется по разным причинам и по-разному. Моя рекомендация состоит в том, чтобы идентифицировать части, которые меняются вместе и извлечь их в отдельный класс, который может сосредоточиться на этой единственной ответственности. Эти классы, в свою очередь, также должны иметь не более чем одну причину для изменения, если нет, другой «запашок» «Расходящиеся модификации», скорее всего, ждет вас.</p> <p>Классы, которые страдают от расходящиеся модификаций, — это те, которые сильно меняются. С помощью инструментов, таких как <span>Churn</span>, вы можете измерить, как часто некоторые части вашего кода нуждались в изменении в прошлом. Чем больше очков вы найдете в классе, тем выше вероятность того, что расходящиеся изменения могут активны. Я также не удивлюсь, если именно эти классы являются причиной большинства ошибок.</p> <p>Не поймите меня неправильно: частые изменения это не «запашок». Это полезный симптом. Другим очень распространенным и более явным признаком является то, что этот объект должен манипулировать более чем одной ответственностью. <em>Принцип единой ответственности</em> <span>SRP</span> является отличным руководством для предотвращения этого запаха кода и для написания более стабильного кода в целом. Это может быть сложно, но, тем не менее, стоит обратить на это внимание.</p> <p>Давайте посмотрим на этот скверный пример ниже. Я немного изменил пример стрельбы дробью. <span>Blofeld</span>, голова Spectre, может быть известен микроматериалам, но я сомневаюсь, что он был бы заинтересован в половине того, с чем связан этот класс.</p> <pre class="brush: ruby noskimlinks noskimwords">class Spectre  STANDARD_CHARGE = 10000000  STANDARD_PAYOUT = 200000  def charge_for_initializing_operation(client)    evil_client_id = PaymentGem.find_client(client.email).payments_id    PaymentGem.charge(evil_client_id, STANDARD_CHARGE)  end  def contractor_payout(contractor)    spectre_agent_id = PaymentGem.find_contractor(contractor.email).payments_id    PaymentGem.transfer_funds(spectre_agent_id, STANDARD_PAYOUT)  end  def assign_new_operation(operation)    operation.contractor = "Some evil dude"    operation.objective  = "Steal a boatload of valuable stuff"    operation.deadline   = "Midnight, November 18th"  end  def print_operation_assignment(operation)    print "#{operation.contractor} is assigned to #{operation.objective}. The mission deadline ends at #{operation.deadline}."  end  def dispose_of_agent(spectre_agent)    puts "You disappointed this organisation. You know how Spectre handles failure. Good bye #{spectre_agent.code_name}!"  endend</pre> <p>Класс <code class="inline">Spectre</code> имеет слишком много разных вещей, о которых он знает:</p> <ul><li>Назначение новых операций</li> <li>Плата за их грязную работу</li> <li>Печать назначение миссий</li> <li>Убийство безуспешных призрачных агентов</li> <li>Работа с внутренними компонентами PaymentGem</li> <li>Оплаты агентам/подрядчикам Spectre</li> <li>Он также знает о сумме денег для начисления и выплаты</li> </ul><p>Семь различных обязанностей по одному классу. Нехорошо! Вам нужно изменить способ удаления агентов? Один вектор для изменения класса<code class="inline"> Spectre</code>. Вы хотите обрабатывать выплаты по-другому? Другой вектор. Вы получаете дрейф.</p> <p>Хотя этот пример далеко не реалистичен, он по-прежнему рассказывает историю о том, как легко излишне использовать поведение, которое необходимо часто менять в одном месте. Мы можем сделать лучше!</p> <pre class="brush: ruby noskimlinks noskimwords">class Spectre  # ...  def dispose_of_agent(spectre_agent)    puts "You disappointed this organisation. You know how Spectre handles failure. Good bye #{spectre_agent.code_name}!"  endendclass PaymentHandler  STANDARD_CHARGE            = 10000000  STANDARD_CONTRACTOR_PAYOUT = 200000  #...  def initialize(payment_handler = PaymentGem)    @payment_handler = payment_handler  end  def charge_for_initializing_operation(evil_client)    evil_client_id = @payment_handler.find_client(evil_client.email).payments_id    @payment_handler.charge(evil_client_id, STANDARD_CHARGE)  end  def contractor_payout(contractor)    spectre_agent_id = @payment_handler.find_contractor(contractor.email).payments_id    @payment_handler.transfer_funds(spectre_agent_id, STANDARD_CONTRACTOR_PAYOUT)    end  endendclass EvilClient  #...  def charge_for_initializing_operation    PaymentHandler.new.charge_for_initializing_operation(self)  endendclass Contractor  #...  def process_payout    PaymentHandler.new.contractor_payout(self)  endendclass Operation  attr_accessor :contractor, :objective, :deadline  def initialize(attrs = {})    @contractor = attrs[:contractor]     @objective  = attrs[:objective]     @deadline   = attrs[:deadline]   end  def print_operation_assignment    print "#{contractor} is assigned to #{objective}. The mission deadline ends at #{deadline}."  endend</pre> <p>Здесь мы извлекли кучу классов и предоставили им свои уникальные обязанности, и поэтому их собственная причина была изменена.</p> <p>Вы хотите обрабатывать платежи по-разному? Теперь вам не нужно прикасаться к классу <code class="inline">Spectre</code>. Вам нужно платить или платить иначе? Опять же, нет необходимости открывать файл для <code class="inline">Spectre</code>. Печать назначение операций теперь является операцией — там, где она принадлежит. Это оно. Не слишком сложно, я думаю, но, безусловно, один из наиболее распространенных запашков, с которыми вам следует познакомится пораньше.</p> <h2>Последние мысли</h2> <p>Надеюсь, вы дошли до того момента, когда чувствуете себя готовым попробовать эти рефакторинги в своем собственном коде, и вам легче определить, какой «запашок» вокруг вас. Мы только начали, но вы уже взялись за пару крупных запашков. Думаю, это было не так сложно, как вы когда-то могли подумать!</p> <p>Конечно, реальные примеры будут намного более сложными, но если вы поняли механику и шаблоны для обнаружения запахов, вы, безусловно, сможете быстро адаптироваться к реальным сложностям.</p>

</div></div>

<div class="tm-article-body__tags"><div class="tm-article-body__tags-links tm-article-body__tags-links2"><span class="tm-article-body__tags-title">Теги:</span><span class="tm-article-body__tags-item"><a aria-label="Code" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02" class="tm-article-body__tags-item-link">Code</a></span><span class="tm-article-body__tags-item"><a aria-label="Ruby" href="https://norma-studio.github.io/article5/220825279-osnovy-refaktoringa-koda-s-zapashkom-na-ruby-rails-chast-02" class="tm-article-body__tags-item-link">Ruby</a></span></div></div></div></article>

<div class="tm-article__icons-wrapper"><div class="tm-data-icons tm-page-article__counters-panel"><div class="tm-article-rating tm-data-icons__item"><div class="v-portal" style="display:none;"></div></div><span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title><svg id="counter-views" viewBox="0 0 56 32"><path d="M28 0c18.368 0 28 13.81 28 16s-9.632 16-28 16c-18.368 0-28-13.81-28-16s9.632-16 28-16zm0 28.309c6.874 0 12.446-5.511 12.446-12.309s-5.572-12.309-12.446-12.309-12.446 5.511-12.446 12.309 5.572 12.309 12.446 12.309zM28 16c.084-1.721 5.596-3.019 4.284-4.352-2.429-2.468-6.317-2.521-8.684-.117s-2.314 6.354.116 8.821c2.429 2.468 6.317 2.521 8.683.117 1.089-1.106-4.47-3.008-4.399-4.469z"></path></svg></svg><span class="tm-icon-counter__value">
40223</span></span><button aria-label="Добавить в закладки" title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item" onclick="return addBookmark(this);"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title><svg id="counter-favorite" viewBox="0 0 12 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1 0C0.734784 0 0.48043 0.105357 0.292893 0.292893C0.105357 0.48043 0 0.734784 0 1V15C0 15.3603 0.193793 15.6927 0.507301 15.8702C0.82081 16.0477 1.20556 16.0429 1.5145 15.8575L6 13.1662L10.4855 15.8575C10.7944 16.0429 11.1792 16.0477 11.4927 15.8702C11.8062 15.6927 12 15.3603 12 15V1C12 0.447715 11.5523 0 11 0H1Z"></path></svg></svg></span><span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
370</span></button><div title="Поделиться" class="tm-sharing tm-data-icons__item">
<button aria-label="sharing" type="button" class="tm-sharing__button sharer button btn5242" data-sharer="vk" data-url="none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button></div><div class="v-portal" style="display:none;"></div></div></div>
</div>

<div class="tm-page-article__additional-blocks wr55"></div>
<!-- pagination -->
 </div></div>
<!-- sidebar -->
<div class="tm-page__sidebar"><div id="572480" class="tm-layout-sidebar">

<div class="tm-sexy-sidebar tm-sexy-sidebar_stick-top wr54" style="margin-top: 0px;">
<section class="tm-block tm-block_spacing-bottom wr12a"></section>
<section class="tm-block tm-block_spacing-bottom wr12">

</section>
</div></div></div></div></div></div></main></div><div id="exbottom" class="tm-footer wr56"></div></div><div class="vue-portal-target"></div></div>
<link rel="stylesheet" href="../style.css">
<script src="../jquery-3.7.0.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9PLTD9XQE"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "G-Y9PLTD9XQE");</script><script>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");ym(63258550, "init", {clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src="https://mc.yandex.ru/watch/63258550" style="position:absolute; left:-9999px;" alt="" /></div></noscript></body></html>
